import{r as rrr}from"./crypto-js-e179ec67.js";import{B as J}from"./bignumber.js-86a357b7.js";import{s as Rr}from"./spark-md5-70718f13.js";import{L}from"./long-9036a742.js";import{n as Or}from"./protobufjs-08248ea9.js";import{r as Cr}from"./@protobufjs-79a8f228.js";import{d as In}from"./js-crypto-aes-3ea73ac5.js";import{t as Fe}from"./axios-4cddcdae.js";import{u as wn}from"./ua-parser-js-325d5185.js";var En=new(function(){function o(){this.servicesIdentifierMap=new Map,this.registeredService=new Map}return o.prototype.registryService=function(t){var e=t.name;this.registeredService.has(e)||this.registeredService.set(e,t)},o.prototype.unregistryService=function(t){},o.prototype.getService=function(t,e,n){n===void 0&&(n="[DEFAULT_CATEGORY]");var r=this.servicesIdentifierMap.get(n);if(r==null)r=new Map,this.servicesIdentifierMap.set(n,r);else if((s=r.get(t))!=null)return s;var i=this.registeredService.get(t);if(i!=null){var s=i.serviceFactory(e);return r.set(t,s),s}return null},o}()),_=new(function(){function o(){}return o.prototype.registerApiProvider=function(t,e,n){this[t]=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];return e(r)},n!=null&&function r(i,s){if(!(s instanceof Object))return s;switch(s.constructor){case Array:i=[];break;case Object:i===void 0&&(i={});break;case Date:return new Date(s.getTime());default:return s}for(var a in s)s.hasOwnProperty(a)&&(i[a]=r(i[a],s[a]));return i}(this[t],n)},o.prototype.registerInternalService=function(t){En.registryService(t)},o.prototype.getService=function(t,e,n){return En.getService(t,e,n)},o}()),ct="[DEFAULT_CATEGORY]",Pr=function(){function o(t){this.factory=t}return o.prototype.get=function(){return this.instance==null&&(this.instance=this.factory()),this.instance},o}(),ir=function(){function o(t){this.instanceMap={},this.factory=t}return o.prototype.get=function(t){if(t&&Array.isArray(t)&&t.length>=1)return this.instanceMap[t[0]]||(this.instanceMap[t[0]]=this.factory(t)),this.instanceMap[t[0]];var e=new Array;return e[0]="[DEFAULT_CATEGORY]",this.get(e)},o}(),Ue,de;(function(o){o[o.DEBUG=0]="DEBUG",o[o.VERBOSE=1]="VERBOSE",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.ERROR=4]="ERROR",o[o.SILENT=5]="SILENT"})(de||(de={}));var Ee=function(){function o(){var t=this;this.moduleName="",this.logLevel=de.VERBOSE,this.userLogProvider=null,this.logProvider=function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(!(n<t.logLevel)){var s=o.consoleType[n];if(!s)throw new Error("invalid logType: ".concat(n));console[s]("[Module:".concat(e,"] [").concat(new Date().toISOString(),"] | "),r.toString())}}}return o.createLogger=function(t){for(var e=0,n=o.logInstanceArray;e<n.length;e++){var r=n[e];if(r.moduleName==t)return r}var i=new o;return i.moduleName=t,o.logInstanceArray.push(i),i},o.prototype.setLogProvider=function(t){if(typeof t!="function")throw new Error("logProvider must be set as a function");this.logProvider=t},o.prototype.setUserLogProvider=function(t){this.userLogProvider=t},o.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.doLog(de.DEBUG,t)},o.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.doLog(de.VERBOSE,t)},o.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.doLog(de.INFO,t)},o.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.doLog(de.WARN,t)},o.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.doLog(de.ERROR,t)},o.prototype.doLog=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.userLogProvider&&this.userLogProvider(this.moduleName,t,e),this.logProvider(this.moduleName,t,e)},o.consoleType=((Ue={})[de.DEBUG]="log",Ue[de.VERBOSE]="log",Ue[de.SILENT]="log",Ue[de.INFO]="info",Ue[de.WARN]="warn",Ue[de.ERROR]="error",Ue),o.logInstanceArray=[],o}();/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var sr=function(o,t){return(sr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])})(o,t)},Dt,Rn,C=function(o){function t(e,n,r){var i=this,s=e.code+t.COLON+e.message;return r&&(s=r+t.DASH+s),n&&(n.message?s=s+t.COMMA+n.message:typeof n=="string"&&(s=s+t.COMMA+n)),(i=o.call(this,s)||this).__proto__=t.prototype,i.code=e.code,i.message=e.message,n&&(n.message?i.message=e.message+t.COMMA+n.message:typeof n=="string"&&(i.message=e.message+t.COMMA+n)),i.msg=i.message,i}return function(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}sr(e,n),e.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}(t,o),t.COLON=": ",t.COMMA=", ",t.DASH="-",t}(Error),H=function(){function o(){}return o.AGC_INNER_ERROR={code:1e4,message:"agc inner error"},o.NETWORK_REQUEST_ERROR={code:10001,message:"agc network request error"},o.GET_AAID_ERROR={code:10002,message:"agc get aaid error"},o.ABTEST_LOAD_EXPERIMENTS_ERROR={code:10003,message:"abtest load experiments error"},o.ABTEST_SAVE_EXPERIMENTS_ERROR={code:10004,message:"abtest save experiments error"},o.ABTEST_REPLACE_EXPERIMENTS_ERROR={code:10005,message:"abtest repalce experiments error"},o.FAIL_TO_GET_STORAGE_SERVICE={code:10006,message:"get agcStorage service failed"},o.FAIL_TO_GET_NETWORK_SERVICE={code:10007,message:"get agcNetwork service failed"},o.REMOVE_TOKEN_FAILED={code:10008,message:"remove client token faild"},o.GET_TOKEN_FAILED={code:10009,message:"get client token faild"},o.AGC_INIT_ERROR={code:10010,message:"AGCInstance init error"},o.FAIL_TO_GET_CRIDENTIAL_SERVICE={code:10011,message:"get agcCredential service failed"},o.WEBSOCKET_NOT_SUPPORT={code:10012,message:"websocket is not support"},o.WEBSOCKET_ERROR={code:10013,message:"websocket error"},o}(),Ge=Ee.createLogger("agconnectInstance"),_r=function(){function o(t,e){this.appVersion="",this._config=null,this._customCredentialsProvider=null,this._customAuthProvider=null,this.cryptImpl=void 0,this.option=null,this.repo_=t,this.name_=e||ct}return o.prototype.name=function(){return this.name_},o.prototype.configInstance=function(t){return this._config=t,this.replaceAppInfo(),this},o.prototype.replaceAppInfo=function(){this._config&&this._config.app_info&&this._config.app_info.app_id&&this._config.client&&(this._config.client.app_id=this._config.app_info.app_id)},o.prototype.config=function(){return this.checkBeforeSetKey(),this._config},o.prototype.setApiKey=function(t){this.checkBeforeSetKey(),this._config.client.api_key=t},o.prototype.setClientSecret=function(t){this.checkBeforeSetKey(),this._config.client.client_secret=t},o.prototype.setClientId=function(t){this.checkBeforeSetKey(),this._config.client.client_id=t},o.prototype.getService=function(t){return this.repo_.getService(t,this,this.name_)},o.prototype.setCustomCredentialsProvider=function(t){return t?t.getToken?t.getToken.length!=1?(Ge.error("the customCredentialsProvider getToken method must contain single parameter：forceRefresh."),!1):(this._customCredentialsProvider=t,!0):(Ge.error("the customCredentialsProvider must contain getToken method."),!1):(this._customCredentialsProvider=t,!0)},o.prototype.setCustomAuthProvider=function(t){return t?t.getToken?t.getToken.length!=1?(Ge.error("the customAuthProvider getToken method must contain single parameter：forceRefresh."),!1):(this._customAuthProvider=t,!0):(Ge.error("the customAuthProvider must contain getToken method."),!1):(this._customAuthProvider=t,!0)},o.prototype.getCustomCredentialsProvider=function(){return this._customCredentialsProvider},o.prototype.getCustomAuthProvider=function(){return this._customAuthProvider},o.prototype.setCryptImp=function(t){return t?t.decrypt&&t.decrypt instanceof Function&&t.encrypt&&t.encrypt instanceof Function?(this.cryptImpl=t,!0):(Ge.error("the crypt is not exist necessary methods."),!1):(Ge.error("the crypt is not available."),!1)},o.prototype.setAppVersion=function(t){this.appVersion=t},o.prototype.setOption=function(t){this.option=t},o.prototype.addHttpToUrl=function(t){return t&&!t.startsWith("https://")?"https://"+t:t},o.prototype.getGwUrl=function(){return this.option!=null?this.option.routePolicy==1?this.addHttpToUrl(this._config.agcgw_all.CN):this.option.routePolicy==2?this.addHttpToUrl(this._config.agcgw_all.DE):this.option.routePolicy==3?this.addHttpToUrl(this._config.agcgw_all.RU):this.option.routePolicy==4?this.addHttpToUrl(this._config.agcgw_all.SG):this.addHttpToUrl(this._config.agcgw.url):this.addHttpToUrl(this._config.agcgw.url)},o.prototype.getGwBackUrl=function(){return this.option!=null?this.option.routePolicy==1?this.addHttpToUrl(this._config.agcgw_all.CN_back):this.option.routePolicy==2?this.addHttpToUrl(this._config.agcgw_all.DE_back):this.option.routePolicy==3?this.addHttpToUrl(this._config.agcgw_all.RU_back):this.option.routePolicy==4?this.addHttpToUrl(this._config.agcgw_all.SG_back):this.addHttpToUrl(this._config.agcgw.backurl):this.addHttpToUrl(this._config.agcgw.backurl)},o.prototype.getAppVersion=function(){return this.appVersion},o.prototype.getCryptImp=function(){return this.cryptImpl},o.prototype.checkBeforeSetKey=function(){if(this._config==null)throw new C(H.AGC_INIT_ERROR,{message:"AGCInstance not configurated. call agconnect.instance().configInstance() to configure the agconnect."},"instance");if(!this._config.agcgw||!this._config.client)throw new C(H.AGC_INIT_ERROR,{message:"AGCInstance config is invalid."},"instance")},o}(),Je=function(){function o(t,e){t===void 0&&(t=0),e===void 0&&(e=""),this.code=t,this.msg=e}return o.prototype.getCode=function(){return this.code},o.prototype.setCode=function(t){this.code=t},o.prototype.getMsg=function(){return this.msg},o.prototype.setMsg=function(t){this.msg=t},o}(),ce=function(){function o(){this.ret=new Je}return o.prototype.isSuccess=function(){return this.ret!=null&&this.ret.getCode()==0},o.prototype.getRet=function(){return this.ret},o.prototype.setRet=function(t){this.ret=t},o.prototype.constructResponse=function(t){},o}(),Ar=new ir(function(o){return new _r(_,o[0])});(function(o){o[o.UNKNOWN=0]="UNKNOWN",o[o.CHINA=1]="CHINA",o[o.GERMANY=2]="GERMANY",o[o.RUSSIA=3]="RUSSIA",o[o.SINGAPORE=4]="SINGAPORE"})(Dt||(Dt={})),Rn={AGCRoutePolicy:Dt},_.registerApiProvider("instance",function(o){return Ar.get(o)},Rn);/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var ar=function(o,t){return(ar=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])})(o,t)};function yn(o,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=o}ar(o,t),o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function kr(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){var c;l.done?r(l.value):(c=l.value,c instanceof e?c:new e(function(d){d(c)})).then(s,a)}u((n=n.apply(o,t||[])).next())})}function Nr(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}var Dr=function(o){function t(e){var n=o.call(this)||this;return n.CancelToken=void 0,Fe.defaults.timeout=7e4,n.CancelToken=Fe.CancelToken,e==null&&e==null||(Fe.defaults.adapter=e),n}return yn(t,o),t.prototype.getAxiosIns=function(){return Fe},t.prototype.sendRequest=function(e,n,r,i,s){return kr(this,void 0,void 0,function(){var a,u;return Nr(this,function(l){switch(l.label){case 0:return this.checkParam(n)?(a={url:n,method:e,transformResponse:s==null?void 0:s.transformResponse,headers:i,timeout:s==null?void 0:s.timeout,responseType:s==null?void 0:s.responseType,onUploadProgress:s==null?void 0:s.onUploadProgress,onDownloadProgress:s==null?void 0:s.onDownloadProgress,validateStatus:s==null?void 0:s.validateStatus,cancelToken:s==null?void 0:s.cancelToken},e!="PUT"&&e!="POST"||(a.data=r),e!="GET"&&e!="DELETE"||(a.params=r),s&&s.throwOriginException?[2,Fe.request(a)]:[4,Fe.request(a).catch(function(c){return Promise.reject(new C(H.NETWORK_REQUEST_ERROR,c,"network"))})]):[2,Promise.reject(new C(H.NETWORK_REQUEST_ERROR,{message:"url is illegal"},"network"))];case 1:return u=l.sent(),[2,Promise.resolve(u)]}})})},t}(function(){function o(){this.CancelToken=void 0}return o.prototype.post=function(t,e,n,r){return this.sendRequest("POST",t,e,n,r)},o.prototype.get=function(t,e,n,r){return this.sendRequest("GET",t,e,n,r)},o.prototype.delete=function(t,e,n,r){return this.sendRequest("DELETE",t,e,n,r)},o.prototype.put=function(t,e,n,r){return this.sendRequest("PUT",t,e,n,r)},o.prototype.checkParam=function(t){return!(!t||t.match(/\s/g)||!t.match(/^(ht)tp(s?)\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/))},o}()),Ur=function(o){function t(e){var n=o.call(this)||this;return n.logger=Ee.createLogger("AGCPlatformInfoService"),n.instance=e||_.instance(),n}return yn(t,o),t.prototype.getPlatform=function(){return"JS-SDK"},t.prototype.getAppVersion=function(){return this.instance.getAppVersion()},t.prototype.getLanguage=function(){var e;return(e=navigator.languages&&navigator.languages[0]?navigator.languages[0]:navigator.language).toLowerCase().length>2?e.toLowerCase().substr(0,2):""},t.prototype.getSystemInfo=function(){var e="",n="";try{var r=navigator.userAgent,i=new wn.UAParser;i.setUA(r);var s=i.getResult();e=s.os.name,n=s.os.version}catch{this.logger.warn("get system info failed")}return e==="Mac OS"&&(e="Macintosh"),{name:e,version:n}},t.prototype.getBrowsersInfo=function(){var e="",n="";try{var r=navigator.userAgent,i=new wn.UAParser;i.setUA(r);var s=i.getResult();e=s.browser.name,n=s.browser.version}catch{this.logger.warn("get browser info failed")}return{name:e,version:n}},t}(function(){function o(){}return o.prototype.getPlatform=function(){return""},o.prototype.getPlatformVersion=function(){return""},o.prototype.getPackageName=function(){return""},o.prototype.getAppVersion=function(){return""},o.prototype.getLanguage=function(){return""},o.prototype.getScript=function(){return""},o.prototype.getCountry=function(){return""},o.prototype.getSystemInfo=function(){return{name:"",version:""}},o.prototype.getBrowsersInfo=function(){return{name:"",version:""}},o}()),Mr=function(o){function t(){var e=o.call(this)||this;if(e.WebSocketImpl="MozWebSocket"in window?MozWebSocket:WebSocket,!e.WebSocketImpl)throw new C(H.WEBSOCKET_NOT_SUPPORT,{message:"Sorry, your browser does not support WebSockets."},"network");return e}return yn(t,o),t.prototype.connect=function(e,n,r){if(this.websocket&&this.websocket.readyState!=3&&(this.websocket.close(),this.websocket=null),this.websocket=new this.WebSocketImpl(e,r),!this.websocket)throw new C(H.WEBSOCKET_ERROR,{message:"webSocket create fail"},"network");return Promise.resolve()},t}(function(){function o(){this.logger=Ee.createLogger("AGCWebSocketService")}return o.prototype.getReadyState=function(){return this.websocket?Number(this.websocket.readyState):null},o.prototype.send=function(t,e,n){try{if(this.websocket){if(this.websocket.send(t),e)return e()}else if(n)return n()}catch(r){if(this.logger.error(r),n)return n()}},o.prototype.close=function(t,e,n,r){try{if(this.websocket){if(this.websocket.close(t,e),n)return n()}else if(r)return r()}catch(i){if(this.logger.error(i),r)return r()}},o.prototype.onOpen=function(t){if(!this.websocket)throw new C(H.WEBSOCKET_ERROR,{message:"webSocket connect fail"},"network");this.websocket.onopen=t},o.prototype.onMessage=function(t){if(!this.websocket)throw new C(H.WEBSOCKET_ERROR,{message:"webSocket connect fail"},"network");this.websocket.onmessage=function(e){t&&t(e.data)}},o.prototype.onClose=function(t){if(!this.websocket)throw new C(H.WEBSOCKET_ERROR,{message:"webSocket connect fail"},"network");this.websocket.onclose=function(e){t&&t(e.code,e.reason,e.wasClean)}},o.prototype.onError=function(t){if(!this.websocket)throw new C(H.WEBSOCKET_ERROR,{message:"webSocket connect fail"},"network");this.websocket.onerror=function(e){t&&t(e)}},o}()),Ut=_;Ut.registerInternalService({name:"AGCNetworkService",serviceFactory:function(o){return new Dr}}),Ut.registerInternalService({name:"AGCWebSocketService",serviceFactory:function(o){return new Mr}}),Ut.registerInternalService({name:"AGCPlatformInfoService",serviceFactory:function(o){return new Ur(o)}});var Mt=function(){function o(){this.storage={}}return o.getInstance=function(t,e){return o.memoryInsMap.has(t)&&o.memoryInsMap.get(t)||o.memoryInsMap.set(t,new o),o.memoryInsMap.get(t)},o.prototype.get=function(t){return Promise.resolve(this.storage[t])},o.prototype.remove=function(t){return delete this.storage[t],Promise.resolve()},o.prototype.set=function(t,e){return this.storage[t]=e,Promise.resolve()},o.memoryInsMap=new Map,o}(),ur=function(){function o(t){this.encryptImpl=void 0,this.encryptImpl=t}return o.prototype.setEncryptImp=function(t){this.encryptImpl=t},o.prototype.decrypt=function(t){return this.encryptImpl!=null&&this.encryptImpl!=null&&t!=null&&t!=null?this.encryptImpl.decrypt(t):t},o.prototype.encrypt=function(t){return this.encryptImpl!=null&&this.encryptImpl!=null&&t!=null&&t!=null?this.encryptImpl.encrypt(t):t},o}(),On=function(){function o(){this.DB_NAME="agcLocalStorageDb",this.OBJECT_STORE_NAME="agc",this.KEY_PATH="agcStorage",this.VERSION=1,this.agcCryptImpl=new ur}return o.getInstance=function(t,e){if(!window.indexedDB)throw Ee.createLogger("AGCStorageService").error("Your environment doesn't support a stable version of IndexedDB."),new C(H.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of IndexedDB."});o.indexedDBInsMap.has(t)&&o.indexedDBInsMap.get(t)||o.indexedDBInsMap.set(t,new o);var n=o.indexedDBInsMap.get(t);return n.agcCryptImpl.setEncryptImp(e),n},o.prototype.initIndexedDb=function(t){var e=this;return window.indexedDB?new Promise(function(n,r){var i=window.indexedDB.open(e.DB_NAME,e.VERSION),s=e;i.onupgradeneeded=function(a){var u=a.target.result;try{u.objectStoreNames.contains(s.OBJECT_STORE_NAME)||u.createObjectStore(s.OBJECT_STORE_NAME,{keyPath:s.KEY_PATH})}catch(l){r(l)}},i.onsuccess=function(a){try{n(a.target.result.transaction([s.OBJECT_STORE_NAME],t).objectStore(s.OBJECT_STORE_NAME))}catch(u){r(u)}},i.onerror=function(a){r(a.target.error)}}):Promise.reject(new C(H.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of IndexedDB."},"storage"))},o.prototype.get=function(t){if(!t)return Promise.reject(new Error("get key is null"));var e=this;return this.initIndexedDb("readonly").then(function(n){return new Promise(function(r,i){try{var s=n.get(t);s.onsuccess=function(){var a=s.result;r(a!=null&&"value"in a?e.agcCryptImpl.decrypt(a.value):a)},s.onerror=function(a){i(a.target.error)}}catch(a){i(a)}})}).catch(function(n){return Promise.reject(n)})},o.prototype.set=function(t,e){if(!t||!e)return Promise.reject(new Error("set key or value is null"));var n={},r={};n[this.KEY_PATH]=t,r.value=this.agcCryptImpl.encrypt(e);var i=Object.assign(r,n);return this.initIndexedDb("readwrite").then(function(s){try{var a=s.get(t);return a.onsuccess=function(){var u=a.result,l=u!=null&&"value"in u?s.put(i):s.add(i);l.onsuccess=function(){return Promise.resolve()},l.onerror=function(c){return Promise.reject(c.target.error)}},a.onerror=function(u){return Promise.reject(u.target.error)},Promise.resolve()}catch(u){return Promise.reject(u)}}).catch(function(s){return Promise.reject(s)})},o.prototype.remove=function(t){return t?this.initIndexedDb("readwrite").then(function(e){try{var n=e.delete(t);return n.onsuccess=function(){return Promise.resolve()},n.onerror=function(r){return Promise.reject(r.target.error)},Promise.resolve()}catch(r){return Promise.reject(r)}}).catch(function(e){return Promise.reject(e)}):Promise.reject(new Error("remove key is null"))},o.indexedDBInsMap=new Map,o}(),Cn=function(){function o(){this.agcCryptImpl=new ur}return o.getInstance=function(t,e){if(!o.isSessionStorageAvailable())throw Ee.createLogger("AGCStorageService").error("Your environment doesn't support a stable version of sessionStorage."),new C(H.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of sessionStorage."});!o.sessionMap.has(t)&&o.sessionMap.get(t)||o.sessionMap.set(t,new o);var n=o.sessionMap.get(t);return n.agcCryptImpl.setEncryptImp(e),n},o.isSessionStorageAvailable=function(){try{return sessionStorage.setItem("agctestKey","testValue"),sessionStorage.removeItem("agctestKey"),!0}catch{return!1}},o.prototype.get=function(t){if(!t)return Promise.reject(new Error("key is null"));try{var e=sessionStorage.getItem(t);return Promise.resolve(e===""?null:this.agcCryptImpl.decrypt(e))}catch(n){return Promise.reject(n)}},o.prototype.set=function(t,e){if(!t||!e)return Promise.reject(new Error("key or value is null"));try{return sessionStorage.setItem(t,this.agcCryptImpl.encrypt(e)),Promise.resolve()}catch(n){return Promise.reject(n)}},o.prototype.remove=function(t){if(!t)return Promise.reject(new Error("key is null"));try{return sessionStorage.removeItem(t),Promise.resolve()}catch(e){return Promise.reject(e)}},o.sessionMap=new Map,o}(),jr=function(){function o(t){this.name=ct,t&&(this.name=t)}return o.prototype.getStorageInstance=function(t,e){var n;switch(t){case 2:n=Mt.getInstance(this.name,e);break;case 0:n=On.getInstance(this.name,e);break;case 1:n=Cn.getInstance(this.name,e);break;default:n=Mt.getInstance(this.name,e)}return n},o.prototype.createPersistentStorage=function(){return On.getInstance(this.name)},o.prototype.createTemporaryStorage=function(){return Cn.getInstance(this.name)},o.prototype.createMemoryStorage=function(){return Mt.getInstance(this.name)},o}();_.registerInternalService({name:"AGCStorageService",serviceFactory:function(o){return new jr(o.name())}});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var cr=function(o,t){return(cr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])})(o,t)};function jt(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){var c;l.done?r(l.value):(c=l.value,c instanceof e?c:new e(function(d){d(c)})).then(s,a)}u((n=n.apply(o,t||[])).next())})}function xt(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}var Lt=function(){function o(){this.TWO_MINUTES_EARLY=12e4,this.ONE_HOUR=36e5,this.expiration=0,this.tokenString="",this.issuedAt="0",this.notBefore="0",this.lastRefreshTime=0}return o.prototype.constructFromJson=function(t){this.expiration=t.expiration,this.issuedAt=t.issuedAt,this.tokenString=t.tokenString,this.notBefore=t.notBefore,this.lastRefreshTime=t.lastRefreshTime},o.prototype.isValid=function(){var t=new Date().getTime(),e=this.lastRefreshTime+1e3*this.expiration-this.TWO_MINUTES_EARLY;return this.tokenString!=null&&t<=e},o.prototype.allowRefresh=function(){return new Date().getTime()-this.lastRefreshTime>this.ONE_HOUR},o}(),xr=function(o){function t(e){var n=o.call(this,e)||this;return n.REQUEST_URL="/agc/apigw/oauth2/v1/token",n.useJwt=0,n}return function(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}cr(e,n),e.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}(t,o),t.prototype.getBody=function(){return{grant_type:"client_credentials",client_id:this.getHeaderClientId(),client_secret:this.getClientSecret(),useJwt:this.getUseJwt()}},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.REQUEST_URL},t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.getUseJwt=function(){return this.useJwt},t}(function(){function o(t){this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerProductId="",this.headerAppId="",this.headerClientId="",this.clientSecret="",this.agcgwUrl="",this.agcgwBackUrl="",this.agcConfig=null,this.instance=null,this.sdkServiceName="agconnect-credential",this.sdkVersion="1.5.1",this.setAGCInstance(t)}return o.prototype.setAGCInstance=function(t){if(!t)throw new C(H.AGC_INNER_ERROR,{message:"set AGCInstance using null or undefined object"},"CredentialsService");this.instance=t,this.agcConfig=null},o.prototype.getHeaderClientId=function(){return this.initConfig()?this.headerClientId:""},o.prototype.getClientSecret=function(){return this.initConfig()?this.clientSecret:""},o.prototype.getAgcgwUrl=function(){return this.initConfig()?this.agcgwUrl:""},o.prototype.getHeader=function(){if(!this.initConfig())return"";var t=this.instance.getService("AGCPlatformInfoService");return t&&(this.sdkPlatform=t.getPlatform(),this.sdkPlatformVersion=t.getPlatformVersion(),this.packageName=t.getPackageName(),this.appVersion=t.getAppVersion()),{sdkVersion:this.sdkVersion,sdkPlatform:this.sdkPlatform,sdkServiceName:this.sdkServiceName,sdkPlatformVersion:this.sdkPlatformVersion,sdkType:this.sdkType,packageName:this.packageName,appVersion:this.appVersion,app_id:this.headerAppId,client_id:this.headerClientId,productId:this.headerProductId,"Content-Type":"application/json;charset=UTF-8"}},o.prototype.initConfig=function(){if(!this.instance)throw new C(H.AGC_INNER_ERROR,{message:"set AGCInstance using null or undefined object"},"CredentialsService");return this.agcConfig==null&&(this.agcConfig=this.instance.config(),this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.clientSecret=this.agcConfig.client.client_secret,this.agcgwUrl=this.instance.getGwUrl(),this.agcgwBackUrl=this.instance.getGwBackUrl()),!0},o}()),Pn=function(){function o(){}return o.getInstance=function(){return o.instance||(o.instance=new o),o.instance},o.prototype.getStorage=function(t){var e=t.getService("AGCStorageService");if(e!=null)return e.getStorageInstance(0,t.getCryptImp());tn.error("Get AGC storage Service failed.")},o}(),tn=Ee.createLogger("CredentialsService"),Lr=function(){function o(t){this.instance=t||_.instance()}return o.prototype.removeToken=function(){if(this.instance.getCustomCredentialsProvider())return Promise.resolve();var t=this.getCredentialStoreKey(),e=Pn.getInstance().getStorage(this.instance);return e?e.remove(t).catch(function(n){return n instanceof C?Promise.reject(n):Promise.reject(new C(H.REMOVE_TOKEN_FAILED,n,"CredentialsService"))}):Promise.reject(new C(H.FAIL_TO_GET_STORAGE_SERVICE,null,"CredentialsService"))},o.prototype.getToken=function(t){return jt(this,void 0,void 0,function(){var e,n,r,i,s,a=this;return xt(this,function(u){switch(u.label){case 0:return this.instance.getCustomCredentialsProvider()?(e=new Lt,[4,this.instance.getCustomCredentialsProvider().getToken(!!t)]):[3,2];case 1:return(n=u.sent())&&n.tokenString&&n.expiration?isNaN(Number(n.expiration))||Number(n.expiration)<=0?(tn.error("the customCredentialsProvider getToken must return valid expiration."),[2,Promise.reject(new C(H.GET_TOKEN_FAILED,{message:"the customCredentialsProvider getToken must return valid expiration"},"CredentialsService"))]):(e.tokenString=n.tokenString,e.expiration=n.expiration,e.lastRefreshTime=new Date().getTime(),[2,Promise.resolve(e)]):(tn.error("the customCredentialsProvider getToken method must contain return value: tokenString, expiration."),[2,Promise.reject(new C(H.GET_TOKEN_FAILED,{message:"the customCredentialsProvider getToken method must contain return value: tokenString, expiration"},"CredentialsService"))]);case 2:return r=this.getCredentialStoreKey(),(i=Pn.getInstance().getStorage(this.instance))?(s=new Lt,[2,i.get(r).then(function(l){return jt(a,void 0,void 0,function(){var c,d;return xt(this,function(y){switch(y.label){case 0:return l?s.constructFromJson(JSON.parse(l)):s=null,s&&s.isValid()?t&&s.allowRefresh()?[4,this.requestToken()]:[3,3]:[3,4];case 1:return c=y.sent(),[4,i.set(r,JSON.stringify(c))];case 2:return y.sent(),[2,Promise.resolve(c)];case 3:return[2,Promise.resolve(s)];case 4:return[4,this.requestToken()];case 5:return d=y.sent(),[4,i.set(r,JSON.stringify(d))];case 6:return y.sent(),[2,Promise.resolve(d)]}})})}).catch(function(l){return l instanceof C?Promise.reject(l):Promise.reject(new C(H.GET_TOKEN_FAILED,l,"CredentialsService"))})]):[2,Promise.reject(new C(H.FAIL_TO_GET_STORAGE_SERVICE,null,"CredentialsService"))]}})})},o.prototype.getCredentialStoreKey=function(){return this.instance.name()===ct?"agcClientToken:"+this.instance.config().client.client_id:"agcClientToken_"+this.instance.name()+":"+this.instance.config().client.client_id},o.prototype.requestToken=function(){return jt(this,void 0,void 0,function(){var t,e;return xt(this,function(n){return(t=this.instance.getService("AGCNetworkService"))?((e=new xr(this.instance)).setUseJwt(1),[2,t.post(e.getUrl(),e.getBody(),e.getHeader()).then(function(r){if(r.data.ret&&r.data.ret.code!=0)return Promise.reject(new C({code:r.data.ret.code,message:r.data.ret.msg},null,"CredentialsService"));var i=new Lt;return i.tokenString=r.data.access_token,i.expiration=r.data.expires_in,i.lastRefreshTime=new Date().getTime(),Promise.resolve(i)})]):[2,Promise.reject(new C(H.FAIL_TO_GET_NETWORK_SERVICE,null,"CredentialsService"))]})})},o}();_.registerInternalService({name:"CredentialsService",serviceFactory:function(o){return new Lr(o)}});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var lr=function(o,t){return(lr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])})(o,t)};function gn(o,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=o}lr(o,t),o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function Xe(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){var c;l.done?r(l.value):(c=l.value,c instanceof e?c:new e(function(d){d(c)})).then(s,a)}u((n=n.apply(o,t||[])).next())})}function Ze(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}var Vr=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.responseBody=void 0,e}return gn(t,o),t.prototype.constructResponse=function(e){this.responseBody=e},t.prototype.getValue=function(){return this.responseBody?this.responseBody:null},t}(ce),nn=function(){function o(){}return o.FAIL_TO_GET_CREDENTIAL_SERVICE={code:11e3,message:"get agcCredential service failed"},o.FAIL_TO_GET_NETWORK_SERVICE={code:11001,message:"get agcNetwork service failed"},o.FAIL_TO_CALL_CLOUD_FUNCTION={code:11002,message:"call cloud function failed"},o.FAIL_TO_GET_ACCESS_TOKEN={code:11003,message:"no user login"},o}(),rn=function(o){function t(e,n){var r=o.call(this,e,n,"function")||this;return r.__proto__=t.prototype,r}return gn(t,o),t.constructExcpFromRet=function(e){return new t({code:e.getCode(),message:e.getMsg()})},t}(C),qr=function(){function o(){}return o.prototype.getAccessToken=function(t,e){return Xe(this,void 0,void 0,function(){var n;return Ze(this,function(r){switch(r.label){case 0:return t?[4,t.getToken(e)]:[3,2];case 1:if(n=r.sent())return[2,n.getToken()];r.label=2;case 2:return[2,Promise.resolve(null)]}})})},o.prototype.doRequest=function(t,e,n,r){return Xe(this,void 0,void 0,function(){var i,s,a,u,l,c,d,y=this;return Ze(this,function(T){switch(T.label){case 0:return i=_.instance().getService("AuthProviderService"),[4,this.getAccessToken(i,!1)];case 1:return(s=T.sent())&&t.setAccessToken(s),a=t.getHeader(),(u=_.instance().getService("CredentialsService"))?(l="",[4,u.getToken().then(function(S){l=S.tokenString})]):(An.error("get credentialProvider service failed."),[2,Promise.reject(new rn(nn.FAIL_TO_GET_CREDENTIAL_SERVICE))]);case 2:return T.sent(),a.Authorization="Bearer "+l,c=void 0,e&&(c={timeout:e,timeoutErrorMessage:"CloudFunction run out of time"}),d=new Vr,[4,this.doNetworkOption(t,a,d,c).catch(function(S){return Xe(y,void 0,void 0,function(){var O;return Ze(this,function(P){switch(P.label){case 0:return S.response&&S.response.status&&S.response.data&&S.response.data.ret&&S.response.data.ret.code?S.response.status!==o.TOKEN_INVALID?[3,6]:(O=S.response.data.ret.code)==o.CLIENT_TOKEN_EXPIRED&&n?[4,u.removeToken()]:[3,3]:[3,6];case 1:return P.sent(),[4,u.getToken(!0)];case 2:return P.sent(),[2,this.doRequest(t,e,!1,r)];case 3:return O==o.ACCESS_TOKEN_EXPIRED&&r?i?[4,i.getToken(!0)]:[3,5]:[3,6];case 4:P.sent(),P.label=5;case 5:return[2,this.doRequest(t,e,n,!1)];case 6:return S.message&&S.message.indexOf("Network Error")!=-1&&!t.useBackUrl?(t.useBackUrl=!0,[2,this.doRequest(t,e,n,r)]):[2,Promise.reject(S)]}})})})];case 3:return T.sent(),[2,Promise.resolve(d)]}})})},o.prototype.doNetworkOption=function(t,e,n,r){return Xe(this,void 0,void 0,function(){var i;return Ze(this,function(s){switch(s.label){case 0:return(i=_.instance().getService("AGCNetworkService"))?[4,i.post(t.getUrl(),t.getBody(),e,r).then(function(a){return a.status&&a.status===o.HTTP_OK?(n.ret.setCode(0),n.ret.setMsg("OK"),n.constructResponse(a.data),Promise.resolve()):Promise.reject(a)}).catch(function(a){return Promise.reject(a)})]:(An.error("get agcNetwork service failed."),[2,Promise.reject(new rn(nn.FAIL_TO_GET_NETWORK_SERVICE))]);case 1:return s.sent(),[2]}})})},o.CLIENT_TOKEN_EXPIRED=205524993,o.ACCESS_TOKEN_EXPIRED=205524994,o.TOKEN_INVALID=401,o.HTTP_OK=200,o}(),Kr=function(){function o(){this.sdkServiceName="",this.sdkVersion="",this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerClientId="",this.authorization="",this.headerProductId="",this.headerAppId="",this.agcgwUrl="",this.agcgwBackUrl=""}return o.prototype.init=function(){this.sdkServiceName="agconnect-function",this.sdkVersion="1.5.1";var t=_.instance().getService("AGCPlatformInfoService");t&&(this.sdkPlatform=t.getPlatform(),this.sdkPlatformVersion=t.getPlatformVersion(),this.packageName=t.getPackageName(),this.appVersion=t.getAppVersion()),this.authorization="",this.agcConfig=_.instance().config(),this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.agcgwUrl=this.addHttpToUrl(this.agcConfig.agcgw.url),this.agcgwBackUrl=this.addHttpToUrl(this.agcConfig.agcgw.backurl)},o.prototype.addHttpToUrl=function(t){return t&&!t.startsWith("https://")?"https://"+t:t},o}(),_n="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",Br=function(){function o(){}return o.hash=function(t,e){var n="agc:"+t+"@"+e,r=Rr.hash(n),i=new J(r="0x"+r);return o.encode(i)},o.encode=function(t){for(var e="";t.isGreaterThan(61);){var n=t.modulo(62);e=_n.charAt(n.toNumber())+e,t=t.dividedToIntegerBy(62)}return e=_n.charAt(t.toNumber())+e},o}(),Fr=function(o){function t(e,n){var r=o.call(this)||this;return r.useBackUrl=!1,r.accessToken="",r.body=n,r.httpTriggerURI=e,r}return gn(t,o),t.prototype.getUrl=function(){var e=this.agcConfig.client.cp_id,n=this.agcConfig.client.product_id,r=Br.hash(e,n);return this.httpTriggerURI&&this.httpTriggerURI.length>0&&this.httpTriggerURI.charAt(0)!="/"&&(this.httpTriggerURI="/"+this.httpTriggerURI),this.useBackUrl?this.agcgwBackUrl+t.SERVER_URL+"/"+r+this.httpTriggerURI:this.agcgwUrl+t.SERVER_URL+"/"+r+this.httpTriggerURI},t.prototype.getHeader=function(){return{sdkVersion:this.sdkVersion,sdkPlatform:this.sdkPlatform,sdkServiceName:this.sdkServiceName,sdkPlatformVersion:this.sdkPlatformVersion,sdkType:this.sdkType,packageName:this.packageName,appVersion:this.appVersion,appId:this.headerAppId,clientId:this.headerClientId,productId:this.headerProductId,Authorization:this.authorization,"Content-Type":"application/json;charset=UTF-8",accessToken:this.accessToken,access_token:this.accessToken}},t.prototype.getBody=function(){return this.body},t.prototype.setAccessToken=function(e){this.accessToken=e},t.SERVER_URL="/agc/apigw/wisefunction/functions",t}(Kr),Gr=function(){function o(t){this.httpTriggerURI="",this.timeout=void 0,this.functionBackend=new qr,this.httpTriggerURI=t}return o.prototype.call=function(t){return Xe(this,void 0,void 0,function(){return Ze(this,function(e){return[2,this.callFunction(t)]})})},o.prototype.callFunction=function(t){return Xe(this,void 0,void 0,function(){var e,n;return Ze(this,function(r){switch(r.label){case 0:return(e=new Fr(this.httpTriggerURI,t)).init(),[4,this.functionBackend.doRequest(e,this.timeout,!0,!0).catch(function(i){return i instanceof C?Promise.reject(i):Promise.reject(new rn(nn.FAIL_TO_CALL_CLOUD_FUNCTION,i))})];case 1:return n=r.sent(),[2,Promise.resolve(n)]}})})},o.prototype.clone=function(t){var e=new o(this.httpTriggerURI);return e.timeout=t,e},o}(),An=Ee.createLogger("function"),zr=function(){function o(){}return o.prototype.wrap=function(t){return new Gr(t)},o}(),Hr=new Pr(function(){return new zr});_.registerApiProvider("function",function(){return Hr.get()});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function Yr(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){var c;l.done?r(l.value):(c=l.value,c instanceof e?c:new e(function(d){d(c)})).then(s,a)}u((n=n.apply(o,t||[])).next())})}function Qr(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}var kn,Wr=function(){function o(){this.storageImpl=void 0}return o.prototype.getAaid=function(t){return Yr(this,void 0,void 0,function(){var e,n,r,i,s;return Qr(this,function(a){switch(a.label){case 0:e=Ee.createLogger("ClientInfoService"),a.label=1;case 1:return a.trys.push([1,5,,6]),n="agcAaid_"+t.name()+":"+t.config().client.client_id,t.name()===ct&&(n="agcAaid:"+t.config().client.client_id),(r=t.getService("AGCStorageService"))==null?(e.error("Get AGC storage Service failed."),[2,Promise.reject(new C(H.GET_AAID_ERROR,{message:"get AGC storage Service failed"},"util"))]):(this.storageImpl||(this.storageImpl=r.getStorageInstance(o.persistence)),[4,this.storageImpl.get(n).catch(function(u){return e.error("get aaid failed",u.message),Promise.reject(new C(H.GET_AAID_ERROR,{message:"get aaid from storage failed"},"util"))})]);case 2:return(i=a.sent())!=null&&i!=null&&i!=""?[3,4]:(i=this.getRandomString(),[4,this.storageImpl.set(n,i).catch(function(u){return e.error("get aaid failed",u.message),Promise.reject(new C(H.GET_AAID_ERROR,{message:"save aaid to storage failed"},"util"))})]);case 3:a.sent(),a.label=4;case 4:return[2,i];case 5:return s=a.sent(),e.error("get aaid failed",s.message),[2,Promise.reject(new C(H.GET_AAID_ERROR,s,"util"))];case 6:return[2]}})})},o.prototype.getRandomString=function(){var t="0123456789abcdef",e=t.length;return"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/x/g,function(){return t.charAt(Math.floor(Math.random()*e))})},o.persistence=0,o.INSTANCE=new o,o}(),$r=function(){function o(){}return o.getEnvironmentIns=function(){return o.instance},o.prototype.isBrowser=function(){return typeof self=="object"&&self.self===self},o.prototype.isNodeJS=function(){try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}},o.prototype.isReactNative=function(){return typeof navigator=="object"&&navigator.product==="ReactNative"},o.prototype.isQuickApp=function(){try{return global&&"fastapp"in global}catch{return!1}},o.instance=new o,o}(),Jr=function(){function o(t){this.instance=t||_.instance()}return o.prototype.getAaid=function(){return Wr.INSTANCE.getAaid(this.instance)},o.prototype.getEnvironmentUtil=function(){return $r.getEnvironmentIns()},o}();function Nn(o){return o!=null}(function(o){var t=function(e,n,r){if(typeof e=="function"||Nn(n)||Nn(r))this.next=e,this.error=n||null,this.complete=r||null;else{var i=e;this.next=i.next||null,this.error=i.error||null,this.complete=i.complete||null}};o.ObserverImpl=t})(kn||(kn={})),_.registerInternalService({name:"ClientInfoService",serviceFactory:function(o){return new Jr(o)}});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var dr=function(o,t){return(dr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])})(o,t)};function N(o,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=o}dr(o,t),o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function A(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){var c;l.done?r(l.value):(c=l.value,c instanceof e?c:new e(function(d){d(c)})).then(s,a)}u((n=n.apply(o,t||[])).next())})}function k(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}var Le,Dn=function(){function o(){}return o.getInstance=function(){return o.instance||(o.instance=new o),o.instance},o.prototype.getStorage=function(t){var e=t.getService("AGCStorageService");if(e!=null){var n=pr.get([t.name()]);return e.getStorageInstance(Number(n.getUserInfoPersistence()),n.getCryptImp()?n.getCryptImp():t.getCryptImp())}ne.error("Get AGC storage Service failed.")},o}(),Xr=function(){function o(){this.providerInfo=new Array}return o.prototype.getProviderInfo=function(){return this.providerInfo},o.prototype.setProviderInfo=function(t){this.providerInfo=t},o.prototype.updateProvider=function(t){if(t&&this.providerInfo){var e=t.provider;e&&this.deleteProvider(e),this.providerInfo.push(t)}},o.prototype.updateProviderInfo=function(t,e,n){var r=this.findProviderIndex(t.toString());r!=null&&(this.providerInfo[r][e]=n)},o.prototype.updateEmail=function(t){this.updateProviderInfo(12,"email",t)},o.prototype.updatePhone=function(t){this.updateProviderInfo(11,"phone",t)},o.prototype.deleteProvider=function(t){var e=this.findProviderIndex(t);this.providerInfo&&e!=null&&this.providerInfo.splice(e,1)},o.prototype.findProviderIndex=function(t){var e=void 0;if(t&&this.providerInfo)for(var n=0;n<this.providerInfo.length;n++){var r=this.providerInfo[n];if(r&&t==r.provider){e=n;break}}return e},o}(),on=function(){function o(t,e,n,r){this.state=void 0,this.expiration=t,this.issuedAt=e,this.notBefore=n,this.tokenString=r}return o.prototype.getState=function(){return this.state},o.prototype.getToken=function(){return this.tokenString},o}(),w=function(o){function t(e,n){var r=o.call(this,e,n,"auth")||this;return r.__proto__=t.prototype,r}return N(t,o),t.constructExcpFromRet=function(e){return new t({code:e.getCode(),message:e.getMsg()})},t}(C),R=function(){function o(){}return o.NULL_TOKEN={code:1,message:"token is null"},o.NOT_SIGN_IN={code:2,message:"no user signed in"},o.USER_LINK_FAILED={code:3,message:"user link faild"},o.USER_UNLINK_FAILED={code:4,message:"user unlink faild"},o.ALREADY_SIGN_IN_USER={code:5,message:"already sign in a user"},o.EMAIL_VERIFICATION_IS_EMPTY={code:6,message:"email verification code is empty"},o.PHONE_VERIFICATION_IS_EMPTY={code:7,message:"phone verification code is empty"},o.ILLEGAL_TOKEN_LISTENER={code:8,message:"illegal token listener"},o.ILLEGAL_CUSTOM_AUTH_PROVIDER={code:9,message:"illegal custom auth provider"},o.FAIL_TO_GET_CREDENTIAL_SERVICE={code:10,message:"get agcCredential service failed"},o.FAIL_TO_GET_NETWORK_SERVICE={code:11,message:"get agcNetwork service failed"},o.FAIL_TO_GET_STORAGE_SERVICE={code:12,message:"get agcStorage service failed"},o.FAIL_TO_GET_USER_EXTRA={code:13,message:"get user extra fail"},o.FAIL_TO_GET_ACCESS_TOKEN={code:14,message:"get user access token fail"},o.FAIL_TO_DO_USER_REAUTH={code:15,message:"user reauthenticate fail"},o.FAIL_TO_UPDATE_PROFILE={code:16,message:"update user reauthenticate fail"},o.FAIL_TO_UPDATE_EMAIL={code:17,message:"update user email fail"},o.FAIL_TO_UPDATE_PHONE={code:18,message:"update user phone fail"},o.FAIL_TO_UPDATE_PASSWORD={code:19,message:"update user password fail"},o.PASSWORD_IS_EMPTY={code:20,message:"password is empty"},o.FAIL_TO_GET_VERIFY_CODE={code:21,message:"get verify code failed"},o.FAIL_TO_CREAT_EMAIL_USER={code:22,message:"create email user failed"},o.FAIL_TO_CREAT_PHONE_USER={code:23,message:"create phone user failed"},o.SIGN_IN_FAILED={code:24,message:"sign in failed"},o.DELETE_USER_FAILED={code:25,message:"delete user failed"},o.SIGN_OUT_FAILED={code:26,message:"sign out failed"},o.GET_CURRENT_USER_FAILED={code:27,message:"get current user failed"},o.SIGN_IN_ANONYMOUS_FAILED={code:28,message:"sign in anonymously failed"},o.FAIL_TO_GET_UTIL_SERVICE={code:29,message:"get clientInfoUtil service failed"},o.FAIL_TO_RESET_PASSWORD_EMAIL={code:30,message:"reset password by email failed"},o.FAIL_TO_RESET_PASSWORD_PHONE={code:31,message:"reset password by phone failed"},o.AUTH_INNER_ERROR={code:32,message:"agc auth service inner error"},o.INVALID_EMAIL={code:203817223,message:"invalid email"},o.INVALID_PHONE={code:203817224,message:"invalid phone"},o}(),nt=function(){function o(){this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerProductId="",this.headerAppId="",this.headerClientId="",this.agcgwUrl="",this.agcgwBackUrl="",this.agcConfig=null,this.instance=null,this.sdkServiceName="agconnect-auth",this.sdkVersion="1.5.1",this.accessToken="",this.authorization="",this.headerAaId="",this.setAGCInstance(_.instance())}return o.prototype.setAGCInstance=function(t){if(!t)throw new w(R.AUTH_INNER_ERROR,{message:"set AGCInstance using null or undefined object"});this.instance=t,this.agcConfig=null},o.prototype.getHeaderProductId=function(){return this.initConfig()?this.headerProductId:""},o.prototype.setAccessToken=function(t){this.accessToken=t},o.prototype.getAgcgwUrl=function(){return this.initConfig()?this.agcgwUrl:""},o.prototype.getAuthHeader=function(){if(!this.initConfig())return"";var t=this.instance.getService("AGCPlatformInfoService");return t&&(this.sdkPlatform=t.getPlatform(),this.sdkPlatformVersion=t.getPlatformVersion(),this.packageName=t.getPackageName(),this.appVersion=t.getAppVersion()),{sdkVersion:this.sdkVersion,sdkPlatform:this.sdkPlatform,sdkPlatformVersion:this.sdkPlatformVersion,sdkType:this.sdkType,packageName:this.packageName,appVersion:this.appVersion,sdkServiceName:this.sdkServiceName,app_id:this.headerAppId,client_id:this.headerClientId,productId:this.headerProductId,access_token:this.accessToken,Authorization:this.authorization,"Content-Type":"application/json;charset=UTF-8"}},o.prototype.initConfig=function(){if(!this.instance)throw new w(R.AUTH_INNER_ERROR,{message:"set AGCInstance using null or undefined object"});return this.agcConfig==null&&(this.agcConfig=this.instance.config(),this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.agcgwUrl=this.instance.getGwUrl(),this.agcgwBackUrl=this.instance.getGwBackUrl()),!0},o}(),B=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t.SERVER_URL="/agc/apigw/oauth2/third/v1",t}(nt),Zr=function(o){function t(e,n){var r=o.call(this)||this;return r.URL=B.SERVER_URL+"/user-auth/refresh-token",r.useJwt=0,r.refreshToken=e,r.useJwt=n,r}return N(t,o),t.prototype.getBody=function(){return{refreshToken:this.refreshToken,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),it=function(){function o(){this.token="",this.validPeriod=0}return o.prototype.getToken=function(){return this.token},o.prototype.setToken=function(t){this.token=t},o.prototype.getValidPeriod=function(){return this.validPeriod},o.prototype.setValidPeriod=function(t){this.validPeriod=t},o}(),eo=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.accessToken=new it,e.productId="",e.uid="",e}return N(t,o),t.prototype.constructResponse=function(e){this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.productId=e.data.productId,this.uid=e.data.uid,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t}(ce),to=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-profile",e}return N(t,o),t.prototype.getBody=function(){},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(nt),no=function(o){function t(){var e=o.call(this)||this;return e.displayName="",e.photoUrl="",e.emailVerified=0,e.passwordSetted=0,e.email="",e.phone="",e.userExtra=null,e}return N(t,o),t.prototype.constructResponse=function(e){this.displayName=e.data.displayName,this.photoUrl=e.data.photoUrl,this.emailVerified=e.data.emailVerified,this.passwordSetted=e.data.passwordSetted,this.email=e.data.email,this.phone=e.data.phone,this.userExtra=new ro,this.userExtra.createTime=e.data.userMetaData.createTime,this.userExtra.lastSignInTime=e.data.userMetaData.lastSignInTime,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t}(ce),ro=function(){function o(){this.createTime="",this.lastSignInTime=""}return o.prototype.getCreateTime=function(){return this.createTime},o.prototype.getLastSignInTime=function(){return this.lastSignInTime},o}(),oo=function(){function o(t,e){this.token=t,this.expirePeriod=e}return o.prototype.getToken=function(){return this.token},o.prototype.getExpirePeriod=function(){return this.expirePeriod},o}(),io=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-link",e.provider=-1,e.token="",e.extraData="",e.useJwt=0,e}return N(t,o),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getExtraData=function(){return this.extraData},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,useJwt:this.useJwt}},t}(B),Oe=function(){function o(){this.autoCreateUser=!0}return o.prototype.getProvider=function(){return-1},o}(),et=function(){function o(){this.password=void 0,this.verifyCode=void 0}return o.prototype.getProvider=function(){return-1},o}(),so=function(o){function t(){var e=o.call(this)||this;return e.providerUserInfo=void 0,e}return N(t,o),t.prototype.getProviderUserInfo=function(){return this.providerUserInfo},t.prototype.setProviderUserInfo=function(e){this.providerUserInfo=e},t.prototype.constructResponse=function(e){this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code),e.data.providerUserInfo&&this.setProviderUserInfo(e.data.providerUserInfo)},t}(ce),ke=function(){function o(t){this.user=t}return o.prototype.getUser=function(){return this.user},o}(),ao=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-unlink",e.provider=-1,e}return N(t,o),t.prototype.getProvider=function(){return this.provider},t.prototype.setProvider=function(e){this.provider=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()+"&provider="+this.getProvider()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{}},t}(B),uo=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),bn=function(o){function t(e,n,r){var i=o.call(this)||this;return i.playerSign=e,i.extraData=n,i.autoCreateUser=r,i}return N(t,o),t.prototype.getProvider=function(){return 5},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData),e.setUseJwt(1)},t}(Oe),co=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-reauthenticate",e.provider=-1,e.token="",e.extraData="",e.autoCreateUser=0,e.useJwt=1,e}return N(t,o),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.setAutoCreateUser=function(e){this.autoCreateUser=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,autoCreateUser:this.autoCreateUser,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),lo=function(){function o(){this.uid="",this.displayName="",this.photoUrl="",this.phone="",this.email="",this.provider=-1,this.openId="",this.emailVerified=0,this.passwordSetted=0}return o.prototype.getUid=function(){return this.uid},o.prototype.setUid=function(t){this.uid=t},o.prototype.getDisplayName=function(){return this.displayName},o.prototype.setDisplayName=function(t){this.displayName=t},o.prototype.getPhotoUrl=function(){return this.photoUrl},o.prototype.setPhotoUrl=function(t){this.photoUrl=t},o.prototype.getPhone=function(){return this.phone},o.prototype.setPhone=function(t){this.phone=t},o.prototype.getEmail=function(){return this.email},o.prototype.setEmail=function(t){this.email=t},o.prototype.getProvider=function(){return this.provider},o.prototype.setProvider=function(t){this.provider=t},o.prototype.getOpenId=function(){return this.openId},o.prototype.setOpenId=function(t){this.openId=t},o.prototype.getEmailVerified=function(){return this.emailVerified},o.prototype.setEmailVerified=function(t){this.emailVerified=t},o.prototype.getPasswordSetted=function(){return this.passwordSetted},o.prototype.setPasswordSetted=function(t){this.passwordSetted=t},o}(),wt=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.accessToken=new it,e.refreshToken=new it,e.userInfo=new lo,e.providers=[],e}return N(t,o),t.prototype.constructResponse=function(e){this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.refreshToken.setToken(e.data.refreshToken.token),this.refreshToken.setValidPeriod(e.data.refreshToken.validPeriod),this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code),this.userInfo.setUid(e.data.userInfo.uid),this.userInfo.setEmail(e.data.userInfo.email),this.userInfo.setPhone(e.data.userInfo.phone),this.userInfo.setProvider(e.data.userInfo.provider),this.userInfo.setEmailVerified(e.data.userInfo.emailVerified),this.userInfo.setPasswordSetted(e.data.userInfo.passwordSetted),this.userInfo.setDisplayName(e.data.userInfo.displayName),this.userInfo.setOpenId(e.data.userInfo.openId),this.userInfo.setPhotoUrl(e.data.userInfo.photoUrl);for(var n=new Array,r=0;r<e.data.providers.length;r++){var i={};this.userInfoToMap(e.data.providers[r],i),n.push(i)}this.providers=n},t.prototype.getAccessToken=function(){return this.accessToken},t.prototype.setAccessToken=function(e){this.accessToken=e},t.prototype.getRefreshToken=function(){return this.refreshToken},t.prototype.setRefreshToken=function(e){this.refreshToken=e},t.prototype.getUserInfo=function(){return this.userInfo},t.prototype.getProviders=function(){return this.providers},t.prototype.userInfoToMap=function(e,n){e.uid&&(n.uid=e.uid.toString()),e.displayName&&(n.displayName=e.displayName.toString()),e.photoUrl&&(n.photoUrl=e.photoUrl.toString()),e.email&&(n.email=e.email.toString()),e.phone&&(n.phone=e.phone.toString()),e.provider&&(n.provider=e.provider.toString()),e.openId&&(n.openId=e.openId.toString())},t}(ce),po=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(wt),fo=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-profile",e.displayName="",e.photoUrl="",e}return N(t,o),t.prototype.setDisplayName=function(e){this.displayName=e},t.prototype.setPhotoUrl=function(e){this.photoUrl=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{displayName:this.displayName,photoUrl:this.photoUrl}},t}(B),ho=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),yo=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-phone-email",e.newEmail="",e.newVerifyCode="",e.lang="",e}return N(t,o),t.prototype.setNewVerifyCode=function(e){this.newVerifyCode=e},t.prototype.setNewEmail=function(e){this.newEmail=e},t.prototype.setLang=function(e){this.lang=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{lang:this.lang,newEmail:this.newEmail,newVerifyCode:this.newVerifyCode}},t}(B),go=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),lt=function(){function o(){}return o.combinatePhone=function(t,e){return t==null||t.startsWith("+")||(t="+"+t),t+"-"+e},o}(),bo=function(o){function t(e,n,r,i){var s=o.call(this)||this;return s.URL=B.SERVER_URL+"/user-phone-email",s.countryCode=e,s.newPhone=n,s.newVerifyCode=r,s.lang=i,s}return N(t,o),t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{lang:this.lang,newPhone:lt.combinatePhone(this.countryCode,this.newPhone),newVerifyCode:this.newVerifyCode}},t}(B),vo=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),mo=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-password",e.verifyCode="",e.newPassword="",e.provider=0,e}return N(t,o),t.prototype.getProvider=function(){return this.provider},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setNewPassword=function(e){this.newPassword=e},t.prototype.setNewverifyCode=function(e){this.verifyCode=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{provider:this.provider,verifyCode:this.verifyCode,newPassword:this.newPassword}},t}(B),So=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),Ve=function(){function o(t){this.instance=t||_.instance(),this.authBackend=new Nt(this.instance),this.storedUserManager=new dt(this.instance),this.user=new Et(this.instance.name())}return o.prototype.getUser=function(){return this.user},o.prototype.isAnonymous=function(){return this.user.anonymous},o.prototype.getUid=function(){return this.user.uid},o.prototype.getEmail=function(){return this.user.email},o.prototype.getPhone=function(){return this.user.phone},o.prototype.getDisplayName=function(){return this.user.displayName},o.prototype.getPhotoUrl=function(){return this.user.photoUrl},o.prototype.getProviderId=function(){return this.user.providerId},o.prototype.getProviderInfo=function(){for(var t=new Array,e=0;e<this.user.providerService.getProviderInfo().length;e++){for(var n=new Map,r=Object.keys(this.user.providerService.getProviderInfo()[e]),i=0;r&&i<r.length;i++)n.set(r[i],this.user.providerService.getProviderInfo()[e][r[i]]);t.push(n)}return t},o.prototype.getUserExtra=function(){return A(this,void 0,void 0,function(){var t,e,n,r=this;return k(this,function(i){switch(i.label){case 0:return t=null,e="",n=this,[4,this.storedUserManager.getStoredUser().then(function(s){return A(r,void 0,void 0,function(){var a,u;return k(this,function(l){switch(l.label){case 0:return s?(e=s.tokenService.accessToken)==""?[3,3]:(a=new to,u=new no,a.setAccessToken(e),a.setAGCInstance(n.instance),[4,n.authBackend.get(a,u)]):[3,3];case 1:return l.sent(),u.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(u.getRet()))]:(n.user.displayName=u.displayName,n.user.photoUrl=u.photoUrl,n.user.emailVerified=u.emailVerified,n.user.passwordSetted=u.passwordSetted,n.user.email=u.email,n.user.phone=u.phone,n.user.displayName=u.displayName,t=u.userExtra,[4,n.storedUserManager.updateStoredUser(n)]);case 2:return l.sent(),[2,Promise.resolve()];case 3:return[2]}})})}).catch(function(s){return s instanceof C?Promise.reject(s):Promise.reject(new w(R.FAIL_TO_GET_USER_EXTRA,s))})];case 1:return i.sent(),[2,Promise.resolve(t)]}})})},o.prototype.getAccessToken=function(){return this.user.tokenService.getAccessToken()},o.prototype.getRefreshToken=function(){return this.user.tokenService.getRefreshToken()},o.prototype.buildUser=function(t){this.user.anonymous=!1,this.user.uid=t.getUserInfo().getUid(),this.user.displayName=t.getUserInfo().getDisplayName(),this.user.photoUrl=t.getUserInfo().getPhotoUrl(),this.user.email=t.getUserInfo().getEmail(),this.user.emailVerified=t.getUserInfo().getEmailVerified(),this.user.passwordSetted=t.getUserInfo().getPasswordSetted(),this.user.phone=t.getUserInfo().getPhone(),this.user.providerId=t.getUserInfo().getProvider().toString(),this.user.tokenService.constructeSecureTokenService(t.getAccessToken(),t.getRefreshToken()),this.user.providerService.setProviderInfo(t.getProviders())},o.prototype.getToken=function(t){return this.user.tokenService.fetchAccessToken(t).then(function(e){return Promise.resolve(new oo(e.tokenString,e.expiration))}).catch(function(e){return e instanceof C?Promise.reject(e):Promise.reject(new w(R.FAIL_TO_GET_ACCESS_TOKEN,e))})},o.prototype.getEmailVerified=function(){return this.user.emailVerified},o.prototype.getPasswordSetted=function(){return this.user.passwordSetted},o.prototype.link=function(t){return A(this,void 0,void 0,function(){var e,n,r,i=this;return k(this,function(s){switch(s.label){case 0:if(!t)return[2,Promise.reject(new w(R.USER_LINK_FAILED,{message:"credential cannot be null or undefined"}))];if(e=new io,t instanceof Oe)t.prepareUserLinkRequest(e);else{if(!(t instanceof et))return[2,Promise.reject(new w(R.USER_LINK_FAILED,{message:"credential type error"}))];t.prepareUserLinkRequest(e)}return t instanceof bn&&((n=JSON.parse(e.getExtraData())).appId=this.instance.config().client.app_id,n.cpId=this.instance.config().client.cp_id,e.setExtraData(JSON.stringify(n))),r=this,[4,this.getToken(!1).then(function(a){return A(i,void 0,void 0,function(){var u,l,c,d,y,T;return k(this,function(S){switch(S.label){case 0:return e.setAccessToken(a.getToken()),e.setAGCInstance(r.instance),u=new so,[4,r.authBackend.post(e,u)];case 1:return S.sent(),u.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(u.getRet()))]:((l=u.getProviderUserInfo())&&(c={},r.userInfoToMap(l,c),r.user.anonymous&&r.updateAnonymousUserInfo(c),r.user.providerService.updateProvider(c),c.provider&&(d=c.provider,12 .toString()==d?(y=c.email)&&(r.user.email=y,r.user.emailVerified=1):11 .toString()==d&&(T=c.phone)&&(r.user.phone=T),t instanceof et&&t.password!=null&&t.password!=null&&t.password!=""&&(r.user.passwordSetted=1))),[4,r.storedUserManager.updateStoredUser(r)]);case 2:return S.sent(),[2,Promise.resolve()]}})})}).catch(function(a){return a instanceof C?Promise.reject(a):Promise.reject(new w(R.USER_LINK_FAILED,a))})];case 1:return s.sent(),[2,Promise.resolve(new ke(this))]}})})},o.prototype.unlink=function(t){return A(this,void 0,void 0,function(){var e;return k(this,function(n){switch(n.label){case 0:return t?this.user.anonymous?[2,Promise.reject(new w(R.USER_UNLINK_FAILED,{message:"anonymous user can not unlink"}))]:[4,this.sendUnlinkRequest(t).catch(function(r){return r instanceof C?Promise.reject(r):Promise.reject(new w(R.USER_UNLINK_FAILED,r))})]:[2,Promise.reject(new w(R.USER_UNLINK_FAILED,{message:"credentialProvider cannot be null or undefined"}))];case 1:return e=n.sent(),[2,Promise.resolve(e)]}})})},o.prototype.userInfoToMap=function(t,e){t.uid&&(e.uid=t.uid.toString()),t.displayName&&(e.displayName=t.displayName.toString()),t.photoUrl&&(e.photoUrl=t.photoUrl.toString()),t.email&&(e.email=t.email.toString()),t.phone&&(e.phone=t.phone.toString()),t.provider&&(e.provider=t.provider.toString()),t.openId&&(e.openId=t.openId.toString())},o.prototype.updateAnonymousUserInfo=function(t){this.user.anonymous=!1,this.user.displayName=t.displayName?t.displayName:"",this.user.photoUrl=t.photoUrl?t.photoUrl:"",this.user.email=t.email?t.email:"",this.user.phone=t.phone?t.phone:"",this.user.providerId=t.provider?t.provider:""},o.prototype.sendUnlinkRequest=function(t){return A(this,void 0,void 0,function(){var e,n,r;return k(this,function(i){switch(i.label){case 0:return(e=new ao).setProvider(t),[4,this.getToken(!1)];case 1:return n=i.sent(),e.setAccessToken(n.getToken()),e.setAGCInstance(this.instance),r=new uo,[4,this.authBackend.post(e,r)];case 2:return i.sent(),r.getRet().getCode()==0?[3,3]:[2,Promise.reject(w.constructExcpFromRet(r.getRet()))];case 3:return this.user.providerService.deleteProvider(t.toString()),t==12&&(this.user.email="",this.user.emailVerified=0),t==11&&(this.user.phone=""),this.user.providerService.findProviderIndex(12 .toString())==null&&this.user.providerService.findProviderIndex(11 .toString())==null&&(this.user.passwordSetted=0),[4,this.storedUserManager.updateStoredUser(this)];case 4:return i.sent(),[2,Promise.resolve(new ke(this))]}})})},o.prototype.userReauthenticate=function(t){return A(this,void 0,void 0,function(){var e;return k(this,function(n){switch(n.label){case 0:return t?[4,this.getUserReauthWithCredential(t).catch(function(r){return r instanceof C?Promise.reject(r):Promise.reject(new w(R.FAIL_TO_DO_USER_REAUTH,r))})]:[2,Promise.reject(new w(R.FAIL_TO_DO_USER_REAUTH,{message:"credential invalid"}))];case 1:return e=n.sent(),[2,Promise.resolve(e)]}})})},o.prototype.getUserReauthWithCredential=function(t){return A(this,void 0,void 0,function(){var e,n,r;return k(this,function(i){switch(i.label){case 0:return e=new co,[4,this.getToken(!1)];case 1:return n=i.sent(),e.setAccessToken(n.getToken()),t instanceof Oe||t instanceof et?(t.prepareUserReauthRequest(e),e.setAGCInstance(this.instance),r=new po,[4,this.authBackend.post(e,r)]):[2,Promise.reject(new w(R.FAIL_TO_DO_USER_REAUTH,{message:"credential type error"}))];case 2:return i.sent(),r.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(r.getRet()))]:(this.buildUser(r),[4,this.storedUserManager.updateStoredUser(this,1)]);case 3:return i.sent(),[2,Promise.resolve(new ke(this))]}})})},o.prototype.updateProfile=function(t){return A(this,void 0,void 0,function(){var e,n,r=this;return k(this,function(i){switch(i.label){case 0:return t.displayName==null||t.displayName==null||t.photoUrl==null||t.photoUrl==null?[3,2]:(e=new fo,n=this,[4,this.getToken(!1).then(function(s){return A(r,void 0,void 0,function(){var a;return k(this,function(u){switch(u.label){case 0:return e.setAccessToken(s.getToken()),e.setDisplayName(t.displayName),e.setPhotoUrl(t.photoUrl),e.setAGCInstance(n.instance),a=new ho,[4,n.authBackend.put(e,a)];case 1:return u.sent(),a.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(a.getRet()))]:(ne.log("updateProfile success."),n.user.displayName=t.displayName,n.user.photoUrl=t.photoUrl,[4,n.storedUserManager.updateStoredUser(n)]);case 2:return u.sent(),[2,Promise.resolve()]}})})}).catch(function(s){return s instanceof C?Promise.reject(s):Promise.reject(new w(R.FAIL_TO_UPDATE_PROFILE,s))})]);case 1:return i.sent(),[3,3];case 2:return[2,Promise.reject(new w(R.FAIL_TO_UPDATE_PROFILE,{message:"displayName or photoUrl can not be null"}))];case 3:return[2,Promise.resolve()]}})})},o.prototype.updateEmail=function(t,e,n){return A(this,void 0,void 0,function(){var r,i,s=this;return k(this,function(a){switch(a.label){case 0:return t?e?((r=new yo).setNewEmail(t),r.setNewVerifyCode(e),r.setLang(n),i=this,[4,this.getToken(!1).then(function(u){return A(s,void 0,void 0,function(){var l;return k(this,function(c){switch(c.label){case 0:return r.setAccessToken(u.getToken()),r.setAGCInstance(i.instance),l=new go,[4,i.authBackend.put(r,l)];case 1:return c.sent(),l.getRet().getCode()!=0?(ne.error("updateEmail fail."),[2,Promise.reject(w.constructExcpFromRet(l.getRet()))]):(ne.log("updateEmail success."),i.user.email=t,i.user.providerService.updateEmail(t),[4,i.storedUserManager.updateStoredUser(i)]);case 2:return c.sent(),[2,Promise.resolve()]}})})}).catch(function(u){return u instanceof C?Promise.reject(u):Promise.reject(new w(R.FAIL_TO_UPDATE_EMAIL,u))})]):[2,Promise.reject(new w(R.FAIL_TO_UPDATE_EMAIL,{message:"verifyCode cannot be null or undefined"}))]:[2,Promise.reject(new w(R.FAIL_TO_UPDATE_EMAIL,{message:"newEmail cannot be null or undefined"}))];case 1:return a.sent(),[2]}})})},o.prototype.updatePhone=function(t,e,n,r){return A(this,void 0,void 0,function(){var i,s=this;return k(this,function(a){switch(a.label){case 0:return e?n?(i=this,[4,this.getToken(!1).then(function(u){return A(s,void 0,void 0,function(){var l,c,d;return k(this,function(y){switch(y.label){case 0:return[4,(l=new bo(t,e,n,r)).setAccessToken(u.getToken())];case 1:return y.sent(),l.setAGCInstance(i.instance),c=new vo,[4,i.authBackend.put(l,c)];case 2:return y.sent(),c.getRet().getCode()!=0?(ne.error("updatePhone fail."),[2,Promise.reject(w.constructExcpFromRet(c.getRet()))]):(ne.log("updatePhone success."),d=lt.combinatePhone(t,e),i.user.phone=d,i.user.providerService.updatePhone(d),[4,i.storedUserManager.updateStoredUser(i)]);case 3:return y.sent(),[2,Promise.resolve()]}})})}).catch(function(u){return u instanceof C?Promise.reject(u):Promise.reject(new w(R.FAIL_TO_UPDATE_PHONE,u))})]):[2,Promise.reject(new w(R.FAIL_TO_UPDATE_PHONE,{message:"verifyCode cannot be null or undefined"}))]:[2,Promise.reject(new w(R.FAIL_TO_UPDATE_PHONE,{message:"newPhone cannot be null or undefined"}))];case 1:return a.sent(),[2]}})})},o.prototype.updatePassword=function(t,e,n){return A(this,void 0,void 0,function(){var r,i=this;return k(this,function(s){switch(s.label){case 0:return t?(r=this,[4,this.getToken(!1).then(function(a){return A(i,void 0,void 0,function(){var u,l;return k(this,function(c){switch(c.label){case 0:return(u=new mo).setProvider(n),u.setNewPassword(t),u.setNewverifyCode(e),u.setAccessToken(a.getToken()),u.setAGCInstance(r.instance),l=new So,[4,r.authBackend.put(u,l)];case 1:return c.sent(),l.getRet().getCode()!=0?(ne.error("updatePassword fail."),[2,Promise.reject(w.constructExcpFromRet(l.getRet()))]):r.user.passwordSetted!=0?[3,3]:(r.user.passwordSetted=1,[4,r.storedUserManager.updateStoredUser(r)]);case 2:c.sent(),c.label=3;case 3:return ne.log("updatePassword success."),[2,Promise.resolve()]}})})}).catch(function(a){return a instanceof C?Promise.reject(a):Promise.reject(new w(R.FAIL_TO_UPDATE_PASSWORD,a))})]):[2,Promise.reject(new w(R.FAIL_TO_UPDATE_PASSWORD,{message:"newPassword cannot be null or undefined"}))];case 1:return s.sent(),[2]}})})},o}();(function(o){o[o.POST=0]="POST",o[o.GET=1]="GET",o[o.PUT=2]="PUT"})(Le||(Le={}));var Vt,qt,Un,Mn,Nt=function(){function o(t){this.instance=t||_.instance(),this.storedUserManager=new dt(this.instance)}return o.prototype.getClientToken=function(t){return A(this,void 0,void 0,function(){var e,n;return k(this,function(r){switch(r.label){case 0:return(e=this.instance.getService("CredentialsService"))?(n="",[4,e.getToken(t).then(function(i){n=i.tokenString})]):[2,Promise.reject(new w(R.FAIL_TO_GET_CREDENTIAL_SERVICE))];case 1:return r.sent(),[2,Promise.resolve(n)]}})})},o.prototype.post=function(t,e){return A(this,void 0,void 0,function(){var n,r,i;return k(this,function(s){switch(s.label){case 0:return n=t.getHeader(),r=n,i="Bearer ",[4,this.getClientToken()];case 1:return r.Authorization=i+s.sent(),[2,this.sendRequest(t,Le.POST,e,n,!0,!0)]}})})},o.prototype.get=function(t,e){return A(this,void 0,void 0,function(){var n,r,i;return k(this,function(s){switch(s.label){case 0:return n=t.getHeader(),r=n,i="Bearer ",[4,this.getClientToken()];case 1:return r.Authorization=i+s.sent(),[2,this.sendRequest(t,Le.GET,e,n,!0,!0)]}})})},o.prototype.put=function(t,e){return A(this,void 0,void 0,function(){var n,r,i;return k(this,function(s){switch(s.label){case 0:return n=t.getHeader(),r=n,i="Bearer ",[4,this.getClientToken()];case 1:return r.Authorization=i+s.sent(),[2,this.sendRequest(t,Le.PUT,e,n,!0,!0)]}})})},o.prototype.sendRequest=function(t,e,n,r,i,s){return A(this,void 0,void 0,function(){var a=this;return k(this,function(u){switch(u.label){case 0:return[4,this.doNetworkOption(e,t,r,n).catch(function(l){return A(a,void 0,void 0,function(){var c,d,y,T,S;return k(this,function(O){switch(O.label){case 0:return l instanceof C?[2,Promise.reject(l)]:this.checkIsTokenError(l)?(c=l.response.data.ret.code)==o.CLIENT_TOKEN_EXPIRED&&i?(d=this.instance.getService("CredentialsService"))?[4,d.removeToken()]:[2,Promise.reject(new w(R.FAIL_TO_GET_CREDENTIAL_SERVICE))]:[3,3]:[3,8];case 1:return O.sent(),y=r,T="Bearer ",[4,this.getClientToken(!0)];case 2:return y.Authorization=T+O.sent(),n.setRet(new Je),[2,this.sendRequest(t,e,n,r,!1,s)];case 3:return c==o.ACCESS_TOKEN_EXPIRED&&s?(S=new Ve(this.instance),[4,this.storedUserManager.getStoredUser().then(function(P){return P==null?Promise.reject(new w(R.NOT_SIGN_IN)):(S.getUser().constructUser(P),Promise.resolve())})]):[3,6];case 4:return O.sent(),[4,S.getToken(!0).then(function(P){r.access_token=P.getToken()})];case 5:return O.sent(),n.setRet(new Je),[2,this.sendRequest(t,e,n,r,i,!1)];case 6:return[2,Promise.reject(l)];case 7:return[3,9];case 8:return[2,Promise.reject(l)];case 9:return[2]}})})})];case 1:return[2,u.sent()]}})})},o.prototype.doNetworkOption=function(t,e,n,r){return A(this,void 0,void 0,function(){var i;return k(this,function(s){switch(s.label){case 0:return(i=this.instance.getService("AGCNetworkService"))?t!=Le.POST?[3,2]:[4,i.post(e.getUrl(),e.getBody(),n).then(function(a){a.data.ret.code==0&&r.constructResponse(a),r.setRet(new Je(a.data.ret.code,a.data.ret.msg))}).catch(function(a){return Promise.reject(a)})]:[2,Promise.reject(new w(R.FAIL_TO_GET_NETWORK_SERVICE))];case 1:return s.sent(),[3,6];case 2:return t!=Le.PUT?[3,4]:[4,i.put(e.getUrl(),e.getBody(),n).then(function(a){a.data.ret.code==0&&r.constructResponse(a),r.setRet(new Je(a.data.ret.code,a.data.ret.msg))}).catch(function(a){return Promise.reject(a)})];case 3:return s.sent(),[3,6];case 4:return[4,i.get(e.getUrl(),e.getBody(),n).then(function(a){a.data.ret.code==0&&r.constructResponse(a),r.setRet(new Je(a.data.ret.code,a.data.ret.msg))}).catch(function(a){return Promise.reject(a)})];case 5:s.sent(),s.label=6;case 6:return[2,Promise.resolve()]}})})},o.prototype.checkIsTokenError=function(t){return!!(t.response&&t.response.status===401&&t.response.data&&t.response.data.ret&&t.response.data.ret.code!=null)},o.CLIENT_TOKEN_EXPIRED=205524993,o.ACCESS_TOKEN_EXPIRED=205524994,o}(),To=function(){function o(){this.TIME_EARLY=3e5,this.accessToken="",this.accessTokenValidPeriod=-1,this.refreshToken="",this.validTime=-1,this.instanceName=ct}return o.prototype.constructeSecureTokenService=function(t,e){this.accessToken=t.getToken(),this.accessTokenValidPeriod=t.getValidPeriod(),this.refreshToken=e.getToken(),this.validTime=new Date().getTime()+1e3*t.getValidPeriod()},o.prototype.getAccessToken=function(){return this.accessToken},o.prototype.getRefreshToken=function(){return this.refreshToken},o.prototype.isValidAccessToken=function(){return this.accessToken!=null&&this.remainToRefreshTime()>0},o.prototype.remainToRefreshTime=function(){return this.validTime-new Date().getTime()-this.TIME_EARLY},o.prototype.fetchAccessToken=function(t){return A(this,void 0,void 0,function(){var e,n,r,i,s=this;return k(this,function(a){switch(a.label){case 0:return!t&&this.isValidAccessToken()?[2,Promise.resolve(new on(this.accessTokenValidPeriod,"0","0",this.accessToken))]:this.accessToken&&this.refreshToken?((e=new Zr(this.refreshToken,1)).setAGCInstance(_.instance(this.instanceName)),n=new eo,[4,new Nt(_.instance(this.instanceName)).post(e,n)]):[2,Promise.reject(new w(R.NULL_TOKEN))];case 1:return a.sent(),n.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(n.getRet()))]:!(r=n.accessToken)||r.getToken()==this.accessToken&&r.getValidPeriod()==this.accessTokenValidPeriod?[3,3]:(this.accessToken=r.getToken(),this.accessTokenValidPeriod=r.getValidPeriod(),this.validTime=new Date().getTime()+1e3*this.accessTokenValidPeriod,[4,(i=new dt(_.instance(this.instanceName))).getStoredUser().then(function(u){return A(s,void 0,void 0,function(){return k(this,function(l){switch(l.label){case 0:return u&&(u.tokenService.accessToken=this.accessToken,u.tokenService.accessTokenValidPeriod=this.accessTokenValidPeriod,u.tokenService.refreshToken=this.refreshToken,u.tokenService.validTime=this.validTime),[4,i.updateUserInfo(u)];case 1:return l.sent(),[2]}})})})]);case 2:a.sent(),a.label=3;case 3:return[2,Promise.resolve(new on(this.accessTokenValidPeriod,"0","0",this.accessToken))]}})})},o}(),Et=function(){function o(t){this.anonymous=!1,this.uid="",this.displayName="",this.photoUrl="",this.email="",this.phone="",this.providerId="",this.emailVerified=0,this.passwordSetted=0,this.providerService=new Xr,this.tokenService=new To,this.tokenService.instanceName=t}return o.prototype.constructUser=function(t){this.anonymous=t.anonymous,this.uid=t.uid,this.displayName=t.displayName,this.photoUrl=t.photoUrl,this.email=t.email,this.phone=t.phone,this.providerId=t.providerId,this.emailVerified=t.emailVerified,this.passwordSetted=t.passwordSetted,this.providerService.setProviderInfo(t.providerService.providerInfo),this.tokenService.accessToken=t.tokenService.accessToken,this.tokenService.accessTokenValidPeriod=t.tokenService.accessTokenValidPeriod,this.tokenService.refreshToken=t.tokenService.refreshToken,this.tokenService.validTime=t.tokenService.validTime},o}(),sn=function(){function o(){this.lastNotifiedToken="DEFAULT",this.tokenListeners=new Array}return o.prototype.ListenerManager=function(){},o.getInstance=function(t){return this.instanceMap.has(t)||this.instanceMap.set(t,new o),this.instanceMap.get(t)},o.prototype.removeTokenListener=function(t){if(t){for(var e=0;e<this.tokenListeners.length;e++)if(this.tokenListeners[e]===t)return void this.tokenListeners.splice(e,1)}},o.prototype.addTokenListener=function(t){if(!t)throw new w(R.ILLEGAL_TOKEN_LISTENER,{message:"listener cannot be null"});if(!(t.onChanged&&t.onChanged instanceof Function))throw new w(R.ILLEGAL_TOKEN_LISTENER,{message:"listener must have onChanged method"});this.tokenListeners.push(t)},o.prototype.postNotification=function(t,e){if(!(e!=null&&e==this.lastNotifiedToken||e==null&&this.lastNotifiedToken==null)){this.lastNotifiedToken=e;var n=new on(0,"0","0",e);n.state=t,this.tokenListeners.forEach(function(r){r.onChanged(n)})}},o.instanceMap=new Map,o}(),dt=function(){function o(t){this.user=null,this.agcConfig=null,this.instance=t||_.instance()}return o.prototype.getStoredUser=function(){return A(this,void 0,void 0,function(){return k(this,function(t){switch(t.label){case 0:return[4,this.loadStoredUser()];case 1:return t.sent(),[2,Promise.resolve(this.user)]}})})},o.prototype.updateUserInfo=function(t){return A(this,void 0,void 0,function(){return k(this,function(e){switch(e.label){case 0:return t?(this.user||(this.user=new Et(this.instance.name())),this.user.constructUser(t)):this.user=null,[4,this.saveCurrentUser()];case 1:return e.sent(),[2]}})})},o.prototype.updateStoredUser=function(t,e){return A(this,void 0,void 0,function(){var n;return k(this,function(r){switch(r.label){case 0:return[4,this.updateUserInfo(t?t.getUser():null)];case 1:return r.sent(),e!=null&&e!=null&&(n=t!=null?t.getAccessToken():null,sn.getInstance(this.instance.name()).postNotification(e,n)),[2]}})})},o.prototype.loadStoredUser=function(){return A(this,void 0,void 0,function(){var t,e=this;return k(this,function(n){switch(n.label){case 0:return(t=Dn.getInstance().getStorage(this.instance))==null?[2,Promise.reject(new w(R.FAIL_TO_GET_STORAGE_SERVICE))]:[4,t.get(this.getUserKey()).then(function(r){r!=null&&r!=null&&r!=""?(e.user==null&&(e.user=new Et(e.instance.name())),e.user.constructUser(JSON.parse(r))):e.user=null})];case 1:return n.sent(),[2,Promise.resolve()]}})})},o.prototype.saveCurrentUser=function(){return A(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return(t=Dn.getInstance().getStorage(this.instance))==null?[2,Promise.reject(new w(R.FAIL_TO_GET_STORAGE_SERVICE))]:this.user!=null?[3,2]:[4,t.remove(this.getUserKey())];case 1:return e.sent(),[3,4];case 2:return[4,t.set(this.getUserKey(),JSON.stringify(this.user))];case 3:e.sent(),e.label=4;case 4:return[2]}})})},o.prototype.getUserKey=function(){return this.agcConfig==null&&(this.agcConfig=this.instance.config()),"agcCurrentUser_"+this.instance.name()+":"+this.agcConfig.client.client_id},o}(),Io=function(o){function t(e,n,r,i){var s=o.call(this)||this;return s.URL=B.SERVER_URL+"/user-signin-anonymous",s.useJwt=0,s.provider=e,s.token=n,s.extraData=r,s.useJwt=i,s}return N(t,o),t.prototype.getBody=function(){return{provider:0,token:this.token,extraData:"",useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),wo=function(o){function t(){var e=o.call(this)||this;return e.accessToken=new it,e.refreshToken=new it,e.uid="",e}return N(t,o),t.prototype.constructResponse=function(e){this.uid=e.data.uid,this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.refreshToken.setToken(e.data.refreshToken.token),this.refreshToken.setValidPeriod(e.data.refreshToken.validPeriod),this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t.prototype.getUid=function(){return this.uid},t.prototype.getAccessToken=function(){return this.accessToken},t.prototype.getRefreshToken=function(){return this.refreshToken},t}(ce),Eo=function(o){function t(e,n,r){var i=o.call(this)||this;return i.URL=B.SERVER_URL+"/reset-password",i.email=e,i.newPassword=n,i.verifyCode=r,i}return N(t,o),t.prototype.getBody=function(){return{account:this.email,password:this.newPassword,verifyCode:this.verifyCode,provider:12}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(nt),Ro=function(o){function t(e,n,r,i){var s=o.call(this)||this;return s.URL=B.SERVER_URL+"/reset-password",s.countryCode=e,s.phoneNumber=n,s.newPassword=r,s.verifyCode=i,s}return N(t,o),t.prototype.getBody=function(){var e=this.phoneNumber;return this.countryCode&&(e=this.countryCode.startsWith("+")?this.countryCode+"-"+this.phoneNumber:"+"+this.countryCode+"-"+this.phoneNumber),{account:e,password:this.newPassword,verifyCode:this.verifyCode,provider:11}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(nt),Oo=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),Co=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),Po=function(o){function t(e,n){var r=o.call(this)||this;return r.URL=B.SERVER_URL+"/user-signout",r.bodyAccessToken=e,r.refreshToken=n,r}return N(t,o),t.prototype.getBody=function(){return{refreshToken:this.refreshToken,accessToken:this.bodyAccessToken}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(nt),jn=function(o){function t(){return o!==null&&o.apply(this,arguments)||this}return N(t,o),t}(ce),_o=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-delete",e}return N(t,o),t.prototype.getBody=function(){return""},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(nt),xn=function(o){function t(e,n,r,i,s){var a=o.call(this)||this;return a.URL=B.SERVER_URL+"/user-register",a.provider=-1,a.useJwt=0,a.email=e,a.phone=n,a.password=r,a.verifyCode=i,a.useJwt=s,a}return N(t,o),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setPhone=function(e){this.phone=e},t.prototype.setEmail=function(e){this.email=e},t.prototype.setVerifyCode=function(e){this.verifyCode=e},t.prototype.setPassword=function(e){this.password=e},t.prototype.getBody=function(){return{phone:this.phone,provider:this.provider,email:this.email,password:this.password,verifyCode:this.verifyCode,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),Ao=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/user-signin",e.provider=-1,e.token="",e.extraData="",e.autoCreateUser=-1,e.useJwt=0,e}return N(t,o),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.getExtraData=function(){return this.extraData},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.setAutoCreateUser=function(e){this.autoCreateUser=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,autoCreateUser:this.autoCreateUser,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),ko=function(){function o(t,e){this.shortestInterval=t,this.validityPeriod=e}return o.prototype.getShortestInterval=function(){return this.shortestInterval},o.prototype.getValidityPeriod=function(){return this.validityPeriod},o}(),No=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.URL=B.SERVER_URL+"/verify-code",e.phone="",e.email="",e.action=-1,e.lang="",e.sendInterval=-1,e}return N(t,o),t.prototype.setPhone=function(e){this.phone=e},t.prototype.setEmail=function(e){this.email=e},t.prototype.setAction=function(e){this.action=e},t.prototype.setLang=function(e){this.lang=e},t.prototype.setSendInterval=function(e){this.sendInterval=e},t.prototype.getBody=function(){return{phone:this.phone,email:this.email,lang:this.lang,action:this.action,sendInterval:this.sendInterval}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(B),Do=function(o){function t(){var e=o!==null&&o.apply(this,arguments)||this;return e.shortestInterval="",e.validityPeriod="",e}return N(t,o),t.prototype.constructResponse=function(e){this.shortestInterval=e.data.shortestInterval,this.validityPeriod=e.data.validityPeriod,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t.prototype.getShortestInterval=function(){return this.shortestInterval},t.prototype.setShortestInterval=function(e){this.shortestInterval=e},t.prototype.getValidityPeriod=function(){return this.validityPeriod},t.prototype.setValidityPeriod=function(e){this.validityPeriod=e},t}(ce),vn=function(){function o(t){this.instance=t||_.instance(),this.authBackend=new Nt(this.instance)}return o.prototype.requestEmailVerifyCode=function(t,e){var n=this.buildRequest(t,"",e);return n.setAGCInstance(this.instance),this.requestVerifyCode(n)},o.prototype.requestPhoneVerifyCode=function(t,e,n){var r=lt.combinatePhone(t,e),i=this.buildRequest("",r,n);return i.setAGCInstance(this.instance),this.requestVerifyCode(i)},o.prototype.requestVerifyCode=function(t){return A(this,void 0,void 0,function(){var e;return k(this,function(n){switch(n.label){case 0:return e=new Do,[4,this.authBackend.post(t,e).catch(function(r){return r instanceof C?Promise.reject(r):Promise.reject(new w(R.FAIL_TO_GET_VERIFY_CODE,r))})];case 1:return n.sent(),e.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(e.getRet()))]:[2,Promise.resolve(new ko(e.getShortestInterval(),e.getValidityPeriod()))]}})})},o.prototype.buildRequest=function(t,e,n){if(!n)throw new w(R.FAIL_TO_GET_VERIFY_CODE,{message:"invalid verifyCodeSettings"});var r=new No;return r.setEmail(t),r.setPhone(e),r.setAction(n.getAction()),r.setLang(n.getLang()),r.setSendInterval(n.getSendInterval()),r},o}(),Rt=function(){function o(t,e,n){this.action=t,this.lang=e,this.sendInterval=n}return o.prototype.getAction=function(){return this.action},o.prototype.getLang=function(){return this.lang},o.prototype.getSendInterval=function(){return this.sendInterval},o.prototype.setAction=function(t){this.action=t},o.prototype.setLang=function(t){this.lang=t},o.prototype.setSendInterval=function(t){this.sendInterval=t},o}(),ne=Ee.createLogger("auth"),Uo=function(){function o(t){this.persistence=2,this.cryptImpl=void 0,this.identifier=t,this.authBackend=new Nt(_.instance(this.identifier)),this.storedUserManager=new dt(_.instance(this.identifier)),this.verifyCodeRequestService=new vn(_.instance(this.identifier))}return o.prototype.createEmailUser=function(t){return A(this,void 0,void 0,function(){var e,n=this;return k(this,function(r){return e=this,[2,this.getCurrentUser().then(function(i){return A(n,void 0,void 0,function(){var s,a,u;return k(this,function(l){switch(l.label){case 0:return i&&!i.isAnonymous()?[2,Promise.reject(new w(R.ALREADY_SIGN_IN_USER))]:t?(t.verifyEmailUser(!1),(s=new xn(t.email,"",t.password,t.verifyCode,1)).setProvider(12),s.setAGCInstance(_.instance(e.identifier)),a=new wt,[4,e.authBackend.post(s,a)]):[2,Promise.reject(new w(R.INVALID_EMAIL))];case 1:return l.sent(),a.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(a.getRet()))]:((u=new Ve(_.instance(e.identifier))).buildUser(a),[4,e.storedUserManager.updateStoredUser(u,0)]);case 2:return l.sent(),[2,Promise.resolve(new ke(u))]}})})}).catch(function(i){return i instanceof C?Promise.reject(i):Promise.reject(new w(R.FAIL_TO_CREAT_EMAIL_USER,i))})]})})},o.prototype.createPhoneUser=function(t){return A(this,void 0,void 0,function(){var e,n=this;return k(this,function(r){return e=this,[2,this.getCurrentUser().then(function(i){return A(n,void 0,void 0,function(){var s,a,u;return k(this,function(l){switch(l.label){case 0:return i&&!i.isAnonymous()?[2,Promise.reject(new w(R.ALREADY_SIGN_IN_USER))]:t?(t.verifyPhoneUser(!1),(s=new xn("",t.getPhone(),t.password,t.verifyCode,1)).setProvider(11),s.setAGCInstance(_.instance(e.identifier)),a=new wt,[4,e.authBackend.post(s,a)]):[2,Promise.reject(new w(R.INVALID_PHONE))];case 1:return l.sent(),a.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(a.getRet()))]:((u=new Ve(_.instance(e.identifier))).buildUser(a),[4,e.storedUserManager.updateStoredUser(u,0)]);case 2:return l.sent(),[2,Promise.resolve(new ke(u))]}})})}).catch(function(i){return i instanceof C?Promise.reject(i):Promise.reject(new w(R.FAIL_TO_CREAT_PHONE_USER,i))})]})})},o.prototype.signIn=function(t){return A(this,void 0,void 0,function(){var e,n=this;return k(this,function(r){return t?(e=this,[2,this.getCurrentUser().then(function(i){return A(n,void 0,void 0,function(){var s;return k(this,function(a){switch(a.label){case 0:return i&&!i.isAnonymous()?[2,Promise.reject(new w(R.ALREADY_SIGN_IN_USER))]:[4,e.getUserWithCredential(t)];case 1:return s=a.sent(),[2,Promise.resolve(s)]}})})}).catch(function(i){return i instanceof C?Promise.reject(i):Promise.reject(new w(R.SIGN_IN_FAILED,i))})]):[2,Promise.reject(new w(R.SIGN_IN_FAILED,{message:"credential invalid"}))]})})},o.prototype.getUserWithCredential=function(t){return A(this,void 0,void 0,function(){var e,n,r,i;return k(this,function(s){switch(s.label){case 0:if(e=new Ao,t instanceof Oe)t.prepareUserAuthRequest(e),e.setAutoCreateUser(t.autoCreateUser?1:0);else{if(!(t instanceof et))return[2,Promise.reject(new w(R.SIGN_IN_FAILED,{message:"credential type error"}))];t.prepareUserAuthRequest(e)}return t instanceof bn&&((n=JSON.parse(e.getExtraData())).appId=_.instance(this.identifier).config().client.app_id,n.cpId=_.instance(this.identifier).config().client.cp_id,e.setExtraData(JSON.stringify(n))),e.setUseJwt(1),e.setAGCInstance(_.instance(this.identifier)),r=new wt,[4,this.authBackend.post(e,r)];case 1:return s.sent(),r.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(r.getRet()))]:((i=new Ve(_.instance(this.identifier))).buildUser(r),[4,this.storedUserManager.updateStoredUser(i,0)]);case 2:return s.sent(),[2,Promise.resolve(new ke(i))]}})})},o.prototype.deleteUser=function(){return A(this,void 0,void 0,function(){var t;return k(this,function(e){return t=this,[2,this.getCurrentUser().then(function(n){return A(this,void 0,void 0,function(){var r,i,s;return k(this,function(a){switch(a.label){case 0:return n==null?[3,3]:(r=n,i=new _o,s=new jn,i.setAccessToken(r.getAccessToken()),i.setAGCInstance(_.instance(t.identifier)),[4,t.authBackend.post(i,s)]);case 1:return a.sent(),s.getRet().getCode()!=0?(ne.error("deleteUser fail."),[2,Promise.reject(w.constructExcpFromRet(s.getRet()))]):[4,t.storedUserManager.updateStoredUser(null,3)];case 2:return a.sent(),ne.log("deleteUser success."),[2,Promise.resolve()];case 3:return ne.error("deleteUser fail, no user signed in."),[2,Promise.reject(new w(R.DELETE_USER_FAILED,{message:"no user signed in"}))]}})})}).catch(function(n){return n instanceof C?Promise.reject(n):Promise.reject(new w(R.DELETE_USER_FAILED,n))})]})})},o.prototype.signOut=function(){return A(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return t=this,[4,this.getCurrentUser().then(function(n){return A(this,void 0,void 0,function(){var r,i,s;return k(this,function(a){switch(a.label){case 0:return n==null?[3,2]:((i=new Po((r=n).getAccessToken(),r.getRefreshToken())).setAGCInstance(_.instance(t.identifier)),s=new jn,t.authBackend.post(i,s).catch(function(u){ne.warn("signOut request fail.")}),[4,t.storedUserManager.updateStoredUser(null,3)]);case 1:return a.sent(),[2,Promise.resolve()];case 2:return[2]}})})}).catch(function(n){return n instanceof C?Promise.reject(n):Promise.reject(new w(R.SIGN_OUT_FAILED,n))})];case 1:return e.sent(),[2]}})})},o.prototype.getCurrentUser=function(){return A(this,void 0,void 0,function(){var t;return k(this,function(e){return t=this,[2,this.storedUserManager.getStoredUser().then(function(n){if(n){var r=new Ve(_.instance(t.identifier));return r.getUser().constructUser(n),Promise.resolve(r)}return Promise.resolve(null)}).catch(function(n){return n instanceof C?Promise.reject(n):Promise.reject(new w(R.GET_CURRENT_USER_FAILED,n))})]})})},o.prototype.signInAnonymously=function(){var t=this;return this.getCurrentUser().then(function(e){if(e!=null){if(e.isAnonymous()){var n=new ke(e);return Promise.resolve(n)}return Promise.reject(new w(R.ALREADY_SIGN_IN_USER))}return t.getUserWithAnonymously()}).catch(function(e){return e instanceof C?Promise.reject(e):Promise.reject(new w(R.SIGN_IN_ANONYMOUS_FAILED,e))})},o.prototype.getUserWithAnonymously=function(){return A(this,void 0,void 0,function(){var t,e,n,r,i,s;return k(this,function(a){switch(a.label){case 0:return(t=_.instance(this.identifier).getService("ClientInfoService"))==null?[2,Promise.reject(new w(R.FAIL_TO_GET_UTIL_SERVICE))]:(e="",[4,t.getAaid().then(function(u){e=u})]);case 1:return a.sent(),e?((n=new Io(0,e,"",1)).setAGCInstance(_.instance(this.identifier)),r=new wo,[4,this.authBackend.post(n,r)]):[2,Promise.reject(new w(R.SIGN_IN_ANONYMOUS_FAILED,{message:"The aaid is null"}))];case 2:return a.sent(),r.getRet().getCode()!=0?[2,Promise.reject(w.constructExcpFromRet(r.getRet()))]:(i=new Ve(_.instance(this.identifier)),(s=new Et(this.identifier)).uid=r.getUid(),s.providerId=0 .toString(),s.tokenService.constructeSecureTokenService(r.getAccessToken(),r.getRefreshToken()),s.anonymous=!0,i.getUser().constructUser(s),[4,this.storedUserManager.updateStoredUser(i,0)]);case 3:return a.sent(),[2,Promise.resolve(new ke(i))]}})})},o.prototype.requestEmailVerifyCode=function(t,e,n,r){return t?this.verifyCodeRequestService.requestEmailVerifyCode(t,new Rt(e,n,r)):Promise.reject(new w(R.INVALID_EMAIL))},o.prototype.requestPhoneVerifyCode=function(t,e,n,r,i){return e?this.verifyCodeRequestService.requestPhoneVerifyCode(t,e,new Rt(n,r,i)):Promise.reject(new w(R.INVALID_PHONE))},o.prototype.setUserInfoPersistence=function(t){this.persistence=t},o.prototype.getUserInfoPersistence=function(){return this.persistence},o.prototype.setCryptImp=function(t){return t?t.decrypt&&t.decrypt instanceof Function&&t.encrypt&&t.encrypt instanceof Function?(this.cryptImpl=t,!0):(ne.error("the crypt must have decrypt and encrypt method."),!1):(ne.error("the crypt is not available."),!1)},o.prototype.getCryptImp=function(){return this.cryptImpl},o.prototype.addTokenListener=function(t){sn.getInstance(this.identifier).addTokenListener(t)},o.prototype.removeTokenListener=function(t){sn.getInstance(this.identifier).removeTokenListener(t)},o.prototype.resetPasswordByEmail=function(t,e,n){return A(this,void 0,void 0,function(){var r,i,s,a=this;return k(this,function(u){return t?e?n?((r=new Eo(t,e,n)).setAGCInstance(_.instance(this.identifier)),i=new Oo,s=this,[2,this.authBackend.post(r,i).then(function(l){return A(a,void 0,void 0,function(){var c,d;return k(this,function(y){switch(y.label){case 0:return i.getRet().getCode()!=0?(ne.error("failed to reset the password of the email"),[2,Promise.reject(w.constructExcpFromRet(i.getRet()))]):[4,s.getCurrentUser()];case 1:return(c=y.sent())==null?[3,3]:((d=c).getUser().passwordSetted=1,[4,s.storedUserManager.updateStoredUser(d)]);case 2:y.sent(),y.label=3;case 3:return ne.log("success to reset the password of the email"),[2,Promise.resolve()]}})})}).catch(function(l){return l instanceof C?Promise.reject(l):Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_EMAIL,l))})]):[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"verifyCode can not be null or empty"}))]:[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"newPassword can not be null or empty"}))]:[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"email can not be null or empty"}))]})})},o.prototype.resetPasswordByPhone=function(t,e,n,r){return A(this,void 0,void 0,function(){var i,s,a,u=this;return k(this,function(l){return t?e?n?r?((i=new Ro(t,e,n,r)).setAGCInstance(_.instance(this.identifier)),s=new Co,a=this,[2,this.authBackend.post(i,s).then(function(){return A(u,void 0,void 0,function(){var c,d;return k(this,function(y){switch(y.label){case 0:return s.getRet().getCode()!=0?(ne.error("failed to reset the password of the phone"),[2,Promise.reject(w.constructExcpFromRet(s.getRet()))]):[4,a.getCurrentUser()];case 1:return(c=y.sent())==null?[3,3]:((d=c).getUser().passwordSetted=1,[4,a.storedUserManager.updateStoredUser(d)]);case 2:y.sent(),y.label=3;case 3:return ne.log("success to reset the password of the phone"),[2,Promise.resolve()]}})})}).catch(function(c){return c instanceof C?Promise.reject(c):Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_PHONE,c))})]):[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_PHONE,{message:"verifyCode can not be null or empty"}))]:[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_PHONE,{message:"newPassword can not be null or empty"}))]:[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_PHONE,{message:"phoneNumber can not be null or empty"}))]:[2,Promise.reject(new w(R.FAIL_TO_RESET_PASSWORD_PHONE,{message:"countryCode can not be null or empty"}))]})})},o}(),Mo=function(){function o(t,e,n,r){this.countryCode="",this.phoneNumber="",this.password="",this.verifyCode="",this.countryCode=t,this.phoneNumber=e,this.password=n,this.verifyCode=r}return o.prototype.getPhone=function(){return lt.combinatePhone(this.countryCode,this.phoneNumber)},o.prototype.verifyPhoneUser=function(t){if(!this.phoneNumber)throw new w(R.INVALID_PHONE);if(this.password==""&&t)throw new w(R.PASSWORD_IS_EMPTY);if(this.verifyCode=="")throw new w(R.PHONE_VERIFICATION_IS_EMPTY)},o}(),jo=function(){function o(t,e,n){this.email="",this.password="",this.verifyCode="",this.email=t,this.password=e,this.verifyCode=n}return o.prototype.verifyEmailUser=function(t){if(!this.email)throw new w(R.INVALID_EMAIL);if(!this.password&&t)throw new w(R.PASSWORD_IS_EMPTY);if(!this.verifyCode)throw new w(R.EMAIL_VERIFICATION_IS_EMPTY)},o}(),Ln=function(o){function t(e,n,r){var i=o.call(this)||this;return i.email=e,i.password=n,i.verifyCode=r,i}return N(t,o),t.prototype.getProvider=function(){return 12},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData()),e.setUseJwt(1)},t.prototype.generateExtraData=function(){return JSON.stringify({password:this.password,verifyCode:this.verifyCode})},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData())},t}(et),xo=function(){function o(){}return o.credentialWithPassword=function(t,e){return new Ln(t,e,"")},o.credentialWithVerifyCode=function(t,e,n){return new Ln(t,e,n)},o.requestVerifyCode=function(t,e,n,r){return new vn().requestEmailVerifyCode(t,new Rt(e,n,r))},o}(),Vn=function(o){function t(e,n,r,i){var s=o.call(this)||this;return s.countryCode=e,s.phoneNumber=n,s.password=r,s.verifyCode=i,s}return N(t,o),t.prototype.getProvider=function(){return 11},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData()),e.setUseJwt(1)},t.prototype.generateExtraData=function(){return JSON.stringify({password:this.password,verifyCode:this.verifyCode})},t.prototype.getPhone=function(){return lt.combinatePhone(this.countryCode,this.phoneNumber)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData())},t}(et),Lo=function(){function o(){}return o.credentialWithPassword=function(t,e,n){return new Vn(t,e,n,"")},o.credentialWithVerifyCode=function(t,e,n,r){return new Vn(t,e,n,r)},o.requestVerifyCode=function(t,e,n,r,i){return new vn().requestPhoneVerifyCode(t,e,new Rt(n,r,i))},o}(),Vo=function(o){function t(e,n,r){var i=o.call(this)||this;return i.token=e,i.openId=n,i.autoCreateUser=r,i}return N(t,o),t.prototype.getProvider=function(){return 4},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId)},t}(Oe),qo=function(){function o(){}return o.credentialWithToken=function(t,e,n){return n===void 0&&(n=!0),new Vo(t,e,n)},o}(),Ko=function(o){function t(e,n){var r=o.call(this)||this;return r.token=e,r.autoCreateUser=n,r}return N(t,o),t.prototype.getProvider=function(){return 10},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t}(Oe),Bo=function(){function o(){}return o.credentialWithToken=function(t,e){return e===void 0&&(e=!0),new Ko(t,e)},o}(),Fo=function(o){function t(e,n,r){r===void 0&&(r=!0);var i=o.call(this)||this;return i.token=e,i.openId=n,i.autoCreateUser=r,i}return N(t,o),t.prototype.getProvider=function(){return 6},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId)},t}(Oe),Go=function(){function o(){}return o.credentialWithToken=function(t,e,n){return n===void 0&&(n=!0),new Fo(t,e,n)},o}(),zo=function(){function o(t){this.instance=_.instance(),this.instance=t||_.instance(),this.storedUserManager=new dt(this.instance)}return o.prototype.getToken=function(t){return A(this,void 0,void 0,function(){var e,n,r,i;return k(this,function(s){switch(s.label){case 0:return this.instance.getCustomAuthProvider()?[4,this.instance.getCustomAuthProvider().getToken(t)]:[3,2];case 1:return(e=s.sent())&&e.tokenString&&e.expiration?isNaN(Number(e.expiration))||Number(e.expiration)<=0?(ne.error("the customAuthProvider getToken must return valid expiration."),[2,Promise.reject(new w(R.ILLEGAL_CUSTOM_AUTH_PROVIDER,{message:"the customAuthProvider getToken must return valid expiration"}))]):(n=new(function(){function a(){}return a.prototype.getExpirePeriod=function(){return Number(e.expiration)},a.prototype.getToken=function(){return e.tokenString},a}()),[2,Promise.resolve(n)]):(ne.error("the customAuthProvider getToken method must contain return value: tokenString, expiration."),[2,Promise.reject(new w(R.ILLEGAL_CUSTOM_AUTH_PROVIDER,{message:"the customAuthProvider getToken method must contain return value: tokenString, expiration"}))]);case 2:return[4,this.storedUserManager.getStoredUser()];case 3:return(r=s.sent())?((i=new Ve(this.instance)).getUser().constructUser(r),[2,i.getToken(t)]):[2,Promise.resolve(null)]}})})},o}(),Ho=function(o){function t(e,n){var r=o.call(this)||this;return r.token=e,r.autoCreateUser=n,r}return N(t,o),t.prototype.getProvider=function(){return 1},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(1),e.setToken(this.token)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(1),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(1),e.setToken(this.token)},t}(Oe),Yo=function(){function o(){}return o.credentialWithToken=function(t,e){return e===void 0&&(e=!0),new Ho(t,e)},o}(),Qo=function(o){function t(e,n){n===void 0&&(n=!0);var r=o.call(this)||this;return r.authCode=e,r.autoCreateUser=n,r}return N(t,o),t.prototype.getProvider=function(){return 18},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.generateExtraData=function(){return JSON.stringify({authCode:this.authCode})},t.TOKEN="alipay",t}(Oe),Wo=function(){function o(){}return o.credentialWithToken=function(t,e){return e===void 0&&(e=!0),new Qo(t,e)},o}(),$o=function(){function o(){}return o.credentialWithPlayerSign=function(t,e){e===void 0&&(e=!0);var n={};return n.ts=t.signTs,n.playerId=t.playerId,n.playerLevel=t.playerLevel,n.displayName=t.displayName,n.imageUrl=t.imageUrl,new bn(t.playerSign,JSON.stringify(n),e)},o}(),pr=new ir(function(o){return new Uo(o[0])});function Jo(o){return new zo(o)}(function(o){o[o.ACTION_REGISTER_LOGIN=1001]="ACTION_REGISTER_LOGIN",o[o.ACTION_RESET_PASSWORD=1002]="ACTION_RESET_PASSWORD"})(Vt||(Vt={})),function(o){o[o.Anonymous=0]="Anonymous",o[o.HMS_Provider=1]="HMS_Provider",o[o.Facebook_Provider=2]="Facebook_Provider",o[o.Twitter_Provider=3]="Twitter_Provider",o[o.WeiXin_Provider=4]="WeiXin_Provider",o[o.HWGame_Provider=5]="HWGame_Provider",o[o.QQ_Provider=6]="QQ_Provider",o[o.WeiBo_Provider=7]="WeiBo_Provider",o[o.Google_Provider=8]="Google_Provider",o[o.GoogleGame_Provider=9]="GoogleGame_Provider",o[o.SelfBuild_Provider=10]="SelfBuild_Provider",o[o.Phone_Provider=11]="Phone_Provider",o[o.Email_Provider=12]="Email_Provider",o[o.Alipay_Provider=18]="Alipay_Provider"}(qt||(qt={})),Mn={PhoneUser:Mo,EmailUser:jo,EmailAuthProvider:xo,PhoneAuthProvider:Lo,WeixinAuthProvider:qo,SelfBuildAuthProvider:Bo,QQAuthProvider:Go,HwIdAuthProvider:Yo,AlipayAuthProvider:Wo,HwGameAuthProvider:$o,Action:Vt,AGConnectAuthCredentialProvider:qt},(Un=_).registerApiProvider("auth",function(o){return pr.get(o)},Mn),Un.registerInternalService({name:"AuthProviderService",serviceFactory:Jo});var M=function(){function o(t){this.logger=new o.logClazz(t)}return o.setLoggerClazz=function(t){this.logClazz=t},o.prototype.debug=function(t){this.logger.debug(t)},o.prototype.log=function(t){this.logger.log(t)},o.prototype.error=function(t){this.logger.error(t)},o.prototype.warn=function(t){this.logger.warn(t)},o.prototype.info=function(t){this.logger.info(t)},o}(),Xo=function(){function o(t){this.logger=Ee.createLogger(t)}return o.prototype.debug=function(t){this.logger.debug(t)},o.prototype.log=function(t){this.logger.log(t)},o.prototype.error=function(t){this.logger.error(t)},o.prototype.warn=function(t){this.logger.warn(t)},o.prototype.info=function(t){this.logger.info(t)},o}();M.setLoggerClazz(Xo);var rt=function(){function o(){}return o.setCryptoJS=function(t){this.CryptoJS=t},o.getCryptoJS=function(){return this.CryptoJS},o}(),Zo=rrr;rt.setCryptoJS(Zo);/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var fr=function(o,t){return(fr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])})(o,t)};function se(o,t){function e(){this.constructor=o}fr(o,t),o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function b(o,t,e,n){return new(e||(e=Promise))(function(r,i){function s(l){try{u(n.next(l))}catch(c){i(c)}}function a(l){try{u(n.throw(l))}catch(c){i(c)}}function u(l){l.done?r(l.value):new e(function(c){c(l.value)}).then(s,a)}u((n=n.apply(o,t||[])).next())})}function g(o,t){var e,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function a(u){return function(l){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!((r=r.length>0&&r[r.length-1])||c[0]!==6&&c[0]!==2)){s=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(c[0]===6&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(o,s)}catch(d){c=[6,d],n=0}finally{e=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([u,l])}}}function E(o){var t=typeof Symbol=="function"&&o[Symbol.iterator],e=0;return t?t.call(o):{next:function(){return o&&e>=o.length&&(o=void 0),{value:o&&o[e++],done:!o}}}}function fe(o,t){var e=typeof Symbol=="function"&&o[Symbol.iterator];if(!e)return o;var n,r,i=e.call(o),s=[];try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(a){r={error:a}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return s}function Q(){for(var o=[],t=0;t<arguments.length;t++)o=o.concat(fe(arguments[t]));return o}var qn,hr=function(){function o(t,e){this.message=t,this.code=e}return o.prototype.getCode=function(){return this.code},o.prototype.getMessage=function(){return this.message},o}();(function(o){o[o.Ok=0]="Ok",o[o.ResourceExhausted=1]="ResourceExhausted",o[o.Timeout=2]="Timeout",o[o.FailedPrecondition=3]="FailedPrecondition",o[o.PermissionDenied=4]="PermissionDenied",o[o.Unknown=5]="Unknown",o[o.DataSizeOverflow=6]="DataSizeOverflow",o[o.UserKeyIllegality=7]="UserKeyIllegality",o[o.DataEncryptionKeyChanged=8]="DataEncryptionKeyChanged"})(qn||(qn={}));var V,te,ge,Ne,ei=new M("BasicException"),ti=function(){function o(t){this.exceptionCode=0,this.msg="",this.check(t)}return o.prototype.getCode=function(){return this.exceptionCode},o.prototype.check=function(t){o.ErrorMessageMapper.has(t)?(this.exceptionCode=t,this.msg=o.ErrorMessageMapper.get(t)||""):(this.exceptionCode=1,this.msg="",ei.warn("Unknown exception code "+t+"."))},o.prototype.getMsg=function(){return this.msg},o.prototype.toString=function(){return"exceptionCode:"+this.exceptionCode+",msg:"+this.msg},o.ErrorMessageMapper=new Map([[0,""],[1,"internal error."],[4,"CloudDBZone init failed."],[5,"CloudDBZone does not exist."],[6,"the count of CloudDBZone exceeds the limit."],[7,"CloudDBZone is busy."],[8,"please close CloudDBZone first."],[9,"please open CloudDBZone first."],[10,"please remove subscriber first."],[11,"query policy is illegal."],[13,"the count of snapshot exceeds the limit."],[14,"sdk version error."],[15,"permission denied."],[16,"object type does not exist."],[17,"object type info is invalid."],[18,"CloudDBZone config is invalid."],[19,"no data was found in CloudDBZone."],[20,"transfer data is unfinished."],[21,"downgrade object type version is illegal."],[50,"user key is invalid."],[51,"data encryption key is invalid."],[52,"encrypt failed."],[53,"decrypt failed."],[54,"please set user key first."],[1e3,"Connect to server failed."],[1001,"Object type negotiating."],[1002,"Object type negotiation exception."],[1003,"Internal error."],[1004,"Internal error."],[1005,"Connect to server failed."],[1006,"Internal error."],[1007,"Request timeout."],[1008,"Internal error."],[1009,"Internal error."],[1010,"Internal error."],[1011,"Request failed."],[1012,"Get verify info failed."],[1013,"Get verify info failed."],[1014,"Illegal application context."],[1e6,"verify token failed."],[1000001,"permission denied."],[1001e3,"the count of product subscriber exceeds the limit."],[1001001,"the count of client subscriber exceeds the limit."],[1001002,"the count of condition for subscription exceeds the limit."],[1001003,"unsupported subscription condition type."],[1001004,"unsupported subscription field type."],[1001005,"the length of subscription field value exceeds the limit."],[1001006,"the count of transaction record exceeds the limit."],[1001007,'"query %s with pagination from the cloud database failed: %s no such index for query.'],[1001008,"subscription condition objectType contains autoIncrement field."],[1001009,"sensitive fields do not support subscription."],[1002e3,"execution parameter is illegal."],[1002001,"execution parameter is illegal."],[1002002,"execution parameter is illegal."],[1002003,"illegal subscription condition."],[1002004,"internal error."],[1002005,"sensitive field not support this query condition."],[1003e3,"internal error."],[1003001,"internal error."],[1003002,"internal error."],[1004e3,"product arrears."],[1004001,"insufficient read quota."],[1004002,"insufficient write quota."],[1004003,"insufficient delete quota."],[1004004,"insufficient network quota."],[1004005,"insufficient storage quota."],[1004006,"resources are exhausted."],[1004007,"resources are exhausted."],[1004008,"resources are exhausted."],[1004009,"resources are exhausted."],[1004010,"resources are exhausted."],[1004011,"resources are exhausted."],[1004012,"resources are exhausted."],[1005e3,"the system status does not meet the operation execution conditions."],[1005001,"invalid operation argument."],[1005002,"rejected by data re-encrypting."],[1005003,"illegal request."],[1005004,"illegal request."],[1006e3,"object type is empty."],[1006001,"object type is not found."],[1006002,"the count of object type field mismatched."],[1006003,"object type field mismatched."],[1006004,"the type of object type field mismatched."],[1006005,"the null property of object type field mismatched."],[1006006,"the primary key of object type field mismatched."],[1006007,"the default value of object type field mismatched."],[1006008,"the encryption property of object type field mismatched."],[2e6,"system error."],[2001e3,"operation is illegal."],[2001001,"product status is not created."],[2001002,"the count of DB Zones exceeds the limit."],[2001003,"object type is not allowed to delete."],[2001004,"object type is not allowed to modify while import."],[2001005,"the count of object type exceeds the limit."],[2001006,"primary key is not allowed to modify."],[2001007,"the field is not allowed to modify."],[2001008,"the field is not allowed to delete."],[2001009,"the count of field exceeds the limit."],[2001010,"the index is not allowed to modify."],[2001011,"the index is not allowed to delete."],[2001012,"the count of index exceeds the limit."],[2001013,"the count of fields in a index exceeds the limit."],[2001014,"no permission found."],[2001015,"permission denied."],[2001016,"encrypted field does not support this query."],[2001017,"the capacity of objects exceeds the limit."],[2001018,"the size of object list exceeds the limit."],[2001019,"write is prohibited."],[2001020,"the size of the data to be written exceeds the limit."],[2001021,"the size of a string data to be written exceeds the limit."],[2001022,"operation is illegal."],[2001023,"operation is illegal."],[2001024,"user is locked."],[2001025,"user authentication failed."],[2001026,"the service is unavailable currently."],[2001027,"operation is denied while key is updating."],[2001028,"the count of string field exceeds the limit."],[2001040,"read is prohibited."],[2001041,"sensitive field does not support this query."],[2002e3,"invalid parameter."],[2002001,"product id is invalid."],[2002002,"product type is invalid."],[2002003,"store id is invalid."],[2002004,"unsupported operation for object type."],[2002005,"original object type is changed."],[2002006,"object type already exists."],[2002007,"object type does not exist."],[2002008,"object type is duplicate."],[2002009,"object type name is invalid."],[2002010,"no field in the object type."],[2002011,"object type is invalid."],[2002012,"field name is duplicate."],[2002013,"field name is invalid."],[2002014,"field type is invalid."],[2002015,"field value is invalid."],[2002016,"encrypt field type error."],[2002017,"index name is invalid."],[2002018,"index name is duplicate."],[2002019,"field in an index does not exist."],[2002020,"role type is invalid."],[2002021,"index is invalid while query by cursor."],[2002022,"invalid cache-changed message."],[2002023,"invalid input."],[2002024,"default value is absent."],[2002025,"primary key does not set not null."],[2002026,"primary key does not support setting default value."],[2002027,"primary key does not support setting encrypted."],[2002028,"primary key does not support the type."],[2002029,"primary key can not be found."],[2002030,"the count of primary key exceeds the limit."],[2002031,"filed type does not support setting not null."],[2002032,"filed type does not support setting default value."],[2002033,"filed type does not support setting encrypt."],[2002034,"object type does not support modifying concurrently."],[2002035,"field of default value can not set as null."],[2002036,"not null field can not be null."],[2002037,"CloudDBZone does not exist."],[2002046,"primary key does not support setting sensitive."],[2002047,"field type does not support setting sensitive."],[2002048,"the index cannot contain sensitive field."],[2002049,"sensitive field not support increment operation."],[2002050,"schema with sensitive field not support this operation."],[2003e3,"runtime error."],[2003001,"getting usage of the storage failed."],[2003002,"getting size of the storage failed."],[2003003,"creating app failed."],[2003004,"deleting app failed."],[2003005,"creating database failed."],[2003006,"error occurred while checking the existence of a database instance."],[2003007,"occupying node group failed."],[2003008,"freeing node group failed."],[2003009,"querying node information failed."],[2003010,"querying the mapping between products and node groups failed."],[2003011,"querying the products in cluster failed."],[2003012,"querying available clusters failed."],[2003013,"occupying cluster failed."],[2003014,"querying cluster failed."],[2003015,"inserting config of product mapping failed."],[2003016,"error occurred while checking the existence of a DB zone."],[2003017,"creating DB zone failed."],[2003018,"dropping DB zone failed."],[2003019,"initializing system tables failed."],[2003020,"upgrading schema failed."],[2003021,"generating a new schema version failed."],[2003022,"setting permission for schemas failed."],[2003023,"field type error."],[2003024,"creating table failed."],[2003025,"upgrading table failed."],[2003026,"dropping object type failed."],[2003027,"error occurred while checking the existence of a table."],[2003028,"locking table failed."],[2003029,"querying product mapping failed."],[2003030,"upserting product mapping failed."],[2003031,"deleting product mapping failed."],[2003032,"querying product key failed."],[2003033,"inserting product key failed."],[2003034,"deleting product key failed."],[2003035,"querying product status failed."],[2003036,"updating product status failed."],[2003037,"querying all the products failed."],[2003038,"saving product info failed."],[2003039,"deleting product info failed."],[2003040,"querying the mapping between product and DB ID failed."],[2003041,"querying all IDs of the products failed."],[2003042,"generate ID failed."],[2003043,"locking the ID failed."],[2003044,"value type of the ID is incorrect."],[2003045,"updating ID failed."],[2003046,"initializing counter failed."],[2003047,"querying counter failed."],[2003048,"update counter failed."],[2003049,"cached plan changed."],[2003050,"invalid prepared statement."],[2003051,"bind value to statement failed."],[2003052,"value convert failed."],[2003053,"numeric value out of range."],[2003054,"getting DB connection failed."],[2003055,"initializing DB connection failed."],[2003056,"invalid DB connection."],[2003057,"invalid group id for DB."],[2003058,"use database for connection failed."],[2003059,"verifying the config of product mapping failed."],[2003060,"getting config in DB failed."],[2003061,"modifying config in DB failed."],[2003062,"item does not exist in config."],[2003063,"transaction execute failed."],[2003064,"transaction start failed."],[2003065,"transaction commit failed."],[2003066,"transaction rollback failed."],[2003067,"sql execute failed."],[2003068,"querying execute failed."],[2003069,"inserting execute failed."],[2003070,"updating execute failed."],[2003071,"deleting execute failed."],[2003072,"truncating execute failed."],[2003073,"upsert failed."],[2003074,"batch upsert failed."],[2003075,"batch delete failed."],[2003076,"querying by row failed."],[2003077,"upserting by row failed."],[2003078,"deleting by row failed."],[2003079,"extracting data from result set failed."],[2003080,"extracting data from result set failed."],[2003081,"extracting data failed."],[2003082,"extracting version failed."],[2003083,"expected value does not exist."],[2003084,"modifying the database connection limit failed."],[2003085,"unsupported."],[2003086,"querying object type failed."],[2003087,"object type conversion failed."],[2003088,"instance id getting error."],[2003089,"no valid product mapping info."],[2003090,"no free cluster."],[2003091,"group is not empty."],[2003092,"no free node group."],[2003093,"node group has not been allocated."],[2003094,"length of index field exceeds the limit."],[2003095,"querying product info failed."],[2003096,"generate product sequence failed."],[2003097,"violates unique constraint."]]),o}(),h=function(){function o(){}return o.build=function(t){return typeof t=="string"?{message:t}:this.parseException(new ti(t))},o.parseException=function(t){return new hr(t.getMsg(),t.getCode())},o}(),Kt=rt.getCryptoJS(),m=function(){function o(){}return o.isFunction=function(t){return typeof t=="function"},o.isArray=function(t){return typeof Array.isArray=="function"?Array.isArray(t):Object.prototype.toString.call(t)==="[object Array]"},o.isObject=function(t){return Object.prototype.toString.call(t)==="[object Object]"},o.isNotNullObject=function(t){return t!==null&&typeof t=="object"},o.isNullOrUndefined=function(t){return t==null},o.checkNotNull=function(t,e){if(o.isNullOrUndefined(t))throw h.build(e)},o.isClass=function(t){if(o.isFunction(t)){var e=t.prototype;if(!o.isNotNullObject(e))return!1;var n=e.constructor;if(o.isFunction(n))return!0}return!1},o.isErrorObject=function(t){return!!(t instanceof hr||o.isObject(t)&&Object.prototype.hasOwnProperty.call(t,"message")&&Object.getOwnPropertyNames(t).length===1)},o.isArrayBuffer=function(t){if(!t)return!1;var e=Object.prototype.toString.call(t);return e==="[object ArrayBuffer]"||e==="[object Uint8Array]"},o.isEmpty=function(){for(var t,e,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length===0)return!0;try{for(var i=E(n),s=i.next();!s.done;s=i.next()){var a=s.value;if(!a)return!0}}catch(u){t={error:u}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}return!1},o.isValidObject=function(t){return!(!t||typeof t!="object"||t.constructor.name==="Object")},o.isSameObjectType=function(t){var e,n;if(o.checkNotNull(t,"The object list is invalid."),o.isEmptyArray(t))return!0;var r=this.getClassName(t[0]);try{for(var i=E(t),s=i.next();!s.done;s=i.next()){var a=s.value;if(this.getClassName(a)!==r)return!1}}catch(u){e={error:u}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return!0},o.isEmptyArray=function(t){return t.length===0},o.getClassName=function(t){if(o.isNullOrUndefined(t))return t;var e=t;return o.isClass(e)||(e=t.constructor),e.className?e.className:e.name},o.deepCopy=function(t){var e,n,r=[];try{for(var i=E(t),s=i.next();!s.done;s=i.next()){var a=s.value;if(typeof a=="object")if(a.constructor!==Date)if(a.constructor!==RegExp)if(a.clone)r.push(a.clone());else{var u=new a.constructor;for(var l in a)if(Object.hasOwnProperty.call(a,l)){var c=a[l];u[l]=c}r.push(u)}else r.push(new RegExp(a));else r.push(new Date(a));else r.push(a)}}catch(d){e={error:d}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.deepCopyNumber=function(t){var e=new Set;return t.forEach(function(n){e.add(n)}),e},o.hash=function(t){for(var e=""+t,n=5381,r=e.length;r;)n=33*n^e.charCodeAt(--r);return""+(n>>>0)},o.generateUUID=function(){for(var t=new Date().getTime(),e="",n=1;n<15;n+=2)e+="abcdefghijklmnopqrstuvwxyz1234567890".charAt((t>>>n)%36);return e},o.generateTraceId=function(){for(var t="",e=0;e<this.TRACE_ID_LENGTH/this.RANDOM_KEY_LENGTH;e++)t+=this.randomKey();return t},o.randomKey=function(){return((1+this.getSecRandom())*this.RANDOM_VALUE|0).toString(this.HEX).substring(1)},o.getSecRandom=function(){return Math.floor(Math.random()*this.RANDOM_RANGE)/(this.RANDOM_DIVISOR+1)},o.uint8ArrayToString=function(t){return decodeURIComponent(escape(String.fromCharCode.apply(String,Q(t))))},o.stringToUint8Array=function(t){var e=unescape(encodeURIComponent(t)).split("").map(function(n){return n.charCodeAt(0)});return new Uint8Array(e)},o.wordArrayToUint8Array=function(t){for(var e=t.sigBytes,n=t.words,r=new Uint8Array(e),i=0,s=0;i!==e;){var a=n[s++];if(r[i++]=(4278190080&a)>>>24,i===e||(r[i++]=(16711680&a)>>>16,i===e)||(r[i++]=(65280&a)>>>8,i===e))break;r[i++]=255&a}return r},o.uint8ArrayToWordArray=function(t){for(var e=t.length,n=[],r=0;r<e;r++)n[r>>>2]|=(255&t[r])<<24-r%4*8;return Kt.lib.WordArray.create(n,e)},o.encode=function(t){return Kt.enc.Base64.stringify(t)},o.decode=function(t){return Kt.enc.Base64.parse(t)},o.convertArray=function(t){return o.isArray(t)?t:[t]},o.isStringEmpty=function(t){return t==null||t===""},o.checkTraceId=function(t){return this.TRACE_ID_EXP.test(t)},o.TRACE_ID_EXP=/^[0-9a-f]{1,32}$/,o.RANDOM_DIVISOR=4294967295,o.RANDOM_VALUE=65536,o.RANDOM_RANGE=1e9,o.HEX=16,o.TRACE_ID_LENGTH=32,o.RANDOM_KEY_LENGTH=4,o}(),Kn=new Set(["Limit","OrderBy"]),ni=function(){function o(t){this.queryConditions=[],this.clazz=t,this.depth=0}return o.where=function(t){return m.checkNotNull(t,"Entity class must not be null."),new o(t)},o.prototype.addCondition=function(t,e,n){if(this.queryConditions.length>=30)throw h.build("Query type exceeds the limit.");var r={conditionType:t,fieldName:e,value:n};return this.queryConditions.push(r),this},o.prototype.equalTo=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("EqualTo",t,e)},o.prototype.count=function(t){return this.checkFieldValidity(t),this.addCondition("Count",t)},o.prototype.beginsWith=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("BeginWith",t,e)},o.prototype.endsWith=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("EndWith",t,e)},o.prototype.contains=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("Contain",t,e)},o.prototype.notEqualTo=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("NotEqualTo",t,e)},o.prototype.greaterThan=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("GreaterThan",t,e)},o.prototype.greaterThanOrEqualTo=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("GreaterThanOrEqualTo",t,e)},o.prototype.lessThan=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("LessThan",t,e)},o.prototype.lessThanOrEqualTo=function(t,e){return this.checkFieldValidity(t,e),this.addCondition("LessThanOrEqualTo",t,e)},o.prototype.in=function(t,e){if(!m.isArray(e))throw h.build("The values must be array.");return this.checkFieldValidity.apply(this,Q([t],e)),this.addCondition("In",t,e)},o.prototype.isNull=function(t){return this.checkFieldValidity(t),this.addCondition("IsNull",t)},o.prototype.isNotNull=function(t){return this.checkFieldValidity(t),this.addCondition("IsNotNull",t)},o.prototype.orderByAsc=function(t){return this.checkFieldValidity(t),this.isValidCloudDBQuery("OrderBy","ASC"),this.addCondition("OrderBy",t,"ASC")},o.prototype.orderByDesc=function(t){return this.checkFieldValidity(t),this.isValidCloudDBQuery("OrderBy","DESC"),this.addCondition("OrderBy",t,"DESC")},o.prototype.limit=function(t,e){if(typeof t!="number"||Math.floor(t)!==t||t<=0)throw h.build("The Count is invalid.");if(m.isNullOrUndefined(e)&&(e=0),typeof e!="number"||Math.floor(e)!==e||e<0)throw h.build("The Offset is invalid.");return this.isValidCloudDBQuery("Limit"),this.addCondition("Limit",void 0,{offset:e!==void 0?e:0,number:t})},o.prototype.beginGroup=function(){return this.isValidCloudDBQuery("BeginGroup"),this.depth++,this.addCondition("BeginGroup",void 0)},o.prototype.endGroup=function(){return this.isValidCloudDBQuery("EndGroup"),this.depth--,this.addCondition("EndGroup",void 0)},o.prototype.or=function(){return this.isValidCloudDBQuery("Or"),this.addCondition("Or",void 0)},o.prototype.and=function(){return this.isValidCloudDBQuery("And"),this.addCondition("And",void 0)},o.prototype.getClassName=function(){var t;if(this.tableName)return this.tableName;var e=this.clazz.className;return e||((t=this.clazz)===null||t===void 0?void 0:t.name)},o.prototype.getClazz=function(){return this.clazz},o.prototype.getQueryConditions=function(){return this.queryConditions},o.prototype.getDepth=function(){return this.depth},o.prototype.checkFieldValidity=function(t){for(var e,n,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];m.checkNotNull(t,"The field name must not be null.");try{for(var s=E(r),a=s.next();!a.done;a=s.next()){var u=a.value;m.checkNotNull(u,"The value is invalid.")}}catch(l){e={error:l}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}},o.prototype.isValidCloudDBQuery=function(t,e){var n=this.queryConditions.length,r=n===0?null:this.queryConditions[n-1].conditionType;if(Kn.has(t)&&(this.depth!==0||r==="Or"||r==="And"))throw t==="OrderBy"?h.build('near "'+e+'": syntax error.'):h.build('near "'+t+'": syntax error.');if((t==="Or"||t==="And")&&(n===0||r==="BeginGroup"||Kn.has(r)||r==="Or"||r==="And"))throw h.build('near "'+t+'": syntax error.');if(t==="EndGroup"){if(this.depth<=0)throw h.build("The query beginGroup and endGroup should come in pairs with right direction.");if(n===0||r==="BeginGroup"||r==="Or"||r==="And")throw h.build('near "'+t+'": syntax error.')}},o}(),an=function(){function o(t,e,n){this.snapshotObjects=t,this.upsertedObjects=e,this.deletedObjects=n}return o.prototype.getSnapshotObjects=function(){return this.snapshotObjects},o.prototype.setSnapshotObjects=function(t){this.snapshotObjects=t},o.prototype.getUpsertedObjects=function(){return this.upsertedObjects},o.prototype.setUpsertedObjects=function(t){this.upsertedObjects=t},o.prototype.getDeletedObjects=function(){return this.deletedObjects},o.prototype.setDeletedObjects=function(t){this.deletedObjects=t},o}(),ri=function(){function o(t){this.capacity_=-1,this.cacheNodeMap=new Map,this.primaryKeys=t}return Object.defineProperty(o.prototype,"capacity",{get:function(){return this.capacity_},enumerable:!1,configurable:!0}),o.prototype.hash=function(t){for(var e=""+t,n=5381,r=e.length;r;)n=33*n^e.charCodeAt(--r);return""+(n>>>0)},o.prototype.getRecordHash=function(t){var e="R";return this.primaryKeys.forEach(function(n){e=e+"-"+t[n]}),this.hash(e)},o}(),oi=function(o){this.versionId=o},ii=function(o){function t(e){var n=o.call(this,e)||this;return n.capacity_=-1,n}return se(t,o),t.prototype.cache=function(e,n){var r=this.cacheNodeMap.get(n);return r||(r=new oi(n),this.cacheNodeMap.set(n,r)),r.record=e,r},t.prototype.remove=function(e){e&&this.cacheNodeMap.get(e)&&this.cacheNodeMap.delete(e)},t.prototype.get=function(e){if(e)return this.cacheNodeMap.get(e)},t}(ri),yr=function(){function o(t){this.value_=void 0,this.actions={},this.value_=t}return Object.defineProperty(o.prototype,"value",{get:function(){return this.value_},set:function(t){var e,n;this.value_=t;var r=Object.getOwnPropertyNames(this.actions);try{for(var i=E(r),s=i.next();!s.done;s=i.next()){var a=s.value,u=this.actions[a];u!=null&&u.isMeetCondition(this)&&u.execute(this)}}catch(l){e={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}},enumerable:!1,configurable:!0}),o.prototype.register=function(t){this.actions[t.id]=t},o.prototype.unregister=function(t){delete this.actions[t]},o.prototype.hasNoAction=function(){return Object.getOwnPropertyNames(this.actions).length===0},o.prototype.release=function(){this.actions={},this.value_=void 0},o}(),si=function(){function o(t,e,n,r){this.isTimeout=!1,this.executed=!1,this.isRegistered=!1,this.isOnce=t,this.id=n,this.func=e,this.condition=r||function(i){return!0}}return Object.defineProperty(o.prototype,"isExecuted",{get:function(){return this.executed},enumerable:!1,configurable:!0}),o.prototype.isMeetCondition=function(t){return this.isTimeout===!1&&this.condition(t)},o.prototype.withTimeout=function(t,e){var n=this;return setTimeout(function(){n.isExecuted||(n.isTimeout=!0,e&&e())},t),this},o.prototype.execute=function(t){this.isTimeout||(this.isRegistered||t.register(this),this.condition(t)&&this.executeAndTryUnregister(t))},o.prototype.executeAndTryUnregister=function(t){this.executed=!0;try{this.func(t)}catch(e){setTimeout(function(){throw e},Math.floor(0))}this.isOnce&&t.unregister(this.id)},o}();(function(o){o[o.EMPTY=0]="EMPTY",o[o.SCHEMA_NEGOTIATE=1]="SCHEMA_NEGOTIATE",o[o.CACHE_UPDATE=2]="CACHE_UPDATE",o[o.OBJECT_UPDATE=3]="OBJECT_UPDATE",o[o.TRANSACTION=4]="TRANSACTION",o[o.OBJECT_QUERY=5]="OBJECT_QUERY",o[o.QUERY_SUB=6]="QUERY_SUB",o[o.QUERY_UNSUB=7]="QUERY_UNSUB",o[o.QUERY_SUB_PUSH=8]="QUERY_SUB_PUSH",o[o.ENCRYPTION_TASK=9]="ENCRYPTION_TASK",o[o.USER_DATA_QUERY=10]="USER_DATA_QUERY",o[o.SERVER_STATUS=11]="SERVER_STATUS"})(V||(V={})),function(o){o[o.EMPTY=0]="EMPTY",o[o.QUERY_SALT_VALUE=1]="QUERY_SALT_VALUE",o[o.QUERY_CIPHER_TEST=2]="QUERY_CIPHER_TEST",o[o.UPDATE_CIPHER_TEXT=3]="UPDATE_CIPHER_TEXT",o[o.INSERT_ENCRYPTION_INFO=4]="INSERT_ENCRYPTION_INFO",o[o.UPDATE_ENCRYPTION_INFO=5]="UPDATE_ENCRYPTION_INFO",o[o.NOTIFY_ENCRYPTION_COMMAND_CHANGED=6]="NOTIFY_ENCRYPTION_COMMAND_CHANGED",o[o.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL=7]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL",o[o.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING=8]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING",o[o.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT=9]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT",o[o.MONITOR_USER_COMMAND_CHANGE=10]="MONITOR_USER_COMMAND_CHANGE",o[o.MONITOR_DATA_KEY_CHANGE=11]="MONITOR_DATA_KEY_CHANGE"}(te||(te={})),function(o){o[o.SYNC_UPSERT=1]="SYNC_UPSERT",o[o.SYNC_DELETE=2]="SYNC_DELETE",o[o.VERIFY=3]="VERIFY"}(ge||(ge={})),function(o){o[o.ALL=0]="ALL",o[o.UPSERT=1]="UPSERT",o[o.DELETE=2]="DELETE"}(Ne||(Ne={}));var v,tt,ft,un,ze,Ot,Bn=new M("SequenceTaskQueue"),ai=function(){function o(){this.tasks=[],this.isExecuting=!1}return o.prototype.scheduleProcess=function(t){Bn.debug("scheduleProcess start: "+this.isExecuting),this.tasks.push(t),this.isExecuting||this.process()},o.prototype.process=function(){var t=this;if(this.isExecuting=!0,Bn.debug("process start length: "+this.tasks.length),this.tasks.length){var e=this.tasks.shift();e==null||e.execute().then(function(){t.process()})}else this.isExecuting=!1},o}(),ui=function(){function o(t){this.func=t}return o.prototype.execute=function(){return this.func.call(null)},o}(),Bt=new M("SnapshotGenerator"),ci=function(){function o(t,e,n){this.snapshotVersionIds=new Set,this.upsertedVersionIds=new Set,this.deletedVersionIds=new Set,this.version=new yr(0),this.taskQueue=new ai,this.clz=t,this.cloudDBZoneQuery=e,this.naturalBaseRef=n}return o.prototype.initialize=function(t){this.snapshotCache=new ii(t)},o.prototype.getVersion=function(){return this.version},o.prototype.increaseVersion=function(){this.version.value=this.version.value+1},o.prototype.cacheSnapshotObjects=function(t,e,n){var r=this,i=new ui(function(){return b(r,void 0,void 0,function(){return g(this,function(s){switch(s.label){case 0:return[4,this.processPushData(t,e,n)];case 1:return[2,s.sent()]}})})});this.taskQueue.scheduleProcess(i)},o.prototype.processPushData=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a=this;return g(this,function(u){switch(u.label){case 0:return Bt.info("processPushData start:"+t.length+" "+this.snapshotVersionIds.size+"             "+this.upsertedVersionIds.size+" "+this.deletedVersionIds.size),e!==0?[3,5]:(this.deletedVersionIds.forEach(function(l){a.snapshotCache.remove(l)}),this.clearSnapshotVersionIds(),r=t.map(function(l){return l}).filter(function(l){return l.operationType===Ne.DELETE&&l.isValidVersion()}),i=t.map(function(l){return l}).filter(function(l){return l.operationType===Ne.UPSERT}),s=t.map(function(l){return l}).filter(function(l){return l.operationType===Ne.ALL}),Bt.info("processPushData on: "+i.length+", "+r.length+", "+s.length),n!==Ne.DELETE&&n!==Ne.UPSERT?[3,2]:[4,this.handleIncrementalData(r,i)]);case 1:return u.sent(),[3,4];case 2:return[4,this.handlePushAllData(s)];case 3:u.sent(),u.label=4;case 4:Bt.info("processPushData done: "+t.length+" "+this.snapshotVersionIds.size+"                 "+this.upsertedVersionIds.size+" "+this.deletedVersionIds.size),u.label=5;case 5:return this.increaseVersion(),[2,Promise.resolve(0)]}})})},o.prototype.handleIncrementalData=function(t,e){var n;return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c,d,y,T,S,O,P,U,z,F;return g(this,function(ae){switch(ae.label){case 0:r=new Map;try{for(i=E(t),s=i.next();!s.done;s=i.next())d=s.value,(a=(n=this.snapshotCache.get(d.objectVersion))===null||n===void 0?void 0:n.record)&&(y=this.generateRecord(a),r.set(this.snapshotCache.getRecordHash(y),d.objectVersion),this.deletedVersionIds.add(d.objectVersion),this.snapshotVersionIds.delete(d.objectVersion))}catch(pt){P={error:pt}}finally{try{s&&!s.done&&(U=i.return)&&U.call(i)}finally{if(P)throw P.error}}u=this.getSnapshotCacheVersionIds(),ae.label=1;case 1:ae.trys.push([1,6,7,8]),l=E(e),c=l.next(),ae.label=2;case 2:if(c.done)return[3,5];if(d=c.value,y=this.generateRecord(d),T=this.snapshotCache.getRecordHash(y),S=r.get(T))this.deletedVersionIds.delete(S);else if(u.has(T)&&u.get(T)===d.objectVersion)return[3,4];return[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(this.cloudDBZoneQuery,[d])];case 3:ae.sent(),this.snapshotCache.cache(d,d.objectVersion),this.snapshotVersionIds.add(d.objectVersion),this.upsertedVersionIds.add(d.objectVersion),ae.label=4;case 4:return c=l.next(),[3,2];case 5:return[3,8];case 6:return O=ae.sent(),z={error:O},[3,8];case 7:try{c&&!c.done&&(F=l.return)&&F.call(l)}finally{if(z)throw z.error}return[7];case 8:return[2]}})})},o.prototype.handlePushAllData=function(t){var e,n,r,i;return b(this,void 0,void 0,function(){var s,a,u,l,c,d,y,T,S,O,P,U,z=this;return g(this,function(F){switch(F.label){case 0:s=new Set(this.snapshotVersionIds),a=this.getSnapshotCacheVersionIds(),F.label=1;case 1:F.trys.push([1,7,8,9]),u=E(t),l=u.next(),F.label=2;case 2:return l.done?[3,6]:(c=l.value,d=this.generateRecord(c),y=this.snapshotCache.getRecordHash(d),T=a.get(y),S=T&&(!(!((n=(e=this.snapshotCache.get(T))===null||e===void 0?void 0:e.record)===null||n===void 0)&&n.objectVersion)||((i=(r=this.snapshotCache.get(T))===null||r===void 0?void 0:r.record)===null||i===void 0?void 0:i.objectVersion)!==c.objectVersion),T&&!S?[3,4]:[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(this.cloudDBZoneQuery,[c])]);case 3:F.sent(),this.upsertedVersionIds.add(c.objectVersion),this.snapshotVersionIds.add(c.objectVersion),this.snapshotCache.cache(c,c.objectVersion),F.label=4;case 4:T&&s.delete(T),S&&(this.snapshotVersionIds.delete(T),this.snapshotCache.remove(T)),F.label=5;case 5:return l=u.next(),[3,2];case 6:return[3,9];case 7:return O=F.sent(),P={error:O},[3,9];case 8:try{l&&!l.done&&(U=u.return)&&U.call(u)}finally{if(P)throw P.error}return[7];case 9:return s.forEach(function(ae){z.deletedVersionIds.add(ae),z.snapshotVersionIds.delete(ae)}),[2]}})})},o.prototype.clearSnapshotVersionIds=function(){this.upsertedVersionIds.clear(),this.deletedVersionIds.clear()},o.prototype.generateSnapshot=function(t,e){if(e){var n=m.deepCopyNumber(this.snapshotVersionIds),r=this.buildSnapshotObjects(t,n);return new an(r,r,[])}var i=m.deepCopyNumber(this.snapshotVersionIds),s=m.deepCopyNumber(this.upsertedVersionIds),a=m.deepCopyNumber(this.deletedVersionIds),u=this.buildSnapshotObjects(t,i),l=this.buildSnapshotObjects(t,s),c=this.buildSnapshotObjects(t,a);return new an(u,l,c)},o.prototype.buildSnapshotObjects=function(t,e){var n,r,i,s=[];try{for(var a=E(e),u=a.next();!u.done;u=a.next()){var l=u.value,c=(i=this.snapshotCache.get(l))===null||i===void 0?void 0:i.record;if(c!==void 0){var d=m.deepCopy([c.getUserObject()]);s.push(d[0])}}}catch(y){n={error:y}}finally{try{u&&!u.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return s},o.prototype.getSnapshotCache=function(){var t=this;return Q(this.snapshotVersionIds).map(function(e){var n;return(n=t.snapshotCache.get(e))===null||n===void 0?void 0:n.record})},o.prototype.getSnapshotCacheVersionIds=function(){var t=this,e=new Map;return this.getSnapshotCache().forEach(function(n){var r=t.generateRecord(n);e.set(t.snapshotCache.getRecordHash(r),n.objectVersion)}),e},o.prototype.generateRecord=function(t){return t.setObjectTypeName(this.clz),this.naturalBaseRef.getDataModelHelper().deserialize(this.clz,t.getObject())},o}(),Ft=new M("SubscribeManager"),gr=function(){function o(t,e,n,r,i){this.exceptionCode=0,this.cloudSubRecordId="",this.cloudSubKey=-1,this.pushSeq=0,this.queryId=t,this.conditionSignature=e,this.naturalStoreName=n,this.cloudDBZoneQuery=r,this.naturalBaseRef=i,this.snapshotGenerator=new ci(this.cloudDBZoneQuery.getClazz(),this.cloudDBZoneQuery,i)}return o.prototype.initialize=function(t){this.snapshotGenerator.initialize(t)},o.prototype.addListener=function(t,e){var n=this;new li(function(r){return b(n,void 0,void 0,function(){var i;return g(this,function(s){if(this.exceptionCode!==0)e.onSnapshot(void 0,h.build(this.exceptionCode));else{if(i=this.snapshotGenerator.generateSnapshot(this.cloudDBZoneQuery.getClazz(),r),!r&&i.getUpsertedObjects().length===0&&i.getDeletedObjects().length===0)return Ft.info("addListener: skip snapShot notify when first snapShot has nothing update!"),[2];e.onSnapshot(i,void 0)}return[2]})})},t,function(){var r=n.snapshotGenerator.getVersion().value;return r!==void 0&&r>0}).execute(this.snapshotGenerator.getVersion())},o.prototype.removeListener=function(t){return this.snapshotGenerator.getVersion().unregister(t.toString()),this.snapshotGenerator.getVersion().hasNoAction()},o.prototype.subscribe=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return Ft.info("start subscribe!"),this.pushSeq=0,[4,this.naturalBaseRef.getNaturalCloudStorage().onSubscribe(ue.DEFAULT_SUBSCRIBE,this.naturalBaseRef.getNaturalStore(this.naturalStoreName),[this.queryId,this.cloudDBZoneQuery.getClassName(),t])];case 1:return e.sent(),[2]}})})},o.prototype.unsubscribe=function(){var t;return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return Ft.info("start unsubscribe!"),[4,this.naturalBaseRef.getNaturalCloudStorage().onUnSubscribe(ue.DEFAULT_SUBSCRIBE,this.naturalBaseRef.getNaturalStore(this.naturalStoreName),[this.queryId,(t=this.cloudSubRecordId)===null||t===void 0?void 0:t.toString(),this.cloudSubKey,this.cloudDBZoneQuery.getClassName()])];case 1:return e.sent(),[2]}})})},o.prototype.notify=function(t,e,n){this.exceptionCode=t,this.snapshotGenerator.cacheSnapshotObjects(e||[],t,n)},o.prototype.isErrorStatus=function(){return this.exceptionCode!==0},o.prototype.getSnapshotCache=function(){return this.snapshotGenerator.getSnapshotCache()},o}(),li=function(o){function t(e,n,r){var i=o.call(this,!1,function(){return i.executeCallback()},n.toString(),r)||this;return i.isFirstSnapshot=!0,i.callback=e,i}return se(t,o),t.prototype.executeCallback=function(){var e=this.isFirstSnapshot;this.isFirstSnapshot=!1,this.callback(e)},t}(si),Gt=new M("ListenerManager"),di=function(){function o(t,e){this.listenerCount=0,this.queryId=0,this.subscribeInfoMap=new Map,this.queryHashMap=new Map,this.listenerIdMap=new Map,this.naturalBaseRef=t,this.naturalStoreName=e}return o.prototype.generateSignature=function(t){var e=this,n=t.getQueryConditions();return n.sort(function(r,i){var s=e.compareValue(r.conditionType,i.conditionType);return s!==0||(s=e.compareValue(r.fieldName,i.fieldName))!==0?s:e.compareValue(r.value,i.value)}),m.hash(t.getClassName()+JSON.stringify(n))},o.prototype.hasListener=function(t){return m.isNullOrUndefined(t)?this.listenerIdMap.size!==0:this.listenerIdMap.has(t)},o.prototype.addListener=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a,u;return g(this,function(l){switch(l.label){case 0:return this.listenerCount>=16?(Gt.warn(`AddListener: failed to add listener.
             Too many snapshot. max size: 16.`),[2,13]):(i=this.generateSignature(t),s=0,Gt.info("addListener: listenerId:"+r),this.queryHashMap.has(i)?(s=this.queryHashMap.get(i),(a=this.subscribeInfoMap.get(s))==null||a.addListener(r,n),a!=null&&a.isErrorStatus()?[4,a.subscribe(e)]:[3,2]):[3,3]);case 1:l.sent(),l.label=2;case 2:return[3,5];case 3:return this.queryId=this.queryId+1,s=this.queryId,a=new gr(s,i,this.naturalStoreName,t,this.naturalBaseRef),u=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(t.getClassName()).getPrimaryKeys(),a.initialize(u),a.addListener(r,n),this.subscribeInfoMap.set(s,a),this.queryHashMap.set(i,s),[4,a.subscribe(e)];case 4:l.sent(),l.label=5;case 5:return this.listenerIdMap.set(r,s),this.listenerCount=this.listenerCount+1,[2,0]}})})},o.prototype.removeListener=function(t){return b(this,void 0,void 0,function(){var e,n;return g(this,function(r){switch(r.label){case 0:return(e=this.listenerIdMap.get(t))===void 0?[2,Promise.resolve(0)]:(this.listenerIdMap.delete(t),(n=this.subscribeInfoMap.get(e))&&(this.listenerCount=this.listenerCount-1),n!=null&&n.removeListener(t)?[4,n==null?void 0:n.unsubscribe()]:[3,2]);case 1:r.sent(),this.cleanSubscription(e),r.label=2;case 2:return[2,Promise.resolve(0)]}})})},o.prototype.cleanSubscribeInfo=function(t){var e=this;Q(this.subscribeInfoMap.values()).filter(function(n){return n.cloudSubRecordId===t}).map(function(n){return n.queryId}).forEach(function(n){e.cleanSubscription(n)})},o.prototype.cleanSubscription=function(t){var e,n;Gt.info("cleanSubscription queryId:"+t),this.subscribeInfoMap.delete(t);try{for(var r=E(this.queryHashMap.keys()),i=r.next();!i.done;i=r.next()){var s=i.value;if(this.queryHashMap.get(s)===t)return void this.queryHashMap.delete(s)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},o.prototype.getAllSubscribeInfo=function(){var t,e,n=new Map;try{for(var r=E(this.subscribeInfoMap.values()),i=r.next();!i.done;i=r.next()){var s=i.value;n.set(s.cloudSubRecordId,s)}}catch(a){t={error:a}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},o.prototype.getSubscribeInfoByRecordId=function(t){var e=Q(this.subscribeInfoMap.values()).filter(function(n){return n.cloudSubRecordId===t});return e.length===0?void 0:e[0]},o.prototype.isSubscribeNotResponsed=function(t){var e=this.subscribeInfoMap.get(t);return!(!e||e.cloudSubRecordId!=="")},o.prototype.getSubscribeInfo=function(t){var e,n;try{for(var r=E(this.subscribeInfoMap),i=r.next();!i.done;i=r.next()){var s=fe(i.value,2),a=s[0],u=s[1];if(t===a)return u}}catch(l){e={error:l}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},o.prototype.compareValue=function(t,e){return t>e?1:t<e?-1:0},o}();(function(o){o[o.Boolean=1]="Boolean",o[o.Byte=2]="Byte",o[o.Short=3]="Short",o[o.Integer=4]="Integer",o[o.Long=5]="Long",o[o.Float=6]="Float",o[o.Double=7]="Double",o[o.ByteArray=8]="ByteArray",o[o.String=9]="String",o[o.Date=10]="Date",o[o.Text=11]="Text",o[o.IntAutoIncrement=12]="IntAutoIncrement",o[o.LongAutoIncrement=13]="LongAutoIncrement",o[o.Unknown=14]="Unknown"})(v||(v={})),function(o){o.getFieldType=function(t){var e=v[t];return e||v.Unknown},o.valueOf=function(t){return t},o.toString=function(t){switch(t){case 1:return"Boolean";case 2:return"Byte";case 3:return"Short";case 4:return"Integer";case 5:return"Long";case 6:return"Float";case 7:return"Double";case 8:return"ByteArray";case 9:return"String";case 10:return"Date";case 11:return"Text";case 12:return"IntAutoIncrement";case 13:return"LongAutoIncrement";default:return"Unknown"}}}(tt||(tt={})),function(o){o.World="World",o.Authenticated="Authenticated",o.Creator="Creator",o.Administrator="Administrator"}(ft||(ft={})),function(o){o.getUserRole=function(t){var e=ft[t];return e||ft.World}}(un||(un={})),function(o){o[o.None=0]="None",o[o.Read=1]="Read",o[o.Upsert=2]="Upsert",o[o.Delete=4]="Delete"}(ze||(ze={})),function(o){o.getUserRight=function(t){switch(t){case"Read":return ze.Read;case"Upsert":return ze.Upsert;case"Delete":return ze.Delete;default:return ze.None}},o.getAllUserRight=function(t){var e=0;return t.forEach(function(n){var r=o.getUserRight(n);e|=r}),e},o.checkUserRight=function(t,e){return(t&e)!=0},o.composeUserRight=function(t){var e=0;return t.forEach(function(n){e|=n}),e}}(Ot||(Ot={}));var x,pi=new Set(["rowid","naturalbase_version","naturalbase_syncstatus","naturalbase_deleted","naturalbase_operationtype","naturalbase_accesstime","naturalbase_operationtime","naturalbase_creator","naturalbase_lastmodifier"]),fi=new Set(["objecttypeinfohelper","t_data_upgrade_info","naturalbase_metadata"]);(function(o){o[o.VALID_VALUE=0]="VALID_VALUE",o[o.INVALID_TYPE=1]="INVALID_TYPE",o[o.INVALID_VALUE=2]="INVALID_VALUE"})(x||(x={}));var Ct=new M("SchemaValidators"),br=/(^[a-zA-Z][A-Za-z0-9_]{0,28}[A-Za-z0-9]$)|(^[a-zA-Z]$)/,st={};function re(o,t){st[o]=t}function hi(o){var t=o.length;return t<=30&&t>=1?!!br.test(o)||(Ct.warn("[Rule Invalidation] field-name-validation => Field Name is invalid."),!1):(Ct.warn("[Rule Invalidation] Field Name length should not exceed 30"),!1)}re("object-has-fields-validation",function(o){if(o.getFieldInfos().size===0)throw h.build("The object type does not define any field.")}),re("field-not-support-notnull-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.isNotNull){if(i.fieldType===v.Date)throw h.build("Date type can not be set as not null value.");if(i.fieldType===v.ByteArray)throw h.build("ByteArray type can not be set as not null value.")}}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("field-not-support-default-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.hasDefaultValue){if(i.fieldType===v.Date)throw h.build("Date type can not be set as default value.");if(i.fieldType===v.ByteArray)throw h.build("ByteArray type can not be set as default value.")}}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("field-primarykey-not-support-default-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.isPrimaryKey&&i.hasDefaultValue)throw h.build("The primary key is forbidden to set default value.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("field-default-not-support-null-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.fieldType!==v.IntAutoIncrement&&i.fieldType!==v.LongAutoIncrement&&!i.isPrimaryKey&&i.isNotNull&&!i.hasDefaultValue)throw h.build("The field should be set default value while it is set not null.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("field-autoincrement-must-not-null-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(!i.isNotNull){if(i.fieldType===v.IntAutoIncrement)throw h.build("IntAutoIncrement type must be set as not null value.");if(i.fieldType===v.LongAutoIncrement)throw h.build("LongAutoIncrement type must be set as not null value.")}}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("string-text-value-length-validation",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if((i.fieldType===v.String||i.fieldType===v.Text)&&!m.isNullOrUndefined(i.defaultValue)&&i.defaultValue.length>200)throw h.build("String default value length cannot be greater than 200.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("no-system-property-column",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(pi.has(i.fieldName.toLowerCase()))throw h.build("Field name "+i.fieldName+" is invalid.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("no-system-table-name",function(o){var t;if(fi.has((t=o.name)===null||t===void 0?void 0:t.toLowerCase()))throw h.build("The object name is invalid.")}),re("field-type-validation",function(o){var t,e,n;try{for(var r=E(o.getFieldInfos().values()),i=r.next();!i.done;i=r.next()){var s=i.value;if((n=s.fieldType)!==v.Short&&n!==v.Long&&n!==v.Integer&&n!==v.Float&&n!==v.Double&&n!==v.String&&n!==v.Date&&n!==v.Byte&&n!==v.ByteArray&&n!==v.Text&&n!==v.Boolean&&n!==v.IntAutoIncrement&&n!==v.LongAutoIncrement)throw h.build("The type of "+s.fieldName+" field is not supported.")}}catch(a){t={error:a}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}}),re("primarykey-require",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next())if(r.value.isPrimaryKey)return}catch(i){t={error:i}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}throw h.build("The class does not have primary key.")}),re("field-not-support-primarykey",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if((i.fieldType===v.Date||i.fieldType===v.ByteArray||i.fieldType===v.Text)&&i.isPrimaryKey)throw h.build(tt.toString(i.fieldType)+" type can not be set as primary key.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("no-non-defaultvalue",function(o){var t,e;try{for(var n=E(o.getFieldInfos().values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.hasDefaultValue&&m.isNullOrUndefined(i.defaultValue))throw h.build("The field should be set default value while it is set not null.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("primarykey-count-limitation",function(o){if(Q(o.getFieldInfos().values()).filter(function(t){return t.isPrimaryKey}).length>5)throw h.build("The count of primary key exceeds the limit.")}),re("string-fields-count-limitation",function(o){if(Q(o.getFieldInfos().values()).filter(function(t){return t.fieldType===v.String}).length>100)throw h.build("The count of string type field exceeds the limit.")}),re("field-name-validation",function(o){var t,e;try{for(var n=E(o.getFieldNames()),r=n.next();!r.done;r=n.next()){var i=r.value;if(!hi(i))throw h.build("Field name "+i+" is invalid.")}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}}),re("objecttype-name-validation",function(o){if(!function(t){return t.length>30||t.length<1?(Ct.warn(`[Rule Invalidation] Table Name length should not exceed 30
         and less than 1.`),!1):br.test(t)?!0:(Ct.warn("[Rule Invalidation] Table Name is invalid."),!1)}(o.name))throw h.build("The object name is invalid.")});var vr={};function pe(o,t){vr[o]=t}pe(v.Integer,function(o){return Number.isInteger(o)?o<-2147483648||o>2147483647?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE}),pe(v.String,function(o){if(typeof o!="string")return x.INVALID_TYPE;if(o.length>200)throw h.build("String type length cannot be greater than 200.");if(o.indexOf("\0")!==-1||o.indexOf("\0")!==-1)throw h.build("The string contains illegal character, use the ByteArray type if you intend to send raw bytes.");return x.VALID_VALUE}),pe(v.Short,function(o){return Number.isSafeInteger(o)?o<-32768||o>32767?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Long,function(o){var t;return m.isNullOrUndefined(o)||((t=o.constructor)===null||t===void 0?void 0:t.name)==="Long"?x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Boolean,function(o){return typeof o=="boolean"?x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Byte,function(o){return Number.isSafeInteger(o)?o<-128||o>127?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Float,function(o){return typeof o!="number"?x.INVALID_TYPE:o<-3402823e32||o>3402823e32?x.INVALID_VALUE:x.VALID_VALUE}),pe(v.Double,function(o){return typeof o!="number"?x.INVALID_TYPE:Number.isFinite(o)?x.VALID_VALUE:x.INVALID_VALUE}),pe(v.ByteArray,function(o){return o instanceof ArrayBuffer||o instanceof Uint8Array?x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Date,function(o){return o instanceof Date?isNaN(o.getTime())?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE}),pe(v.Text,function(o){if(typeof o=="string"){if(o.indexOf("\0")!==-1||o.indexOf("\0")!==-1)throw h.build("The string contains illegal character, use the ByteArray type if you intend to send raw bytes.");return x.VALID_VALUE}return x.INVALID_TYPE}),pe(v.IntAutoIncrement,function(o){return Number.isInteger(o)?o<1||o>2147483647?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE}),pe(v.LongAutoIncrement,function(o){var t;return m.isNullOrUndefined(o)||((t=o.constructor)===null||t===void 0?void 0:t.name)==="Long"?o.compare(L.fromString("1"))===-1?x.INVALID_VALUE:x.VALID_VALUE:x.INVALID_TYPE});var Se,we,yi=function(){function o(t){this.isNeedEncrypt=!1,this.notNull=!1,this.belongPrimaryKey=!1,this.fieldName="",this.fieldType=v.Unknown,this.signature=-1,this.hasDefaultValue=!1,this.opeName="",t&&(this.parseFieldInfo(t),this.signature=o.hash(this.fieldName))}return o.hash=function(t){for(var e=""+t,n=5381,r=e.length;r;)n=33*n^e.charCodeAt(--r);return Math.abs(n>>>0)},o.prototype.parseFieldInfo=function(t){this.isNeedEncrypt=t.isNeedEncrypt,this.fieldName=t.fieldName,this.notNull=t.notNull,this.belongPrimaryKey=t.belongPrimaryKey,this.fieldType=tt.getFieldType(t.fieldType),this.isEncryptField&&t.fieldName!==null&&t.fieldName!==void 0&&(this.opeName=t.fieldName.indexOf("#ope")===-1?t.fieldName+"#ope":t.fieldName),Object.prototype.hasOwnProperty.call(t,"defaultValue")&&this.setDefaultValue(t.defaultValue)},o.prototype.setDefaultValue=function(t){switch(this.hasDefaultValue=!0,this.fieldType){case v.Boolean:this.defaultValue=t==="true";break;case v.Byte:case v.Double:case v.Float:case v.Integer:case v.Short:this.defaultValue=Number(t);break;case v.Long:this.defaultValue=L.fromString(t);break;case v.String:case v.Text:this.defaultValue=t}},Object.defineProperty(o.prototype,"isEncryptField",{get:function(){return this.isNeedEncrypt},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isNotNull",{get:function(){return this.notNull},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isPrimaryKey",{get:function(){return this.belongPrimaryKey},enumerable:!1,configurable:!0}),o.prototype.equalTo=function(t){var e,n;if(!t)return!1;var r=Object.getOwnPropertyNames(t);try{for(var i=E(r),s=i.next();!s.done;s=i.next()){var a=s.value;if(this[a]instanceof L&&t[a]instanceof L){var u=this[a],l=t[a];if(!u.equals(l))return!1}else if(this[a]!==t[a])return!1}}catch(c){e={error:c}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return!0},o}();(function(o){o[o.MORE_TABLES=1]="MORE_TABLES",o[o.LESS_TABLES=2]="LESS_TABLES",o[o.EQUAL_TABLES=3]="EQUAL_TABLES",o[o.DIFF_TABLES=4]="DIFF_TABLES"})(Se||(Se={})),function(o){o[o.MORE_FIELDS=1]="MORE_FIELDS",o[o.LESS_FIELDS=2]="LESS_FIELDS",o[o.EQUAL_FIELDS=3]="EQUAL_FIELDS",o[o.DIFF_FIELDS=4]="DIFF_FIELDS",o[o.INVALID_INDEX=5]="INVALID_INDEX",o[o.INVALID_SCHEMA=6]="INVALID_SCHEMA"}(we||(we={}));var gi=function(){function o(t,e){var n=this;this.name_="",this.primaryKeyList=[],this.fieldInfos=new Map,this.permissions=new Map,t&&(this.name_=e.objectTypeName,e.fields.forEach(function(r){var i=new yi(r);n.fieldInfos.set(i.fieldName,i),i.isPrimaryKey&&n.primaryKeyList.push(i)}),t.permissions.forEach(function(r){n.permissions.set(un.getUserRole(r.role),Ot.getAllUserRight(r.rights))}))}return Object.defineProperty(o.prototype,"name",{get:function(){return this.name_},enumerable:!1,configurable:!0}),o.validateObjectSchema=function(t){var e,n;try{for(var r=E(Object.getOwnPropertyNames(st)),i=r.next();!i.done;i=r.next()){var s=i.value;st[s](t)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}return!0},o.prototype.compareFields=function(t){if(!t)return we.INVALID_SCHEMA;var e=this.compareFieldInfo(t);return e===we.DIFF_FIELDS?we.INVALID_SCHEMA:e},o.prototype.compareFieldInfo=function(t){var e,n;if(this.fieldInfos.size<t.fieldInfos.size)return we.MORE_FIELDS;try{for(var r=E(this.fieldInfos.values()),i=r.next();!i.done;i=r.next()){var s=i.value;if(!s.equalTo(t.fieldInfos.get(s.fieldName)))return we.DIFF_FIELDS}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}return we.EQUAL_FIELDS},o.prototype.getFieldInfo=function(t){return this.fieldInfos.get(t)},o.prototype.checkPermission=function(t,e){var n=this.permissions.get(t);return!!n&&Ot.checkUserRight(n,e)},o.prototype.getPrimaryKeys=function(){return Q(this.fieldInfos.values()).filter(function(t){return t.isPrimaryKey}).map(function(t){return t.fieldName}).sort()},o.prototype.getPrimaryKeyFieldTypes=function(){return this.primaryKeyList},o.prototype.getFieldNames=function(){return Q(this.fieldInfos.keys())},o.prototype.hasCompositePrimaryKey=function(){return this.getPrimaryKeys().length>1},o.prototype.getFieldInfos=function(){return this.fieldInfos},o.prototype.setPermission=function(t,e){this.permissions.set(t,e)},o.prototype.isLegalOpeFieldName=function(t){return t.indexOf("#ope")!==-1},o.prototype.isEncryptTable=function(){var t,e;try{for(var n=E(this.fieldInfos.values()),r=n.next();!r.done;r=n.next())if(r.value.isEncryptField)return!0}catch(i){t={error:i}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}return!1},o.prototype.getEncryptFieldList=function(){return Q(this.fieldInfos.values()).filter(function(t){return t.isEncryptField}).sort()},o}(),He=new M("SchemaUtils"),Pt=function(){function o(){}return o.validateFieldValue=function(t,e){var n=vr[t](e);if(n===x.INVALID_TYPE)throw h.build("The field type mismatches the value type.");if(n===x.INVALID_VALUE){var r=tt.toString(t);throw h.build("The value for a "+r+" column is invalid.")}},o.validateFieldValueForQuery=function(t,e){t===v.LongAutoIncrement?t=v.Long:t===v.IntAutoIncrement&&(t=v.Integer),this.validateFieldValue(t,e)},o.validateObjectSchema=function(t){var e,n;try{for(var r=E(Object.getOwnPropertyNames(st)),i=r.next();!i.done;i=r.next()){var s=i.value;st[s](t)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}return!0},o.compareSchemas=function(t,e,n,r){if(t>n)throw He.error("compareSchemas: Object version downgrade is not support. current version: "+t),h.build(21);var i=this.compareTables(e,r);if(t===n){if(i===Se.EQUAL_TABLES)return He.warn("compareSchemas: ObjectType version and ObjectType has not changed."),!0;throw He.error("compareSchemas: ObjectType version has not changed, but ObjectType has changed."),h.build(17)}switch(i){case Se.EQUAL_TABLES:throw He.error("compareSchemas: ObjectType version has changed, but ObjectType has not changed."),h.build(17);case Se.LESS_TABLES:throw He.error("compareSchemas: Remove ObjectType is not supported."),h.build(17);case Se.DIFF_TABLES:throw He.error("compareSchemas: cannot modify existing schema when upgrade."),h.build(17);case Se.MORE_TABLES:default:return!1}},o.compareTables=function(t,e){var n,r;if(t.size>e.size)return Se.LESS_TABLES;var i=!1;try{for(var s=E(t.values()),a=s.next();!a.done;a=s.next()){var u=a.value,l=u.name,c=e.get(l),d=u.compareFields(c);if(d!==we.MORE_FIELDS){if(d===we.EQUAL_FIELDS)continue;return Se.DIFF_TABLES}i=!0}}catch(y){n={error:y}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return t.size<e.size||i?Se.MORE_TABLES:Se.EQUAL_TABLES},o}(),Ye=new M("NaturalStore"),bi=new Set(["Limit","OrderBy"]),ht=new Set(["Limit","Or","BeginGroup","EndGroup","And"]),vi=new Set(["Or","BeginGroup","EndGroup","EqualTo","And"]),mi=new Set(["BeginGroup","EndGroup","Or","And"]),Si=new Set(["In","Average","Contain","BeginWith","EndWith"]),Ti=new Set(["EqualTo","NotEqualTo","GreaterThan","GreaterThanOrEqualTo","LessThan","LessThanOrEqualTo"]),Ii=new Set(["IsNull","IsNotNull","OrderBy","Count"]),cn=function(){function o(t,e){this.references=new Set,this.listenerManager=null,this.naturalStoreId=t,this.cloudStorage=e.getNaturalCloudStorage(),this.naturalBaseRef=e,this.listenerManager=new di(e,t)}return o.prototype.releaseNaturalStoreResource=function(){this.listenerManager=null},o.prototype.getNaturalStoreName=function(){return this.naturalStoreId},o.prototype.close=function(){this.releaseNaturalStoreResource()},o.prototype.hasSubscriber=function(){return!(!this.listenerManager||!this.listenerManager.hasListener())},o.prototype.executeUpsert=function(t){return b(this,void 0,void 0,function(){var e;return g(this,function(n){switch(n.label){case 0:return[4,this.naturalBaseRef.getEntireEncryption().encryptEntireEncryptedFields(t)];case 1:return e=n.sent(),[4,this.cloudStorage.executeUpsert(e,this.naturalStoreId)];case 2:return[2,n.sent()]}})})},o.prototype.executeDelete=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(m.getClassName(t[0]))];case 1:return e.sent(),[4,this.cloudStorage.executeDelete(t,this.naturalStoreId)];case 2:return[2,e.sent()]}})})},o.prototype.executeQuery=function(t){return b(this,void 0,void 0,function(){var e,n,r;return g(this,function(i){switch(i.label){case 0:return this.checkQueryClass(t),[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(t.getClassName())];case 1:return i.sent(),[4,this.getQueryConditionByString(t.getClassName(),t.getQueryConditions())];case 2:return e=i.sent(),[4,this.cloudStorage.executeQuery(this.naturalStoreId,t.getClassName(),e)];case 3:return n=i.sent(),[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(t,n)];case 4:return r=i.sent(),[2,new an(r,[],[])]}})})},o.prototype.executeTransactionQuery=function(t){return b(this,void 0,void 0,function(){var e,n,r;return g(this,function(i){switch(i.label){case 0:return[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(t.getClassName())];case 1:return i.sent(),[4,this.getQueryConditionByString(t.getClassName(),t.getQueryConditions())];case 2:return e=i.sent(),[4,this.cloudStorage.executeQuery(this.naturalStoreId,t.getClassName(),e)];case 3:return n=i.sent(),[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(t,n)];case 4:return r=i.sent(),[2,Promise.resolve({objects:n,decryptObjects:r})]}})})},o.prototype.executeAggregateQuery=function(t,e,n){return b(this,void 0,void 0,function(){var r,i;return g(this,function(s){switch(s.label){case 0:return this.verifyAvgQuery(t,n),r=m.deepCopy(t.getQueryConditions()),this.addCondition(r,e,n),[4,this.getQueryConditionByString(t.getClassName(),r)];case 1:return i=s.sent(),[4,this.cloudStorage.executeAggregateQuery(this.naturalStoreId,t.getClassName(),i)];case 2:return[2,s.sent()]}})})},o.prototype.executeServerStatusQuery=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.cloudStorage.executeServerStatusQuery()];case 1:return[2,t.sent()]}})})},o.prototype.runTransaction=function(t,e,n){return b(this,void 0,void 0,function(){var r,i;return g(this,function(s){switch(s.label){case 0:return[4,this.getTransactionOperation(n)];case 1:return r=s.sent(),i=m.deepCopy(e),[2,this.cloudStorage.runTransaction(t,i,r)]}})})},o.prototype.addSnapshotListener=function(t,e,n){return b(this,void 0,void 0,function(){var r,i;return g(this,function(s){switch(s.label){case 0:return this.checkSubscribeQuery(t),[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(t.getClassName())];case 1:return s.sent(),[4,this.getQueryConditionByString(t.getClassName(),t.getQueryConditions())];case 2:return r=s.sent(),this.listenerManager?[4,this.listenerManager.addListener(t,r,e,n)]:[3,4];case 3:return i=s.sent(),[3,5];case 4:i=0,s.label=5;case 5:return[2,i]}})})},o.prototype.removeSnapshotListener=function(t){var e;return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,(e=this.listenerManager)===null||e===void 0?void 0:e.removeListener(t)];case 1:return n.sent(),[2,0]}})})},o.prototype.getAllSubscribeInfo=function(){return this.listenerManager?this.listenerManager.getAllSubscribeInfo():new Map},o.prototype.getSubscribeInfoByCloudSubRecordId=function(t){var e;return(e=this.listenerManager)===null||e===void 0?void 0:e.getSubscribeInfoByRecordId(t)},o.prototype.isSubscribeNotResponsed=function(t){var e=Number(t);return!(t===""||isNaN(e)||!this.listenerManager)&&this.listenerManager.isSubscribeNotResponsed(e)},o.prototype.handleSubscribeRes=function(t,e,n,r){var i,s=(i=this.listenerManager)===null||i===void 0?void 0:i.getSubscribeInfo(e);return s instanceof gr&&(s.cloudSubRecordId=n,s.cloudSubKey=r,t!==0)?(s.notify(t,[]),t):0},o.prototype.handleUnsubscribeRes=function(t,e){var n;return e!==0?e:((n=this.listenerManager)===null||n===void 0||n.cleanSubscribeInfo(t),0)},o.prototype.handleSubPushRes=function(t,e,n,r){t.notify(e,n,r)},o.prototype.getQueryConditionByString=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s,a,u,l,c,d,y,T;return g(this,function(S){switch(S.label){case 0:n=[],S.label=1;case 1:S.trys.push([1,8,9,10]),r=E(e),i=r.next(),S.label=2;case 2:if(i.done)return[3,7];if((s=i.value).conditionType==="And")return[3,6];if(this.isInvalidCondition(s))throw Ye.error("getQueryConditionByString fail for invalid query condition!"),h.build("Invalid query conditions.");if(a={fieldName:s.fieldName,conditionType:s.conditionType,value:void 0},!(u=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(t,s.fieldName))&&!ht.has(s.conditionType))throw h.build("The field name does not exist.");if(!(u!=null&&u.isEncryptField))return a.fieldType=u==null?void 0:u.fieldType,s.value instanceof Date?a.value=s.value.getTime():s.value instanceof L?a.value=s.value.toString():m.isArray(s.value)?a.value=this.arrayToString(s.value):a.value=s.value,n.push(a),[3,6];if(l=s.conditionType,Si.has(l))throw h.build("Encrypted field does not support "+l+".");return a.fieldName=s.fieldName+"#ope",a.fieldType=v.String,Ti.has(l)?(c=a,[4,this.naturalBaseRef.getEntireEncryption().conditionEntireEncryptedField(t,s.fieldName,u.fieldType,s.value)]):[3,4];case 3:return c.value=S.sent(),[3,5];case 4:a.value=s.value,S.label=5;case 5:n.push(a),S.label=6;case 6:return i=r.next(),[3,2];case 7:return[3,10];case 8:return d=S.sent(),y={error:d},[3,10];case 9:try{i&&!i.done&&(T=r.return)&&T.call(r)}finally{if(y)throw y.error}return[7];case 10:return[2,JSON.stringify({queryConditions:n})]}})})},o.prototype.arrayToString=function(t){var e,n,r=[];try{for(var i=E(t),s=i.next();!s.done;s=i.next()){var a=s.value,u=a;a instanceof Date?u=a.getTime():a instanceof L&&(u=a.toString()),r.push(u)}}catch(l){e={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.prototype.isInvalidCondition=function(t){return!t.conditionType||!ht.has(t.conditionType)&&!t.fieldName},o.prototype.getTransactionOperation=function(t){return b(this,void 0,void 0,function(){var e,n,r,i,s,a,u,l,c;return g(this,function(d){switch(d.label){case 0:e=[],d.label=1;case 1:d.trys.push([1,6,7,8]),n=E(t),r=n.next(),d.label=2;case 2:return r.done?[3,5]:(i=r.value,[4,this.naturalBaseRef.getEntireEncryption().encryptEntireEncryptedFields(i.objects)]);case 3:s=d.sent(),a={operationType:i.operationType,objectTypeName:i.objectTypeName,objects:s},e.push(a),d.label=4;case 4:return r=n.next(),[3,2];case 5:return[3,8];case 6:return u=d.sent(),l={error:u},[3,8];case 7:try{r&&!r.done&&(c=n.return)&&c.call(n)}finally{if(l)throw l.error}return[7];case 8:return[2,Promise.resolve(e)]}})})},o.prototype.getAllSubscribeInfos=function(){var t=[],e=0;return this.getAllSubscribeInfo().forEach(function(n){t[e++]=[n.queryId,n.cloudSubRecordId,n.cloudSubKey,n.cloudDBZoneQuery.getClassName()]}),t},o.prototype.verifyAvgQuery=function(t,e){m.checkNotNull(e,"The field name must not be null."),this.checkQueryClass(t);var n=t.getClassName(),r=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(n,e);if(!r)throw h.build("The field name does not exist.");if(r.isEncryptField)throw h.build("Encrypted field does not support AVG.");switch(r.fieldType){case v.Byte:case v.Short:case v.Integer:case v.Long:case v.Float:case v.Double:case v.LongAutoIncrement:case v.IntAutoIncrement:return;default:throw h.build("The field type is not numeric.")}},o.prototype.checkQueryClass=function(t){var e,n;if(m.isNullOrUndefined(t))throw h.build("CloudDBZoneQuery must not be null.");if(!(t instanceof ni))throw h.build("The type of input must be CloudDBZoneQuery.");var r=t.getClazz();if(typeof r!="function")throw h.build("The input parameter is not a class.");if(!t.getQueryConditions())throw Ye.warn("checkSubscribeQuery: failed to get conditions array."),h.build("Invalid query conditions.");var i=Object.getOwnPropertyNames(new r);if(m.isEmpty(t.getClassName())||!this.naturalBaseRef.getDataModelHelper().validate(new r))throw h.build(16);var s=this.naturalBaseRef.getDataModelHelper().getFieldInfosByClassName(t.getClassName());if(i.length!==(s==null?void 0:s.size))throw h.build("The field size of input object is different with that of the imported class.");try{for(var a=E(i),u=a.next();!u.done;u=a.next()){var l=u.value;if(!s.has(l))throw h.build("The field does not exist.")}}catch(c){e={error:c}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}this.checkConditions(t)},o.prototype.checkConditions=function(t){var e,n;if(t.getDepth()!==0)throw h.build("The query beginGroup and endGroup should come in pairs with right direction.");var r=t.getQueryConditions().length;if(r>30)throw h.build("Query type exceeds the limit.");for(var i=0,s=t.getClassName(),a=t.getQueryConditions(),u=0;u<r;u++){var l=a[u];if(mi.has(l.conditionType)&&(i=this.validBeginOrEndGroup(l,a,u,i),this.validOrAndCondition(l,a,u)),bi.has(l.conditionType)&&(i!==0||u!==0&&(a[u-1].conditionType==="And"||a[u-1].conditionType==="Or")))throw l.conditionType==="OrderBy"?h.build('near "'+l.value+'": syntax error.'):h.build('near "'+l.conditionType+'": syntax error.');if(!ht.has(l.conditionType)){m.checkNotNull(l.fieldName,"The field name must not be null.");var c=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(s,l.fieldName);if(!c)throw h.build("The field name does not exist.");if(!Ii.has(l.conditionType)){if(!this.checkConditionTypeAndFieldType(l.conditionType,c.fieldType))throw h.build("The "+v[c.fieldType]+" type does not support the "+l.conditionType+" operation.");var d=m.convertArray(l.value);try{for(var y=(e=void 0,E(d)),T=y.next();!T.done;T=y.next()){var S=T.value;Pt.validateFieldValueForQuery(c.fieldType,S)}}catch(O){e={error:O}}finally{try{T&&!T.done&&(n=y.return)&&n.call(y)}finally{if(e)throw e.error}}}}}},o.prototype.checkConditionTypeAndFieldType=function(t,e){switch(t){case"EqualTo":case"NotEqualTo":return e!==v.ByteArray;case"GreaterThan":case"GreaterThanOrEqualTo":case"LessThan":case"LessThanOrEqualTo":case"In":return e!==v.Boolean&&e!==v.ByteArray;case"BeginWith":case"EndWith":case"Contain":return e===v.Text||e===v.String;default:return!1}},o.prototype.checkSubscribeQuery=function(t){this.checkQueryClass(t),this.checkSubscribeCondition(t.getQueryConditions(),t.getClassName())},o.prototype.checkSubscribeCondition=function(t,e){var n,r;this.checkSubscribeConditionSize(t);try{for(var i=E(t),s=i.next();!s.done;s=i.next()){var a=s.value;this.checkSubscribeConditionType(a,e)}}catch(u){n={error:u}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},o.prototype.checkSubscribeConditionSize=function(t){var e,n,r=t.length;if(r<1||r>30)throw Ye.warn("checkSubscribeCondition: invalid condition count: "+r),h.build("Query type exceeds the limit.");var i=0;try{for(var s=E(t),a=s.next();!a.done;a=s.next())a.value.conditionType==="EqualTo"&&i++}catch(u){e={error:u}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}if(i<1||i>5)throw Ye.warn("checkSubscribeCondition: invalid equalTo condition count: "+i),h.build("Invalid query object. Only support 1 to 5 equalTo conditions.")},o.prototype.checkSubscribeConditionType=function(t,e){if(!vi.has(t.conditionType))throw Ye.warn("checkSubscribeConditionType: not support condition: "+t.conditionType),h.build('Invalid query object. Only support EqualTo, BeginGroup, EndGroup, Or and "And" condition.');if(!ht.has(t.conditionType)){var n=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(e,t.fieldName);if(!n)throw h.build("The field name does not exist.");if(n.fieldType===v.Text)throw Ye.warn("checkSubscribeQuery: not support EqualTo condition on text field."),h.build("Invalid query object. Not support EqualTo condition on text field.")}},o.prototype.getDataModelHelper=function(){return this.naturalBaseRef.getDataModelHelper()},o.prototype.validOrAndCondition=function(t,e,n){if(!(t.conditionType!=="Or"&&t.conditionType!=="And"||n!==0&&n!==e.length-1&&e[n-1].conditionType!=="BeginGroup"&&e[n-1].conditionType!=="Or"&&e[n-1].conditionType!=="And"))throw h.build('near "'+t.conditionType+'": syntax error.')},o.prototype.validBeginOrEndGroup=function(t,e,n,r){if(t.conditionType==="BeginGroup"&&r++,t.conditionType==="EndGroup"){if(--r<0)throw h.build("The query beginGroup and endGroup should come in pairs with right direction.");var i=e[n-1].conditionType;if(i==="BeginGroup"||i==="Or"||i==="And")throw h.build('near "'+t.conditionType+'": syntax error.')}return r},o.prototype.addCondition=function(t,e,n,r){if(t.length>=30)throw h.build("Query type exceeds the limit.");var i={conditionType:e,fieldName:n,value:r};t.push(i)},o}();let K=Or;K.util.Long=L,K.configure();const I=K.Reader,$=K.Writer,f=K.util,p=K.roots.default||(K.roots.default={}),W=p.naturalcloudsyncv2=(()=>{const o={};return o.Schema=function(){function t(e){if(this.fs=[],e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.n="",t.prototype.fs=f.emptyArray,t.create=function(e){return new t(e)},t.encode=function(e,n){if(n||(n=$.create()),e.n!=null&&Object.hasOwnProperty.call(e,"n")&&n.uint32(10).string(e.n),e.fs!=null&&e.fs.length)for(let r=0;r<e.fs.length;++r)p.naturalcloudsyncv2.SchemaField.encode(e.fs[r],n.uint32(18).fork()).ldelim();return n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.Schema;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.n=e.string();break;case 2:i.fs&&i.fs.length||(i.fs=[]),i.fs.push(p.naturalcloudsyncv2.SchemaField.decode(e,e.uint32()));break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.n!=null&&e.hasOwnProperty("n")&&!f.isString(e.n))return"n: string expected";if(e.fs!=null&&e.hasOwnProperty("fs")){if(!Array.isArray(e.fs))return"fs: array expected";for(let n=0;n<e.fs.length;++n){let r=p.naturalcloudsyncv2.SchemaField.verify(e.fs[n]);if(r)return"fs."+r}}return null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.Schema)return e;let n=new p.naturalcloudsyncv2.Schema;if(e.n!=null&&(n.n=String(e.n)),e.fs){if(!Array.isArray(e.fs))throw TypeError(".naturalcloudsyncv2.Schema.fs: array expected");n.fs=[];for(let r=0;r<e.fs.length;++r){if(typeof e.fs[r]!="object")throw TypeError(".naturalcloudsyncv2.Schema.fs: object expected");n.fs[r]=p.naturalcloudsyncv2.SchemaField.fromObject(e.fs[r])}}return n},t.toObject=function(e,n){n||(n={});let r={};if((n.arrays||n.defaults)&&(r.fs=[]),n.defaults&&(r.n=""),e.n!=null&&e.hasOwnProperty("n")&&(r.n=e.n),e.fs&&e.fs.length){r.fs=[];for(let i=0;i<e.fs.length;++i)r.fs[i]=p.naturalcloudsyncv2.SchemaField.toObject(e.fs[i],n)}return r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.Schema"},t}(),o.SchemaField=function(){function t(n){if(n)for(let r=Object.keys(n),i=0;i<r.length;++i)n[r[i]]!=null&&(this[r[i]]=n[r[i]])}let e;return t.prototype.n="",t.prototype.t=0,t.prototype.p=!1,t.prototype.e=!1,t.prototype.nn=!1,t.prototype.df=!1,t.prototype.bl=null,t.prototype.b=null,t.prototype.st=null,t.prototype.i=null,t.prototype.l=null,t.prototype.f=null,t.prototype.d=null,t.prototype.ba=null,t.prototype.s=null,Object.defineProperty(t.prototype,"defaultValue",{get:f.oneOfGetter(e=["bl","b","st","i","l","f","d","ba","s"]),set:f.oneOfSetter(e)}),t.create=function(n){return new t(n)},t.encode=function(n,r){return r||(r=$.create()),n.n!=null&&Object.hasOwnProperty.call(n,"n")&&r.uint32(10).string(n.n),n.t!=null&&Object.hasOwnProperty.call(n,"t")&&r.uint32(16).int32(n.t),n.p!=null&&Object.hasOwnProperty.call(n,"p")&&r.uint32(24).bool(n.p),n.e!=null&&Object.hasOwnProperty.call(n,"e")&&r.uint32(32).bool(n.e),n.nn!=null&&Object.hasOwnProperty.call(n,"nn")&&r.uint32(40).bool(n.nn),n.df!=null&&Object.hasOwnProperty.call(n,"df")&&r.uint32(48).bool(n.df),n.bl!=null&&Object.hasOwnProperty.call(n,"bl")&&r.uint32(56).bool(n.bl),n.b!=null&&Object.hasOwnProperty.call(n,"b")&&r.uint32(64).int32(n.b),n.st!=null&&Object.hasOwnProperty.call(n,"st")&&r.uint32(72).int32(n.st),n.i!=null&&Object.hasOwnProperty.call(n,"i")&&r.uint32(80).int32(n.i),n.l!=null&&Object.hasOwnProperty.call(n,"l")&&r.uint32(88).int64(n.l),n.f!=null&&Object.hasOwnProperty.call(n,"f")&&r.uint32(101).float(n.f),n.d!=null&&Object.hasOwnProperty.call(n,"d")&&r.uint32(105).double(n.d),n.ba!=null&&Object.hasOwnProperty.call(n,"ba")&&r.uint32(114).bytes(n.ba),n.s!=null&&Object.hasOwnProperty.call(n,"s")&&r.uint32(122).string(n.s),r},t.encodeDelimited=function(n,r){return this.encode(n,r).ldelim()},t.decode=function(n,r){n instanceof I||(n=I.create(n));let i=r===void 0?n.len:n.pos+r,s=new p.naturalcloudsyncv2.SchemaField;for(;n.pos<i;){let a=n.uint32();switch(a>>>3){case 1:s.n=n.string();break;case 2:s.t=n.int32();break;case 3:s.p=n.bool();break;case 4:s.e=n.bool();break;case 5:s.nn=n.bool();break;case 6:s.df=n.bool();break;case 7:s.bl=n.bool();break;case 8:s.b=n.int32();break;case 9:s.st=n.int32();break;case 10:s.i=n.int32();break;case 11:s.l=n.int64();break;case 12:s.f=n.float();break;case 13:s.d=n.double();break;case 14:s.ba=n.bytes();break;case 15:s.s=n.string();break;default:n.skipType(7&a)}}return s},t.decodeDelimited=function(n){return n instanceof I||(n=new I(n)),this.decode(n,n.uint32())},t.verify=function(n){if(typeof n!="object"||n===null)return"object expected";let r={};if(n.n!=null&&n.hasOwnProperty("n")&&!f.isString(n.n))return"n: string expected";if(n.t!=null&&n.hasOwnProperty("t"))switch(n.t){default:return"t: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:}if(n.p!=null&&n.hasOwnProperty("p")&&typeof n.p!="boolean")return"p: boolean expected";if(n.e!=null&&n.hasOwnProperty("e")&&typeof n.e!="boolean")return"e: boolean expected";if(n.nn!=null&&n.hasOwnProperty("nn")&&typeof n.nn!="boolean")return"nn: boolean expected";if(n.df!=null&&n.hasOwnProperty("df")&&typeof n.df!="boolean")return"df: boolean expected";if(n.bl!=null&&n.hasOwnProperty("bl")&&(r.defaultValue=1,typeof n.bl!="boolean"))return"bl: boolean expected";if(n.b!=null&&n.hasOwnProperty("b")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!f.isInteger(n.b))return"b: integer expected"}if(n.st!=null&&n.hasOwnProperty("st")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!f.isInteger(n.st))return"st: integer expected"}if(n.i!=null&&n.hasOwnProperty("i")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!f.isInteger(n.i))return"i: integer expected"}if(n.l!=null&&n.hasOwnProperty("l")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!(f.isInteger(n.l)||n.l&&f.isInteger(n.l.low)&&f.isInteger(n.l.high)))return"l: integer|Long expected"}if(n.f!=null&&n.hasOwnProperty("f")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,typeof n.f!="number")return"f: number expected"}if(n.d!=null&&n.hasOwnProperty("d")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,typeof n.d!="number")return"d: number expected"}if(n.ba!=null&&n.hasOwnProperty("ba")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!(n.ba&&typeof n.ba.length=="number"||f.isString(n.ba)))return"ba: buffer expected"}if(n.s!=null&&n.hasOwnProperty("s")){if(r.defaultValue===1)return"defaultValue: multiple values";if(r.defaultValue=1,!f.isString(n.s))return"s: string expected"}return null},t.fromObject=function(n){if(n instanceof p.naturalcloudsyncv2.SchemaField)return n;let r=new p.naturalcloudsyncv2.SchemaField;switch(n.n!=null&&(r.n=String(n.n)),n.t){default:if(typeof n.t=="number"){r.t=n.t;break}break;case"TYPE_DEFAULT":case 0:r.t=0;break;case"TYPE_BOOLEAN":case 1:r.t=1;break;case"TYPE_BYTE":case 2:r.t=2;break;case"TYPE_SHORT":case 3:r.t=3;break;case"TYPE_INT32":case 4:r.t=4;break;case"TYPE_LONG":case 5:r.t=5;break;case"TYPE_FLOAT":case 6:r.t=6;break;case"TYPE_DOUBLE":case 7:r.t=7;break;case"TYPE_BYTE_ARRAY":case 8:r.t=8;break;case"TYPE_STRING":case 9:r.t=9;break;case"TYPE_DATE":case 10:r.t=10;break;case"TYPE_TEXT":case 11:r.t=11;break;case"TYPE_AUTO_INCREMENT_INT":case 12:r.t=12;break;case"TYPE_AUTO_INCREMENT_LONG":case 13:r.t=13}return n.p!=null&&(r.p=!!n.p),n.e!=null&&(r.e=!!n.e),n.nn!=null&&(r.nn=!!n.nn),n.df!=null&&(r.df=!!n.df),n.bl!=null&&(r.bl=!!n.bl),n.b!=null&&(r.b=0|n.b),n.st!=null&&(r.st=0|n.st),n.i!=null&&(r.i=0|n.i),n.l!=null&&(f.Long?(r.l=f.Long.fromValue(n.l)).unsigned=!1:typeof n.l=="string"?r.l=parseInt(n.l,10):typeof n.l=="number"?r.l=n.l:typeof n.l=="object"&&(r.l=new f.LongBits(n.l.low>>>0,n.l.high>>>0).toNumber())),n.f!=null&&(r.f=Number(n.f)),n.d!=null&&(r.d=Number(n.d)),n.ba!=null&&(typeof n.ba=="string"?f.base64.decode(n.ba,r.ba=f.newBuffer(f.base64.length(n.ba)),0):n.ba.length>=0&&(r.ba=n.ba)),n.s!=null&&(r.s=String(n.s)),r},t.toObject=function(n,r){r||(r={});let i={};return r.defaults&&(i.n="",i.t=r.enums===String?"TYPE_DEFAULT":0,i.p=!1,i.e=!1,i.nn=!1,i.df=!1),n.n!=null&&n.hasOwnProperty("n")&&(i.n=n.n),n.t!=null&&n.hasOwnProperty("t")&&(i.t=r.enums===String?p.naturalcloudsyncv2.FieldType[n.t]===void 0?n.t:p.naturalcloudsyncv2.FieldType[n.t]:n.t),n.p!=null&&n.hasOwnProperty("p")&&(i.p=n.p),n.e!=null&&n.hasOwnProperty("e")&&(i.e=n.e),n.nn!=null&&n.hasOwnProperty("nn")&&(i.nn=n.nn),n.df!=null&&n.hasOwnProperty("df")&&(i.df=n.df),n.bl!=null&&n.hasOwnProperty("bl")&&(i.bl=n.bl,r.oneofs&&(i.defaultValue="bl")),n.b!=null&&n.hasOwnProperty("b")&&(i.b=n.b,r.oneofs&&(i.defaultValue="b")),n.st!=null&&n.hasOwnProperty("st")&&(i.st=n.st,r.oneofs&&(i.defaultValue="st")),n.i!=null&&n.hasOwnProperty("i")&&(i.i=n.i,r.oneofs&&(i.defaultValue="i")),n.l!=null&&n.hasOwnProperty("l")&&(typeof n.l=="number"?i.l=r.longs===String?String(n.l):n.l:i.l=r.longs===String?f.Long.prototype.toString.call(n.l):r.longs===Number?new f.LongBits(n.l.low>>>0,n.l.high>>>0).toNumber():n.l,r.oneofs&&(i.defaultValue="l")),n.f!=null&&n.hasOwnProperty("f")&&(i.f=r.json&&!isFinite(n.f)?String(n.f):n.f,r.oneofs&&(i.defaultValue="f")),n.d!=null&&n.hasOwnProperty("d")&&(i.d=r.json&&!isFinite(n.d)?String(n.d):n.d,r.oneofs&&(i.defaultValue="d")),n.ba!=null&&n.hasOwnProperty("ba")&&(i.ba=r.bytes===String?f.base64.encode(n.ba,0,n.ba.length):r.bytes===Array?Array.prototype.slice.call(n.ba):n.ba,r.oneofs&&(i.defaultValue="ba")),n.s!=null&&n.hasOwnProperty("s")&&(i.s=n.s,r.oneofs&&(i.defaultValue="s")),i},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/naturalcloudsyncv2.SchemaField"},t}(),o.FieldType=function(){const t={},e=Object.create(t);return e[t[0]="TYPE_DEFAULT"]=0,e[t[1]="TYPE_BOOLEAN"]=1,e[t[2]="TYPE_BYTE"]=2,e[t[3]="TYPE_SHORT"]=3,e[t[4]="TYPE_INT32"]=4,e[t[5]="TYPE_LONG"]=5,e[t[6]="TYPE_FLOAT"]=6,e[t[7]="TYPE_DOUBLE"]=7,e[t[8]="TYPE_BYTE_ARRAY"]=8,e[t[9]="TYPE_STRING"]=9,e[t[10]="TYPE_DATE"]=10,e[t[11]="TYPE_TEXT"]=11,e[t[12]="TYPE_AUTO_INCREMENT_INT"]=12,e[t[13]="TYPE_AUTO_INCREMENT_LONG"]=13,e}(),o.OperationData=function(){function t(e){if(this.os=[],e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.os=f.emptyArray,t.prototype.t=0,t.prototype.i=0,t.create=function(e){return new t(e)},t.encode=function(e,n){if(n||(n=$.create()),e.os!=null&&e.os.length)for(let r=0;r<e.os.length;++r)p.naturalcloudsyncv2.Obj.encode(e.os[r],n.uint32(10).fork()).ldelim();return e.t!=null&&Object.hasOwnProperty.call(e,"t")&&n.uint32(16).int32(e.t),e.i!=null&&Object.hasOwnProperty.call(e,"i")&&n.uint32(24).int32(e.i),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.OperationData;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.os&&i.os.length||(i.os=[]),i.os.push(p.naturalcloudsyncv2.Obj.decode(e,e.uint32()));break;case 2:i.t=e.int32();break;case 3:i.i=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.os!=null&&e.hasOwnProperty("os")){if(!Array.isArray(e.os))return"os: array expected";for(let n=0;n<e.os.length;++n){let r=p.naturalcloudsyncv2.Obj.verify(e.os[n]);if(r)return"os."+r}}return e.t!=null&&e.hasOwnProperty("t")&&!f.isInteger(e.t)?"t: integer expected":e.i!=null&&e.hasOwnProperty("i")&&!f.isInteger(e.i)?"i: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.OperationData)return e;let n=new p.naturalcloudsyncv2.OperationData;if(e.os){if(!Array.isArray(e.os))throw TypeError(".naturalcloudsyncv2.OperationData.os: array expected");n.os=[];for(let r=0;r<e.os.length;++r){if(typeof e.os[r]!="object")throw TypeError(".naturalcloudsyncv2.OperationData.os: object expected");n.os[r]=p.naturalcloudsyncv2.Obj.fromObject(e.os[r])}}return e.t!=null&&(n.t=0|e.t),e.i!=null&&(n.i=0|e.i),n},t.toObject=function(e,n){n||(n={});let r={};if((n.arrays||n.defaults)&&(r.os=[]),n.defaults&&(r.t=0,r.i=0),e.os&&e.os.length){r.os=[];for(let i=0;i<e.os.length;++i)r.os[i]=p.naturalcloudsyncv2.Obj.toObject(e.os[i],n)}return e.t!=null&&e.hasOwnProperty("t")&&(r.t=e.t),e.i!=null&&e.hasOwnProperty("i")&&(r.i=e.i),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.OperationData"},t}(),o.Obj=function(){function t(e){if(this.fs=[],e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.fs=f.emptyArray,t.prototype.i=0,t.create=function(e){return new t(e)},t.encode=function(e,n){if(n||(n=$.create()),e.fs!=null&&e.fs.length)for(let r=0;r<e.fs.length;++r)p.naturalcloudsyncv2.Field.encode(e.fs[r],n.uint32(10).fork()).ldelim();return e.i!=null&&Object.hasOwnProperty.call(e,"i")&&n.uint32(16).int32(e.i),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.Obj;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.fs&&i.fs.length||(i.fs=[]),i.fs.push(p.naturalcloudsyncv2.Field.decode(e,e.uint32()));break;case 2:i.i=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.fs!=null&&e.hasOwnProperty("fs")){if(!Array.isArray(e.fs))return"fs: array expected";for(let n=0;n<e.fs.length;++n){let r=p.naturalcloudsyncv2.Field.verify(e.fs[n]);if(r)return"fs."+r}}return e.i!=null&&e.hasOwnProperty("i")&&!f.isInteger(e.i)?"i: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.Obj)return e;let n=new p.naturalcloudsyncv2.Obj;if(e.fs){if(!Array.isArray(e.fs))throw TypeError(".naturalcloudsyncv2.Obj.fs: array expected");n.fs=[];for(let r=0;r<e.fs.length;++r){if(typeof e.fs[r]!="object")throw TypeError(".naturalcloudsyncv2.Obj.fs: object expected");n.fs[r]=p.naturalcloudsyncv2.Field.fromObject(e.fs[r])}}return e.i!=null&&(n.i=0|e.i),n},t.toObject=function(e,n){n||(n={});let r={};if((n.arrays||n.defaults)&&(r.fs=[]),n.defaults&&(r.i=0),e.fs&&e.fs.length){r.fs=[];for(let i=0;i<e.fs.length;++i)r.fs[i]=p.naturalcloudsyncv2.Field.toObject(e.fs[i],n)}return e.i!=null&&e.hasOwnProperty("i")&&(r.i=e.i),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.Obj"},t}(),o.Field=function(){function t(n){if(n)for(let r=Object.keys(n),i=0;i<r.length;++i)n[r[i]]!=null&&(this[r[i]]=n[r[i]])}let e;return t.prototype.n=!1,t.prototype.bl=null,t.prototype.b=null,t.prototype.st=null,t.prototype.i=null,t.prototype.l=null,t.prototype.f=null,t.prototype.d=null,t.prototype.ba=null,t.prototype.s=null,Object.defineProperty(t.prototype,"value",{get:f.oneOfGetter(e=["bl","b","st","i","l","f","d","ba","s"]),set:f.oneOfSetter(e)}),t.create=function(n){return new t(n)},t.encode=function(n,r){return r||(r=$.create()),n.n!=null&&Object.hasOwnProperty.call(n,"n")&&r.uint32(8).bool(n.n),n.bl!=null&&Object.hasOwnProperty.call(n,"bl")&&r.uint32(16).bool(n.bl),n.b!=null&&Object.hasOwnProperty.call(n,"b")&&r.uint32(24).int32(n.b),n.st!=null&&Object.hasOwnProperty.call(n,"st")&&r.uint32(32).int32(n.st),n.i!=null&&Object.hasOwnProperty.call(n,"i")&&r.uint32(40).int32(n.i),n.l!=null&&Object.hasOwnProperty.call(n,"l")&&r.uint32(48).int64(n.l),n.f!=null&&Object.hasOwnProperty.call(n,"f")&&r.uint32(61).float(n.f),n.d!=null&&Object.hasOwnProperty.call(n,"d")&&r.uint32(65).double(n.d),n.ba!=null&&Object.hasOwnProperty.call(n,"ba")&&r.uint32(74).bytes(n.ba),n.s!=null&&Object.hasOwnProperty.call(n,"s")&&r.uint32(82).string(n.s),r},t.encodeDelimited=function(n,r){return this.encode(n,r).ldelim()},t.decode=function(n,r){n instanceof I||(n=I.create(n));let i=r===void 0?n.len:n.pos+r,s=new p.naturalcloudsyncv2.Field;for(;n.pos<i;){let a=n.uint32();switch(a>>>3){case 1:s.n=n.bool();break;case 2:s.bl=n.bool();break;case 3:s.b=n.int32();break;case 4:s.st=n.int32();break;case 5:s.i=n.int32();break;case 6:s.l=n.int64();break;case 7:s.f=n.float();break;case 8:s.d=n.double();break;case 9:s.ba=n.bytes();break;case 10:s.s=n.string();break;default:n.skipType(7&a)}}return s},t.decodeDelimited=function(n){return n instanceof I||(n=new I(n)),this.decode(n,n.uint32())},t.verify=function(n){if(typeof n!="object"||n===null)return"object expected";let r={};if(n.n!=null&&n.hasOwnProperty("n")&&typeof n.n!="boolean")return"n: boolean expected";if(n.bl!=null&&n.hasOwnProperty("bl")&&(r.value=1,typeof n.bl!="boolean"))return"bl: boolean expected";if(n.b!=null&&n.hasOwnProperty("b")){if(r.value===1)return"value: multiple values";if(r.value=1,!f.isInteger(n.b))return"b: integer expected"}if(n.st!=null&&n.hasOwnProperty("st")){if(r.value===1)return"value: multiple values";if(r.value=1,!f.isInteger(n.st))return"st: integer expected"}if(n.i!=null&&n.hasOwnProperty("i")){if(r.value===1)return"value: multiple values";if(r.value=1,!f.isInteger(n.i))return"i: integer expected"}if(n.l!=null&&n.hasOwnProperty("l")){if(r.value===1)return"value: multiple values";if(r.value=1,!(f.isInteger(n.l)||n.l&&f.isInteger(n.l.low)&&f.isInteger(n.l.high)))return"l: integer|Long expected"}if(n.f!=null&&n.hasOwnProperty("f")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof n.f!="number")return"f: number expected"}if(n.d!=null&&n.hasOwnProperty("d")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof n.d!="number")return"d: number expected"}if(n.ba!=null&&n.hasOwnProperty("ba")){if(r.value===1)return"value: multiple values";if(r.value=1,!(n.ba&&typeof n.ba.length=="number"||f.isString(n.ba)))return"ba: buffer expected"}if(n.s!=null&&n.hasOwnProperty("s")){if(r.value===1)return"value: multiple values";if(r.value=1,!f.isString(n.s))return"s: string expected"}return null},t.fromObject=function(n){if(n instanceof p.naturalcloudsyncv2.Field)return n;let r=new p.naturalcloudsyncv2.Field;return n.n!=null&&(r.n=!!n.n),n.bl!=null&&(r.bl=!!n.bl),n.b!=null&&(r.b=0|n.b),n.st!=null&&(r.st=0|n.st),n.i!=null&&(r.i=0|n.i),n.l!=null&&(f.Long?(r.l=f.Long.fromValue(n.l)).unsigned=!1:typeof n.l=="string"?r.l=parseInt(n.l,10):typeof n.l=="number"?r.l=n.l:typeof n.l=="object"&&(r.l=new f.LongBits(n.l.low>>>0,n.l.high>>>0).toNumber())),n.f!=null&&(r.f=Number(n.f)),n.d!=null&&(r.d=Number(n.d)),n.ba!=null&&(typeof n.ba=="string"?f.base64.decode(n.ba,r.ba=f.newBuffer(f.base64.length(n.ba)),0):n.ba.length>=0&&(r.ba=n.ba)),n.s!=null&&(r.s=String(n.s)),r},t.toObject=function(n,r){r||(r={});let i={};return r.defaults&&(i.n=!1),n.n!=null&&n.hasOwnProperty("n")&&(i.n=n.n),n.bl!=null&&n.hasOwnProperty("bl")&&(i.bl=n.bl,r.oneofs&&(i.value="bl")),n.b!=null&&n.hasOwnProperty("b")&&(i.b=n.b,r.oneofs&&(i.value="b")),n.st!=null&&n.hasOwnProperty("st")&&(i.st=n.st,r.oneofs&&(i.value="st")),n.i!=null&&n.hasOwnProperty("i")&&(i.i=n.i,r.oneofs&&(i.value="i")),n.l!=null&&n.hasOwnProperty("l")&&(typeof n.l=="number"?i.l=r.longs===String?String(n.l):n.l:i.l=r.longs===String?f.Long.prototype.toString.call(n.l):r.longs===Number?new f.LongBits(n.l.low>>>0,n.l.high>>>0).toNumber():n.l,r.oneofs&&(i.value="l")),n.f!=null&&n.hasOwnProperty("f")&&(i.f=r.json&&!isFinite(n.f)?String(n.f):n.f,r.oneofs&&(i.value="f")),n.d!=null&&n.hasOwnProperty("d")&&(i.d=r.json&&!isFinite(n.d)?String(n.d):n.d,r.oneofs&&(i.value="d")),n.ba!=null&&n.hasOwnProperty("ba")&&(i.ba=r.bytes===String?f.base64.encode(n.ba,0,n.ba.length):r.bytes===Array?Array.prototype.slice.call(n.ba):n.ba,r.oneofs&&(i.value="ba")),n.s!=null&&n.hasOwnProperty("s")&&(i.s=n.s,r.oneofs&&(i.value="s")),i},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/naturalcloudsyncv2.Field"},t}(),o.MessageInfo=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.id=f.Long?f.Long.fromBits(0,0,!1):0,t.prototype.type=0,t.prototype.subType=0,t.prototype.opStore=null,t.prototype.traceId="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.id!=null&&Object.hasOwnProperty.call(e,"id")&&n.uint32(8).int64(e.id),e.type!=null&&Object.hasOwnProperty.call(e,"type")&&n.uint32(16).int32(e.type),e.subType!=null&&Object.hasOwnProperty.call(e,"subType")&&n.uint32(24).int32(e.subType),e.opStore!=null&&Object.hasOwnProperty.call(e,"opStore")&&p.naturalcloudsyncv2.Store.encode(e.opStore,n.uint32(34).fork()).ldelim(),e.traceId!=null&&Object.hasOwnProperty.call(e,"traceId")&&n.uint32(42).string(e.traceId),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.MessageInfo;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.id=e.int64();break;case 2:i.type=e.int32();break;case 3:i.subType=e.int32();break;case 4:i.opStore=p.naturalcloudsyncv2.Store.decode(e,e.uint32());break;case 5:i.traceId=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.id!=null&&e.hasOwnProperty("id")&&!(f.isInteger(e.id)||e.id&&f.isInteger(e.id.low)&&f.isInteger(e.id.high)))return"id: integer|Long expected";if(e.type!=null&&e.hasOwnProperty("type")&&!f.isInteger(e.type))return"type: integer expected";if(e.subType!=null&&e.hasOwnProperty("subType")&&!f.isInteger(e.subType))return"subType: integer expected";if(e.opStore!=null&&e.hasOwnProperty("opStore")){let n=p.naturalcloudsyncv2.Store.verify(e.opStore);if(n)return"opStore."+n}return e.traceId!=null&&e.hasOwnProperty("traceId")&&!f.isString(e.traceId)?"traceId: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.MessageInfo)return e;let n=new p.naturalcloudsyncv2.MessageInfo;if(e.id!=null&&(f.Long?(n.id=f.Long.fromValue(e.id)).unsigned=!1:typeof e.id=="string"?n.id=parseInt(e.id,10):typeof e.id=="number"?n.id=e.id:typeof e.id=="object"&&(n.id=new f.LongBits(e.id.low>>>0,e.id.high>>>0).toNumber())),e.type!=null&&(n.type=0|e.type),e.subType!=null&&(n.subType=0|e.subType),e.opStore!=null){if(typeof e.opStore!="object")throw TypeError(".naturalcloudsyncv2.MessageInfo.opStore: object expected");n.opStore=p.naturalcloudsyncv2.Store.fromObject(e.opStore)}return e.traceId!=null&&(n.traceId=String(e.traceId)),n},t.toObject=function(e,n){n||(n={});let r={};if(n.defaults){if(f.Long){let i=new f.Long(0,0,!1);r.id=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else r.id=n.longs===String?"0":0;r.type=0,r.subType=0,r.opStore=null,r.traceId=""}return e.id!=null&&e.hasOwnProperty("id")&&(typeof e.id=="number"?r.id=n.longs===String?String(e.id):e.id:r.id=n.longs===String?f.Long.prototype.toString.call(e.id):n.longs===Number?new f.LongBits(e.id.low>>>0,e.id.high>>>0).toNumber():e.id),e.type!=null&&e.hasOwnProperty("type")&&(r.type=e.type),e.subType!=null&&e.hasOwnProperty("subType")&&(r.subType=e.subType),e.opStore!=null&&e.hasOwnProperty("opStore")&&(r.opStore=p.naturalcloudsyncv2.Store.toObject(e.opStore,n)),e.traceId!=null&&e.hasOwnProperty("traceId")&&(r.traceId=e.traceId),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.MessageInfo"},t}(),o.Store=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.storeName="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.storeName!=null&&Object.hasOwnProperty.call(e,"storeName")&&n.uint32(10).string(e.storeName),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.Store;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.storeName=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.storeName!=null&&e.hasOwnProperty("storeName")&&!f.isString(e.storeName)?"storeName: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.Store)return e;let n=new p.naturalcloudsyncv2.Store;return e.storeName!=null&&(n.storeName=String(e.storeName)),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.storeName=""),e.storeName!=null&&e.hasOwnProperty("storeName")&&(r.storeName=e.storeName),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.Store"},t}(),o.EncryptionInfo=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.keyStatus=0,t.prototype.firstSalt=f.newBuffer([]),t.prototype.secondSalt=f.newBuffer([]),t.prototype.rootToken=f.newBuffer([]),t.prototype.cipherText=f.newBuffer([]),t.prototype.oldCipherText=f.newBuffer([]),t.prototype.keyVer=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.keyStatus!=null&&Object.hasOwnProperty.call(e,"keyStatus")&&n.uint32(8).int32(e.keyStatus),e.firstSalt!=null&&Object.hasOwnProperty.call(e,"firstSalt")&&n.uint32(18).bytes(e.firstSalt),e.secondSalt!=null&&Object.hasOwnProperty.call(e,"secondSalt")&&n.uint32(26).bytes(e.secondSalt),e.rootToken!=null&&Object.hasOwnProperty.call(e,"rootToken")&&n.uint32(34).bytes(e.rootToken),e.cipherText!=null&&Object.hasOwnProperty.call(e,"cipherText")&&n.uint32(42).bytes(e.cipherText),e.oldCipherText!=null&&Object.hasOwnProperty.call(e,"oldCipherText")&&n.uint32(50).bytes(e.oldCipherText),e.keyVer!=null&&Object.hasOwnProperty.call(e,"keyVer")&&n.uint32(56).int32(e.keyVer),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.EncryptionInfo;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.keyStatus=e.int32();break;case 2:i.firstSalt=e.bytes();break;case 3:i.secondSalt=e.bytes();break;case 4:i.rootToken=e.bytes();break;case 5:i.cipherText=e.bytes();break;case 6:i.oldCipherText=e.bytes();break;case 7:i.keyVer=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.keyStatus!=null&&e.hasOwnProperty("keyStatus")&&!f.isInteger(e.keyStatus)?"keyStatus: integer expected":e.firstSalt!=null&&e.hasOwnProperty("firstSalt")&&!(e.firstSalt&&typeof e.firstSalt.length=="number"||f.isString(e.firstSalt))?"firstSalt: buffer expected":e.secondSalt!=null&&e.hasOwnProperty("secondSalt")&&!(e.secondSalt&&typeof e.secondSalt.length=="number"||f.isString(e.secondSalt))?"secondSalt: buffer expected":e.rootToken!=null&&e.hasOwnProperty("rootToken")&&!(e.rootToken&&typeof e.rootToken.length=="number"||f.isString(e.rootToken))?"rootToken: buffer expected":e.cipherText!=null&&e.hasOwnProperty("cipherText")&&!(e.cipherText&&typeof e.cipherText.length=="number"||f.isString(e.cipherText))?"cipherText: buffer expected":e.oldCipherText!=null&&e.hasOwnProperty("oldCipherText")&&!(e.oldCipherText&&typeof e.oldCipherText.length=="number"||f.isString(e.oldCipherText))?"oldCipherText: buffer expected":e.keyVer!=null&&e.hasOwnProperty("keyVer")&&!f.isInteger(e.keyVer)?"keyVer: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.EncryptionInfo)return e;let n=new p.naturalcloudsyncv2.EncryptionInfo;return e.keyStatus!=null&&(n.keyStatus=0|e.keyStatus),e.firstSalt!=null&&(typeof e.firstSalt=="string"?f.base64.decode(e.firstSalt,n.firstSalt=f.newBuffer(f.base64.length(e.firstSalt)),0):e.firstSalt.length>=0&&(n.firstSalt=e.firstSalt)),e.secondSalt!=null&&(typeof e.secondSalt=="string"?f.base64.decode(e.secondSalt,n.secondSalt=f.newBuffer(f.base64.length(e.secondSalt)),0):e.secondSalt.length>=0&&(n.secondSalt=e.secondSalt)),e.rootToken!=null&&(typeof e.rootToken=="string"?f.base64.decode(e.rootToken,n.rootToken=f.newBuffer(f.base64.length(e.rootToken)),0):e.rootToken.length>=0&&(n.rootToken=e.rootToken)),e.cipherText!=null&&(typeof e.cipherText=="string"?f.base64.decode(e.cipherText,n.cipherText=f.newBuffer(f.base64.length(e.cipherText)),0):e.cipherText.length>=0&&(n.cipherText=e.cipherText)),e.oldCipherText!=null&&(typeof e.oldCipherText=="string"?f.base64.decode(e.oldCipherText,n.oldCipherText=f.newBuffer(f.base64.length(e.oldCipherText)),0):e.oldCipherText.length>=0&&(n.oldCipherText=e.oldCipherText)),e.keyVer!=null&&(n.keyVer=0|e.keyVer),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.keyStatus=0,n.bytes===String?r.firstSalt="":(r.firstSalt=[],n.bytes!==Array&&(r.firstSalt=f.newBuffer(r.firstSalt))),n.bytes===String?r.secondSalt="":(r.secondSalt=[],n.bytes!==Array&&(r.secondSalt=f.newBuffer(r.secondSalt))),n.bytes===String?r.rootToken="":(r.rootToken=[],n.bytes!==Array&&(r.rootToken=f.newBuffer(r.rootToken))),n.bytes===String?r.cipherText="":(r.cipherText=[],n.bytes!==Array&&(r.cipherText=f.newBuffer(r.cipherText))),n.bytes===String?r.oldCipherText="":(r.oldCipherText=[],n.bytes!==Array&&(r.oldCipherText=f.newBuffer(r.oldCipherText))),r.keyVer=0),e.keyStatus!=null&&e.hasOwnProperty("keyStatus")&&(r.keyStatus=e.keyStatus),e.firstSalt!=null&&e.hasOwnProperty("firstSalt")&&(r.firstSalt=n.bytes===String?f.base64.encode(e.firstSalt,0,e.firstSalt.length):n.bytes===Array?Array.prototype.slice.call(e.firstSalt):e.firstSalt),e.secondSalt!=null&&e.hasOwnProperty("secondSalt")&&(r.secondSalt=n.bytes===String?f.base64.encode(e.secondSalt,0,e.secondSalt.length):n.bytes===Array?Array.prototype.slice.call(e.secondSalt):e.secondSalt),e.rootToken!=null&&e.hasOwnProperty("rootToken")&&(r.rootToken=n.bytes===String?f.base64.encode(e.rootToken,0,e.rootToken.length):n.bytes===Array?Array.prototype.slice.call(e.rootToken):e.rootToken),e.cipherText!=null&&e.hasOwnProperty("cipherText")&&(r.cipherText=n.bytes===String?f.base64.encode(e.cipherText,0,e.cipherText.length):n.bytes===Array?Array.prototype.slice.call(e.cipherText):e.cipherText),e.oldCipherText!=null&&e.hasOwnProperty("oldCipherText")&&(r.oldCipherText=n.bytes===String?f.base64.encode(e.oldCipherText,0,e.oldCipherText.length):n.bytes===Array?Array.prototype.slice.call(e.oldCipherText):e.oldCipherText),e.keyVer!=null&&e.hasOwnProperty("keyVer")&&(r.keyVer=e.keyVer),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.EncryptionInfo"},t}(),o.SyncRequestMessage=function(){function t(e){if(this.schemas=[],this.opData=[],this.subReqMsg=[],this.unSubReqMsg=[],this.enReqInfo=[],e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.msgInfo=null,t.prototype.clientInfo=null,t.prototype.schemas=f.emptyArray,t.prototype.opData=f.emptyArray,t.prototype.queryReqMsg=null,t.prototype.subReqMsg=f.emptyArray,t.prototype.unSubReqMsg=f.emptyArray,t.prototype.enReqInfo=f.emptyArray,t.create=function(e){return new t(e)},t.encode=function(e,n){if(n||(n=$.create()),e.msgInfo!=null&&Object.hasOwnProperty.call(e,"msgInfo")&&p.naturalcloudsyncv2.MessageInfo.encode(e.msgInfo,n.uint32(10).fork()).ldelim(),e.clientInfo!=null&&Object.hasOwnProperty.call(e,"clientInfo")&&p.naturalcloudsyncv2.ClientInfo.encode(e.clientInfo,n.uint32(18).fork()).ldelim(),e.schemas!=null&&e.schemas.length)for(let r=0;r<e.schemas.length;++r)p.naturalcloudsyncv2.Schema.encode(e.schemas[r],n.uint32(26).fork()).ldelim();if(e.opData!=null&&e.opData.length)for(let r=0;r<e.opData.length;++r)p.naturalcloudsyncv2.OperationData.encode(e.opData[r],n.uint32(34).fork()).ldelim();if(e.queryReqMsg!=null&&Object.hasOwnProperty.call(e,"queryReqMsg")&&p.naturalcloudsyncv2.QueryRequestMessage.encode(e.queryReqMsg,n.uint32(42).fork()).ldelim(),e.subReqMsg!=null&&e.subReqMsg.length)for(let r=0;r<e.subReqMsg.length;++r)p.naturalcloudsyncv2.SubscribeRequestMessage.encode(e.subReqMsg[r],n.uint32(50).fork()).ldelim();if(e.unSubReqMsg!=null&&e.unSubReqMsg.length)for(let r=0;r<e.unSubReqMsg.length;++r)p.naturalcloudsyncv2.UnsubscribeRequestMessage.encode(e.unSubReqMsg[r],n.uint32(58).fork()).ldelim();if(e.enReqInfo!=null&&e.enReqInfo.length)for(let r=0;r<e.enReqInfo.length;++r)p.naturalcloudsyncv2.EncryptionInfo.encode(e.enReqInfo[r],n.uint32(66).fork()).ldelim();return n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.SyncRequestMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.msgInfo=p.naturalcloudsyncv2.MessageInfo.decode(e,e.uint32());break;case 2:i.clientInfo=p.naturalcloudsyncv2.ClientInfo.decode(e,e.uint32());break;case 3:i.schemas&&i.schemas.length||(i.schemas=[]),i.schemas.push(p.naturalcloudsyncv2.Schema.decode(e,e.uint32()));break;case 4:i.opData&&i.opData.length||(i.opData=[]),i.opData.push(p.naturalcloudsyncv2.OperationData.decode(e,e.uint32()));break;case 5:i.queryReqMsg=p.naturalcloudsyncv2.QueryRequestMessage.decode(e,e.uint32());break;case 6:i.subReqMsg&&i.subReqMsg.length||(i.subReqMsg=[]),i.subReqMsg.push(p.naturalcloudsyncv2.SubscribeRequestMessage.decode(e,e.uint32()));break;case 7:i.unSubReqMsg&&i.unSubReqMsg.length||(i.unSubReqMsg=[]),i.unSubReqMsg.push(p.naturalcloudsyncv2.UnsubscribeRequestMessage.decode(e,e.uint32()));break;case 8:i.enReqInfo&&i.enReqInfo.length||(i.enReqInfo=[]),i.enReqInfo.push(p.naturalcloudsyncv2.EncryptionInfo.decode(e,e.uint32()));break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.msgInfo!=null&&e.hasOwnProperty("msgInfo")){let n=p.naturalcloudsyncv2.MessageInfo.verify(e.msgInfo);if(n)return"msgInfo."+n}if(e.clientInfo!=null&&e.hasOwnProperty("clientInfo")){let n=p.naturalcloudsyncv2.ClientInfo.verify(e.clientInfo);if(n)return"clientInfo."+n}if(e.schemas!=null&&e.hasOwnProperty("schemas")){if(!Array.isArray(e.schemas))return"schemas: array expected";for(let n=0;n<e.schemas.length;++n){let r=p.naturalcloudsyncv2.Schema.verify(e.schemas[n]);if(r)return"schemas."+r}}if(e.opData!=null&&e.hasOwnProperty("opData")){if(!Array.isArray(e.opData))return"opData: array expected";for(let n=0;n<e.opData.length;++n){let r=p.naturalcloudsyncv2.OperationData.verify(e.opData[n]);if(r)return"opData."+r}}if(e.queryReqMsg!=null&&e.hasOwnProperty("queryReqMsg")){let n=p.naturalcloudsyncv2.QueryRequestMessage.verify(e.queryReqMsg);if(n)return"queryReqMsg."+n}if(e.subReqMsg!=null&&e.hasOwnProperty("subReqMsg")){if(!Array.isArray(e.subReqMsg))return"subReqMsg: array expected";for(let n=0;n<e.subReqMsg.length;++n){let r=p.naturalcloudsyncv2.SubscribeRequestMessage.verify(e.subReqMsg[n]);if(r)return"subReqMsg."+r}}if(e.unSubReqMsg!=null&&e.hasOwnProperty("unSubReqMsg")){if(!Array.isArray(e.unSubReqMsg))return"unSubReqMsg: array expected";for(let n=0;n<e.unSubReqMsg.length;++n){let r=p.naturalcloudsyncv2.UnsubscribeRequestMessage.verify(e.unSubReqMsg[n]);if(r)return"unSubReqMsg."+r}}if(e.enReqInfo!=null&&e.hasOwnProperty("enReqInfo")){if(!Array.isArray(e.enReqInfo))return"enReqInfo: array expected";for(let n=0;n<e.enReqInfo.length;++n){let r=p.naturalcloudsyncv2.EncryptionInfo.verify(e.enReqInfo[n]);if(r)return"enReqInfo."+r}}return null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.SyncRequestMessage)return e;let n=new p.naturalcloudsyncv2.SyncRequestMessage;if(e.msgInfo!=null){if(typeof e.msgInfo!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.msgInfo: object expected");n.msgInfo=p.naturalcloudsyncv2.MessageInfo.fromObject(e.msgInfo)}if(e.clientInfo!=null){if(typeof e.clientInfo!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.clientInfo: object expected");n.clientInfo=p.naturalcloudsyncv2.ClientInfo.fromObject(e.clientInfo)}if(e.schemas){if(!Array.isArray(e.schemas))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.schemas: array expected");n.schemas=[];for(let r=0;r<e.schemas.length;++r){if(typeof e.schemas[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.schemas: object expected");n.schemas[r]=p.naturalcloudsyncv2.Schema.fromObject(e.schemas[r])}}if(e.opData){if(!Array.isArray(e.opData))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.opData: array expected");n.opData=[];for(let r=0;r<e.opData.length;++r){if(typeof e.opData[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.opData: object expected");n.opData[r]=p.naturalcloudsyncv2.OperationData.fromObject(e.opData[r])}}if(e.queryReqMsg!=null){if(typeof e.queryReqMsg!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.queryReqMsg: object expected");n.queryReqMsg=p.naturalcloudsyncv2.QueryRequestMessage.fromObject(e.queryReqMsg)}if(e.subReqMsg){if(!Array.isArray(e.subReqMsg))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.subReqMsg: array expected");n.subReqMsg=[];for(let r=0;r<e.subReqMsg.length;++r){if(typeof e.subReqMsg[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.subReqMsg: object expected");n.subReqMsg[r]=p.naturalcloudsyncv2.SubscribeRequestMessage.fromObject(e.subReqMsg[r])}}if(e.unSubReqMsg){if(!Array.isArray(e.unSubReqMsg))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.unSubReqMsg: array expected");n.unSubReqMsg=[];for(let r=0;r<e.unSubReqMsg.length;++r){if(typeof e.unSubReqMsg[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.unSubReqMsg: object expected");n.unSubReqMsg[r]=p.naturalcloudsyncv2.UnsubscribeRequestMessage.fromObject(e.unSubReqMsg[r])}}if(e.enReqInfo){if(!Array.isArray(e.enReqInfo))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.enReqInfo: array expected");n.enReqInfo=[];for(let r=0;r<e.enReqInfo.length;++r){if(typeof e.enReqInfo[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.enReqInfo: object expected");n.enReqInfo[r]=p.naturalcloudsyncv2.EncryptionInfo.fromObject(e.enReqInfo[r])}}return n},t.toObject=function(e,n){n||(n={});let r={};if((n.arrays||n.defaults)&&(r.schemas=[],r.opData=[],r.subReqMsg=[],r.unSubReqMsg=[],r.enReqInfo=[]),n.defaults&&(r.msgInfo=null,r.clientInfo=null,r.queryReqMsg=null),e.msgInfo!=null&&e.hasOwnProperty("msgInfo")&&(r.msgInfo=p.naturalcloudsyncv2.MessageInfo.toObject(e.msgInfo,n)),e.clientInfo!=null&&e.hasOwnProperty("clientInfo")&&(r.clientInfo=p.naturalcloudsyncv2.ClientInfo.toObject(e.clientInfo,n)),e.schemas&&e.schemas.length){r.schemas=[];for(let i=0;i<e.schemas.length;++i)r.schemas[i]=p.naturalcloudsyncv2.Schema.toObject(e.schemas[i],n)}if(e.opData&&e.opData.length){r.opData=[];for(let i=0;i<e.opData.length;++i)r.opData[i]=p.naturalcloudsyncv2.OperationData.toObject(e.opData[i],n)}if(e.queryReqMsg!=null&&e.hasOwnProperty("queryReqMsg")&&(r.queryReqMsg=p.naturalcloudsyncv2.QueryRequestMessage.toObject(e.queryReqMsg,n)),e.subReqMsg&&e.subReqMsg.length){r.subReqMsg=[];for(let i=0;i<e.subReqMsg.length;++i)r.subReqMsg[i]=p.naturalcloudsyncv2.SubscribeRequestMessage.toObject(e.subReqMsg[i],n)}if(e.unSubReqMsg&&e.unSubReqMsg.length){r.unSubReqMsg=[];for(let i=0;i<e.unSubReqMsg.length;++i)r.unSubReqMsg[i]=p.naturalcloudsyncv2.UnsubscribeRequestMessage.toObject(e.unSubReqMsg[i],n)}if(e.enReqInfo&&e.enReqInfo.length){r.enReqInfo=[];for(let i=0;i<e.enReqInfo.length;++i)r.enReqInfo[i]=p.naturalcloudsyncv2.EncryptionInfo.toObject(e.enReqInfo[i],n)}return r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.SyncRequestMessage"},t}(),o.ClientInfo=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.uid="",t.prototype.pid="",t.prototype.cid="",t.prototype.aid="",t.prototype.appVer=f.Long?f.Long.fromBits(0,0,!1):0,t.prototype.msgVer=0,t.prototype.enVer=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.uid!=null&&Object.hasOwnProperty.call(e,"uid")&&n.uint32(10).string(e.uid),e.pid!=null&&Object.hasOwnProperty.call(e,"pid")&&n.uint32(18).string(e.pid),e.cid!=null&&Object.hasOwnProperty.call(e,"cid")&&n.uint32(26).string(e.cid),e.aid!=null&&Object.hasOwnProperty.call(e,"aid")&&n.uint32(34).string(e.aid),e.appVer!=null&&Object.hasOwnProperty.call(e,"appVer")&&n.uint32(40).int64(e.appVer),e.msgVer!=null&&Object.hasOwnProperty.call(e,"msgVer")&&n.uint32(48).int32(e.msgVer),e.enVer!=null&&Object.hasOwnProperty.call(e,"enVer")&&n.uint32(56).int32(e.enVer),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.ClientInfo;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.uid=e.string();break;case 2:i.pid=e.string();break;case 3:i.cid=e.string();break;case 4:i.aid=e.string();break;case 5:i.appVer=e.int64();break;case 6:i.msgVer=e.int32();break;case 7:i.enVer=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.uid!=null&&e.hasOwnProperty("uid")&&!f.isString(e.uid)?"uid: string expected":e.pid!=null&&e.hasOwnProperty("pid")&&!f.isString(e.pid)?"pid: string expected":e.cid!=null&&e.hasOwnProperty("cid")&&!f.isString(e.cid)?"cid: string expected":e.aid!=null&&e.hasOwnProperty("aid")&&!f.isString(e.aid)?"aid: string expected":e.appVer!=null&&e.hasOwnProperty("appVer")&&!(f.isInteger(e.appVer)||e.appVer&&f.isInteger(e.appVer.low)&&f.isInteger(e.appVer.high))?"appVer: integer|Long expected":e.msgVer!=null&&e.hasOwnProperty("msgVer")&&!f.isInteger(e.msgVer)?"msgVer: integer expected":e.enVer!=null&&e.hasOwnProperty("enVer")&&!f.isInteger(e.enVer)?"enVer: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.ClientInfo)return e;let n=new p.naturalcloudsyncv2.ClientInfo;return e.uid!=null&&(n.uid=String(e.uid)),e.pid!=null&&(n.pid=String(e.pid)),e.cid!=null&&(n.cid=String(e.cid)),e.aid!=null&&(n.aid=String(e.aid)),e.appVer!=null&&(f.Long?(n.appVer=f.Long.fromValue(e.appVer)).unsigned=!1:typeof e.appVer=="string"?n.appVer=parseInt(e.appVer,10):typeof e.appVer=="number"?n.appVer=e.appVer:typeof e.appVer=="object"&&(n.appVer=new f.LongBits(e.appVer.low>>>0,e.appVer.high>>>0).toNumber())),e.msgVer!=null&&(n.msgVer=0|e.msgVer),e.enVer!=null&&(n.enVer=0|e.enVer),n},t.toObject=function(e,n){n||(n={});let r={};if(n.defaults){if(r.uid="",r.pid="",r.cid="",r.aid="",f.Long){let i=new f.Long(0,0,!1);r.appVer=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else r.appVer=n.longs===String?"0":0;r.msgVer=0,r.enVer=0}return e.uid!=null&&e.hasOwnProperty("uid")&&(r.uid=e.uid),e.pid!=null&&e.hasOwnProperty("pid")&&(r.pid=e.pid),e.cid!=null&&e.hasOwnProperty("cid")&&(r.cid=e.cid),e.aid!=null&&e.hasOwnProperty("aid")&&(r.aid=e.aid),e.appVer!=null&&e.hasOwnProperty("appVer")&&(typeof e.appVer=="number"?r.appVer=n.longs===String?String(e.appVer):e.appVer:r.appVer=n.longs===String?f.Long.prototype.toString.call(e.appVer):n.longs===Number?new f.LongBits(e.appVer.low>>>0,e.appVer.high>>>0).toNumber():e.appVer),e.msgVer!=null&&e.hasOwnProperty("msgVer")&&(r.msgVer=e.msgVer),e.enVer!=null&&e.hasOwnProperty("enVer")&&(r.enVer=e.enVer),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.ClientInfo"},t}(),o.QueryRequestMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.queryType=0,t.prototype.queryTable="",t.prototype.queryCond="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.queryType!=null&&Object.hasOwnProperty.call(e,"queryType")&&n.uint32(8).int32(e.queryType),e.queryTable!=null&&Object.hasOwnProperty.call(e,"queryTable")&&n.uint32(18).string(e.queryTable),e.queryCond!=null&&Object.hasOwnProperty.call(e,"queryCond")&&n.uint32(26).string(e.queryCond),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.QueryRequestMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.queryType=e.int32();break;case 2:i.queryTable=e.string();break;case 3:i.queryCond=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.queryType!=null&&e.hasOwnProperty("queryType")&&!f.isInteger(e.queryType)?"queryType: integer expected":e.queryTable!=null&&e.hasOwnProperty("queryTable")&&!f.isString(e.queryTable)?"queryTable: string expected":e.queryCond!=null&&e.hasOwnProperty("queryCond")&&!f.isString(e.queryCond)?"queryCond: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.QueryRequestMessage)return e;let n=new p.naturalcloudsyncv2.QueryRequestMessage;return e.queryType!=null&&(n.queryType=0|e.queryType),e.queryTable!=null&&(n.queryTable=String(e.queryTable)),e.queryCond!=null&&(n.queryCond=String(e.queryCond)),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.queryType=0,r.queryTable="",r.queryCond=""),e.queryType!=null&&e.hasOwnProperty("queryType")&&(r.queryType=e.queryType),e.queryTable!=null&&e.hasOwnProperty("queryTable")&&(r.queryTable=e.queryTable),e.queryCond!=null&&e.hasOwnProperty("queryCond")&&(r.queryCond=e.queryCond),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.QueryRequestMessage"},t}(),o.SubscribeRequestMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.subId="",t.prototype.subStore="",t.prototype.subTable="",t.prototype.subCond="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.subId!=null&&Object.hasOwnProperty.call(e,"subId")&&n.uint32(10).string(e.subId),e.subStore!=null&&Object.hasOwnProperty.call(e,"subStore")&&n.uint32(18).string(e.subStore),e.subTable!=null&&Object.hasOwnProperty.call(e,"subTable")&&n.uint32(26).string(e.subTable),e.subCond!=null&&Object.hasOwnProperty.call(e,"subCond")&&n.uint32(34).string(e.subCond),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.SubscribeRequestMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.subId=e.string();break;case 2:i.subStore=e.string();break;case 3:i.subTable=e.string();break;case 4:i.subCond=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.subId!=null&&e.hasOwnProperty("subId")&&!f.isString(e.subId)?"subId: string expected":e.subStore!=null&&e.hasOwnProperty("subStore")&&!f.isString(e.subStore)?"subStore: string expected":e.subTable!=null&&e.hasOwnProperty("subTable")&&!f.isString(e.subTable)?"subTable: string expected":e.subCond!=null&&e.hasOwnProperty("subCond")&&!f.isString(e.subCond)?"subCond: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.SubscribeRequestMessage)return e;let n=new p.naturalcloudsyncv2.SubscribeRequestMessage;return e.subId!=null&&(n.subId=String(e.subId)),e.subStore!=null&&(n.subStore=String(e.subStore)),e.subTable!=null&&(n.subTable=String(e.subTable)),e.subCond!=null&&(n.subCond=String(e.subCond)),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.subId="",r.subStore="",r.subTable="",r.subCond=""),e.subId!=null&&e.hasOwnProperty("subId")&&(r.subId=e.subId),e.subStore!=null&&e.hasOwnProperty("subStore")&&(r.subStore=e.subStore),e.subTable!=null&&e.hasOwnProperty("subTable")&&(r.subTable=e.subTable),e.subCond!=null&&e.hasOwnProperty("subCond")&&(r.subCond=e.subCond),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.SubscribeRequestMessage"},t}(),o.UnsubscribeRequestMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.subRecId="",t.prototype.unSubStore="",t.prototype.unSubTable="",t.prototype.subKey=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.subRecId!=null&&Object.hasOwnProperty.call(e,"subRecId")&&n.uint32(10).string(e.subRecId),e.unSubStore!=null&&Object.hasOwnProperty.call(e,"unSubStore")&&n.uint32(18).string(e.unSubStore),e.unSubTable!=null&&Object.hasOwnProperty.call(e,"unSubTable")&&n.uint32(26).string(e.unSubTable),e.subKey!=null&&Object.hasOwnProperty.call(e,"subKey")&&n.uint32(32).int32(e.subKey),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.UnsubscribeRequestMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.subRecId=e.string();break;case 2:i.unSubStore=e.string();break;case 3:i.unSubTable=e.string();break;case 4:i.subKey=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.subRecId!=null&&e.hasOwnProperty("subRecId")&&!f.isString(e.subRecId)?"subRecId: string expected":e.unSubStore!=null&&e.hasOwnProperty("unSubStore")&&!f.isString(e.unSubStore)?"unSubStore: string expected":e.unSubTable!=null&&e.hasOwnProperty("unSubTable")&&!f.isString(e.unSubTable)?"unSubTable: string expected":e.subKey!=null&&e.hasOwnProperty("subKey")&&!f.isInteger(e.subKey)?"subKey: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.UnsubscribeRequestMessage)return e;let n=new p.naturalcloudsyncv2.UnsubscribeRequestMessage;return e.subRecId!=null&&(n.subRecId=String(e.subRecId)),e.unSubStore!=null&&(n.unSubStore=String(e.unSubStore)),e.unSubTable!=null&&(n.unSubTable=String(e.unSubTable)),e.subKey!=null&&(n.subKey=0|e.subKey),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.subRecId="",r.unSubStore="",r.unSubTable="",r.subKey=0),e.subRecId!=null&&e.hasOwnProperty("subRecId")&&(r.subRecId=e.subRecId),e.unSubStore!=null&&e.hasOwnProperty("unSubStore")&&(r.unSubStore=e.unSubStore),e.unSubTable!=null&&e.hasOwnProperty("unSubTable")&&(r.unSubTable=e.unSubTable),e.subKey!=null&&e.hasOwnProperty("subKey")&&(r.subKey=e.subKey),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.UnsubscribeRequestMessage"},t}(),o.ServerStatus=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.timestamp=f.Long?f.Long.fromBits(0,0,!1):0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.timestamp!=null&&Object.hasOwnProperty.call(e,"timestamp")&&n.uint32(8).int64(e.timestamp),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.ServerStatus;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.timestamp=e.int64();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.timestamp!=null&&e.hasOwnProperty("timestamp")&&!(f.isInteger(e.timestamp)||e.timestamp&&f.isInteger(e.timestamp.low)&&f.isInteger(e.timestamp.high))?"timestamp: integer|Long expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.ServerStatus)return e;let n=new p.naturalcloudsyncv2.ServerStatus;return e.timestamp!=null&&(f.Long?(n.timestamp=f.Long.fromValue(e.timestamp)).unsigned=!1:typeof e.timestamp=="string"?n.timestamp=parseInt(e.timestamp,10):typeof e.timestamp=="number"?n.timestamp=e.timestamp:typeof e.timestamp=="object"&&(n.timestamp=new f.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber())),n},t.toObject=function(e,n){n||(n={});let r={};if(n.defaults)if(f.Long){let i=new f.Long(0,0,!1);r.timestamp=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else r.timestamp=n.longs===String?"0":0;return e.timestamp!=null&&e.hasOwnProperty("timestamp")&&(typeof e.timestamp=="number"?r.timestamp=n.longs===String?String(e.timestamp):e.timestamp:r.timestamp=n.longs===String?f.Long.prototype.toString.call(e.timestamp):n.longs===Number?new f.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber():e.timestamp),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.ServerStatus"},t}(),o.SyncResponseMessage=function(){function t(e){if(this.schemas=[],this.opData=[],this.permRecs=[],this.subResMsg=[],this.unSubResMsg=[],this.enResInfo=[],e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.msgInfo=null,t.prototype.resInfo=null,t.prototype.schemas=f.emptyArray,t.prototype.opData=f.emptyArray,t.prototype.permRecs=f.emptyArray,t.prototype.updateResMsg=null,t.prototype.queryResMsg=null,t.prototype.subResMsg=f.emptyArray,t.prototype.unSubResMsg=f.emptyArray,t.prototype.subPushMsg=null,t.prototype.enResInfo=f.emptyArray,t.prototype.serverStatus=null,t.create=function(e){return new t(e)},t.encode=function(e,n){if(n||(n=$.create()),e.msgInfo!=null&&Object.hasOwnProperty.call(e,"msgInfo")&&p.naturalcloudsyncv2.MessageInfo.encode(e.msgInfo,n.uint32(10).fork()).ldelim(),e.resInfo!=null&&Object.hasOwnProperty.call(e,"resInfo")&&p.naturalcloudsyncv2.ResponseInfo.encode(e.resInfo,n.uint32(18).fork()).ldelim(),e.schemas!=null&&e.schemas.length)for(let r=0;r<e.schemas.length;++r)p.naturalcloudsyncv2.Schema.encode(e.schemas[r],n.uint32(26).fork()).ldelim();if(e.opData!=null&&e.opData.length)for(let r=0;r<e.opData.length;++r)p.naturalcloudsyncv2.OperationData.encode(e.opData[r],n.uint32(34).fork()).ldelim();if(e.permRecs!=null&&e.permRecs.length)for(let r=0;r<e.permRecs.length;++r)p.naturalcloudsyncv2.PermissionRecord.encode(e.permRecs[r],n.uint32(42).fork()).ldelim();if(e.updateResMsg!=null&&Object.hasOwnProperty.call(e,"updateResMsg")&&p.naturalcloudsyncv2.UpdateResponseMessage.encode(e.updateResMsg,n.uint32(50).fork()).ldelim(),e.queryResMsg!=null&&Object.hasOwnProperty.call(e,"queryResMsg")&&p.naturalcloudsyncv2.QueryResponseMessage.encode(e.queryResMsg,n.uint32(58).fork()).ldelim(),e.subResMsg!=null&&e.subResMsg.length)for(let r=0;r<e.subResMsg.length;++r)p.naturalcloudsyncv2.SubscribeResponseMessage.encode(e.subResMsg[r],n.uint32(66).fork()).ldelim();if(e.unSubResMsg!=null&&e.unSubResMsg.length)for(let r=0;r<e.unSubResMsg.length;++r)p.naturalcloudsyncv2.UnsubscribeResponseMessage.encode(e.unSubResMsg[r],n.uint32(74).fork()).ldelim();if(e.subPushMsg!=null&&Object.hasOwnProperty.call(e,"subPushMsg")&&p.naturalcloudsyncv2.SubscribePushMessage.encode(e.subPushMsg,n.uint32(82).fork()).ldelim(),e.enResInfo!=null&&e.enResInfo.length)for(let r=0;r<e.enResInfo.length;++r)p.naturalcloudsyncv2.EncryptionInfo.encode(e.enResInfo[r],n.uint32(90).fork()).ldelim();return e.serverStatus!=null&&Object.hasOwnProperty.call(e,"serverStatus")&&p.naturalcloudsyncv2.ServerStatus.encode(e.serverStatus,n.uint32(98).fork()).ldelim(),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.SyncResponseMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.msgInfo=p.naturalcloudsyncv2.MessageInfo.decode(e,e.uint32());break;case 2:i.resInfo=p.naturalcloudsyncv2.ResponseInfo.decode(e,e.uint32());break;case 3:i.schemas&&i.schemas.length||(i.schemas=[]),i.schemas.push(p.naturalcloudsyncv2.Schema.decode(e,e.uint32()));break;case 4:i.opData&&i.opData.length||(i.opData=[]),i.opData.push(p.naturalcloudsyncv2.OperationData.decode(e,e.uint32()));break;case 5:i.permRecs&&i.permRecs.length||(i.permRecs=[]),i.permRecs.push(p.naturalcloudsyncv2.PermissionRecord.decode(e,e.uint32()));break;case 6:i.updateResMsg=p.naturalcloudsyncv2.UpdateResponseMessage.decode(e,e.uint32());break;case 7:i.queryResMsg=p.naturalcloudsyncv2.QueryResponseMessage.decode(e,e.uint32());break;case 8:i.subResMsg&&i.subResMsg.length||(i.subResMsg=[]),i.subResMsg.push(p.naturalcloudsyncv2.SubscribeResponseMessage.decode(e,e.uint32()));break;case 9:i.unSubResMsg&&i.unSubResMsg.length||(i.unSubResMsg=[]),i.unSubResMsg.push(p.naturalcloudsyncv2.UnsubscribeResponseMessage.decode(e,e.uint32()));break;case 10:i.subPushMsg=p.naturalcloudsyncv2.SubscribePushMessage.decode(e,e.uint32());break;case 11:i.enResInfo&&i.enResInfo.length||(i.enResInfo=[]),i.enResInfo.push(p.naturalcloudsyncv2.EncryptionInfo.decode(e,e.uint32()));break;case 12:i.serverStatus=p.naturalcloudsyncv2.ServerStatus.decode(e,e.uint32());break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.msgInfo!=null&&e.hasOwnProperty("msgInfo")){let n=p.naturalcloudsyncv2.MessageInfo.verify(e.msgInfo);if(n)return"msgInfo."+n}if(e.resInfo!=null&&e.hasOwnProperty("resInfo")){let n=p.naturalcloudsyncv2.ResponseInfo.verify(e.resInfo);if(n)return"resInfo."+n}if(e.schemas!=null&&e.hasOwnProperty("schemas")){if(!Array.isArray(e.schemas))return"schemas: array expected";for(let n=0;n<e.schemas.length;++n){let r=p.naturalcloudsyncv2.Schema.verify(e.schemas[n]);if(r)return"schemas."+r}}if(e.opData!=null&&e.hasOwnProperty("opData")){if(!Array.isArray(e.opData))return"opData: array expected";for(let n=0;n<e.opData.length;++n){let r=p.naturalcloudsyncv2.OperationData.verify(e.opData[n]);if(r)return"opData."+r}}if(e.permRecs!=null&&e.hasOwnProperty("permRecs")){if(!Array.isArray(e.permRecs))return"permRecs: array expected";for(let n=0;n<e.permRecs.length;++n){let r=p.naturalcloudsyncv2.PermissionRecord.verify(e.permRecs[n]);if(r)return"permRecs."+r}}if(e.updateResMsg!=null&&e.hasOwnProperty("updateResMsg")){let n=p.naturalcloudsyncv2.UpdateResponseMessage.verify(e.updateResMsg);if(n)return"updateResMsg."+n}if(e.queryResMsg!=null&&e.hasOwnProperty("queryResMsg")){let n=p.naturalcloudsyncv2.QueryResponseMessage.verify(e.queryResMsg);if(n)return"queryResMsg."+n}if(e.subResMsg!=null&&e.hasOwnProperty("subResMsg")){if(!Array.isArray(e.subResMsg))return"subResMsg: array expected";for(let n=0;n<e.subResMsg.length;++n){let r=p.naturalcloudsyncv2.SubscribeResponseMessage.verify(e.subResMsg[n]);if(r)return"subResMsg."+r}}if(e.unSubResMsg!=null&&e.hasOwnProperty("unSubResMsg")){if(!Array.isArray(e.unSubResMsg))return"unSubResMsg: array expected";for(let n=0;n<e.unSubResMsg.length;++n){let r=p.naturalcloudsyncv2.UnsubscribeResponseMessage.verify(e.unSubResMsg[n]);if(r)return"unSubResMsg."+r}}if(e.subPushMsg!=null&&e.hasOwnProperty("subPushMsg")){let n=p.naturalcloudsyncv2.SubscribePushMessage.verify(e.subPushMsg);if(n)return"subPushMsg."+n}if(e.enResInfo!=null&&e.hasOwnProperty("enResInfo")){if(!Array.isArray(e.enResInfo))return"enResInfo: array expected";for(let n=0;n<e.enResInfo.length;++n){let r=p.naturalcloudsyncv2.EncryptionInfo.verify(e.enResInfo[n]);if(r)return"enResInfo."+r}}if(e.serverStatus!=null&&e.hasOwnProperty("serverStatus")){let n=p.naturalcloudsyncv2.ServerStatus.verify(e.serverStatus);if(n)return"serverStatus."+n}return null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.SyncResponseMessage)return e;let n=new p.naturalcloudsyncv2.SyncResponseMessage;if(e.msgInfo!=null){if(typeof e.msgInfo!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.msgInfo: object expected");n.msgInfo=p.naturalcloudsyncv2.MessageInfo.fromObject(e.msgInfo)}if(e.resInfo!=null){if(typeof e.resInfo!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.resInfo: object expected");n.resInfo=p.naturalcloudsyncv2.ResponseInfo.fromObject(e.resInfo)}if(e.schemas){if(!Array.isArray(e.schemas))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.schemas: array expected");n.schemas=[];for(let r=0;r<e.schemas.length;++r){if(typeof e.schemas[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.schemas: object expected");n.schemas[r]=p.naturalcloudsyncv2.Schema.fromObject(e.schemas[r])}}if(e.opData){if(!Array.isArray(e.opData))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.opData: array expected");n.opData=[];for(let r=0;r<e.opData.length;++r){if(typeof e.opData[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.opData: object expected");n.opData[r]=p.naturalcloudsyncv2.OperationData.fromObject(e.opData[r])}}if(e.permRecs){if(!Array.isArray(e.permRecs))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.permRecs: array expected");n.permRecs=[];for(let r=0;r<e.permRecs.length;++r){if(typeof e.permRecs[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.permRecs: object expected");n.permRecs[r]=p.naturalcloudsyncv2.PermissionRecord.fromObject(e.permRecs[r])}}if(e.updateResMsg!=null){if(typeof e.updateResMsg!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.updateResMsg: object expected");n.updateResMsg=p.naturalcloudsyncv2.UpdateResponseMessage.fromObject(e.updateResMsg)}if(e.queryResMsg!=null){if(typeof e.queryResMsg!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.queryResMsg: object expected");n.queryResMsg=p.naturalcloudsyncv2.QueryResponseMessage.fromObject(e.queryResMsg)}if(e.subResMsg){if(!Array.isArray(e.subResMsg))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subResMsg: array expected");n.subResMsg=[];for(let r=0;r<e.subResMsg.length;++r){if(typeof e.subResMsg[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subResMsg: object expected");n.subResMsg[r]=p.naturalcloudsyncv2.SubscribeResponseMessage.fromObject(e.subResMsg[r])}}if(e.unSubResMsg){if(!Array.isArray(e.unSubResMsg))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.unSubResMsg: array expected");n.unSubResMsg=[];for(let r=0;r<e.unSubResMsg.length;++r){if(typeof e.unSubResMsg[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.unSubResMsg: object expected");n.unSubResMsg[r]=p.naturalcloudsyncv2.UnsubscribeResponseMessage.fromObject(e.unSubResMsg[r])}}if(e.subPushMsg!=null){if(typeof e.subPushMsg!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subPushMsg: object expected");n.subPushMsg=p.naturalcloudsyncv2.SubscribePushMessage.fromObject(e.subPushMsg)}if(e.enResInfo){if(!Array.isArray(e.enResInfo))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.enResInfo: array expected");n.enResInfo=[];for(let r=0;r<e.enResInfo.length;++r){if(typeof e.enResInfo[r]!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.enResInfo: object expected");n.enResInfo[r]=p.naturalcloudsyncv2.EncryptionInfo.fromObject(e.enResInfo[r])}}if(e.serverStatus!=null){if(typeof e.serverStatus!="object")throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.serverStatus: object expected");n.serverStatus=p.naturalcloudsyncv2.ServerStatus.fromObject(e.serverStatus)}return n},t.toObject=function(e,n){n||(n={});let r={};if((n.arrays||n.defaults)&&(r.schemas=[],r.opData=[],r.permRecs=[],r.subResMsg=[],r.unSubResMsg=[],r.enResInfo=[]),n.defaults&&(r.msgInfo=null,r.resInfo=null,r.updateResMsg=null,r.queryResMsg=null,r.subPushMsg=null,r.serverStatus=null),e.msgInfo!=null&&e.hasOwnProperty("msgInfo")&&(r.msgInfo=p.naturalcloudsyncv2.MessageInfo.toObject(e.msgInfo,n)),e.resInfo!=null&&e.hasOwnProperty("resInfo")&&(r.resInfo=p.naturalcloudsyncv2.ResponseInfo.toObject(e.resInfo,n)),e.schemas&&e.schemas.length){r.schemas=[];for(let i=0;i<e.schemas.length;++i)r.schemas[i]=p.naturalcloudsyncv2.Schema.toObject(e.schemas[i],n)}if(e.opData&&e.opData.length){r.opData=[];for(let i=0;i<e.opData.length;++i)r.opData[i]=p.naturalcloudsyncv2.OperationData.toObject(e.opData[i],n)}if(e.permRecs&&e.permRecs.length){r.permRecs=[];for(let i=0;i<e.permRecs.length;++i)r.permRecs[i]=p.naturalcloudsyncv2.PermissionRecord.toObject(e.permRecs[i],n)}if(e.updateResMsg!=null&&e.hasOwnProperty("updateResMsg")&&(r.updateResMsg=p.naturalcloudsyncv2.UpdateResponseMessage.toObject(e.updateResMsg,n)),e.queryResMsg!=null&&e.hasOwnProperty("queryResMsg")&&(r.queryResMsg=p.naturalcloudsyncv2.QueryResponseMessage.toObject(e.queryResMsg,n)),e.subResMsg&&e.subResMsg.length){r.subResMsg=[];for(let i=0;i<e.subResMsg.length;++i)r.subResMsg[i]=p.naturalcloudsyncv2.SubscribeResponseMessage.toObject(e.subResMsg[i],n)}if(e.unSubResMsg&&e.unSubResMsg.length){r.unSubResMsg=[];for(let i=0;i<e.unSubResMsg.length;++i)r.unSubResMsg[i]=p.naturalcloudsyncv2.UnsubscribeResponseMessage.toObject(e.unSubResMsg[i],n)}if(e.subPushMsg!=null&&e.hasOwnProperty("subPushMsg")&&(r.subPushMsg=p.naturalcloudsyncv2.SubscribePushMessage.toObject(e.subPushMsg,n)),e.enResInfo&&e.enResInfo.length){r.enResInfo=[];for(let i=0;i<e.enResInfo.length;++i)r.enResInfo[i]=p.naturalcloudsyncv2.EncryptionInfo.toObject(e.enResInfo[i],n)}return e.serverStatus!=null&&e.hasOwnProperty("serverStatus")&&(r.serverStatus=p.naturalcloudsyncv2.ServerStatus.toObject(e.serverStatus,n)),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.SyncResponseMessage"},t}(),o.ResponseInfo=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.resCode=0,t.prototype.resInfo="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.resCode!=null&&Object.hasOwnProperty.call(e,"resCode")&&n.uint32(8).int32(e.resCode),e.resInfo!=null&&Object.hasOwnProperty.call(e,"resInfo")&&n.uint32(18).string(e.resInfo),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.ResponseInfo;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.resCode=e.int32();break;case 2:i.resInfo=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.resCode!=null&&e.hasOwnProperty("resCode")&&!f.isInteger(e.resCode)?"resCode: integer expected":e.resInfo!=null&&e.hasOwnProperty("resInfo")&&!f.isString(e.resInfo)?"resInfo: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.ResponseInfo)return e;let n=new p.naturalcloudsyncv2.ResponseInfo;return e.resCode!=null&&(n.resCode=0|e.resCode),e.resInfo!=null&&(n.resInfo=String(e.resInfo)),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.resCode=0,r.resInfo=""),e.resCode!=null&&e.hasOwnProperty("resCode")&&(r.resCode=e.resCode),e.resInfo!=null&&e.hasOwnProperty("resInfo")&&(r.resInfo=e.resInfo),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.ResponseInfo"},t}(),o.PermissionRecord=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.tableName="",t.prototype.roleType="",t.prototype.readPerm=!1,t.prototype.upsertPerm=!1,t.prototype.deletePerm=!1,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.tableName!=null&&Object.hasOwnProperty.call(e,"tableName")&&n.uint32(10).string(e.tableName),e.roleType!=null&&Object.hasOwnProperty.call(e,"roleType")&&n.uint32(18).string(e.roleType),e.readPerm!=null&&Object.hasOwnProperty.call(e,"readPerm")&&n.uint32(24).bool(e.readPerm),e.upsertPerm!=null&&Object.hasOwnProperty.call(e,"upsertPerm")&&n.uint32(32).bool(e.upsertPerm),e.deletePerm!=null&&Object.hasOwnProperty.call(e,"deletePerm")&&n.uint32(40).bool(e.deletePerm),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.PermissionRecord;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.tableName=e.string();break;case 2:i.roleType=e.string();break;case 3:i.readPerm=e.bool();break;case 4:i.upsertPerm=e.bool();break;case 5:i.deletePerm=e.bool();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.tableName!=null&&e.hasOwnProperty("tableName")&&!f.isString(e.tableName)?"tableName: string expected":e.roleType!=null&&e.hasOwnProperty("roleType")&&!f.isString(e.roleType)?"roleType: string expected":e.readPerm!=null&&e.hasOwnProperty("readPerm")&&typeof e.readPerm!="boolean"?"readPerm: boolean expected":e.upsertPerm!=null&&e.hasOwnProperty("upsertPerm")&&typeof e.upsertPerm!="boolean"?"upsertPerm: boolean expected":e.deletePerm!=null&&e.hasOwnProperty("deletePerm")&&typeof e.deletePerm!="boolean"?"deletePerm: boolean expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.PermissionRecord)return e;let n=new p.naturalcloudsyncv2.PermissionRecord;return e.tableName!=null&&(n.tableName=String(e.tableName)),e.roleType!=null&&(n.roleType=String(e.roleType)),e.readPerm!=null&&(n.readPerm=!!e.readPerm),e.upsertPerm!=null&&(n.upsertPerm=!!e.upsertPerm),e.deletePerm!=null&&(n.deletePerm=!!e.deletePerm),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.tableName="",r.roleType="",r.readPerm=!1,r.upsertPerm=!1,r.deletePerm=!1),e.tableName!=null&&e.hasOwnProperty("tableName")&&(r.tableName=e.tableName),e.roleType!=null&&e.hasOwnProperty("roleType")&&(r.roleType=e.roleType),e.readPerm!=null&&e.hasOwnProperty("readPerm")&&(r.readPerm=e.readPerm),e.upsertPerm!=null&&e.hasOwnProperty("upsertPerm")&&(r.upsertPerm=e.upsertPerm),e.deletePerm!=null&&e.hasOwnProperty("deletePerm")&&(r.deletePerm=e.deletePerm),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.PermissionRecord"},t}(),o.UpdateResponseMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.successRecCount=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.successRecCount!=null&&Object.hasOwnProperty.call(e,"successRecCount")&&n.uint32(8).int32(e.successRecCount),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.UpdateResponseMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.successRecCount=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.successRecCount!=null&&e.hasOwnProperty("successRecCount")&&!f.isInteger(e.successRecCount)?"successRecCount: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.UpdateResponseMessage)return e;let n=new p.naturalcloudsyncv2.UpdateResponseMessage;return e.successRecCount!=null&&(n.successRecCount=0|e.successRecCount),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.successRecCount=0),e.successRecCount!=null&&e.hasOwnProperty("successRecCount")&&(r.successRecCount=e.successRecCount),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.UpdateResponseMessage"},t}(),o.QueryResponseMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.queryType=0,t.prototype.isComplete=!1,t.prototype.aggQueryRes=null,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.queryType!=null&&Object.hasOwnProperty.call(e,"queryType")&&n.uint32(8).int32(e.queryType),e.isComplete!=null&&Object.hasOwnProperty.call(e,"isComplete")&&n.uint32(16).bool(e.isComplete),e.aggQueryRes!=null&&Object.hasOwnProperty.call(e,"aggQueryRes")&&p.naturalcloudsyncv2.AggregateQueryResult.encode(e.aggQueryRes,n.uint32(26).fork()).ldelim(),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.QueryResponseMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.queryType=e.int32();break;case 2:i.isComplete=e.bool();break;case 3:i.aggQueryRes=p.naturalcloudsyncv2.AggregateQueryResult.decode(e,e.uint32());break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.queryType!=null&&e.hasOwnProperty("queryType")&&!f.isInteger(e.queryType))return"queryType: integer expected";if(e.isComplete!=null&&e.hasOwnProperty("isComplete")&&typeof e.isComplete!="boolean")return"isComplete: boolean expected";if(e.aggQueryRes!=null&&e.hasOwnProperty("aggQueryRes")){let n=p.naturalcloudsyncv2.AggregateQueryResult.verify(e.aggQueryRes);if(n)return"aggQueryRes."+n}return null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.QueryResponseMessage)return e;let n=new p.naturalcloudsyncv2.QueryResponseMessage;if(e.queryType!=null&&(n.queryType=0|e.queryType),e.isComplete!=null&&(n.isComplete=!!e.isComplete),e.aggQueryRes!=null){if(typeof e.aggQueryRes!="object")throw TypeError(".naturalcloudsyncv2.QueryResponseMessage.aggQueryRes: object expected");n.aggQueryRes=p.naturalcloudsyncv2.AggregateQueryResult.fromObject(e.aggQueryRes)}return n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.queryType=0,r.isComplete=!1,r.aggQueryRes=null),e.queryType!=null&&e.hasOwnProperty("queryType")&&(r.queryType=e.queryType),e.isComplete!=null&&e.hasOwnProperty("isComplete")&&(r.isComplete=e.isComplete),e.aggQueryRes!=null&&e.hasOwnProperty("aggQueryRes")&&(r.aggQueryRes=p.naturalcloudsyncv2.AggregateQueryResult.toObject(e.aggQueryRes,n)),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.QueryResponseMessage"},t}(),o.AggregateQueryResult=function(){function t(n){if(n)for(let r=Object.keys(n),i=0;i<r.length;++i)n[r[i]]!=null&&(this[r[i]]=n[r[i]])}let e;return t.prototype.isNull=!1,t.prototype.longRes=null,t.prototype.doubleRes=null,Object.defineProperty(t.prototype,"result",{get:f.oneOfGetter(e=["longRes","doubleRes"]),set:f.oneOfSetter(e)}),t.create=function(n){return new t(n)},t.encode=function(n,r){return r||(r=$.create()),n.isNull!=null&&Object.hasOwnProperty.call(n,"isNull")&&r.uint32(8).bool(n.isNull),n.longRes!=null&&Object.hasOwnProperty.call(n,"longRes")&&r.uint32(16).int64(n.longRes),n.doubleRes!=null&&Object.hasOwnProperty.call(n,"doubleRes")&&r.uint32(25).double(n.doubleRes),r},t.encodeDelimited=function(n,r){return this.encode(n,r).ldelim()},t.decode=function(n,r){n instanceof I||(n=I.create(n));let i=r===void 0?n.len:n.pos+r,s=new p.naturalcloudsyncv2.AggregateQueryResult;for(;n.pos<i;){let a=n.uint32();switch(a>>>3){case 1:s.isNull=n.bool();break;case 2:s.longRes=n.int64();break;case 3:s.doubleRes=n.double();break;default:n.skipType(7&a)}}return s},t.decodeDelimited=function(n){return n instanceof I||(n=new I(n)),this.decode(n,n.uint32())},t.verify=function(n){if(typeof n!="object"||n===null)return"object expected";let r={};if(n.isNull!=null&&n.hasOwnProperty("isNull")&&typeof n.isNull!="boolean")return"isNull: boolean expected";if(n.longRes!=null&&n.hasOwnProperty("longRes")&&(r.result=1,!(f.isInteger(n.longRes)||n.longRes&&f.isInteger(n.longRes.low)&&f.isInteger(n.longRes.high))))return"longRes: integer|Long expected";if(n.doubleRes!=null&&n.hasOwnProperty("doubleRes")){if(r.result===1)return"result: multiple values";if(r.result=1,typeof n.doubleRes!="number")return"doubleRes: number expected"}return null},t.fromObject=function(n){if(n instanceof p.naturalcloudsyncv2.AggregateQueryResult)return n;let r=new p.naturalcloudsyncv2.AggregateQueryResult;return n.isNull!=null&&(r.isNull=!!n.isNull),n.longRes!=null&&(f.Long?(r.longRes=f.Long.fromValue(n.longRes)).unsigned=!1:typeof n.longRes=="string"?r.longRes=parseInt(n.longRes,10):typeof n.longRes=="number"?r.longRes=n.longRes:typeof n.longRes=="object"&&(r.longRes=new f.LongBits(n.longRes.low>>>0,n.longRes.high>>>0).toNumber())),n.doubleRes!=null&&(r.doubleRes=Number(n.doubleRes)),r},t.toObject=function(n,r){r||(r={});let i={};return r.defaults&&(i.isNull=!1),n.isNull!=null&&n.hasOwnProperty("isNull")&&(i.isNull=n.isNull),n.longRes!=null&&n.hasOwnProperty("longRes")&&(typeof n.longRes=="number"?i.longRes=r.longs===String?String(n.longRes):n.longRes:i.longRes=r.longs===String?f.Long.prototype.toString.call(n.longRes):r.longs===Number?new f.LongBits(n.longRes.low>>>0,n.longRes.high>>>0).toNumber():n.longRes,r.oneofs&&(i.result="longRes")),n.doubleRes!=null&&n.hasOwnProperty("doubleRes")&&(i.doubleRes=r.json&&!isFinite(n.doubleRes)?String(n.doubleRes):n.doubleRes,r.oneofs&&(i.result="doubleRes")),i},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/naturalcloudsyncv2.AggregateQueryResult"},t}(),o.SubscribeResponseMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.subRecId="",t.prototype.subId="",t.prototype.subKey=0,t.prototype.subResCode=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.subRecId!=null&&Object.hasOwnProperty.call(e,"subRecId")&&n.uint32(10).string(e.subRecId),e.subId!=null&&Object.hasOwnProperty.call(e,"subId")&&n.uint32(18).string(e.subId),e.subKey!=null&&Object.hasOwnProperty.call(e,"subKey")&&n.uint32(24).int32(e.subKey),e.subResCode!=null&&Object.hasOwnProperty.call(e,"subResCode")&&n.uint32(32).int32(e.subResCode),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.SubscribeResponseMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.subRecId=e.string();break;case 2:i.subId=e.string();break;case 3:i.subKey=e.int32();break;case 4:i.subResCode=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.subRecId!=null&&e.hasOwnProperty("subRecId")&&!f.isString(e.subRecId)?"subRecId: string expected":e.subId!=null&&e.hasOwnProperty("subId")&&!f.isString(e.subId)?"subId: string expected":e.subKey!=null&&e.hasOwnProperty("subKey")&&!f.isInteger(e.subKey)?"subKey: integer expected":e.subResCode!=null&&e.hasOwnProperty("subResCode")&&!f.isInteger(e.subResCode)?"subResCode: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.SubscribeResponseMessage)return e;let n=new p.naturalcloudsyncv2.SubscribeResponseMessage;return e.subRecId!=null&&(n.subRecId=String(e.subRecId)),e.subId!=null&&(n.subId=String(e.subId)),e.subKey!=null&&(n.subKey=0|e.subKey),e.subResCode!=null&&(n.subResCode=0|e.subResCode),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.subRecId="",r.subId="",r.subKey=0,r.subResCode=0),e.subRecId!=null&&e.hasOwnProperty("subRecId")&&(r.subRecId=e.subRecId),e.subId!=null&&e.hasOwnProperty("subId")&&(r.subId=e.subId),e.subKey!=null&&e.hasOwnProperty("subKey")&&(r.subKey=e.subKey),e.subResCode!=null&&e.hasOwnProperty("subResCode")&&(r.subResCode=e.subResCode),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.SubscribeResponseMessage"},t}(),o.UnsubscribeResponseMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.unSubRecId="",t.prototype.unSubResCode=0,t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.unSubRecId!=null&&Object.hasOwnProperty.call(e,"unSubRecId")&&n.uint32(10).string(e.unSubRecId),e.unSubResCode!=null&&Object.hasOwnProperty.call(e,"unSubResCode")&&n.uint32(16).int32(e.unSubResCode),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.UnsubscribeResponseMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.unSubRecId=e.string();break;case 2:i.unSubResCode=e.int32();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.unSubRecId!=null&&e.hasOwnProperty("unSubRecId")&&!f.isString(e.unSubRecId)?"unSubRecId: string expected":e.unSubResCode!=null&&e.hasOwnProperty("unSubResCode")&&!f.isInteger(e.unSubResCode)?"unSubResCode: integer expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.UnsubscribeResponseMessage)return e;let n=new p.naturalcloudsyncv2.UnsubscribeResponseMessage;return e.unSubRecId!=null&&(n.unSubRecId=String(e.unSubRecId)),e.unSubResCode!=null&&(n.unSubResCode=0|e.unSubResCode),n},t.toObject=function(e,n){n||(n={});let r={};return n.defaults&&(r.unSubRecId="",r.unSubResCode=0),e.unSubRecId!=null&&e.hasOwnProperty("unSubRecId")&&(r.unSubRecId=e.unSubRecId),e.unSubResCode!=null&&e.hasOwnProperty("unSubResCode")&&(r.unSubResCode=e.unSubResCode),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.UnsubscribeResponseMessage"},t}(),o.SubscribePushMessage=function(){function t(e){if(e)for(let n=Object.keys(e),r=0;r<n.length;++r)e[n[r]]!=null&&(this[n[r]]=e[n[r]])}return t.prototype.subRecId="",t.prototype.pushSeq=f.Long?f.Long.fromBits(0,0,!1):0,t.prototype.subKey=0,t.prototype.subId="",t.create=function(e){return new t(e)},t.encode=function(e,n){return n||(n=$.create()),e.subRecId!=null&&Object.hasOwnProperty.call(e,"subRecId")&&n.uint32(10).string(e.subRecId),e.pushSeq!=null&&Object.hasOwnProperty.call(e,"pushSeq")&&n.uint32(16).int64(e.pushSeq),e.subKey!=null&&Object.hasOwnProperty.call(e,"subKey")&&n.uint32(24).int32(e.subKey),e.subId!=null&&Object.hasOwnProperty.call(e,"subId")&&n.uint32(34).string(e.subId),n},t.encodeDelimited=function(e,n){return this.encode(e,n).ldelim()},t.decode=function(e,n){e instanceof I||(e=I.create(e));let r=n===void 0?e.len:e.pos+n,i=new p.naturalcloudsyncv2.SubscribePushMessage;for(;e.pos<r;){let s=e.uint32();switch(s>>>3){case 1:i.subRecId=e.string();break;case 2:i.pushSeq=e.int64();break;case 3:i.subKey=e.int32();break;case 4:i.subId=e.string();break;default:e.skipType(7&s)}}return i},t.decodeDelimited=function(e){return e instanceof I||(e=new I(e)),this.decode(e,e.uint32())},t.verify=function(e){return typeof e!="object"||e===null?"object expected":e.subRecId!=null&&e.hasOwnProperty("subRecId")&&!f.isString(e.subRecId)?"subRecId: string expected":e.pushSeq!=null&&e.hasOwnProperty("pushSeq")&&!(f.isInteger(e.pushSeq)||e.pushSeq&&f.isInteger(e.pushSeq.low)&&f.isInteger(e.pushSeq.high))?"pushSeq: integer|Long expected":e.subKey!=null&&e.hasOwnProperty("subKey")&&!f.isInteger(e.subKey)?"subKey: integer expected":e.subId!=null&&e.hasOwnProperty("subId")&&!f.isString(e.subId)?"subId: string expected":null},t.fromObject=function(e){if(e instanceof p.naturalcloudsyncv2.SubscribePushMessage)return e;let n=new p.naturalcloudsyncv2.SubscribePushMessage;return e.subRecId!=null&&(n.subRecId=String(e.subRecId)),e.pushSeq!=null&&(f.Long?(n.pushSeq=f.Long.fromValue(e.pushSeq)).unsigned=!1:typeof e.pushSeq=="string"?n.pushSeq=parseInt(e.pushSeq,10):typeof e.pushSeq=="number"?n.pushSeq=e.pushSeq:typeof e.pushSeq=="object"&&(n.pushSeq=new f.LongBits(e.pushSeq.low>>>0,e.pushSeq.high>>>0).toNumber())),e.subKey!=null&&(n.subKey=0|e.subKey),e.subId!=null&&(n.subId=String(e.subId)),n},t.toObject=function(e,n){n||(n={});let r={};if(n.defaults){if(r.subRecId="",f.Long){let i=new f.Long(0,0,!1);r.pushSeq=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else r.pushSeq=n.longs===String?"0":0;r.subKey=0,r.subId=""}return e.subRecId!=null&&e.hasOwnProperty("subRecId")&&(r.subRecId=e.subRecId),e.pushSeq!=null&&e.hasOwnProperty("pushSeq")&&(typeof e.pushSeq=="number"?r.pushSeq=n.longs===String?String(e.pushSeq):e.pushSeq:r.pushSeq=n.longs===String?f.Long.prototype.toString.call(e.pushSeq):n.longs===Number?new f.LongBits(e.pushSeq.low>>>0,e.pushSeq.high>>>0).toNumber():e.pushSeq),e.subKey!=null&&e.hasOwnProperty("subKey")&&(r.subKey=e.subKey),e.subId!=null&&e.hasOwnProperty("subId")&&(r.subId=e.subId),r},t.prototype.toJSON=function(){return this.constructor.toObject(this,K.util.toJSONOptions)},t.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/naturalcloudsyncv2.SubscribePushMessage"},t}(),o})();var _t,be=W.Field,zt=W.Schema,Ht=W.SchemaField,ee=W.FieldType,wi=W.OperationData,Ei=new M("ObjectWrapper"),Ie=function(){function o(t,e,n){var r,i,s;if(this.creator="",this.objectVersion=0,this.objectTypeName="",this.values=e,this.operationType=n,n===Ne.DELETE){if(!e||e.length===0||!e[0].l)return void Ei.warn("invalid object version of delete wrapper object");this.objectVersion=e[0].l.toNumber()}else this.schema=zt.fromObject(zt.toObject(t,new Ke)),o.addSystemSchemaField(this.schema),this.objectTypeName=t.n,this.creator=(r=e[t.fs.indexOf(t.fs.find(function(a){return a.n==="naturalbase_creator"}))])===null||r===void 0?void 0:r.s,this.objectVersion=(s=(i=e[t.fs.indexOf(t.fs.find(function(a){return a.n==="naturalbase_version"}))])===null||i===void 0?void 0:i.l)===null||s===void 0?void 0:s.toNumber()}return o.findSchemaIndex=function(t,e){var n=-1,r=t.find(function(i,s){return i.n===e&&(n=s,!0)});return[n,r]},o.addSystemSchemaField=function(t){var e=t.fs.find(function(i){return i.n==="naturalbase_creator"}),n=t.fs.find(function(i){return i.n==="naturalbase_version"}),r=t.fs.find(function(i){return i.n==="naturalbase_deleted"});e||t.fs.push(Ht.create({n:"naturalbase_creator",t:ee.TYPE_STRING})),n||t.fs.push(Ht.create({n:"naturalbase_version",t:ee.TYPE_LONG})),r||t.fs.push(Ht.create({n:"naturalbase_deleted",t:ee.TYPE_BOOLEAN}))},o.buildObjs=function(t,e,n){var r,i,s=[];try{for(var a=E(t),u=a.next();!u.done;u=a.next()){var l=u.value,c=o.getClassName(l),d=fe(this.findSchemaIndex(e,c),2),y=d[0],T=d[1];if(y<0||!T)throw h.build(1003);s.push(this.buildObj(l,T,n,y))}}catch(S){r={error:S}}finally{try{u&&!u.done&&(i=a.return)&&i.call(a)}finally{if(r)throw r.error}}return s},o.buildVerifyObjs=function(t,e){var n,r,i,s,a=[];try{for(var u=E(t),l=u.next();!l.done;l=u.next()){var c=l.value,d=fe(o.findSchemaIndex(e,c.objectTypeName),2),y=d[0],T=d[1],S=c.toSyncObject();if(y<0||!T)throw h.build(1003);S.i=y,S.fs.push(be.create({n:!1,bl:!1}));try{for(var O=(i=void 0,E(T.fs)),P=O.next();!P.done;P=O.next())P.value.n.indexOf("#ope")>-1&&S.fs.splice(-3,0,be.create({n:!0}))}catch(U){i={error:U}}finally{try{P&&!P.done&&(s=O.return)&&s.call(O)}finally{if(i)throw i.error}}a.push(S)}}catch(U){n={error:U}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return a},o.buildTransactionData=function(t,e,n){var r,i,s;try{for(var a=E(e),u=a.next();!u.done;u=a.next()){var l=u.value,c=l.objectTypeName,d=l.operationType,y=l.operationType===ge.SYNC_DELETE,T=l.objects,S=fe(this.findSchemaIndex(n,c),2),O=S[0],P=S[1];if(O<0||!P)throw h.build(1003);var U=this.buildObjs(T,n,y),z=this.buildOperationData(U,d);(s=t.opData).push.apply(s,Q(z))}}catch(F){r={error:F}}finally{try{u&&!u.done&&(i=a.return)&&i.call(a)}finally{if(r)throw r.error}}},o.buildOperationData=function(t,e){var n,r,i,s=[],a=this.groupBy(t,"i");try{for(var u=E(a),l=u.next();!l.done;l=u.next()){var c=l.value,d=(i=c[0])===null||i===void 0?void 0:i.i;s.push(wi.create({os:c,t:e,i:d}))}}catch(y){n={error:y}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return s},o.groupBy=function(t,e){for(var n,r,i={},s=0;s<t.length;s++){var a=t[s],u=a[e];i[u]=i[u]||[],i[u].push(a)}var l=[];try{for(var c=E(Object.entries(i)),d=c.next();!d.done;d=c.next()){var y=fe(d.value,2),T=(y[0],y[1]);l.push(T)}}catch(S){n={error:S}}finally{try{d&&!d.done&&(r=c.return)&&r.call(c)}finally{if(n)throw n.error}}return l},o.buildSubObjs=function(t,e){var n,r,i,s,a=[];try{for(var u=E(t),l=u.next();!l.done;l=u.next()){var c=l.value,d=c.getUserObject(),y=[];try{for(var T=(i=void 0,E(e.fs)),S=T.next();!S.done;S=T.next()){var O=S.value;if(O.n!=="naturalbase_version"){var P=be.create(),U=O.t;P[oe.get(U)]=d[O.n],y.push(P)}else c.objectVersion!=null&&y.push(be.create({l:L.fromNumber(c.objectVersion)}))}}catch(z){i={error:z}}finally{try{S&&!S.done&&(s=T.return)&&s.call(T)}finally{if(i)throw i.error}}a.push(W.Obj.create({fs:y}))}}catch(z){n={error:z}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return a},o.buildObj=function(t,e,n,r){var i,s,a=[];try{for(var u=E(e.fs),l=u.next();!l.done;l=u.next()){var c=l.value,d=c.n,y=c.p;if(d==="naturalbase_creator")a.push(be.create({n:!0}));else if(d==="naturalbase_version")a.push(be.create({n:!0}));else if(d==="naturalbase_deleted")a.push(be.create({n:!1,bl:n}));else{var T=t[d],S=c.t,O=void 0;O=!(y||!n)||o.isNullValue(T,S);var P=be.create({n:O});O||(P[oe.get(S)]=S===ee.TYPE_DATE?T.getTime():T),a.push(P)}}}catch(U){i={error:U}}finally{try{l&&!l.done&&(s=u.return)&&s.call(u)}finally{if(i)throw i.error}}return W.Obj.create({fs:a,i:r})},o.isNullValue=function(t,e){var n;return t==null||(e===ee.TYPE_DATE?!(t instanceof Date):e===ee.TYPE_LONG&&((n=t==null?void 0:t.constructor)===null||n===void 0?void 0:n.name)!=="Long")},o.getClassName=function(t){return t.constructor.className?t.constructor.className:t.constructor.name},o.prototype.toSyncObject=function(){var t=W.Obj.create();return t.fs=this.values,t},o.prototype.setObjectTypeName=function(t){this.objectTypeName=t.className?t.className:t.name},o.prototype.getUserObject=function(){return this.userObject},o.prototype.setUserObject=function(t){this.userObject=t},o.prototype.getObject=function(){for(var t=zt.toObject(this.schema,new Ke),e=this.values.map(function(d){return be.toObject(d,{longs:L,defaults:!0})}),n={},r=0;r<e.length;r++){var i=t.fs[r],s=i.n,a=i.e?ee.TYPE_BYTE_ARRAY:i.t,u=e[r],l=u.n,c=oe.get(a);n[s]=l?void 0:u[c]}return n},o.prototype.clone=function(){var t,e,n=[];try{for(var r=E(this.values),i=r.next();!i.done;i=r.next()){var s=i.value,a=be.toObject(s,new Ke);n.push(be.fromObject(a))}}catch(u){t={error:u}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return new o(this.schema,n)},o.prototype.isValidVersion=function(){return this.objectVersion!==0},o}(),oe=new Map;oe.set(ee.TYPE_BOOLEAN,"bl"),oe.set(ee.TYPE_BYTE,"b"),oe.set(ee.TYPE_BYTE_ARRAY,"ba"),oe.set(ee.TYPE_DATE,"l"),oe.set(ee.TYPE_DOUBLE,"d"),oe.set(ee.TYPE_FLOAT,"f"),oe.set(ee.TYPE_INT32,"i"),oe.set(ee.TYPE_LONG,"l"),oe.set(ee.TYPE_SHORT,"st"),oe.set(ee.TYPE_STRING,"s"),oe.set(ee.TYPE_TEXT,"s"),oe.set(ee.TYPE_AUTO_INCREMENT_INT,"i"),oe.set(ee.TYPE_AUTO_INCREMENT_LONG,"l"),function(o){o[o.CONVENTIONAL_QUERY=0]="CONVENTIONAL_QUERY",o[o.AVG_QUERY=1]="AVG_QUERY"}(_t||(_t={}));var ye,ln=function(){};(function(o){o[o.DEFAULT=0]="DEFAULT",o[o.NORMAL=1]="NORMAL",o[o.UPDATING=2]="UPDATING",o[o.INTERRUPT=3]="INTERRUPT"})(ye||(ye={}));var Z,je=function(){function o(){this.keyStatus_=ye.DEFAULT,this.keyVersion_=0}return Object.defineProperty(o.prototype,"firstSaltValue",{get:function(){return this.firstSaltValue_},set:function(t){this.firstSaltValue_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"secondSaltValue",{get:function(){return this.secondSaltValue_},set:function(t){this.secondSaltValue_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"rootKeyToken",{get:function(){return this.rootKeyToken_},set:function(t){this.rootKeyToken_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"dataKeyCipherText",{get:function(){return this.dataKeyCipherText_},set:function(t){this.dataKeyCipherText_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"oldDataKeyCipherText",{get:function(){return this.oldDataKeyCipherText_},set:function(t){this.oldDataKeyCipherText_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"keyStatus",{get:function(){return this.keyStatus_},set:function(t){this.keyStatus_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"keyVersion",{get:function(){return this.keyVersion_},set:function(t){this.keyVersion_=t},enumerable:!1,configurable:!0}),o.prototype.clear=function(){var t,e,n,r,i;(t=this.firstSaltValue_)===null||t===void 0||t.set([],0),(e=this.secondSaltValue_)===null||e===void 0||e.set([],0),(n=this.rootKeyToken_)===null||n===void 0||n.set([],0),(r=this.dataKeyCipherText_)===null||r===void 0||r.set([],0),(i=this.oldDataKeyCipherText_)===null||i===void 0||i.set([],0)},o}(),qe=function(){function o(t,e){this.encryptInfo_=[],this.resultCode_=0,this.resultCode_=t,this.encryptInfo_=e}return Object.defineProperty(o.prototype,"resultCode",{get:function(){return this.resultCode_},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"encryptInfo",{get:function(){return this.encryptInfo_},enumerable:!1,configurable:!0}),o}(),Ri=new M("CommunicateTask"),Oi=function(){function o(t,e,n){this.delayMs=0,this.isCanceled=!1,this.task=t,this.func=t.request,this.delayMs=e,this.handle=n}return o.prototype.execute=function(){var t=this.handle;if(!this.isCanceled)try{this.func.call(this.task)}catch(e){Ri.error(e),t==null||t.handle(!1,e)}},o.prototype.getDelayMs=function(){return this.delayMs},o.prototype.cleanDelayMs=function(){this.delayMs=0},o.prototype.cancel=function(){this.isCanceled=!0},o}(),Ci=new M("CommunicateTaskQueue"),Pi=function(){function o(){this.tasks=[],this.taskId=0,this.head=0,this.isShutdown=!1,this.isExecuting=!1}return o.prototype.enqueueTask=function(t){if(this.isShutdown)return Ci.log("[CommunicateTaskQueue] enqueueTask fail due to shutdown!"),-1;var e=++this.taskId;return this.tasks.push(t),this.isExecuting||this.process(),e},o.prototype.process=function(){var t=this;this.isExecuting=!0;var e=this.tasks.splice(0,1);if(e.length===0)this.isExecuting=!1;else{this.head++;var n=e[0];this.timerHandle=setTimeout(function(){return b(t,void 0,void 0,function(){return g(this,function(r){return this.timerHandle||clearTimeout(this.timerHandle),n.execute(),this.process(),[2]})})},n.getDelayMs())}},o}(),he=function(){function o(){}return o.setConfigAdapter=function(t){this.configClazz=t},o.getConfigInstance=function(){return this.configInstance||(this.configInstance=new this.configClazz),this.configInstance},o}(),D=new M("WebSocketClient"),_i=0,Yt=45e3;(function(o){o[o.Disconnected=0]="Disconnected",o[o.RequestToConnect=1]="RequestToConnect",o[o.Connecting=2]="Connecting",o[o.Connected=3]="Connected",o[o.Disconnecting=4]="Disconnecting"})(Z||(Z={}));var at,mr=function(){function o(t){this.msgId=0,this.connectionState=Z.Disconnected,this.isHeartBeatHasResp=0,this.isReconnecting=!1,this.isInitiativeStop=!1,this.keepaliveTimer=null,this.currentBaseMs=0,this.lastAttemptTime=Date.now(),this.backoffFactor=1.5,this.timerHandler=null,this.deviceId=0,this.currentVersion=0,this.isEnableBackUrl=!1,this.subscribeDatas=new Set,this.encryptRequest=new Set,this.unsubscribeCallbacks=new Map,this.isConnected=new yr(!1),this.certificateService=t}return o.setClient=function(t){this.websocketAdapterClazz=t},o.prototype.registerConnectCallback=function(t){t&&(this.connectCallback=t)},o.prototype.registerDisconnectCallback=function(t){t&&(this.disconnectCallback=t)},o.prototype.start=function(t,e){if(this.isInitiativeStop=!1,this.keepaliveTimer||this.resetKeepAlive(),this.connectionState!==Z.Connected&&this.connectionState!==Z.Connecting){D.info("start enter"),this.connectionState=Z.Connecting;var n=this.getWebSocketListeners(e);this.websocketAdapter=new o.websocketAdapterClazz(n,he.getConfigInstance().getRegionMap().get(this.certificateService.getAGCRoutePolicy())),this.websocketAdapter.connect(t)}else D.info("websocket's already started, connectionState: "+this.connectionState)},o.prototype.stop=function(){return b(this,void 0,void 0,function(){var t,e;return g(this,function(n){switch(n.label){case 0:return this.connectionState===Z.Disconnecting||this.connectionState===Z.Disconnected?[2]:[4,this.certificateService.getHeaderParam()];case 1:return t=n.sent(),e={websocketMsgType:"UNREGISTER",websocketMsgId:this.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/unregister",headers:t,body:""}},this.connectionState===Z.Connected&&this.simplifiedSendMessage(JSON.stringify(e)),this.connectionState=Z.Disconnecting,D.info("start to stop"),this.websocketAdapter.close(),this.clearKeepAliveTimer(),[2]}})})},o.prototype.registerResponseCallback=function(t){t&&(this.responseCallback=t)},o.prototype.notifyResponseCallback=function(t,e){this.responseCallback&&this.responseCallback(t,e)},o.prototype.sendSubscribeRequest=function(t){return b(this,void 0,void 0,function(){var e;return g(this,function(n){switch(n.label){case 0:return m.isNotNullObject(t)?(D.info("sendSubscribeRequest state:"+this.connectionState),this.start(this.certificateService.getSubscribeOptions()),this.connectionState!==Z.Connected?(D.log("sendSubscribeRequest: network is not available, schedule to sendMessages!"),this.subscribeDatas.add(t),[2]):((e=new Set).add(t),D.log("sendSubscribeRequest start sendMessages"),[4,this.sendMessages(e)])):(D.error("sendSubscribeRequest: Invalid request, stop to send!"),[2]);case 1:return n.sent(),[2]}})})},o.prototype.sendUnsubscribeRequest=function(t,e){return b(this,void 0,void 0,function(){var n;return g(this,function(r){switch(r.label){case 0:return m.isNotNullObject(t)?(D.info("sendUnsubscribeRequest state:"+this.connectionState),this.connectionState===Z.Disconnecting||this.connectionState===Z.Disconnected?(D.info("sendUnsubscribeRequest it is not connect state, skip to send unsubscribe request!"),e.call(null),[2]):this.connectionState!==Z.Connected?[3,2]:((n=new Set).add(t),D.log("sendUnsubscribeRequest start sendMessages"),this.unsubscribeCallbacks.set(t.taskId.toString(),e),[4,this.sendMessages(n)])):(D.error("sendUnsubscribeRequest: Invalid request, stop to send!"),[2]);case 1:return r.sent(),[3,3];case 2:D.log("sendUnsubscribeRequest connectionState: "+this.connectionState+", skip to send request."),r.label=3;case 3:return[2]}})})},o.prototype.getWebSocketListeners=function(t){var e,n=this;return e=this,{_onopen:function(){n.onOpen(e,t)},_onerror:function(r){n.onError(e)},_onclose:function(r,i,s){n.onClose(e,r,t)},_onmessage:function(r){n.onMessage(e,r)}}},o.prototype.onOpen=function(t,e){return b(this,void 0,void 0,function(){var n,r;return g(this,function(i){switch(i.label){case 0:return[4,this.certificateService.getHeaderParam()];case 1:return n=i.sent(),D.info("onOpen enter"),t.connectionState=Z.Connected,t.currentVersion=t.currentVersion+1,r={websocketMsgType:"REGISTER",websocketMsgId:this.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/register",params:{_v:at.JSON},headers:n,body:""}},t.simplifiedSendMessage(JSON.stringify(r)),e&&e(),[2]}})})},o.prototype.subEncryption=function(t,e){return b(this,void 0,void 0,function(){var n;return g(this,function(r){switch(r.label){case 0:return D.info("subEncryption enter: connectionState: "+this.connectionState),this.start(this.certificateService.getSubscribeOptions()),this.connectionState!==Z.Connected?(this.encryptRequest.add(t),D.info("subEncryption: websocket has not established yet, schedule to add encryption listener!"),[2]):((n=new Set).add(t),[4,this.sendMessages(n)]);case 1:return r.sent(),e&&e(),D.debug("subEncryption: sendMessages done!"),[2]}})})},o.prototype.sendMessages=function(t){return b(this,void 0,void 0,function(){var e,n=this;return g(this,function(r){switch(r.label){case 0:return t.size?[4,this.certificateService.getHeaderParam()]:[2];case 1:return e=r.sent(),t.forEach(function(i){i.deviceId=n.deviceId;var s={websocketMsgType:"COMMON_MSG",websocketMsgId:n.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/message",params:{_v:at.JSON},headers:e,body:JSON.stringify(dn.serializeMessage(i,n.certificateService))}};t.delete(i),n.simplifiedSendMessage(JSON.stringify(s))}),t.clear(),[2]}})})},o.prototype.onError=function(t){D.info("onError enter"),t.resetConnectionState(),this.disconnectCallback&&this.disconnectCallback(this.isInitiativeStop),D.debug("onError done")},o.prototype.onClose=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a;return g(this,function(u){D.info("onClose enter"),t.resetConnectionState(),D.info("onClose message.code: "+e+" isReconnecting: "+t.isReconnecting),n&&n(),this.disconnectCallback&&(D.info("onClose disconnectCallback is called"),this.disconnectCallback(this.isInitiativeStop)),D.info("onClose done"),this.msgId=0,D.info("Start release all unsubscribeCallbacks.");try{for(r=E(this.unsubscribeCallbacks.values()),i=r.next();!i.done;i=r.next())i.value.call()}catch(l){s={error:l}}finally{try{i&&!i.done&&(a=r.return)&&a.call(r)}finally{if(s)throw s.error}}return this.unsubscribeCallbacks.clear(),D.info("Release all unsubscribeCallbacks success."),[2]})})},o.prototype.resetConnectionState=function(){this.clearKeepAliveTimer(),this.connectionState=Z.Disconnected,this.isConnected.value=!1},o.prototype.isReconnectingState=function(){return this.isReconnecting},o.prototype.sizeof=function(t){var e,n,r,i=0;for(n=0,r=t.length;n<r;n++)i+=(e=t.charCodeAt(n))<=127?1:e<=2047?2:e<=65535?3:4;return i},o.prototype.onMessage=function(t,e){if(D.info("onMessage enter"),e){var n=void 0;try{n=JSON.parse(e)}catch{return void D.error("onMessage: fail ,parse data failed, type =  "+typeof e+".")}Object.prototype.hasOwnProperty.call(n,"websocketMsgType")?this.handleAGCMessage(n,t,this):D.warn("Unknown websocket message length = "+(e==null?void 0:e.length))}},o.prototype.handleAGCMessage=function(t,e,n){D.info("receive agc push message msgId: "+t.websocketMsgId);var r=this.getAGCMsgHandlerMap().find(function(i){return i.agcMessageType===t.websocketMsgType});r?(D.info("handleAGCMessage websocketMsgType: "+t.websocketMsgType),r.handler(t,e,n)):D.debug("handleAGCMessage: useless agcMessage responseType: "+(t==null?void 0:t.websocketMsgType))},o.prototype.getAGCMsgHandlerMap=function(){var t=this;return[{agcMessageType:"REGISTER_RSP",handler:function(e,n,r){var i=t.parseJson(e.websocketMsgBody.body).channelId;i&&(r.setDeviceId(i),r.resubscribeAll(),r.connectCallback&&r.connectCallback())}},{agcMessageType:"HEARTBEAT_RSP",handler:function(e,n,r){r.isHeartBeatHasResp=0;var i=1e3*Math.floor(e.websocketChannelIdleTimeout/3);Yt!==i&&(Yt=i,r.resetKeepAlive())}},{agcMessageType:"NOTIFY_MSG",handler:function(e,n,r){r.simplifiedSendMessage(JSON.stringify({websocketMsgType:"NOTIFY_MSG_RSP",websocketMsgId:e.websocketMsgId,websocketMsgBody:{status:200,body:"ok"}}));var i=t.parseJson(e.websocketMsgBody.body),s=i.msgInfo,a=s.id,u=s.type;u&&(t.unsubscribeCallbacks.delete(a),u!==V.QUERY_SUB&&u!==V.QUERY_UNSUB||D.debug("TrafficStatistics:"+_i+++".Receiver                         "+t.sizeof(e.websocketMsgBody.body)+"B."),n.notifyResponseCallback(!0,i))}}]},o.prototype.sendHeartBeatMessage=function(){var t=this,e=this;if(e.isHeartBeatHasResp++,this.connectionState===Z.Connected){var n={websocketMsgType:"HEARTBEAT",websocketMsgId:this.msgId++};setTimeout(function(){D.debug("start check heartBeat response."),e.isHeartBeatHasResp>2&&(D.warn("heartBeat timeout, lost "+e.isHeartBeatHasResp+" package."),t.connectionState=Z.Disconnecting,t.websocketAdapter.close({eventCode:3001})),D.debug("check heartBeat response finish.")},1e4),this.simplifiedSendMessage(JSON.stringify(n))}},o.prototype.resetKeepAlive=function(){var t=this;this.clearKeepAliveTimer(),D.debug("resetKeepAlive enter."),this.sendHeartBeatMessage(),this.keepaliveTimer=setInterval(function(){t.sendHeartBeatMessage()},Math.floor(Yt))},o.prototype.parseJson=function(t){var e={};if(typeof t!="string")return D.warn("parse json type error for"+typeof t),e;try{e=JSON.parse(t)}catch(n){D.warn("Parse json error for"+n+",message length ="+(t==null?void 0:t.length))}return e},o.prototype.needReconnect=function(){return this.connectionState!==Z.Connected&&!this.isInitiativeStop},o.prototype.reconnect=function(){var t=this,e=Math.floor(1.5*this.currentBaseMs),n=Math.max(0,Date.now()-this.lastAttemptTime),r=Math.max(0,e-n);this.lastAttemptTime=Date.now(),D.info("reconnect enter: remainingDelayMs: "+r+" connState: "+this.connectionState);var i=this.isEnableBackUrl?this.certificateService.getSubscribeBackOptions():this.certificateService.getSubscribeOptions();this.isEnableBackUrl=!this.isEnableBackUrl,this.timerHandler=setTimeout(function(){t.start(i,function(){t.needReconnect()?(clearTimeout(t.timerHandler),t.isReconnecting=!0,t.reconnect()):(t.currentBaseMs=0,t.isReconnecting=!1)})},r),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<1e3&&(this.currentBaseMs=1e3),this.currentBaseMs>6e4&&(this.currentBaseMs=6e4)},o.prototype.clearKeepAliveTimer=function(){this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null)},o.prototype.stopHeartBeat=function(){this.isInitiativeStop=!0,this.clearKeepAliveTimer()},o.prototype.resubscribeAll=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return D.info("schedule to resubscribeAll: "+this.encryptRequest.size+" "+this.subscribeDatas.size),[4,this.sendMessages(this.encryptRequest)];case 1:return t.sent(),[4,this.sendMessages(this.subscribeDatas)];case 2:return t.sent(),[2]}})})},o.prototype.simplifiedSendMessage=function(t,e,n){var r={data:t,success:e||function(){},fail:n||function(){}};D.info("simplifiedSendMessage sendMessage"),this.websocketAdapter.sendMessage(r)},o.prototype.setDeviceId=function(t){this.deviceId=t,this.currentVersion++},o}(),Ai="1.5.1",Fn=new M("ContextWrapper"),De=function(){function o(){}return o.setApplicationType=function(t){o.appType=t},o.getApplicationType=function(){return o.appType},o.setApplicationVersion=function(t){o.appVersion=t},o.getApplicationVersion=function(){return o.appVersion},o.getWSocketMessageType=function(t){var e,n,r,i;if(Object.prototype.hasOwnProperty.call(t,"msgInfo"))switch(Fn.log("getWSocketMessageType responseType: "+((e=t.msgInfo)===null||e===void 0?void 0:e.type)+" errorCode: "+((n=t.resInfo)===null||n===void 0?void 0:n.resCode)),(r=t.msgInfo)===null||r===void 0?void 0:r.type){case V.QUERY_SUB:return"SubscribeResponse";case V.QUERY_SUB_PUSH:return"SnapshotUpdate";case V.QUERY_UNSUB:return"UnsubscribeResponse";case V.ENCRYPTION_TASK:return"EncryptionResponse";default:Fn.warn("unknown WSocket message type "+((i=t.msgInfo)===null||i===void 0?void 0:i.type))}return"ErrorMessage"},o.appType="Unknown",o.appVersion=Ai,o}(),ki=W.SyncResponseMessage,Me=new M("SyncRequestProcessor"),ut=function(){function o(t){var e=this;this.webSocketResponse=new Map,this.taskMap=new Map,this.communicateTaskQueue=new Pi,this.subscribeTaskIdSet=new Set,this.subscribeRecordSet=new Set,this.certificateService=t,this.webSocketClient=new mr(t),this.webSocketClient.registerResponseCallback(function(n,r){e.onWebSocketResponse(n,r)})}return o.generateTaskId=function(){return this.taskId=this.taskId.add(1),this.taskId},o.setTraceId=function(t){this.traceId=t},o.generalTraceId=function(){return this.traceId?this.traceId:m.generateTraceId()},o.prototype.registerConnectCallback=function(t){var e=this;this.webSocketClient.registerConnectCallback(function(){e.hasSubscriber()&&(Me.info("do clear subscribes onConnect."),e.clearSubscriber()),t.call(null)})},o.prototype.registerDisconnectCallback=function(t){var e=this;this.webSocketClient.registerDisconnectCallback(function(n){e.needToConnectWebSocket()&&!e.webSocketClient.isReconnectingState()&&(Me.info("do reconnect when there is Subscriber or encryptionMonitor onDisconnect."),e.webSocketClient.reconnect()),t.call(null,n)})},o.prototype.registerWebSocketCallBack=function(t,e){var n,r;e.syncRequest&&e.syncRequest.taskId?this.taskMap.set(((r=(n=e.syncRequest)===null||n===void 0?void 0:n.taskId)===null||r===void 0?void 0:r.toString())||-1,e):this.webSocketResponse.set(t,e)},o.prototype.process=function(t){if(this.verifyRequest()!==0)return Me.warn("invalid request!"),void t.handle(1,new ln);this.communicateTaskQueue.enqueueTask(new Oi(t,0,t.handle))},o.prototype.verifyRequest=function(){var t=this.certificateService.getContext();return m.isEmpty(t)?1014:t.productId?0:1014},o.prototype.onWebSocketResponse=function(t,e){var n,r,i,s,a,u=this;if(t){var l=ki.fromObject(e),c=De.getWSocketMessageType(l),d={responseCode:((n=l.resInfo)===null||n===void 0?void 0:n.resCode)||0,responseType:(r=l.msgInfo)===null||r===void 0?void 0:r.type,taskId:(i=l.msgInfo)===null||i===void 0?void 0:i.id,storeName:(a=(s=l.msgInfo)===null||s===void 0?void 0:s.opStore)===null||a===void 0?void 0:a.storeName},y=m.isNullOrUndefined(d.taskId)||d.taskId<=0?-1:d.taskId;Me.info("onWebSocketResponse taskId: "+y+" responseType: "+d.responseType+"            dataType:"+c),(y===-1?Q(this.webSocketResponse).filter(function(T){var S=fe(T,2),O=S[0];return S[1],O===c}):Q(this.taskMap).filter(function(T){var S=fe(T,2),O=S[0];return S[1],O===y.toString()})).forEach(function(T){var S=fe(T,2);S[0],S[1].onResponse(l,d,u)}),y!==-1&&this.taskMap.delete(y.toString())}else Me.error("onWebSocketResponse: fail!")},o.prototype.getSubscribeTaskIdSet=function(){return this.subscribeTaskIdSet},o.prototype.getSubscribeRecordSet=function(){return this.subscribeRecordSet},o.prototype.clearSubscriber=function(){this.subscribeRecordSet.clear(),this.subscribeTaskIdSet.clear()},o.prototype.hasSubscriber=function(){return this.subscribeRecordSet.size!==0||this.subscribeTaskIdSet.size!==0},o.prototype.needToDisconnectWebsocket=function(){return!this.hasSubscriber()&&!this.encryptionInfoPush},o.prototype.needToConnectWebSocket=function(){return this.hasSubscriber()||!!this.encryptionInfoPush},o.prototype.disConnectWebSocket=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.webSocketClient.stop()];case 1:return t.sent(),[2]}})})},o.prototype.tryToDisconnectWebsocket=function(){this.encryptionInfoPush=void 0,this.hasSubscriber()?Me.info("[tryToDisconnectWebsocket] won't disconnect websocket since there's subscriber!"):(this.webSocketClient.stop(),Me.info("[tryToDisconnectWebsocket] since has no subscriber!"))},o.prototype.addEncryptStatusMonitor=function(t){this.encryptionInfoPush=t},o.prototype.getEncryptionInfoPush=function(){return this.encryptionInfoPush},o.prototype.getWebSocketClient=function(){return this.webSocketClient},o.taskId=L.fromNumber(1),o}(),Be=function(){function o(){this.taskId_=ut.generateTaskId(),this.encryptionVersion_=0,this.schemas_=[],this.traceId_=ut.generalTraceId()}return Object.defineProperty(o.prototype,"schemas",{get:function(){return this.schemas_},set:function(t){this.schemas_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"requestSubType",{get:function(){return this.requestSubType_},set:function(t){this.requestSubType_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"requestType",{get:function(){return this.requestType_},set:function(t){this.requestType_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"traceId",{get:function(){return this.traceId_},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(t){this.naturalStoreName_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"taskId",{get:function(){return this.taskId_},set:function(t){this.taskId_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"encryptionVersion",{get:function(){return this.encryptionVersion_},set:function(t){this.encryptionVersion_=t},enumerable:!1,configurable:!0}),o}(),Sr=function(o){function t(){var e=o.call(this)||this;return e.objectList_=[],e.requestType=V.OBJECT_UPDATE,e}return se(t,o),Object.defineProperty(t.prototype,"objList",{get:function(){return this.objectList_},set:function(e){this.objectList_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"operationType",{get:function(){return this.operationType_},set:function(e){this.operationType_=e},enumerable:!1,configurable:!0}),t}(Be),Gn=W.ClientInfo,Ni=W.EncryptionInfo,Di=W.SyncResponseMessage,Qt=W.SyncRequestMessage,Ui=W.MessageInfo,Mi=W.Store,Wt=W.OperationData,ji=W.SubscribePushMessage,zn=W.Schema,yt=W.SchemaField,$t=W.FieldType,xi=W.QueryRequestMessage,Li=W.SubscribeRequestMessage,Vi=W.UnsubscribeRequestMessage,qi=W.ServerStatus,Ke=function(){this.longs=String,this.defaults=!0},Ce=new M("ProtoHelper"),dn=function(){function o(){}return o.serializeMessage=function(t,e){var n=Qt.create(),r=Ui.create();r.id=t.taskId;var i=Mi.create();if(i.storeName=t.naturalStoreName||"",r.opStore=i,r.type=t.requestType,r.subType=t.requestSubType,r.traceId=t.traceId,Ce.info("[request] traceId:"+t.traceId+", requestType: "+t.requestType),n.clientInfo=o.buildClientInfo(e),n.msgInfo=r,n.clientInfo.enVer=t.encryptionVersion,r.type===V.QUERY_SUB)n.schemas=t.schemas.map(function(c){return o.schemaSub2Proto(c)});else if(r.type!==V.SERVER_STATUS){var s=r.type!==V.SCHEMA_NEGOTIATE,a=!1;t instanceof Sr&&(a=t.operationType===ge.SYNC_DELETE),n.schemas=t.schemas.map(function(c){return o.schema2Proto(c,s,a)})}var u=Q(o.serializationActions())[r.type];if(!u)throw Ce.warn("unknown message type"+r.type),h.build(1008);if(u.call(null,t,n),o.isWebSocketMessageType(t))return Qt.toObject(n,new Ke);var l=Qt.encode(n).finish();return l.buffer.slice(l.byteOffset,l.byteOffset+l.length)},o.deserializeMessage=function(t){var e,n,r=Di.decode(new Uint8Array(t)),i=r.msgInfo,s=i.type,a=i.id,u={storeName:((e=i.opStore)===null||e===void 0?void 0:e.storeName)||"",taskId:a,responseCode:((n=r.resInfo)===null||n===void 0?void 0:n.resCode)||0,type:s,subType:i.subType||0,response:void 0};u.responseCode!==0&&Ce.warn("cloud sync not execute success , responseCode =  "+u.responseCode);var l=Q(o.deserializationActions())[i.type];if(!l)throw Ce.warn("unknown message type"+s),h.build(1008);return u.response=l.call(null,u,r),u},o.parseValue=function(t,e){var n,r;if(!t||t.length===0)return[];var i=[];try{for(var s=E(t),a=s.next();!a.done;a=s.next())a.value.os.forEach(function(u){i.push(new Ie(e[u.i],u.fs))})}catch(u){n={error:u}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return i},o.schemaSub2Proto=function(t){var e=[];return Q(t.getFieldInfos().values()).forEach(function(n){n.isPrimaryKey&&e.push(yt.fromObject({n:n.fieldName,t:n.fieldType}))}),e.push(yt.fromObject({n:"naturalbase_version",t:$t.TYPE_LONG})),zn.create({n:t.name,fs:e})},o.schema2Proto=function(t,e,n){var r,i,s=[],a=[];try{for(var u=E(Q(t.getFieldInfos().values())),l=u.next();!l.done;l=u.next()){var c=l.value,d=c.fieldType;e&&c.isEncryptField&&!n&&s.push(yt.create({n:c.fieldName+"#ope",t:$t.TYPE_STRING}));var y=yt.create({n:c.fieldName,t:e&&c.isEncryptField?$t.TYPE_BYTE_ARRAY:d,p:c.isPrimaryKey,e:c.isEncryptField,nn:c.isNotNull,df:c.hasDefaultValue});y.defaultValue=c.defaultValue,y[oe.get(d)]=c.defaultValue,n&&!c.isPrimaryKey||a.push(y)}}catch(T){r={error:T}}finally{try{l&&!l.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}return zn.create({n:t.name,fs:a.concat(s)})},o.isWebSocketMessageType=function(t){var e=t.requestType;return e===V.QUERY_SUB||e===V.QUERY_UNSUB||e===V.ENCRYPTION_TASK&&(t.requestSubType===te.MONITOR_USER_COMMAND_CHANGE||t.requestSubType===te.MONITOR_DATA_KEY_CHANGE)},o.buildClientInfo=function(t){var e=t.getContext(),n=new Object({appVer:e.appVersion,msgVer:2,pid:e.productId,cid:e.clientId,aid:e.appId}),r=Gn.verify(n);if(r!=null)throw Ce.warn(r),h.build(1003);return Gn.fromObject(n)},o.objectUpdateDeserialization=function(t,e){return{queryId:e.msgInfo.id.toString(),successNumber:e.updateResMsg.successRecCount}},o.objectUpdateSerialization=function(t,e){e.schemas.forEach(function(s){Ie.addSystemSchemaField(s)});var n=t.operationType===ge.SYNC_DELETE,r=Ie.buildObjs(t.objList,e.schemas,n),i=Wt.create({os:r,t:t.operationType,i:0});e.opData=[i]},o.encryptionDeserialization=function(t,e){var n=e==null?void 0:e.enResInfo;if(!n)throw Ce.error("ProtoHelper:deserializationActions encryption get invalid encryptionResponseMessage"),h.build("ProtoHelper:deserializationActions encryption get invalid encryptionResponseMessage");return{encryptionMessageType:e.msgInfo.subType,encryptionInfoList:n.map(function(r){var i=new je;return i.keyStatus=r.keyStatus,i.firstSaltValue=r.firstSalt,i.secondSaltValue=r.secondSalt,i.rootKeyToken=r.rootToken,i.dataKeyCipherText=r.cipherText,i.oldDataKeyCipherText=r.oldCipherText,i.keyVersion=r.keyVer,i})}},o.encryptionSerialization=function(t,e){e.msgInfo.subType=t.requestSubType,e.msgInfo.type=V.ENCRYPTION_TASK,e.enReqInfo=t.requestInfo.map(function(n){return Ni.create({keyStatus:n.keyStatus,firstSalt:n.firstSaltValue,secondSalt:n.secondSaltValue,rootToken:n.rootKeyToken,cipherText:n.dataKeyCipherText,oldCipherText:n.oldDataKeyCipherText,keyVer:n.keyVersion})})},o.objectQueryDeserialization=function(t,e){var n,r=e.queryResMsg,i=e.opData,s=e.schemas;return{tableName:(n=s[0])===null||n===void 0?void 0:n.n,queryResult:r.isComplete,queryType:r.queryType,totalLength:i.length,aggreResult:r.aggQueryRes,responseObject:o.parseValue(i,s)}},o.objectQuerySerialization=function(t,e){e.queryReqMsg=xi.create({queryType:t.queryType,queryTable:t.tableName,queryCond:t.queryCondition})},o.transactionDeserialization=function(t,e){var n;return{transactionId:e.msgInfo.id.toString(),transactionResult:(n=e.resInfo)===null||n===void 0?void 0:n.resCode}},o.transactionSerialization=function(t,e){var n;e.schemas.forEach(function(l){Ie.addSystemSchemaField(l)});var r=e.schemas,i=t.verifyObjects,s=Ie.buildVerifyObjs(i,r),a=Ie.buildOperationData(s,ge.VERIFY);(n=e.opData).push.apply(n,Q(a));var u=t.transactionDatas;Ie.buildTransactionData(e,u,r)},o.querySubscribeDeserialization=function(t,e){return{subscribeResults:e.subResMsg.map(function(n){return n.toJSON()})}},o.querySubscribeSerialization=function(t,e){var n=[];e.subReqMsg=t.subscribeDatas.map(function(r){if(r.snapshotObjs&&r.snapshotObjs.length>0){var i=fe(Ie.findSchemaIndex(e.schemas,r.tableName),2),s=i[0],a=i[1];if(s<0||!a)throw h.build(1003);var u=Ie.buildSubObjs(r.snapshotObjs,a);n.push(Wt.create({os:u}))}return Li.create({subId:r.subscribeId,subTable:r.tableName,subCond:r.subscribeCondition,subStore:r.naturalStoreName})}),e.opData=n},o.queryUnsubscribeDeserialization=function(t,e){return{unSubScribeResults:e.unSubResMsg.map(function(n){return n.toJSON()})}},o.queryUnSubscribeSerialization=function(t,e){e.unSubReqMsg=t.unSubscribeDatas.map(function(n){return Vi.create({subRecId:n.cloudSubRecordId,unSubStore:n.naturalStoreName,unSubTable:n.tableName,subKey:n.cloudSubKey})})},o.querySubPushDeserialization=function(t,e){var n,r,i=ji.toObject(e.subPushMsg,new Ke),s=e.schemas,a=e.opData.map(function(l){var c=Wt.toObject(l,new Ke);return c.tableName=s[l.i].n,c}),u=((r=(n=e.msgInfo)===null||n===void 0?void 0:n.opStore)===null||r===void 0?void 0:r.storeName)||"";return{pushSeq:i.pushSeq,storeName:u,subRecId:i.subRecId,subKey:i.subKey,subscribeId:i.subId,responseObject:a}},o.serverStatusQueryDeserialization=function(t,e){if(e.serverStatus){var n=qi.toObject(e.serverStatus,new Ke);return{serverTimestamp:Number(n.timestamp)}}return{}},o.serverStatusQuerySerialization=function(){},o.emptyFuncDeserialization=function(t,e){Ce.error("Call deserialization empty function.")},o.emptyFuncSerialization=function(t,e){Ce.error("Call serialization empty function.")},o.deserializationActions=function(){return[o.emptyFuncDeserialization,o.emptyFuncDeserialization,o.emptyFuncDeserialization,o.objectUpdateDeserialization,o.transactionDeserialization,o.objectQueryDeserialization,o.querySubscribeDeserialization,o.queryUnsubscribeDeserialization,o.querySubPushDeserialization,o.encryptionDeserialization,o.emptyFuncDeserialization,o.serverStatusQueryDeserialization]},o.serializationActions=function(){return[o.emptyFuncSerialization,o.emptyFuncSerialization,o.emptyFuncSerialization,o.objectUpdateSerialization,o.transactionSerialization,o.objectQuerySerialization,o.querySubscribeSerialization,o.queryUnSubscribeSerialization,o.emptyFuncSerialization,o.encryptionSerialization,o.emptyFuncDeserialization,o.serverStatusQuerySerialization]},o}();(function(o){o[o.PROTOBUF=3]="PROTOBUF",o[o.JSON=4]="JSON"})(at||(at={}));var ue,Hn=function(o){function t(){var e=o.call(this)||this;return e.subscribeDatas_=[],e.requestType=V.QUERY_SUB,e}return se(t,o),Object.defineProperty(t.prototype,"subscribeDatas",{get:function(){return this.subscribeDatas_},set:function(e){this.subscribeDatas_=e},enumerable:!1,configurable:!0}),t}(Be),Yn=function(){function o(){this.snapshotObjs_=[]}return Object.defineProperty(o.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(t){this.naturalStoreName_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"tableName",{get:function(){return this.tableName_},set:function(t){this.tableName_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"subscribeId",{get:function(){return this.subscribeId_},set:function(t){this.subscribeId_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"subscribeCondition",{get:function(){return this.subscribeCondition_},set:function(t){this.subscribeCondition_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"snapshotObjs",{get:function(){return this.snapshotObjs_},set:function(t){this.snapshotObjs_=t},enumerable:!1,configurable:!0}),o}(),Ki=function(o){function t(){var e=o.call(this)||this;return e.requestType=V.OBJECT_QUERY,e}return se(t,o),Object.defineProperty(t.prototype,"tableName",{get:function(){return this.tableName_},set:function(e){this.tableName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queryCondition",{get:function(){return this.queryCondition_},set:function(e){this.queryCondition_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queryType",{get:function(){return this.queryType_},set:function(e){this.queryType_=e},enumerable:!1,configurable:!0}),t}(Be),Bi=function(o){function t(){var e=o.call(this)||this;return e.verifyObjects_=[],e.transactionDatas_=[],e.requestType=V.TRANSACTION,e}return se(t,o),Object.defineProperty(t.prototype,"verifyObjects",{get:function(){return this.verifyObjects_},set:function(e){this.verifyObjects_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transactionDatas",{get:function(){return this.transactionDatas_},set:function(e){this.transactionDatas_=e},enumerable:!1,configurable:!0}),t}(Be),Qn=function(o){function t(){var e=o.call(this)||this;return e.unSubscribeDatas_=[],e.requestType=V.QUERY_UNSUB,e}return se(t,o),Object.defineProperty(t.prototype,"unSubscribeDatas",{get:function(){return this.unSubscribeDatas_},set:function(e){this.unSubscribeDatas_=e},enumerable:!1,configurable:!0}),t}(Be),Wn=function(){function o(){}return Object.defineProperty(o.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(t){this.naturalStoreName_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"tableName",{get:function(){return this.tableName_},set:function(t){this.tableName_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"cloudSubRecordId",{get:function(){return this.cloudSubRecordId_},set:function(t){this.cloudSubRecordId_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"cloudSubKey",{get:function(){return this.cloudSubKey_},set:function(t){this.cloudSubKey_=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"subscribeId",{get:function(){return this.subscribeId_},set:function(t){this.subscribeId_=t},enumerable:!1,configurable:!0}),o}(),Tr=function(){},mn=function(o){function t(e,n,r){var i=o.call(this)||this;return i.syncRequest=e,i.handle=n,i.syncProcessor=r,i}return se(t,o),t}(Tr),gt=new M("SubscribeTask"),Fi=function(o){function t(e,n,r,i){var s=o.call(this,e,r,i)||this;return s.syncRequest.encryptionVersion=n,s.onSubscribeResponse=r,s}return se(t,o),t.prototype.onResponse=function(e,n,r){var i,s=[];e.subResMsg.forEach(function(a){var u,l;l=((u=e.resInfo)===null||u===void 0?void 0:u.resCode)===1004008?1004008:a.subResCode,s.push({cloudSubRecordId:a==null?void 0:a.subRecId,subscribeId:a==null?void 0:a.subId,subKey:a==null?void 0:a.subKey,result:l,subResponseCode:a.subResCode}),a!=null&&a.subRecId&&r.getSubscribeRecordSet().add(a==null?void 0:a.subRecId)}),n.response={subscribeResults:s},r.getSubscribeTaskIdSet().has(e.msgInfo.id.toString())&&(gt.info("[onResponse] subscribeTaskIdSet size : "+r.getSubscribeTaskIdSet().size),r.getSubscribeTaskIdSet().delete(e.msgInfo.id.toString())),gt.info("[onResponse] subscribeResults size : "+s.length),(i=this.onSubscribeResponse)===null||i===void 0||i.call(null,0,n)},t.prototype.request=function(){var e,n,r;gt.info("[request] taskId: "+this.syncRequest.taskId+"             requestType: "+this.syncRequest.requestType),this.syncRequest.taskId&&((e=this.syncProcessor)===null||e===void 0||e.getSubscribeTaskIdSet().add(this.syncRequest.taskId.toString())),gt.info("[request] subscribeRecordSet len: "+((n=this.syncProcessor)===null||n===void 0?void 0:n.getSubscribeRecordSet().size)),(r=this.syncProcessor)===null||r===void 0||r.getWebSocketClient().sendSubscribeRequest(this.syncRequest)},t}(mn),bt=new M("HttpsClient"),Ir=function(){function o(t){this.productId="",this.certificateService=t,this.httpAdapter=new o.httpAdapterClazz}return o.setClient=function(t){this.httpAdapterClazz=t},o.prototype.send=function(t,e,n,r){return b(this,void 0,void 0,function(){return g(this,function(i){switch(i.label){case 0:return m.isEmpty(this.certificateService.getContext())?(r(!1,h.build(1003)),[2]):(this.productId=this.certificateService.getContext().productId,this.productId?[4,this.processRequest(this.certificateService.getUrl()+t,this.certificateService.getBackUrl()+t,e,n,r)]:(r(!1,h.build(1003)),[2]));case 1:return i.sent(),[2]}})})},o.prototype.processRequest=function(t,e,n,r,i){return b(this,void 0,void 0,function(){var s,a,u;return g(this,function(l){switch(l.label){case 0:s=r instanceof ArrayBuffer,a=s?r:JSON.stringify(r),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.certificateService.getHeaderParam(s)];case 2:return(u=l.sent())===void 0?(i(!1,h.build(1013)),[2]):(this.requestForSync(t,e,n,a,u,i),[3,4]);case 3:return l.sent(),i(!1,h.build(1011)),[2];case 4:return[2]}})})},o.prototype.requestForSync=function(t,e,n,r,i,s){var a={url:t,backUrl:e,method:n,header:i,data:r,success:function(u){s(!0,u.data),bt.log("requestForSync: success!")},fail:function(u){if(bt.error("HTTPS request process failed."),u.status!==413)s(!1,h.build(1011));else{bt.error("Request entity is too large.");var l=h.build(1006);s(!1,l)}}};bt.info("HTTP_ADAPTER send request"),this.httpAdapter.request(a)},o}(),Pe=new M("HttpRequestTask"),Gi=new Map([[V.SCHEMA_NEGOTIATE,"/negotiate"],[V.OBJECT_UPDATE,"/upsert"],[V.CACHE_UPDATE,"/upsert"],[V.OBJECT_QUERY,"/query"],[V.TRANSACTION,"/transaction"],[V.ENCRYPTION_TASK,"/encryption"],[V.SERVER_STATUS,"/query"]]),pn=function(o){function t(e,n,r,i){var s=o.call(this)||this;return s.syncRequest=e,s.certificateService=r,s.syncRequest.encryptionVersion=n,s.handle=i,s}return se(t,o),t.prototype.request=function(){var e=this;Pe.info("[request] taskId:"+this.syncRequest.taskId+"             requestType: "+this.syncRequest.requestType+" encryptType: "+this.syncRequest.requestSubType);var n=Gi.get(this.syncRequest.requestType);t.httpResponseMap.set(this.syncRequest.taskId.toString(),this.handle),n?new Ir(this.certificateService).send(n.toString()+"?_v="+at.PROTOBUF,"POST",dn.serializeMessage(this.syncRequest,this.certificateService),function(r,i){var s,a;Pe.info("[request] isSuccess: "+r),r?m.isArrayBuffer(i)?e.onResponse(i):(Pe.warn("[request] Illegal http response content type = "+typeof i),Pe.warn(""+h.build(1010)),(s=t.httpResponseMap.get(e.syncRequest.taskId.toString()))===null||s===void 0||s.call(null,1010,new ln),t.httpResponseMap.delete(e.syncRequest.taskId.toString())):((a=t.httpResponseMap.get(e.syncRequest.taskId.toString()))===null||a===void 0||a.call(null,i.code,new ln),t.httpResponseMap.delete(e.syncRequest.taskId.toString()))}):Pe.warn("request: requestType is not contained in REQUEST_URL_MAP!")},t.prototype.onResponse=function(e){var n,r=dn.deserializeMessage(e);r.responseCode!==0&&Pe.warn("[onResponse] CloudSyncResultCode = "+r.responseCode),Pe.info("[onResponse] taskId: "+r.taskId+" responseType: "+r.type+"             httpResponseMap size: "+t.httpResponseMap.size),t.httpResponseMap.has(r.taskId.toString())?((n=t.httpResponseMap.get(r.taskId.toString()))===null||n===void 0||n.call(null,r.responseCode,r),t.httpResponseMap.delete(r.taskId.toString())):Pe.warn("[onResponse]: callback of the taskId has no register")},t.httpResponseMap=new Map,t}(Tr),vt=new M("UnSubscribeTask"),zi=function(o){function t(e,n,r,i){var s=o.call(this,e,r,i)||this;return s.syncRequest.encryptionVersion=n,s.onUnSubscribeResponse=s.handle,s}return se(t,o),t.prototype.onResponse=function(e,n,r){var i,s,a=[];(i=e.unSubResMsg)===null||i===void 0||i.forEach(function(u){a.push({cloudSubRecordId:u==null?void 0:u.unSubRecId,ExceptionCode:u==null?void 0:u.unSubResCode})}),n.response={unSubScribeResults:a},vt.info("[onResponse] unSubScribeResults size: "+a.length+"             subscribeRecordSet.size "+r.getSubscribeRecordSet().size),(s=this.onUnSubscribeResponse)===null||s===void 0||s.call(null,0,n),r.needToDisconnectWebsocket()&&(vt.info("[onResponse] stopHeartBeat since there is no subscriber."),r.getWebSocketClient().stopHeartBeat())},t.prototype.request=function(){var e,n,r,i,s,a=this;vt.info("[request] taskId: "+this.syncRequest.taskId+"             requestType:"+this.syncRequest.requestType);try{for(var u=E(this.syncRequest.unSubscribeDatas),l=u.next();!l.done;l=u.next()){var c=l.value;(r=this.syncProcessor)===null||r===void 0||r.getSubscribeRecordSet().delete(c.cloudSubRecordId)}}catch(y){e={error:y}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(e)throw e.error}}vt.info("[request] subscribeRecordSet.size "+((i=this.syncProcessor)===null||i===void 0?void 0:i.getSubscribeRecordSet().size));var d=[];(s=this.syncProcessor)===null||s===void 0||s.getWebSocketClient().sendUnsubscribeRequest(this.syncRequest,function(){a.syncRequest.unSubscribeDatas.forEach(function(T){d.push({cloudSubRecordId:T.cloudSubRecordId,errorCode:0})});var y={responseCode:0,responseType:a.syncRequest.requestType,taskId:a.syncRequest.taskId,storeName:a.syncRequest.naturalStoreName,response:{unSubScribeResults:d}};a.onUnSubscribeResponse.call(null,0,y)})},t}(mn),Re=new M("CallbackTask"),Hi=function(){function o(){this.timerHandler=void 0,this.timeoutMs=0,this.isDone=!1}return o.prototype.timeoutMonitor=function(t){var e=this;Re.debug("timeoutMonitor: enter"),this.timeoutMs>0&&(this.timerHandler=setTimeout(function(){e.timerHandler&&clearTimeout(e.timerHandler),Re.log("timeoutMonitor: setTimeout reject isDone:"+e.isDone),e.isDone||(Re.log("timeoutMonitor: setTimeout reject"),t(1004))},this.timeoutMs))},o.prototype.execute=function(t){return b(this,void 0,void 0,function(){var e=this;return g(this,function(n){return[2,new Promise(function(r,i){e.timeoutMonitor(i),b(e,void 0,void 0,function(){return g(this,function(s){return Re.log("executeWithTimeout: handle start calling"),[2,t==null?void 0:t.call(null)]})}).then(function(s){e.isDone=!0,e.timerHandler&&clearTimeout(e.timerHandler),Re.debug("executeWithTimeout: handle finished calling: resultCode = "+s.resultCode),r(s)}).catch(function(s){e.isDone=!0,i(s)})})]})})},o.prototype.executeWithTimeout=function(t,e){return b(this,void 0,void 0,function(){var n=this;return g(this,function(r){return this.timeoutMs=t,Re.debug("executeWithTimeout: enter"),[2,new Promise(function(i,s){n.execute(e).then(function(a){Re.debug("executeWithTimeout: execute done resultCode = "+a.resultCode),i(a)}).catch(function(a){n.isDone||Re.error("executeWithTimeout: timeout!"),Re.debug("executeWithTimeout: execute done resultCode = "+a.resultCode),i(a)})})]})})},o}(),Yi=function(o){function t(e,n,r){var i=o.call(this)||this;return i.requestInfo_=[],i.taskId_=r,i.requestType=V.ENCRYPTION_TASK,i.requestSubType=e,i.requestInfo_=n,i}return se(t,o),Object.defineProperty(t.prototype,"requestInfo",{get:function(){return this.requestInfo_},enumerable:!1,configurable:!0}),t}(Be),Qe=new M("MonitorTask"),Qi=function(o){function t(e,n,r,i){var s=o.call(this,e,r,i)||this;return s.syncRequest.encryptionVersion=n,s}return se(t,o),t.prototype.onResponse=function(e,n,r){var i=e.msgInfo;if(i){var s=i.subType,a=e.enResInfo,u=a==null?void 0:a.length;Qe.info("[onResponse] messageType: "+s+" encryptionInfoList size:"+u),n.response={encryptionInfoList:e.enResInfo,encryptionMessageType:s},s===te.MONITOR_USER_COMMAND_CHANGE?this.userCommandMonitorResponse(0,n):s===te.MONITOR_DATA_KEY_CHANGE&&this.userKeyMonitorResponse(0,n)}else Qe.error("[onResponse] invalid encryptionResponseMessage!")},t.prototype.request=function(){Qe.info("MonitorTask taskId: "+this.syncRequest.taskId+"             encryptType: "+this.syncRequest.requestSubType),this.syncRequest.requestSubType===te.MONITOR_USER_COMMAND_CHANGE?this.commandMonitor(this.syncRequest,this.handle):this.syncRequest.requestSubType===te.MONITOR_DATA_KEY_CHANGE?this.userKeyMonitor(this.syncRequest,this.handle):Qe.warn("MonitorTask taskId: "+this.syncRequest.taskId+" is not need to call")},t.prototype.commandMonitor=function(e,n){var r;(r=this.syncProcessor)===null||r===void 0||r.getWebSocketClient().subEncryption(e,function(){Qe.info("commandMonitorTask: add user command changed monitor success!")}),this.userCommandMonitorResponse=n},t.prototype.userKeyMonitor=function(e,n){var r;(r=this.syncProcessor)===null||r===void 0||r.getWebSocketClient().subEncryption(e,function(){Qe.info("userKeyMonitorTask: add user key changed monitor success!")}),this.userKeyMonitorResponse=n},t}(mn),Y=new M("EncryptTaskManager"),Wi=function(){function o(t,e){this.encryptTaskCacheMap=new Map,this.syncProcess=t,this.naturalBaseRef=e,this.naturalBaseRef.getEntireEncryptInterval().saveEncryptTaskManager(this)}return o.prototype.clearEncryptInfo=function(t){t.forEach(function(e){e.clear()}),t.length=0},o.prototype.addEncryptionListener=function(t){return b(this,void 0,void 0,function(){var e,n=this;return g(this,function(r){switch(r.label){case 0:return[4,this.processEncryptionTask(te.MONITOR_USER_COMMAND_CHANGE,[])];case 1:return(e=r.sent()).resultCode!==0?(Y.error("addEncryptionListener: add user command monitor fail: "+e.resultCode),[2]):[4,this.processEncryptionTask(te.MONITOR_DATA_KEY_CHANGE,[])];case 2:return(e=r.sent()).resultCode!==0?(Y.error("addEncryptionListener: add data key monitor fail: "+e.resultCode),[2]):(this.syncProcess.addEncryptStatusMonitor(function(i,s){i===0?(Y.info("addEncryptionListener: receive notification success."),n.handleEncryptPushMessage(s,t)):Y.warn("addEncryptionListener: get notification fail for "+i+".")}),Y.info("addEncryptionListener: add user encryption changed monitor success!"),[2])}})})},o.prototype.tryToDisconnectWhenClearUserKey=function(){this.syncProcess.tryToDisconnectWebsocket()},o.prototype.processEncryptionTask=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s=this;return g(this,function(a){switch(a.label){case 0:return n=ut.generateTaskId(),r=new $i(t,n,e),this.encryptTaskCacheMap.set(n.toString(),r),Y.info("processEncryptionTask: taskId: "+n+" encryptType: "+t),[4,r.executeWithTimeout(o.ENCRYPT_TASK_TIMEOUT_IN_MILLISECOND,function(){return b(s,void 0,void 0,function(){var u;return g(this,function(l){switch(l.label){case 0:return u=new Yi(r.requestSubType,r.requestInfo,r.taskId),[4,this.onEncryptTask(u)];case 1:return[2,l.sent()]}})})})];case 1:return i=a.sent(),Y.info("processEncryptionTask resultCode:"+i.resultCode),[2,i]}})})},o.prototype.onEncryptTask=function(t){return b(this,void 0,void 0,function(){var e=this;return g(this,function(n){switch(n.label){case 0:return[4,new Promise(function(r,i){var s,a=function(u,l){if(Y.debug("onWebsocketTask: handle encrypt resultCode: "+u),u!==0)return Y.error("onWebsocketTask: fail to send encrypt task!"),void i(new qe(u,[]));r(e.handleEncryptTaskResult(l))};t.requestSubType===te.MONITOR_USER_COMMAND_CHANGE||t.requestSubType===te.MONITOR_DATA_KEY_CHANGE?(s=new Qi(t,e.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),a,e.syncProcess),e.syncProcess.registerWebSocketCallBack("EncryptionResponse",s)):s=new pn(t,e.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),e.naturalBaseRef.getCertificateService(),a),e.syncProcess.process(s)})];case 1:return[2,n.sent()]}})})},o.prototype.querySaltValue=function(){return b(this,void 0,void 0,function(){return g(this,function(t){return Y.debug("querySaltValue start"),[2,this.processEncryptionTask(te.QUERY_SALT_VALUE,[])]})})},o.prototype.queryDataKeyCipherText=function(t){var e;return b(this,void 0,void 0,function(){return g(this,function(n){return Y.info("queryDataKeyCipherText start"),((e=t.rootKeyToken)===null||e===void 0?void 0:e.length)===0?(Y.error("queryDataKeyCipherText fail: requestInfo rootKeyToken is empty!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(te.QUERY_CIPHER_TEST,[t])]})})},o.prototype.insertEncryptedInfo=function(t){var e,n,r,i;return b(this,void 0,void 0,function(){return g(this,function(s){return Y.info("insertEncryptedInfo start"),((e=t.firstSaltValue)===null||e===void 0?void 0:e.length)===0||((n=t.secondSaltValue)===null||n===void 0?void 0:n.length)===0||((r=t.rootKeyToken)===null||r===void 0?void 0:r.length)===0||((i=t.dataKeyCipherText)===null||i===void 0?void 0:i.length)===0?(Y.error("insertEncryptedInfo fail: insert encrypt info contains empty buffer!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(te.INSERT_ENCRYPTION_INFO,[t])]})})},o.prototype.updateEncryptedInfo=function(t,e){var n,r,i,s,a;return b(this,void 0,void 0,function(){return g(this,function(u){return Y.info("updateEncryptedInfo start"),((n=t.rootKeyToken)===null||n===void 0?void 0:n.length)===0?(Y.error("updateEncryptedInfo: old encrypt rootKeyToken is null!"),[2,Promise.reject(1e6)]):((r=e.firstSaltValue)===null||r===void 0?void 0:r.length)===0||((i=e.secondSaltValue)===null||i===void 0?void 0:i.length)===0||((s=e.rootKeyToken)===null||s===void 0?void 0:s.length)===0||((a=e.dataKeyCipherText)===null||a===void 0?void 0:a.length)===0?(Y.error("updateEncryptedInfo: new encrypt contains empty buffer!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(te.UPDATE_ENCRYPTION_INFO,[t,e])]})})},o.prototype.handleEncryptTaskResult=function(t){var e,n,r=t.responseCode;if(r!==0)return Y.warn("handleEncryptTaskResult: cloud encryption exception occurs!"),new qe(r,[]);var i=this.encryptTaskCacheMap.get(t.taskId.toString());if(!i)return Y.error("handleEncryptTaskResult: invalid encryptTask, taskId: "+t.taskId),new qe(1007,[]);var s=t.response;if(Y.info("handleEncryptTaskResult: taskId: "+t.taskId+"             encryptType: "+s.encryptionMessageType+"             responseInfo size:"+((e=s.encryptionInfoList)===null||e===void 0?void 0:e.length)),i.requestSubType!==s.encryptionMessageType)return Y.error("handleEncryptTaskResult: response encrypt type does not matched with task encrypt type"),this.clearEncryptInfo(i.requestInfo),this.encryptTaskCacheMap.delete(t.taskId.toString()),new qe(1007,[]);var a=[];return(n=s.encryptionInfoList)===null||n===void 0||n.forEach(function(u){a.push(u)}),this.clearEncryptInfo(i.requestInfo),this.encryptTaskCacheMap.delete(t.taskId.toString()),Y.debug("handleEncryptTaskResult: encryptTaskCacheMap size: "+this.encryptTaskCacheMap.size),new qe(0,a)},o.prototype.handleEncryptPushMessage=function(t,e){var n;if(!e)return Y.error("handleEncryptPushMessage: no encryption monitor registered!"),0;var r=new Map([[te.NOTIFY_ENCRYPTION_COMMAND_CHANGED,function(s){s.onUserCommandChanged()}],[te.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL,function(s){s.onKeyChanged(ye.NORMAL)}],[te.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING,function(s){s.onKeyChanged(ye.UPDATING)}],[te.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT,function(s){s.onKeyChanged(ye.INTERRUPT)}]]),i=t.response.encryptionMessageType;return Y.info("handleEncryptPushMessage: notificationType: "+i),r.has(i)?((n=r.get(i))===null||n===void 0||n.call(null,e),0):(Y.error("handleEncryptPushMessage: invalid encryption push type!"),1007)},o.ENCRYPT_TASK_TIMEOUT_IN_MILLISECOND=6e4,o}(),$i=function(o){function t(e,n,r){var i=o.call(this)||this;return i.taskId_=L.fromNumber(0),i.resultCode_=0,i.requestInfo_=[],i.taskId_=n,i.requestSubType_=e,r.forEach(function(s){i.requestInfo_.push(s)}),i}return se(t,o),Object.defineProperty(t.prototype,"requestSubType",{get:function(){return this.requestSubType_},set:function(e){this.requestSubType_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"taskId",{get:function(){return this.taskId_},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"resultCode",{get:function(){return this.resultCode_},set:function(e){this.resultCode_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"requestInfo",{get:function(){return this.requestInfo_},enumerable:!1,configurable:!0}),t.prototype.clearRequestInfo=function(){this.requestInfo_=[]},t}(Hi),Ji=new M("SnapshotUpdateTask"),Xi=function(){function o(t){this.onPush=t}return o.prototype.onResponse=function(t,e){var n,r,i=t.opData,s=t.schemas,a=s?(n=s[0])===null||n===void 0?void 0:n.n:void 0,u=[],l=t.subPushMsg,c={pushSeq:l.pushSeq.toNumber(),storeName:t.msgInfo.opStore.storeName,subKey:l.subKey,subRecId:l.subRecId,subscribeId:l.subId,responseObject:u,tableName:a,operationType:(i==null?void 0:i.length)>0?(r=i[0])===null||r===void 0?void 0:r.t:void 0};i.forEach(function(y){y.os.forEach(function(T){var S=T.fs;u.push(new Ie(s[0],S,y.t))})});var d=u.length;Ji.info("[onResponse] enter, responseObjects size:"+(d||0)),e.response=c,this.onPush(e.responseCode,e)},o}(),$n=new M("EncryptionInfoPushTask"),Zi=function(){function o(){}return o.prototype.onResponse=function(t,e,n){var r,i=t.msgInfo;if(i){var s=i.subType,a=t.enResInfo,u=a==null?void 0:a.length;$n.info("[onResponse] messageType: "+s+" encryptionInfoList size:"+u),e.response={encryptionInfoList:t.enResInfo,encryptionMessageType:s},(r=n==null?void 0:n.getEncryptionInfoPush())===null||r===void 0||r.call(null,0,e)}else $n.error("[onResponse] invalid encryptionResponseMessage!")},o}(),es=function(o){function t(){var e=o.call(this)||this;return e.requestType=V.SERVER_STATUS,e}return se(t,o),t}(Be);(function(o){o[o.ALL_STORE=1]="ALL_STORE",o[o.STORE=2]="STORE",o[o.DEFAULT_SUBSCRIBE=3]="DEFAULT_SUBSCRIBE"})(ue||(ue={}));var q=new M("NaturalCloudSyncModule"),ts=function(){function o(t){var e=this;this.subTunnelFail=!1,this.isInitiativeStop=!1,this.naturalBaseRef=t,this.syncInstance=new ut(t.getCertificateService()),this.syncInstance.registerWebSocketCallBack("SnapshotUpdate",new Xi(function(n,r){e.handleQuerySubPushRes(r)})),this.syncInstance.registerWebSocketCallBack("EncryptionResponse",new Zi),this.syncInstance.registerConnectCallback(function(){return b(e,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.onConnect()];case 1:return n.sent(),[2]}})})}),this.syncInstance.registerDisconnectCallback(function(n){e.onDisconnect(n)}),this.encryptTaskManager=new Wi(this.syncInstance,this.naturalBaseRef)}return o.prototype.getSubscribeInfos=function(t){return b(this,void 0,void 0,function(){var e,n,r,i,s,a,u,l,c,d,y,T,S;return g(this,function(O){switch(O.label){case 0:e=[],n=0,r=t.getAllSubscribeInfo(),O.label=1;case 1:O.trys.push([1,7,8,9]),i=E(r.values()),s=i.next(),O.label=2;case 2:return s.done?[3,6]:(a=s.value,[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(a.cloudDBZoneQuery.getClassName()).catch(function(P){return(P==null?void 0:P.getCode())||0})]);case 3:return u=O.sent(),l=e,c=n++,d=[a.queryId,a.cloudDBZoneQuery.getClassName()],[4,t.getQueryConditionByString(a.cloudDBZoneQuery.getClassName(),a.cloudDBZoneQuery.getQueryConditions())];case 4:l[c]=d.concat([O.sent(),u,a.cloudSubRecordId]),a.pushSeq=0,O.label=5;case 5:return s=i.next(),[3,2];case 6:return[3,9];case 7:return y=O.sent(),T={error:y},[3,9];case 8:try{s&&!s.done&&(S=i.return)&&S.call(i)}finally{if(T)throw T.error}return[7];case 9:return[2,e]}})})},o.prototype.getSubInfoByRange=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c,d;return g(this,function(y){switch(y.label){case 0:switch(r=new Map,i=[],t){case ue.ALL_STORE:return[3,1];case ue.STORE:return[3,9];case ue.DEFAULT_SUBSCRIBE:return[3,11]}return[3,12];case 1:y.trys.push([1,6,7,8]),s=E(this.naturalBaseRef.getAllNaturalStore()),a=s.next(),y.label=2;case 2:return a.done?[3,5]:(u=a.value,[4,this.getSubscribeInfos(u)]);case 3:if((i=y.sent()).length===0)return[3,4];r.set(u.getNaturalStoreName(),i),y.label=4;case 4:return a=s.next(),[3,2];case 5:return[3,8];case 6:return l=y.sent(),c={error:l},[3,8];case 7:try{a&&!a.done&&(d=s.return)&&d.call(s)}finally{if(c)throw c.error}return[7];case 8:return[3,12];case 9:return e?[4,this.getSubscribeInfos(e)]:(q.warn("STORE subscribe should pass store"),[3,12]);case 10:return(i=y.sent()).length===0||r.set(e.getNaturalStoreName(),i),[3,12];case 11:return e&&n?(r.set(e.getNaturalStoreName(),[n]),[3,12]):(q.warn("DEFAULT_SUBSCRIBE subscribe should pass store and defaultSubscribeInfo"),[3,12]);case 12:return[2,r]}})})},o.prototype.getUnSubInfoByRange=function(t,e,n){var r=new Map,i=[];switch(t){case ue.ALL_STORE:this.naturalBaseRef.getAllNaturalStore().forEach(function(s){(i=s.getAllSubscribeInfos()).length!==0&&r.set(s.getNaturalStoreName(),i)});break;case ue.STORE:if(!e){q.warn("STORE subscribe should pass store");break}if((i=e.getAllSubscribeInfos()).length===0)break;r.set(e.getNaturalStoreName(),i);break;case ue.DEFAULT_SUBSCRIBE:if(!e||!n){q.warn("DEFAULT_SUBSCRIBE unsubscribe should pass store and defaultSubscribeInfo");break}r.set(e.getNaturalStoreName(),[n])}return r},o.prototype.onConnect=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return q.info("onConnect: subTunnelFail: "+this.subTunnelFail),this.subTunnelFail?(this.subTunnelFail=!1,this.isInitiativeStop=!1,[4,this.naturalBaseRef.onConnect()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},o.prototype.subscribeForRekey=function(){return b(this,void 0,void 0,function(){var t,e,n=this;return g(this,function(r){switch(r.label){case 0:return q.info("subscribeForRekey start"),[4,this.checkStatus()];case 1:return r.sent(),[4,this.getSubInfoByRange(ue.ALL_STORE)];case 2:return(t=r.sent()).size===0?(q.warn("subscribeForRekey: no subscriber in all store!"),[2,Promise.resolve(0)]):(e=0,t.forEach(function(i,s){return b(n,void 0,void 0,function(){var a,u,l,c=this;return g(this,function(d){switch(d.label){case 0:return(a=new Hn).naturalStoreName=s,u=[],i.forEach(function(y){var T=fe(y,4),S=T[0],O=T[1],P=T[2],U=T[3],z=c.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(O);if(U!==void 0&&U!==0)e=U,q.error("get subscribeInfo fail for "+U+",queryId = "+S);else if(z!=null&&z.isEncryptTable()){var F=new Yn;F.subscribeId=S.toString(),F.subscribeCondition=P,F.tableName=O,F.naturalStoreName=s,u.push(F)}}),a.subscribeDatas=u,a.subscribeDatas&&a.subscribeDatas.length?[3,1]:(q.info("subscribeForRekey: subscribeData is empty, no need to send request!"),[3,3]);case 1:return[4,this.processSubRequest(a,this.handleQuerySubRes)];case 2:l=d.sent(),e=l!==0?l:e,q.info("subscribeForRekey result = "+e),d.label=3;case 3:return[2]}})})}),[2,Promise.resolve(e)])}})})},o.prototype.unsubscribeForRekey=function(){return b(this,void 0,void 0,function(){var t,e,n=this;return g(this,function(r){switch(r.label){case 0:return q.info("unsubscribeForRekey start"),[4,this.checkStatus()];case 1:return r.sent(),(t=this.getUnSubInfoByRange(ue.ALL_STORE)).size===0?(q.warn("unsubscribeForRekey: no subscriber in all store!"),[2,Promise.resolve(0)]):(e=0,t.forEach(function(i,s){return b(n,void 0,void 0,function(){var a,u,l,c=this;return g(this,function(d){switch(d.label){case 0:return(a=new Qn).naturalStoreName=s,u=[],i.forEach(function(y){var T=y[3],S=c.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(T);if(S!=null&&S.isEncryptTable()){var O=new Wn;O.subscribeId=y[0].toString(),O.cloudSubRecordId=y[1],O.cloudSubKey=y[2],O.tableName=T,O.naturalStoreName=s,u.push(O)}}),a.unSubscribeDatas=u,a.unSubscribeDatas&&a.unSubscribeDatas.length?[3,1]:(q.info("unsubscribeForRekey: subscribeData is empty, no need to send request!"),[3,3]);case 1:return[4,this.processSubRequest(a,this.handleQueryUnsubRes)];case 2:l=d.sent(),e=l!==0?l:e,q.info("unsubscribeForRekey result = "+e),d.label=3;case 3:return[2]}})})}),[2,Promise.resolve(e)])}})})},o.prototype.onDisconnect=function(t){this.isInitiativeStop=t,q.warn("onDisconnect isInitiativeStop:"+this.isInitiativeStop),this.isInitiativeStop||(this.subTunnelFail=!0)},o.prototype.disconnectWebSocket=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.syncInstance.disConnectWebSocket()];case 1:return t.sent(),[2]}})})},o.prototype.needToDisconnectWebsocket=function(){return this.syncInstance.needToDisconnectWebsocket()},o.prototype.handleQuerySubRes=function(t,e){var n=0,r=t.response;return e?(r.subscribeResults.forEach(function(i){var s=e.handleSubscribeRes(i.subResponseCode,Number(i.subscribeId),i.cloudSubRecordId,i.subKey);n=s!==0?s:n}),n):(q.error("NaturalCloudSyncModule: handleQuerySubRes store is null!"),1)},o.prototype.handleQueryUnsubRes=function(t,e){var n,r=0,i=t.response;return t.responseCode!==0&&q.warn("handleQueryUnsubRes receive an error from cloud side,"+t.responseCode+`,
                unSubScribeResults size = `+((n=i==null?void 0:i.unSubScribeResults)===null||n===void 0?void 0:n.length)),e instanceof cn&&(i==null||i.unSubScribeResults.forEach(function(s){var a=e.handleUnsubscribeRes(s.unSubRecId,s.unSubResCode);r=a!==0?a:r})),r},o.prototype.handleQuerySubPushRes=function(t){var e=t.response,n=this.naturalBaseRef.getNaturalStore(t.storeName);if(n){var r=n.getSubscribeInfoByCloudSubRecordId(e.subRecId);if(!r){if(!n.isSubscribeNotResponsed(e.subscribeId)){q.warn("unknown subscribe push of "+e.subRecId);var i=[0,e.subRecId,e.subKey,e.tableName];return void this.onUnSubscribe(ue.DEFAULT_SUBSCRIBE,n,i)}if(!this.handlePushWithQueryId(e))return void q.warn("handlePushWithQueryId failed and ignore response");if(!(r=n.getSubscribeInfoByCloudSubRecordId(e.subRecId)))return void q.warn("retry set response for subscribe failed and ignore sub push")}if(t.responseCode!==0)return q.log("SubPush errorCode for "+t.responseCode),void n.handleSubPushRes(r,t.responseCode);r.pushSeq>=Number(e.pushSeq)?q.log("ignore old pushSeq from cloud local:"+r.pushSeq+"                 >= received:"+e.pushSeq):(r.pushSeq=e.pushSeq,q.log("Subscribe Info Push Sequence Number: "+r.pushSeq),n.handleSubPushRes(r,0,e.responseObject,e.operationType))}else q.error("NaturalCloudSyncModule: handleQuerySubPushRes store is null!")},o.prototype.handlePushWithQueryId=function(t){var e=this.naturalBaseRef.getNaturalStore(t.storeName);return e?(e instanceof cn&&e.handleSubscribeRes(0,Number(t.subscribeId),t.subRecId,t.subKey),!0):(q.error("handlePushWithQueryId failed for store is null!"),!1)},o.prototype.onQuery=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createSyncQueryRequest(t,e,n,_t.CONVENTIONAL_QUERY))];case 1:return[2,r.sent().responseObject]}})})},o.prototype.onAggregateQuery=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createSyncQueryRequest(t,e,n,_t.AVG_QUERY))];case 1:return[2,r.sent().aggreResult]}})})},o.prototype.createSyncQueryRequest=function(t,e,n,r){var i=new Ki;return i.naturalStoreName=t,i.tableName=e,i.queryCondition=n,i.queryType=r,i},o.prototype.onUpsert=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.processCRUDRequest(this.createSyncObjectRequest(t,V.OBJECT_UPDATE,ge.SYNC_UPSERT,e))];case 1:return[2,n.sent().successNumber]}})})},o.prototype.onDelete=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.processCRUDRequest(this.createSyncObjectRequest(t,V.OBJECT_UPDATE,ge.SYNC_DELETE,e))];case 1:return[2,n.sent().successNumber]}})})},o.prototype.createSyncObjectRequest=function(t,e,n,r){var i=new Sr;i.naturalStoreName=t,i.requestType=e,i.operationType=n,i.objList=r;var s=new Set;return r.forEach(function(a){s.add(m.getClassName(a))}),i.schemas=this.buildSchemas(Q(s)),i},o.prototype.buildSchemas=function(t){var e,n,r=[];try{for(var i=E(t),s=i.next();!s.done;s=i.next()){var a=s.value,u=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(a);u&&r.push(u)}}catch(l){e={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.prototype.processCRUDRequest=function(t){return b(this,void 0,void 0,function(){var e=this;return g(this,function(n){return[2,new Promise(function(r,i){e.syncInstance.process(new pn(t,e.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),e.naturalBaseRef.getCertificateService(),function(s,a){s===0?r(a.response):i(s)}))})]})})},o.prototype.onSubscribe=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a=this;return g(this,function(u){switch(u.label){case 0:return[4,this.checkStatus(t,n)];case 1:return u.sent(),[4,this.getSubInfoByRange(t,e,n)];case 2:return(i=u.sent()).size===0?[2,Promise.resolve(0)]:(s=[],i.forEach(function(l,c){return b(a,void 0,void 0,function(){var d,y;return g(this,function(T){return d=new Set,(y=new Hn).naturalStoreName=c,y.subscribeDatas=this.buildSubscribeData(l,c,d,r),y.schemas=this.buildSchemas(Q(d)),y.subscribeDatas&&y.subscribeDatas.length?s.push(y):q.info("onSubscribe: subscribeData is empty, no need to send request!"),[2]})})}),[4,Promise.all(s.map(function(l){return a.processSubRequest(l,a.handleQuerySubRes)}))]);case 3:return u.sent().forEach(function(l){q.info("Subscribe store "+(e==null?void 0:e.getNaturalStoreName())+",result = "+l)}),[2,Promise.resolve(0)]}})})},o.prototype.buildSubscribeData=function(t,e,n,r){var i=this.naturalBaseRef.getNaturalStore(e),s=[];return t.forEach(function(a){var u=fe(a,5),l=u[0],c=u[1],d=u[2],y=u[3],T=u[4];if(y===void 0||y===0){var S=new Yn;if(S.subscribeId=l.toString(),S.tableName=c,r&&T){n.add(c);var O=i.getSubscribeInfoByCloudSubRecordId(T);S.snapshotObjs=O.getSnapshotCache()}S.subscribeCondition=d,S.naturalStoreName=e,s.push(S)}}),s},o.prototype.processSubRequest=function(t,e){return b(this,void 0,void 0,function(){var n=this;return g(this,function(r){return[2,new Promise(function(i){var s,a=function(u,l){i(u===0?e(l,n.naturalBaseRef.getNaturalStore(l.storeName)):u)};t.requestType===V.QUERY_SUB?(s=new Fi(t,n.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),a,n.syncInstance),n.syncInstance.registerWebSocketCallBack("SubscribeResponse",s)):(s=new zi(t,n.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),a,n.syncInstance),n.syncInstance.registerWebSocketCallBack("UnsubscribeResponse",s)),n.syncInstance.process(s)})]})})},o.prototype.onUnSubscribe=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c,d,y,T;return g(this,function(S){switch(S.label){case 0:return n&&!n[1]?(q.info("Skip to unsubscribe to cloud since cloudSyncSubrecordId is invalid."),this.syncInstance.needToDisconnectWebsocket()&&(q.info("Stop heartbeat since there is no subscriber."),this.syncInstance.getWebSocketClient().stopHeartBeat()),[2,Promise.resolve(0)]):[4,this.checkStatus(t,n)];case 1:if(S.sent(),(r=this.getUnSubInfoByRange(t,e,n)).size===0)return[2,Promise.resolve(0)];i=0,S.label=2;case 2:S.trys.push([2,8,9,10]),s=E(r),a=s.next(),S.label=3;case 3:return a.done?[3,7]:(u=a.value,(l=this.createUnSubscribeRequest(u)).unSubscribeDatas&&l.unSubscribeDatas.length?[3,4]:(q.info("onUnSubscribe: subscribeData is empty, no need to send request!"),[3,6]));case 4:return[4,this.processSubRequest(l,this.handleQueryUnsubRes)];case 5:c=S.sent(),i=c!==0?c:i,S.label=6;case 6:return a=s.next(),[3,3];case 7:return[3,10];case 8:return d=S.sent(),y={error:d},[3,10];case 9:try{a&&!a.done&&(T=s.return)&&T.call(s)}finally{if(y)throw y.error}return[7];case 10:return[2,Promise.resolve(i)]}})})},o.prototype.createUnSubscribeRequest=function(t){var e=new Qn;e.naturalStoreName=t[0];var n=[];return t[1].forEach(function(r){var i=new Wn;i.subscribeId=r[0].toString(),i.cloudSubRecordId=r[1],i.cloudSubKey=r[2],i.tableName=r[3],i.naturalStoreName=t[0],n.push(i)}),e.unSubscribeDatas=n,e},o.prototype.checkStatus=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){return this.subTunnelFail?[2,Promise.reject(1e3)]:t!==ue.DEFAULT_SUBSCRIBE||e?[2]:(q.warn("DEFAULT_SUBSCRIBE should pass defaultSubscribeInfo"),[2,Promise.reject(1)])})})},o.prototype.onTransaction=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createTransactionRequest(t,e,n))];case 1:if(r.sent().transactionResult!==0)throw 1;return[2]}})})},o.prototype.createTransactionRequest=function(t,e,n){var r=new Bi;r.naturalStoreName=t,r.verifyObjects=e,r.transactionDatas=n;var i=new Set;return r.verifyObjects.forEach(function(s){i.add(s.objectTypeName)}),r.transactionDatas.forEach(function(s){i.add(s.objectTypeName)}),r.schemas=this.buildSchemas(Q(i)),r},o.prototype.getEncryptTaskManager=function(){return this.encryptTaskManager},o.prototype.onServerStatusQuery=function(){return b(this,void 0,void 0,function(){var t,e=this;return g(this,function(n){return t=new es,[2,new Promise(function(r,i){e.syncInstance.process(new pn(t,e.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),e.naturalBaseRef.getCertificateService(),function(s,a){s===0?r(a.response):i(s)}))})]})})},o}(),xe={},fn={};function Jt(o,t){xe[o]=t}function mt(o,t){if(!m.isNullOrUndefined(o))return typeof o=="number"?Number(o.toPrecision(t)).valueOf():void 0}function St(o,t){fn[o]=t}Jt(v.Date,function(o){if(o instanceof Date)return L.fromNumber(o.getTime())}),Jt(v.Float,function(o){return mt(o,6)}),Jt(v.Double,function(o){return mt(o,15)}),St(v.Date,function(o){if(!m.isNullOrUndefined(o))return o instanceof L?new Date(o.toNumber()):void 0}),St(v.ByteArray,function(o){if(o instanceof Uint8Array)return o;if(typeof o=="string"){var t=new ArrayBuffer(o.length),e=new Uint8Array(t),n=Cr.decode(o,e,0);return e.slice(0,n)}}),St(v.Float,function(o){return mt(o,6)}),St(v.Double,function(o){return mt(o,15)});var hn={};function ve(o,t){hn[o]=t}function Jn(o){if(m.isNullOrUndefined(o))return 0;for(var t=0,e=o,n=0;n<e.length;n+=1)t+=ns(e,n);return t}function ns(o,t){var e=o.charCodeAt(t);return e>>11>0?3:e>>7>0?2:1}ve(v.Integer,function(o){return 4}),ve(v.String,function(o){return Jn(o)}),ve(v.Short,function(o){return 2}),ve(v.Long,function(o){return 8}),ve(v.Boolean,function(o){return 1}),ve(v.Byte,function(o){return 1}),ve(v.Float,function(o){return 4}),ve(v.Double,function(o){return 8}),ve(v.ByteArray,function(o){return o?o.byteLength:0}),ve(v.Date,function(o){return 8}),ve(v.Text,function(o){return Jn(o)});var At,ot=new M("DataModelProcessor"),rs=function(){function o(t){this.fieldsInfos=t.getFieldInfos(),this.primaryKeys=t.getPrimaryKeyFieldTypes(),this.name_=t.name}return Object.defineProperty(o.prototype,"name",{get:function(){return this.name_},enumerable:!1,configurable:!0}),o.prototype.getFieldsInfos=function(){return this.fieldsInfos},o.prototype.getFieldInfo=function(t){return this.fieldsInfos.get(t)},o.prototype.getPrimaryKeys=function(){return this.primaryKeys},o.prototype.deserialize=function(t,e){var n,r,i=new t;try{for(var s=E(this.fieldsInfos.keys()),a=s.next();!a.done;a=s.next()){var u=a.value,l=this.fieldsInfos.get(u);if(l){var c=l.fieldType;e[u]===null?i[u]=void 0:l!=null&&l.isEncryptField?i[u]=e[u]:i[u]=fn[c]?fn[c](e[u]):e[u]}else ot.warn("DataModelHelper: deserialize invalid fieldInfo.")}}catch(d){n={error:d}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return i},o.prototype.serialize=function(t){var e,n,r={};try{for(var i=E(this.fieldsInfos.keys()),s=i.next();!s.done;s=i.next()){var a=s.value,u=this.fieldsInfos.get(a);if(u){var l=u.fieldType;if(t[a]===null)r[a]=void 0;else if(u!=null&&u.isEncryptField){if(r[a]=t[a],(u==null?void 0:u.opeName)&&t[u==null?void 0:u.opeName]){var c=u==null?void 0:u.opeName;r[c]=xe[v.String]?xe[v.String](t[c]):t[c]}}else r[a]=xe[l]?xe[l](t[a]):t[a]}else ot.warn("DataModelHelper: serialize invalid fieldInfo key.")}}catch(d){e={error:d}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.prototype.serializeDeletedObject=function(t){var e,n,r={};try{for(var i=E(this.fieldsInfos.keys()),s=i.next();!s.done;s=i.next()){var a=s.value,u=this.fieldsInfos.get(a);u?u.isPrimaryKey&&(r[a]=xe[u.fieldType]?xe[u.fieldType](t[a]):t[a]):ot.warn("DataModelHelper: serializeDeletedObject invalid fieldInfo key.")}}catch(l){e={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.prototype.calculate=function(t){var e,n,r=0;try{for(var i=E(this.fieldsInfos.keys()),s=i.next();!s.done;s=i.next()){var a=s.value,u=this.fieldsInfos.get(a).fieldType;m.isNullOrUndefined(t[a])||(r+=hn[u]?hn[u](t[a]):0)}}catch(l){e={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},o.prototype.validate=function(t){var e,n,r=Object.getOwnPropertyNames(t);if(r.length!==this.fieldsInfos.size)return ot.warn("The number of fields in the object is inconsistent with that in the schema."),!1;try{for(var i=E(r),s=i.next();!s.done;s=i.next()){var a=s.value;if(!this.validateFieldValue(this.fieldsInfos.get(a),t[a]))return!1}}catch(u){e={error:u}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return!0},o.prototype.validateFieldValue=function(t,e){return t?(m.isNullOrUndefined(e)||Pt.validateFieldValue(t.fieldType,e),!0):(ot.warn("The field info not found in DataModelHelper."),!1)},o}(),os=function(){function o(t){this.processors=new Map,this.loadAppSchema(t)}return o.prototype.loadAppSchema=function(t){var e,n;try{for(var r=E(t.values()),i=r.next();!i.done;i=r.next()){var s=i.value,a=new rs(s);this.processors.set(a.name,a)}}catch(u){e={error:u}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},o.prototype.deserialize=function(t,e){var n=m.getClassName(t);if(!m.isClass(t)||!this.containProcessor(n))throw h.build("clz is not valid data model class!");if(!m.isNotNullObject(e))throw h.build("object is not valid data model object!");return this.processors.get(n).deserialize(t,e)},o.prototype.serialize=function(t,e){var n=m.getClassName(t);if(!m.isClass(t)||!this.containProcessor(n))throw h.build("clz is not valid data model class!");if(!m.isNotNullObject(e))throw h.build("object is not valid data model object!");return this.processors.get(n).serialize(e)},o.prototype.serializeDeletedObject=function(t,e){var n=m.getClassName(t);if(!m.isClass(t)||!this.containProcessor(n))throw h.build("serializeDeletedObject: clz is not valid data model class!");if(!m.isNotNullObject(e))throw h.build("serializeDeletedObject: object is not valid data model object!");return this.processors.get(n).serializeDeletedObject(e)},o.prototype.calculate=function(t,e){var n=m.getClassName(t);if(!m.isClass(t)||!this.containProcessor(n))throw h.build("clz is not valid data model class!");if(!m.isNotNullObject(e))throw h.build("object is not valid data model object!");return this.processors.get(n).calculate(e)+16},o.prototype.calculateObject=function(t){if(!m.isNotNullObject(t))throw h.build("The object is invalid data model.");var e=m.getClassName(t);if(!this.containProcessor(e))throw h.build("The object type is not loaded yet.");return this.processors.get(e).calculate(t)+16},o.prototype.getFieldInfosByClassName=function(t){var e=this.processors.get(t);return e?e.getFieldsInfos():new Map},o.prototype.getFieldInfoByName=function(t,e){var n=this.processors.get(t);if(n)return n.getFieldInfo(e)},o.prototype.getPrimaryKeyByClassName=function(t){var e=this.processors.get(t);return e?e.getPrimaryKeys():[]},o.prototype.validate=function(t){if(m.isNotNullObject(t)){var e=m.getClassName(t),n=this.processors.get(e);return!!n&&n.validate(t)}return!1},o.prototype.containProcessor=function(t){return this.processors.has(t)},o}(),Xn=function(){function o(){this.version=-1,this.schemas=new Map}return o.prototype.createObjectType=function(t,e){this.version=t,this.schemas=e,this.dataModelHelper=new os(e)},o.prototype.getAppSchema=function(){return this.schemas},o.prototype.getAppVersion=function(){return this.version},o.prototype.getSchemaToNegotiate=function(){return Q(this.schemas.values())},o.prototype.freshPermissionInfo=function(t){var e,n,r=function(u){var l=t.get(u),c=i.schemas.get(u);l==null||l.forEach(function(d){var y=fe(d,2),T=y[0],S=y[1];c==null||c.setPermission(T,S)})},i=this;try{for(var s=E(t.keys()),a=s.next();!a.done;a=s.next())r(a.value)}catch(u){e={error:u}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}},o.prototype.getDataModelHelper=function(){return this.dataModelHelper},o}(),Tt=new M("CertificateService"),kt=function(){function o(t){if(this.websocketUrl="",this.websocketBackUrl="",this.httpUrl="",this.httpBackUrl="",this.addressMap=he.getConfigInstance().getAddressMap(),m.isNullOrUndefined(t))this.agcRoutePolicy=he.getConfigInstance().getAgcRoutePolicyMap().get(o.agcConfig.region),this.loadAgcGwAddress(o.agcConfig.agcgw);else{if(this.agcRoutePolicy=t,!this.isValidAgcGwAllAddress(o.agcConfig.agcgw_all,t))throw Tt.warn("The agconnect service config agcgw_all is invalid."),h.build("The agconnect service config agcgw_all is invalid.");if(!this.isValidAgcGwAllAddress(o.agcConfig.websocketgw_all,t))throw Tt.warn("The agconnect service config websocketgw_all is invalid."),h.build("The agconnect service config websocketgw_all is invalid.");this.loadAgcGwAllAddress(o.agcConfig.agcgw_all,o.agcConfig.websocketgw_all,this.agcRoutePolicy)}this.setContext(o.agcConfig)}return o.loadAgcConfig=function(t){if(!this.isValidContext(t))throw Tt.warn("The agconnect service config is invalid."),h.build("The agconnect service config is invalid.");this.agcConfig=t,this.agcInstance=he.getConfigInstance().getConfigInstance(this.agcConfig),this.credentialsProvider=he.getConfigInstance().getCredentialsProvider()},o.getUserInfo=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,he.getConfigInstance().getCurrentUser()];case 1:return[2,t.sent()]}})})},o.isValidContext=function(t){return!!t&&!!(t.agcgw&&t.client&&t.region)&&!!he.getConfigInstance().getAgcRoutePolicyMap().has(t.region)&&!!(t.agcgw.url&&t.agcgw.backurl&&t.agcgw.websocketurl&&t.agcgw.websocketbackurl&&t.client.product_id&&t.client.app_id&&t.client.client_id&&t.client.cp_id)},o.checkSupportEncryption=function(){if(De.getApplicationType()!=="Browser"&&De.getApplicationType()!=="FastApp")throw h.build(De.getApplicationType()+" platform is not support encryption feature")},o.getAuthorization=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:if(!this.credentialsProvider)throw Tt.error("The credentialsProvider is null."),h.build(1012);return[4,this.credentialsProvider.getToken()];case 1:return[2,"Bearer "+t.sent().tokenString]}})})},o.prototype.getHeaderParam=function(t){return b(this,void 0,void 0,function(){var e,n,r,i;return g(this,function(s){switch(s.label){case 0:return[4,he.getConfigInstance().getCurrentUser()];case 1:return e=s.sent(),[4,o.getAuthorization()];case 2:return n=s.sent(),r=this.createHeader(n,t),e?[4,e.getToken(!1)]:[3,4];case 3:i=s.sent(),r.access_token=this.escapeHeader(i.getToken()),s.label=4;case 4:return[2,r]}})})},o.prototype.isValidAgcGwAllAddress=function(t,e){return!!t&&!(!t[this.addressMap.get(e)[0]]||!t[this.addressMap.get(e)[1]])},o.prototype.createHeader=function(t,e){return{"Content-Type":e?"application/octet-stream":"application/json; charset=UTF-8",authorization:this.escapeHeader(t),client_id:this.escapeHeader(this.context.clientId),productId:this.escapeHeader(this.context.productId),sdkPlatform:De.getApplicationType(),sdkVersion:De.getApplicationVersion(),appVersion:o.APP_VERSION}},o.prototype.escapeHeader=function(t){return t==null?void 0:t.replace(/^\w /g,"")},o.prototype.loadAgcGwAddress=function(t){this.websocketUrl="wss://"+t.websocketurl+"/agc/websocket/connection",this.websocketBackUrl="wss://"+t.websocketbackurl+"/agc/websocket/connection",this.httpUrl="https://"+t.url+"/agc/apigw/clouddb/clouddbservice/sync",this.httpBackUrl="https://"+t.backurl+"/agc/apigw/clouddb/clouddbservice/sync"},o.prototype.loadAgcGwAllAddress=function(t,e,n){this.websocketUrl="wss://"+e[this.addressMap.get(n)[0]]+"/agc/websocket/connection",this.websocketBackUrl="wss://"+e[this.addressMap.get(n)[1]]+"/agc/websocket/connection",this.httpUrl="https://"+t[this.addressMap.get(n)[0]]+"/agc/apigw/clouddb/clouddbservice/sync",this.httpBackUrl="https://"+t[this.addressMap.get(n)[1]]+"/agc/apigw/clouddb/clouddbservice/sync"},o.prototype.setAppVersion=function(t){this.context.appVersion=t},o.prototype.getSubscribeOptions=function(){return{url:this.websocketUrl}},o.prototype.getSubscribeBackOptions=function(){return{url:this.websocketBackUrl}},o.prototype.getContext=function(){return this.context},o.prototype.getUrl=function(){return this.httpUrl},o.prototype.getBackUrl=function(){return this.httpBackUrl},o.prototype.getAGCRoutePolicy=function(){return this.agcRoutePolicy},o.prototype.setContext=function(t){this.context={productId:t.client.product_id,appId:t.client.app_id,clientId:t.client.client_id,userId:t.client.cp_id,appVersion:0,clientVersion:2}},o.APP_VERSION="003",o}(),is=function(o,t){this.onUserCommandChanged=o,this.onKeyChanged=t},Zn=function(){function o(){this.inEdge=L.UZERO,this.inSize=L.UZERO,this.outEdge=L.UZERO,this.outSize=L.UZERO,this.value=L.UZERO,this.outLen=0}return o.copy=function(t){var e=new o;return e.inEdge=t.inEdge,e.inSize=t.inSize,e.outEdge=t.outEdge,e.outSize=t.outSize,e.value=t.value,e.outLen=t.outLen,e},o.prototype.toString=function(){return"inEdge: "+this.inEdge.toString(10)+", inSize: "+this.inSize.toString(10)+", outEdge: "+this.outEdge.toString(10)+", outSize: "+this.outSize.toString(10)+", value: "+this.value.toString(10)+", outLen: "+this.outLen},o}(),er=function(){function o(){this.inEdge=new J(0),this.inSize=new J(0),this.outSize=new J(0),this.outEdge=new J(0),this.value=new J(0),this.outLen=0}return o.copy=function(t){var e=new o;return e.value=t.value,e.inSize=t.inSize,e.inEdge=t.inEdge,e.outEdge=t.outEdge,e.outSize=t.outSize,e.outLen=t.outLen,e},o.prototype.toString=function(){return"inEdge: "+this.inEdge.toString(10)+", inSize: "+this.inSize.toString(10)+", outEdge: "+this.outEdge.toString(10)+", outSize: "+this.outSize.toString(10)+", value: "+this.value.toString(10)+", outLen: "+this.outLen},o}(),tr=function(){function o(){this.radixSign=0,this.radixLen=0,this.expSign=0,this.expLen=0,this.normalizedExp=0,this.normalizedSize=1,this.effectiveLen=0}return o.prototype.toString=function(){return"radixSign: "+this.radixSign+", radixLen: "+this.radixLen+", expSign: "+this.expSign+", expLen: "+this.expLen+", normalizedExp: "+this.normalizedExp+", normalizedSize: "+this.normalizedSize+", effectiveLen: "+this.effectiveLen},o}(),me=new M("OpeTypeConversion"),It=function(){function o(){}return o.convertToOpeDataSpaceUint64=function(t,e,n){if(t==null||n==null)return me.warn("convertToOpeDataSpaceUint64: input parameter is invalid"),this.OPE_FAIL;switch(e){case 1:case 2:return this.convertInt8ToOpeDataSpace(t,n);case 3:return this.convertInt16ToOpeDataSpace(t,n);case 4:return this.convertInt32ToOpeDataSpace(t,n);case 6:return this.convertFloatToOpeDataSpace(t,n);default:return me.warn("convertToOpeDataSpaceUint64: input type is error to Uint64Space, type: "+e),this.OPE_FAIL}},o.convertToOpeDataSpaceBigNum=function(t,e,n,r){if(t==null||e==null||e<=0)return me.warn("convertToOpeDataSpaceBigNum: input parameter is invalid."),this.OPE_FAIL;switch(n){case 5:case 9:return typeof t=="string"?this.convertInt64ToOpeDataSpace(t,r):(me.warn("convertToOpeDataSpaceBigNum: input type should be string but got: ."+typeof t),this.OPE_FAIL);case 7:return typeof t=="string"?this.convertDoubleToOpeDataSpace(t,r):(me.warn("convertToOpeDataSpaceBigNum: input type should be string but got: ."+typeof t),this.OPE_FAIL);case 8:return typeof t!="string"?this.convertStringToOpeDataSpace(t,e,r):(me.warn("convertToOpeDataSpaceBigNum: input type should be Uint8Array but got: ."+typeof t),this.OPE_FAIL);default:return me.warn("convertToOpeDataSpaceBigNum: input type is error to BigNumSpace, type: "+n),this.OPE_FAIL}},o.convertInt8ToOpeDataSpace=function(t,e){var n=L.fromString(t,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT8_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,i=this.INT8_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,i,e)},o.convertInt16ToOpeDataSpace=function(t,e){var n=L.fromString(t,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT16_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,i=this.INT16_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,i,e)},o.convertInt32ToOpeDataSpace=function(t,e){var n=L.fromString(t,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT32_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,i=this.INT32_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,i,e)},o.convertInt64ToOpeDataSpace=function(t,e){var n=new J(t);n=n.times(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT64_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,i=this.INT64_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToBigNumSpace(n,r,i,e)},o.convertFloatToOpeDataSpace=function(t,e){var n=parseFloat(t).toExponential(this.FLOAT_VALID_DIGITS),r=this.convertFloatToUint64(n,n.length+1,this.FLOAT_EXPONENT_MAX_RANGE,this.FLOAT_DEFAULT_PRECISION);r=r.multiply(this.PLAIN_TEXT_REDUNDANCY);var i=(this.FLOAT_DEFAULT_PRECISION+this.FLOAT_EXPONENT_MAX_LEN)*this.NUMBER_RADIX_DECIMAL_LOG2+this.PLAIN_TEXT_REDUNDANCY_LOG2-1;return i=Math.floor(i),this.convertToUint64Space(r,i,0,e)},o.convertDoubleToOpeDataSpace=function(t,e){var n=parseFloat(t).toExponential(this.DOUBLE_VALID_DIGITS),r=this.convertDoubleToBigNum(n,n.length+1,this.DOUBLE_EXPONENT_MAX_RANGE,this.DOUBLE_DEFAULT_PRECISION);r=r.times(this.PLAIN_TEXT_REDUNDANCY);var i=(this.DOUBLE_DEFAULT_PRECISION+this.DOUBLE_EXPONENT_MAX_LEN)*this.NUMBER_RADIX_DECIMAL_LOG2+this.PLAIN_TEXT_REDUNDANCY_LOG2-1;return i=Math.floor(i),this.convertToBigNumSpace(r,i,0,e)},o.convertStringToOpeDataSpace=function(t,e,n){var r=this.convertCharToBigNum(t,e,this.STRING_VALID_BYTE_LEN);r=r.times(this.PLAIN_TEXT_REDUNDANCY);var i=this.STRING_VALID_BYTE_LEN*Math.log2(this.CHAR_SPACE_SIZE)+this.PLAIN_TEXT_REDUNDANCY_LOG2+1;return this.convertToBigNumSpace(r,i,0,n)},o.convertFloatToUint64=function(t,e,n,r){if(t==null||e<=0)throw me.warn("convertFloatToUint64: text is null"),Error("convertFloatToUint64: text is null");var i=new tr;this.calculateFloatingPointParameter(t,e,i),this.calculateNormalizedExp(t,n,i);var s=i.expLen+r,a=this.translateFloatingPointToChar(t,r,i,s);return L.fromString(a)},o.convertDoubleToBigNum=function(t,e,n,r){if(t==null||e<=0)throw me.warn("convertDoubleToBigNum: text is null"),Error("convertDoubleToBigNum: text is null");var i=new tr;this.calculateFloatingPointParameter(t,e,i),this.calculateNormalizedExp(t,n,i);var s=i.expLen+r,a=this.translateFloatingPointToChar(t,r,i,s);return new J(a)},o.convertCharToBigNum=function(t,e,n){var r,i=new J(0),s=new J(1);e>=n&&(i=new J(t[n-1]));for(var a=n-1;a>0;a--)s=s.times(this.CHAR_SPACE_SIZE),e>=a&&(r=(r=s).times(t[a-1]===void 0?0:t[a-1]),i=i.plus(r));return i},o.calculateFloatingPointParameter=function(t,e,n){var r=0;for(t.charAt(r)==="-"&&(n.radixSign=1);t.charAt(r)!=="e";)r++;for(n.radixLen=r,t.charAt(r+1)==="-"&&(n.expSign=1),r+=2;t.charAt(r)==="0";)r++;for(;r<e&&t.charCodeAt(r)>="0".charCodeAt(0)&&t.charCodeAt(r)<="9".charCodeAt(0);)r++,n.expLen++;n.effectiveLen=r,n.expLen=n.expLen===0?1:n.expLen},o.calculateNormalizedExp=function(t,e,n){var r,i=n.normalizedSize;if(t.charAt(0)==="0")r=2*e+1,i*=this.NUMBER_RADIX_DECIMAL;else if(n.radixSign===1){r=e;for(var s=0;s<n.expLen;s++)n.expSign===1?r+=(t.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*i:r-=(t.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*i,i*=this.NUMBER_RADIX_DECIMAL}else for(r=3*e+1,s=0;s<n.expLen;s++)n.expSign===1?r-=(t.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*i:r+=(t.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*i,i*=this.NUMBER_RADIX_DECIMAL;if(parseInt((r/i).toString(10),10)===0)for(i=Math.floor(i/this.NUMBER_RADIX_DECIMAL);parseInt((r/i).toString(10),10)===0;){if(i===1){n.expLen--;break}i=Math.floor(i/this.NUMBER_RADIX_DECIMAL),n.expLen--}else{for(;parseInt((r/i).toString(10),10)!==0;)i*=this.NUMBER_RADIX_DECIMAL,n.expLen++;i=Math.floor(i/this.NUMBER_RADIX_DECIMAL)}n.normalizedSize=i,n.normalizedExp=r},o.translateFloatingPointToChar=function(t,e,n,r){if(r<n.expLen+e)throw me.warn("translateFloatingPointToChar: formatText length is not enough."),Error("translateFloatingPointToChar: formatText length is not enough.");for(var i=[],s=0;s<n.expLen;s++)i[s]="0".charCodeAt(0)+Math.floor(n.normalizedExp/n.normalizedSize),n.normalizedExp%=n.normalizedSize,n.normalizedSize=Math.floor(n.normalizedSize/this.NUMBER_RADIX_DECIMAL);var a=0,u=0;if(n.radixSign===1)for(a++;u<e;)a>=n.radixLen?(i[u+n.expLen]="0".charCodeAt(0),u++):(t.charAt(a)!=="."&&(i[u+n.expLen]="0".charCodeAt(0)+9-t.charCodeAt(a)+"0".charCodeAt(0),u++),a++);else for(;u<e;)a>=n.radixLen?(i[u+n.expLen]="0".charCodeAt(0),u++):(t.charAt(a)!=="."&&(i[u+n.expLen]=t.charCodeAt(a),u++),a++);return String.fromCharCode.apply(String,Q(i))},o.convertToUint64Space=function(t,e,n,r){var i=Math.floor(e*this.CIPHER_SPACE_RATE/this.CIPHER_SPACE_RATE_BASE);return i-e<this.CIPHER_SPACE_LIMIT_LOG2&&(i=e+this.CIPHER_SPACE_LIMIT_LOG2),r.inSize=L.fromNumber(Math.pow(2,e),!0),r.inEdge=n<0?L.MAX_UNSIGNED_VALUE.divide(2).add(1).subtract(L.fromNumber(Math.pow(2,-n),!0)):n===0?L.UZERO:L.fromNumber(Math.pow(2,n),!0),r.outEdge=L.UONE,i>=this.INT64_DEFAULT_DIGIT?(r.outSize=L.MAX_UNSIGNED_VALUE,r.outLen=16):(r.outSize=L.fromNumber(Math.pow(2,i)),r.outLen=Math.floor((i-1)/4)+1,r.outLen%2!=0&&r.outLen++),n<0?t.greaterThan(L.MAX_UNSIGNED_VALUE.divide(2))?r.value=t.subtract(L.MAX_UNSIGNED_VALUE.divide(2)).subtract(1).toUnsigned():r.value=t.add(L.MAX_UNSIGNED_VALUE.divide(2)).add(1).toUnsigned():r.value=t,this.OPE_SUCCESS},o.convertToBigNumSpace=function(t,e,n,r,i){return i==null?this.convertToBigNumSpaceWithoutOutSize(t,e,n,r):(r.outEdge=new J(1),r.value=t,n<=0?(r.inEdge=new J(0),r.value=this.setBitLenToOneInBigNum(r.value,-n)):r.inEdge=new J(2).pow(n),r.inSize=new J(2).pow(e),r.outSize=new J(2).pow(i),r.outLen=Math.floor((i-1)/4)+1,r.outLen%2!=0&&r.outLen++,this.OPE_SUCCESS)},o.convertToBigNumSpaceWithoutOutSize=function(t,e,n,r){if(t==null)throw me.warn("convertToBigNumSpace: plaintext is null."),Error("convertToBigNumSpace: plaintext is null.");r.inEdge=new J(0),r.inSize=new J(0),r.outEdge=new J(0),r.outSize=new J(0);var i=Math.floor(e*this.CIPHER_SPACE_RATE/this.CIPHER_SPACE_RATE_BASE);return i-e<this.CIPHER_SPACE_LIMIT_LOG2&&(i=e+this.CIPHER_SPACE_LIMIT_LOG2),this.convertToBigNumSpace(t,e,n,r,i)},o.setBitLenToOneInBigNum=function(t,e){if(e<=0)return t;var n=new J(2).pow(e);return t.plus(n)},o.NUMBER_RADIX_DECIMAL=10,o.NUMBER_RADIX_DECIMAL_LOG2=Math.log2(o.NUMBER_RADIX_DECIMAL),o.INT8_DEFAULT_DIGIT=8,o.INT16_DEFAULT_DIGIT=16,o.INT32_DEFAULT_DIGIT=32,o.INT64_DEFAULT_DIGIT=64,o.INT8_NEGATIVE_EDGE=-7,o.INT16_NEGATIVE_EDGE=-15,o.INT32_NEGATIVE_EDGE=-31,o.INT64_NEGATIVE_EDGE=-63,o.FLOAT_DEFAULT_PRECISION=8,o.FLOAT_EXPONENT_MAX_RANGE=38,o.FLOAT_EXPONENT_MAX_LEN=3,o.DOUBLE_DEFAULT_PRECISION=17,o.DOUBLE_EXPONENT_MAX_RANGE=308,o.DOUBLE_EXPONENT_MAX_LEN=4,o.PLAIN_TEXT_REDUNDANCY=8,o.PLAIN_TEXT_REDUNDANCY_LOG2=Math.log2(o.PLAIN_TEXT_REDUNDANCY),o.CIPHER_SPACE_RATE=13e3,o.CIPHER_SPACE_RATE_BASE=1e4,o.CIPHER_SPACE_LIMIT=1024,o.CIPHER_SPACE_LIMIT_LOG2=Math.log2(o.CIPHER_SPACE_LIMIT),o.STRING_VALID_BYTE_LEN=16,o.CHAR_SPACE_SIZE=256,o.FLOAT_VALID_DIGITS=7,o.DOUBLE_VALID_DIGITS=16,o.OPE_FAIL=-1,o.OPE_SUCCESS=1,o}(),le=new M("OpeGenerator"),We=rt.getCryptoJS(),ss=function(){function o(){}return o.prototype.generateOpeValue=function(t,e,n,r){if(t==null||e==null||e<=0||r==null||n==null)throw le.warn("generateOpeValue: input parameter is invalid."),Error("generateOpeValue: input parameter is invalid.");var i;switch(this.inputVerification(t,n),n){case 1:case 2:case 3:case 4:case 6:i=this.generateOpeValueByUint64(t,n,r);break;case 5:case 9:case 7:i=this.generateOpeValueByBigNum(t,e,n,r);break;case 8:i=this.generateOpeValueForString(t,e,n,r);break;default:throw le.warn("generateOpeValue: type: "+n+" is error."),Error("generateOpeValue: type: "+n+" is error.")}if(i.length<=0)throw le.warn("generateOpeValue: generate ope value failed"),Error("generateOpeValue: generate ope value failed");return i},o.prototype.generateOpeValueByUint64=function(t,e,n){var r=new Zn;if(It.convertToOpeDataSpaceUint64(t,e,r)!==It.OPE_SUCCESS)throw le.warn("generateOpeValueByUint64: convert to uint64 space failed"),Error("generateOpeValueByUint64: convert to uint64 space failed");return this.getOpeValueByUint64(n,r)},o.prototype.generateOpeValueByBigNum=function(t,e,n,r){var i=new er;if(It.convertToOpeDataSpaceBigNum(t,e,n,i)!==It.OPE_SUCCESS)throw le.warn("generateOpeValueByUint64: convert to bigNum space failed"),Error("generateOpeValueByUint64: convert to bigNum space failed");var s=this.getOpeValueByBigNum(r,i);if(s.length<=0)throw le.warn("generateOpeValueByBigNum: generate ope value by bigNum failed"),Error("generateOpeValueByBigNum: generate ope value by bigNum failed");return s},o.prototype.generateOpeValueForString=function(t,e,n,r){var i=m.stringToUint8Array(t),s=i.length===0?1:i.length,a=s,u=(s-1)/o.STRING_TRUNCATED_BYTE_LEN+1;u=Math.floor(u);for(var l,c=0,d="",y=0;y<u;y++){a>o.STRING_TRUNCATED_BYTE_LEN?(a-=o.STRING_TRUNCATED_BYTE_LEN,l=o.STRING_TRUNCATED_BYTE_LEN):l=a;var T=i.subarray(y*o.STRING_TRUNCATED_BYTE_LEN,(y+1)*o.STRING_TRUNCATED_BYTE_LEN),S=this.generateOpeValueByBigNum(T,l,n,r);if(S.length<=0||c+S.length>o.MAX_ENTIRE_OPE_LEN)throw le.warn("generateOpeValueForString: generate ope value by bigNum failed, opeValueLen: "+S.length+" truncateCnt: "+u),Error("generateOpeValueForString: generate ope value by bigNum failed, opeValueLen: "+S.length+" truncateCnt: "+u);d+=S,c+=S.length}return d},o.prototype.getOpeValueByUint64=function(t,e){var n=this.calculateOpeValueByUint64(e,t);if(n.equals(o.OPE_UINT64_ERROR))throw le.warn("getOpeValueByUint64: calculate ope value by uint64 fail."),Error("getOpeValueByUint64: calculate ope value by uint64 fail.");return(Array(e.outLen).join("0")+n.toString(16).toUpperCase()).slice(-e.outLen)},o.prototype.getOpeValueByBigNum=function(t,e){var n=this.calculateOpeValueByBigNum(e,t).toString(16);return(Array(e.outLen).join("0")+n.toUpperCase()).slice(-e.outLen)},o.prototype.calculateOpeValueByUint64=function(t,e){for(var n=L.fromNumber(0);t.inSize.greaterThanOrEqual(1);){if(t.value.lessThan(t.inEdge)||t.value.greaterThanOrEqual(t.inEdge.add(t.inSize)))throw le.warn("calculateOpeValueByUint64: value out of range by uint64."),Error("calculateOpeValueByUint64: value out of range by uint64.");if(t.inSize.equals(t.outSize))return t.outEdge.add(t.value).subtract(t.inEdge);if(t.inSize.equals(1))return this.uniformSampleInUint64(t.value,t,e);var r=t.inEdge.add(t.inSize.subtract(1).divide(2)),i=this.uniformSampleInUint64(r,Zn.copy(t),e);t.value.lessThanOrEqual(r)?(t.inSize=r.subtract(t.inEdge).add(1),t.outSize=i.subtract(t.outEdge).add(1)):(t.inSize=t.inEdge.add(t.inSize).subtract(1).subtract(r),t.outSize=t.outEdge.add(t.outSize).subtract(1).subtract(i),t.inEdge=r.add(1),t.outEdge=i.add(1))}return n},o.prototype.uniformSampleInUint64=function(t,e,n){if(!e.inSize.equals(1)){var r=e.inSize.multiply(o.CIPHER_TEXT_SAMPLE_REDUNDANCY).divide(o.NUMBER_RADIX_DECIMAL);r.greaterThan(e.outSize)?(e.outEdge=e.outEdge.add(t).subtract(e.inEdge),e.outSize=e.outSize.subtract(e.inSize).subtract(1)):(e.outSize=e.outSize.add(1).subtract(r),e.outEdge=e.outEdge.add(t.subtract(e.inEdge).multiply(o.CIPHER_TEXT_SAMPLE_REDUNDANCY).divide(o.NUMBER_RADIX_DECIMAL)))}if(e.outSize.equals(1))return e.outEdge;for(var i,s=this.calculateCoinByUint64(t,e,n),a=0;e.outSize.greaterThan(1);)i=e.outEdge.add(e.outSize.subtract(1).divide(2)),s.charAt(a)==="0"?e.outSize=i.subtract(e.outEdge).add(1):(e.outSize=e.outEdge.add(e.outSize.subtract(1)).subtract(i),e.outEdge=i.add(1)),a++;return e.outEdge},o.prototype.calculateCoinByUint64=function(t,e,n){for(var r=We.enc.Utf8.parse(t.toString(10)).concat(n),i=We.SHA256(r).toString(We.enc.Hex),s=Math.floor((Math.floor(Math.log2(e.outSize.toNumber()))+1)/o.INT8_DEFAULT_DIGIT)+1,a="",u=0;u<s;u++)a+=this.hex2binForUint64(i.substring(2*u,2*(u+1)));return a},o.prototype.calculateOpeValueByBigNum=function(t,e){for(var n=new J(0);t.inSize.gte(1);){if(t.value.lt(t.inEdge)||t.value.gte(t.inEdge.plus(t.inSize)))throw le.warn("calculateOpeValueByBigNum: value out of range by bigNum"),Error("calculateOpeValueByBigNum: value out of range by bigNum");if(t.inSize.eq(t.outSize))return t.outEdge.plus(t.value).minus(t.inEdge);if(t.inSize.eq(1))return this.uniformSampleInBigNum(t.value,t,e);var r=t.inEdge.plus(t.inSize.minus(1).dividedToIntegerBy(2)),i=this.uniformSampleInBigNum(r,t,e);t.value.lte(r)?(t.inSize=r.minus(t.inEdge).plus(1),t.outSize=i.minus(t.outEdge).plus(1)):(t.inSize=t.inSize.plus(t.inEdge).minus(1).minus(r),t.outSize=t.outSize.plus(t.outEdge).minus(1).minus(i),t.inEdge=r.plus(1),t.outEdge=i.plus(1))}return n},o.prototype.uniformSampleInBigNum=function(t,e,n){var r=er.copy(e);if(this.calculateSampleSpaceWithRedundancy(r,t),r.outSize.eq(1))return r.outEdge;var i=this.calculateSampleCoinInBigNum(t,n);return r.outEdge.plus(i.mod(r.outSize))},o.prototype.calculateSampleSpaceWithRedundancy=function(t,e){if(!t.inSize.eq(1)){var n=this.calculateRedundancySize(t);if(n.gt(t.outSize))t.outEdge=t.outEdge.plus(e).minus(t.inEdge),t.outSize=t.outSize.plus(1).minus(t.inSize);else{t.outSize=t.outSize.plus(1).minus(n);var r=e.minus(t.inEdge);r=r.times(o.CIPHER_TEXT_SAMPLE_REDUNDANCY).dividedToIntegerBy(10),t.outEdge=t.outEdge.plus(r)}}},o.prototype.calculateRedundancySize=function(t){var e=t.inSize;return e=(e=e.times(o.CIPHER_TEXT_SAMPLE_REDUNDANCY)).dividedToIntegerBy(o.NUMBER_RADIX_DECIMAL)},o.prototype.calculateSampleCoinInBigNum=function(t,e){var n=t.toString(16).toUpperCase();n!=="0"&&n.length%2!=0&&(n="0"+n);var r=We.enc.Utf8.parse(n).concat(e),i=We.SHA256(r);return new J("0x"+this.changeOrder(i.toString(We.enc.Hex)))},o.prototype.hex2binForUint64=function(t){return("00000000"+parseInt(t,16).toString(2)).substr(-8).split("").reverse().join("")},o.prototype.changeOrder=function(t){for(var e=t.length,n="";e>=0;)n+=t.substring(e-2,e),e-=2;return n},o.prototype.inputVerification=function(t,e){if(e===0)throw le.warn("generateOpeValue: ope type input is invalid, type: OPE_TYPE_NULL."),Error("generateOpeValue: ope type input is invalid, OPE_TYPE_NULL.");if(e===1&&t!=="1"&&t!=="0")throw le.warn("generateOpeValue: boolean type input is invalid, input is not a boolean value."),Error("generateOpeValue: boolean type input is invalid.");if(e!==8&&e!==1){if(t===""||t.trim()==="")throw le.warn("generateOpeValue: Number type input is invalid, input is empty."),Error("generateOpeValue: Number type input is invalid.");if(isNaN(Number(t)))throw le.warn("generateOpeValue: Number type input is invalid, input is NaN."),Error("generateOpeValue: Number type input is invalid.")}},o.NUMBER_RADIX_DECIMAL=10,o.INT8_DEFAULT_DIGIT=8,o.CIPHER_TEXT_SAMPLE_REDUNDANCY=11,o.MAX_ENTIRE_OPE_LEN=2400,o.OPE_UINT64_ERROR=L.UZERO,o.STRING_TRUNCATED_BYTE_LEN=16,o}(),as=rt.getCryptoJS(),G=new M("EntireEncryption"),wr=function(){function o(t){this.encryptInstance=o.encryptor,this.userKeysInfo=new us,this.naturalBaseRef=t}return o.setEncryptor=function(t){o.encryptor=t},o.prototype.aesGcm256Encrypt=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.encryptInstance.encrypt(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.aesGcm256Decrypt=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.encryptInstance.decrypt(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.generateRandom=function(t){return this.encryptInstance.generateRandom(t)},o.prototype.setKeys=function(t,e,n,r,i,s){return b(this,void 0,void 0,function(){return g(this,function(a){if(m.isNullOrUndefined(e)||m.isNullOrUndefined(r)||n<=0||i<0||s<=0)return G.error("setKeys: input dataKey or oldDataKey is invalid."),[2,Promise.reject(51)];G.log("setKeys: set iv key and encrypted key."),m.isStringEmpty(this.userKeysInfo.userId)||this.clearUserKeysInfo();try{this.generateKeys(e,r,i)}catch(u){return G.error("setKeys: set keys failed."),this.clearUserKeysInfo(),[2,Promise.reject(u.getCode())]}return this.userKeysInfo.userId=t,this.userKeysInfo.dataKeyVersion=s,[2]})})},o.prototype.conditionEntireEncryptedField=function(t,e,n,r){return b(this,void 0,void 0,function(){var i;return g(this,function(s){switch(s.label){case 0:return this.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),i=this.getPlainText(n,r),[4,this.getOpeFieldDataValue(t,e,n,i)];case 1:return[2,s.sent()]}})})},o.prototype.encryptEntireEncryptedFields=function(t){return b(this,void 0,void 0,function(){var e,n,r,i,s,a,u,l,c,d,y;return g(this,function(T){switch(T.label){case 0:G.debug("encryptEntireEncryptedFields: objectItems size: "+t.length),e=[],n=m.deepCopy(t),T.label=1;case 1:T.trys.push([1,7,8,9]),r=E(n),i=r.next(),T.label=2;case 2:return i.done?[3,6]:(s=i.value,a=m.getClassName(s),[4,this.isValidEncryptionOperation(a)]);case 3:return T.sent(),l=(u=e).push,[4,this.handleEntireEncryptedField(a,s)];case 4:l.apply(u,[T.sent()]),T.label=5;case 5:return i=r.next(),[3,2];case 6:return[3,9];case 7:return c=T.sent(),d={error:c},[3,9];case 8:try{i&&!i.done&&(y=r.return)&&y.call(r)}finally{if(d)throw d.error}return[7];case 9:return G.debug("encryptEntireEncryptedFields done"),[2,Promise.resolve(e)]}})})},o.prototype.handleEntireEncryptedField=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s,a,u,l,c,d;return g(this,function(y){switch(y.label){case 0:n=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(t),r=n.getEncryptFieldList(),i=e,y.label=1;case 1:y.trys.push([1,6,7,8]),s=E(r),a=s.next(),y.label=2;case 2:return a.done?[3,5]:(u=a.value,this.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),[4,this.encryptEntireEncryptedField(t,u.fieldName,u.fieldType,e)]);case 3:i=y.sent(),y.label=4;case 4:return a=s.next(),[3,2];case 5:return[3,8];case 6:return l=y.sent(),c={error:l},[3,8];case 7:try{a&&!a.done&&(d=s.return)&&d.call(s)}finally{if(c)throw c.error}return[7];case 8:return[2,Promise.resolve(i)]}})})},o.prototype.encryptEntireEncryptedField=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a,u,l,c;return g(this,function(d){switch(d.label){case 0:return i=r[e],m.isNullOrUndefined(i)?[2,r]:[4,this.checkUserId()];case 1:return d.sent(),s=this.getPlainText(n,i),a=r,u=e,[4,this.encryptFieldData(t,e,s)];case 2:return a[u]=d.sent(),[4,this.getOpeFieldDataValue(t,e,n,s)];case 3:return l=d.sent(),c=e.indexOf("#ope")!==-1?e:e+"#ope",r[c]=l,[2,Promise.resolve(r)]}})})},o.prototype.getPlainText=function(t,e){var n="",r=tt.toString(t);switch(t){case v.Boolean:n=e===!0?"1":"0";break;case v.Integer:case v.Short:case v.Float:case v.Double:case v.Byte:case v.Long:case v.IntAutoIncrement:case v.LongAutoIncrement:n=e.toString();break;case v.Date:n=e.getTime().toString();break;case v.String:n=e;break;default:throw G.error("getPlainText: inputValue fieldType:"+r+" is error."),h.build(1003)}if(n.length>800)throw G.error("Plaintext length cannot be greater than 800."),h.build(1003);return n},o.prototype.encryptFieldData=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c;return g(this,function(d){switch(d.label){case 0:if(r=t+":"+e,i=this.calculateGcmIv(r,m.stringToUint8Array(n)),!((s=this.userKeysInfo.encryptedKeyMap.get(r))||(G.warn("encryptFieldData: this field has not encryptKey."),this.generateEncryptedKey(r,this.userKeysInfo.dataKeyPlaintext),s=this.userKeysInfo.encryptedKeyMap.get(r))))throw G.error("encryptFieldData: not found regenerate field encryptKey."),h.build(1);return[4,this.aesGcm256Encrypt(m.stringToUint8Array(n),s,i)];case 1:if(!(a=d.sent()))throw G.error("encryptFieldData: encrypt failed."),h.build(52);return u=a.slice(0,a.length-Te),l=a.slice(a.length-Te,a.length),c=Array.from(i).concat(Array.from(l)).concat(Array.from(u)),[2,Promise.resolve(new Uint8Array(c))]}})})},o.prototype.calculateGcmIv=function(t,e){var n=this.userKeysInfo.ivKeyMap.get(t);if(!n){if(!this.userKeysInfo.dataKeyPlaintext)throw G.error("calculateGcmIv: this field has not encryptedKey."),h.build(1);if(this.generateIvKey(t,this.userKeysInfo.dataKeyPlaintext),!(n=this.userKeysInfo.ivKeyMap.get(t)))throw G.error("calculateGcmIv: GenerateIvKey not found."),h.build(1)}var r=this.calculateHmacSha256(n,m.uint8ArrayToString(e));return m.wordArrayToUint8Array(r).slice(0,ie)},o.prototype.getOpeFieldDataValue=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a,u,l;return g(this,function(c){if(i=r.length>0?r.length:1,s=t+":"+e,!((a=this.userKeysInfo.opeKeyMap.get(s))||(G.warn("getOpeFieldDataValue: this field has not opeKey."),this.generateOpeKey(s,this.userKeysInfo.dataKeyPlaintext),a=this.userKeysInfo.opeKeyMap.get(s))))throw G.error("getOpeFieldDataValue: not found regenerate field opeKey."),h.build(1);u=this.convertFieldToOpeDataType(n);try{return l=new ss().generateOpeValue(r,i,u,a),[2,Promise.resolve(l)]}catch(d){throw G.error("Encrypt data failed, please check user key validity.for"+d),h.build(52)}return[2]})})},o.prototype.convertFieldToOpeDataType=function(t){var e=8;switch(t){case v.Integer:e=4;break;case v.Byte:e=2;break;case v.Short:e=3;break;case v.Long:e=5;break;case v.Float:e=6;break;case v.Double:e=7;break;case v.String:case v.Text:e=8;break;case v.Date:e=9;break;case v.Boolean:e=1;break;default:G.error("convertFieldToOpeDataType: fieldType is Unknown")}return e},o.prototype.decryptEntireEncryptedFields=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s,a,u,l,c,d,y;return g(this,function(T){switch(T.label){case 0:n=[],r=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(t.getClassName()),i=r.getEncryptFieldList(),T.label=1;case 1:T.trys.push([1,6,7,8]),s=E(e),a=s.next(),T.label=2;case 2:return a.done?[3,5]:(u=a.value,[4,this.innerDecryptEntireEncryptedFields(t,i,u)]);case 3:l=T.sent(),n.push(l),T.label=4;case 4:return a=s.next(),[3,2];case 5:return[3,8];case 6:return c=T.sent(),d={error:c},[3,8];case 7:try{a&&!a.done&&(y=s.return)&&y.call(s)}finally{if(d)throw d.error}return[7];case 8:return[2,Promise.resolve(n)]}})})},o.prototype.innerDecryptEntireEncryptedFields=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c,d,y,T=this;return g(this,function(S){switch(S.label){case 0:return n.setObjectTypeName(t.getClazz()),r=this.naturalBaseRef.getDefaultNaturalStore().getDataModelHelper().deserialize(t.getClazz(),n.getObject()),e&&e.length!==0?[4,this.checkUserId()]:(n.setUserObject(r),[2,Promise.resolve(r)]);case 1:S.sent(),i=function(O){var P,U,z,F,ae,pt,Sn;return g(this,function(Tn){switch(Tn.label){case 0:if(P=O.fieldName,!(U=r[P]))return[2,"continue"];if(!(z=s.userKeysInfo.encryptedKeyMap.get(t.getClassName()+":"+P)))throw G.error("innerDecryptEntireEncryptedFields: get encryptKey failed."),h.build(1);return s.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),typeof U=="string"&&(U=m.wordArrayToUint8Array(m.decode(U))),F=U.slice(0,ie),ae=U.slice(ie,ie+Te),pt=U.slice(ie+Te,U.length),Sn=Array.from(pt).concat(Array.from(ae)),[4,s.aesGcm256Decrypt(new Uint8Array(Sn),z,F).then(function(Er){T.decryptFieldData(Er,P,O.fieldType,r)}).catch(function(){throw G.error("innerDecryptEntireEncryptedFields: decrypt text failed."),h.build(53)})];case 1:return Tn.sent(),[2]}})},s=this,S.label=2;case 2:S.trys.push([2,7,8,9]),a=E(e),u=a.next(),S.label=3;case 3:return u.done?[3,6]:(l=u.value,[5,i(l)]);case 4:S.sent(),S.label=5;case 5:return u=a.next(),[3,3];case 6:return[3,9];case 7:return c=S.sent(),d={error:c},[3,9];case 8:try{u&&!u.done&&(y=a.return)&&y.call(a)}finally{if(d)throw d.error}return[7];case 9:return n.setUserObject(r),[2,Promise.resolve(r)]}})})},o.prototype.decryptFieldData=function(t,e,n,r){var i=m.uint8ArrayToString(t);switch(n){case v.Boolean:r[e]=i==="1";break;case v.Byte:case v.Short:case v.Integer:r[e]=parseInt(i,10);break;case v.Float:case v.Double:r[e]=parseFloat(i);break;case v.String:case v.Text:r[e]=i;break;case v.Date:r[e]=new Date(parseInt(i,10));break;case v.Long:r[e]=L.fromString(i)}return r},o.prototype.clearUserKeysInfo=function(){G.log("clearUserKeysInfo: clear userKeys."),this.userKeysInfo.userId="",this.userKeysInfo.dataKeyVersion=0,this.clearUserKey(this.userKeysInfo.ivKeyMap),this.clearUserKey(this.userKeysInfo.encryptedKeyMap),this.clearUserKey(this.userKeysInfo.oldEncryptedKeyMap),this.clearUserKey(this.userKeysInfo.opeKeyMap)},o.prototype.clearUserKey=function(t){t.clear()},o.prototype.generateKeys=function(t,e,n){var r,i,s,a,u=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema();if(u.size===0)throw G.error("generateKeys: schemas have not been loaded."),h.build(1);try{for(var l=E(u),c=l.next();!c.done;c=l.next()){var d=c.value,y=d[1].getEncryptFieldList();try{for(var T=(s=void 0,E(y)),S=T.next();!S.done;S=T.next()){var O=S.value,P=d[0]+":"+O.fieldName;this.generateColumnKeys(P,t,e,n)}}catch(U){s={error:U}}finally{try{S&&!S.done&&(a=T.return)&&a.call(T)}finally{if(s)throw s.error}}}}catch(U){r={error:U}}finally{try{c&&!c.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}},o.prototype.generateColumnKeys=function(t,e,n,r){this.generateEncryptedKey(t,e),r>0&&this.generateOldEncryptedKey(t,n),this.generateIvKey(t,e),this.generateOpeKey(t,e)},o.prototype.generateEncryptedKey=function(t,e){if(this.userKeysInfo.encryptedKeyMap.has(t))G.log("generateEncryptedKey: encryptedKey of the tableFieldName already existed.");else{var n=t;n+=" generate encryption key with encryption algorithm AES_256_GCM_HMAC_SHA256";var r=this.calculateHmacSha256(e,n);this.userKeysInfo.encryptedKeyMap.set(t,m.wordArrayToUint8Array(r))}},o.prototype.generateOldEncryptedKey=function(t,e){if(this.userKeysInfo.oldEncryptedKeyMap.has(t))G.log("generateOldEncryptedKey: oldEncryptedKey of the tableFieldName already existed.");else{var n=t+" generate encryption key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(e,n);this.userKeysInfo.oldEncryptedKeyMap.set(t,m.wordArrayToUint8Array(r))}},o.prototype.generateIvKey=function(t,e){if(this.userKeysInfo.ivKeyMap.has(t))G.log("generateIvKey: ivKey of the tableFieldName already existed.");else{var n=t+" generate IV key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(e,n);this.userKeysInfo.ivKeyMap.set(t,m.wordArrayToUint8Array(r))}},o.prototype.generateOpeKey=function(t,e){if(this.userKeysInfo.opeKeyMap.has(t))G.log("generateOpeKey: opeKey of the tableFieldName already existed.");else{var n=t+" generate Order-preserving key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(e,n);this.userKeysInfo.opeKeyMap.set(t,r)}},o.prototype.calculateHmacSha256=function(t,e){var n=m.uint8ArrayToWordArray(t),r=m.uint8ArrayToWordArray(m.stringToUint8Array(e)),i=as.HmacSHA256(r,n);if(!i)throw G.error("calculateHmacSha256: calculate hmac failed."),h.build(1);return i},o.prototype.isValidEncryptionOperation=function(t){return b(this,void 0,void 0,function(){var e,n;return g(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),(e=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(t))!=null&&e.isEncryptTable()?(kt.checkSupportEncryption(),[4,this.checkUserId()]):[2];case 1:return r.sent(),[3,3];case 2:return n=r.sent(),[2,Promise.reject(m.isErrorObject(n)?n:h.build(n))];case 3:return[2]}})})},o.prototype.checkUserId=function(){return b(this,void 0,void 0,function(){var t,e;return g(this,function(n){switch(n.label){case 0:return[4,he.getConfigInstance().getCurrentUser()];case 1:return t=n.sent(),(e=t==null?void 0:t.getUid())&&e.length!==0?this.userKeysInfo.dataKeyVersion===0?(G.error("checkUserId: data key version is invalid."),[2,Promise.reject(51)]):e!==this.userKeysInfo.userId?(G.error("checkUserId: this user is not the current user, please verify user key first."),[2,Promise.reject(15)]):[2]:(G.error("checkUserId: this user is not authenticated."),[2,Promise.reject(15)])}})})},o.prototype.GetEncryptVersion=function(){return this.userKeysInfo.dataKeyVersion},o}(),us=function(){this.ivKeyMap=new Map,this.encryptedKeyMap=new Map,this.oldEncryptedKeyMap=new Map,this.opeKeyMap=new Map,this.userId="",this.dataKeyVersion=0,this.dataKeyPlaintext=new Uint8Array,this.oldDataKeyPlaintext=new Uint8Array,this.dataKeyPlaintextLen=0,this.oldDataKeyPlaintextLen=0},_e=rt.getCryptoJS(),cs=/^[0-9a-zA-Z`~!@#$%^&*()-_=+\\\\|\\[{\]};:'",<.>/? ]{6,32}$/,ls=/^(?![0-9]+$)(?![a-z]+$)(?![A-Z]+$)(?![^a-zA-Z0-9]+$)[0-9a-zA-Z`~!@#$%^&*()-_=+\\\\|\\[{\]};:'",<.>? ]{8,32}$/,Te=16,ie=12,$e=ie+Te+32,j=new M("SecretKeyManager"),ds=function(){function o(t){this.userDataKeyInfo=new Xt,this.cloudStorage=t.getNaturalCloudStorage(),this.entireEncryption=new wr(t),this.entireEncryptInterval=t.getEntireEncryptInterval(),this.entireEncryptInterval.saveSecretKeyManager(this)}return o.prototype.getEntireEncryption=function(){return this.entireEncryption},o.prototype.setUserKey=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s;return g(this,function(a){switch(a.label){case 0:return this.checkUserKeyFormat(t,!1),[4,this.getUserId()];case 1:return n=a.sent(),r=new Xt,[4,this.getSaltFromCloud()];case 2:return i=a.sent(),(s=i.resultCode)!==0?[3,4]:(j.log("setUserKey: user key has been created, need to verify it."),r.rootKeySalt=i.encryptInfo[0].firstSaltValue,r.rootKeyTokenSalt=i.encryptInfo[0].secondSaltValue,[4,this.verifyUserKey(n,t,r)]);case 3:return a.sent(),this.entireEncryptInterval.setIntervalCleanKey(!1),[3,7];case 4:return s!==54?[3,6]:(j.log("setUserKey: the first time to set user key."),[4,this.createUserKey(n,t,r,e)]);case 5:return a.sent(),this.entireEncryptInterval.setIntervalCleanKey(!1),[3,7];case 6:return j.error("setUserKey: get salt failed, ret: "+s+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(s)];case 7:return this.userDataKeyInfo.copy(r),[2]}})})},o.prototype.modifyUserKey=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s;return g(this,function(a){switch(a.label){case 0:return this.checkUserKeyFormat(t,!1),this.checkUserKeyFormat(e,n),[4,this.getUserId()];case 1:return r=a.sent(),i=new Xt,[4,this.getSaltFromCloud()];case 2:return(s=a.sent()).resultCode!==0?(j.error("ModifyUserKey: get user salt failed."),[2,Promise.reject(s.resultCode)]):(i.rootKeySalt=s.encryptInfo[0].firstSaltValue,i.rootKeyTokenSalt=s.encryptInfo[0].secondSaltValue,[4,this.modifyUserKeyInner(r,t,e,i)]);case 3:return a.sent(),this.userDataKeyInfo.copy(i),this.entireEncryptInterval.setIntervalCleanKey(!1),[2]}})})},o.prototype.verifyUserKey=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u;return g(this,function(l){switch(l.label){case 0:this.clearDataKeyInfo(),l.label=1;case 1:return l.trys.push([1,4,,5]),[4,this.queryDataKeyCipher(e,n)];case 2:return r=l.sent(),i=r[0],s=r[1],n.userId=t,a=this.saveUserDataKey(i,s,n),[4,this.entireEncryption.setKeys(t,i,8,s,a,n.dataKeyVersion)];case 3:return l.sent(),[3,5];case 4:return u=l.sent(),j.error("verifyUserKey: verify user key failed, ret: "+u+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(u)];case 5:return[2]}})})},o.prototype.createUserKey=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a,u;return g(this,function(l){switch(l.label){case 0:r&&this.checkUserKeyFormat(e,!0),this.clearDataKeyInfo(),l.label=1;case 1:return l.trys.push([1,5,,6]),i=this.generateRandom(32),[4,this.generateUserKey(e,n,i)];case 2:return l.sent(),[4,this.InsertEncryptionInfoToCloud(n)];case 3:return l.sent(),n.userId=t,s=m.uint8ArrayToWordArray(i),n.userDataKey=m.stringToUint8Array(this.encodeDataKey(s)),n.userDataKeyLen=44,a=new Uint8Array(8),[4,this.entireEncryption.setKeys(n.userId,i,8,a,0,++n.dataKeyVersion)];case 4:return l.sent(),[3,6];case 5:return u=l.sent(),j.error("createUserKey: create user key failed, ret: "+u+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(u)];case 6:return[2]}})})},o.prototype.modifyUserKeyInner=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s,a,u;return g(this,function(l){switch(l.label){case 0:return this.clearDataKeyInfo(),[4,this.queryDataKeyCipher(e,r)];case 1:return i=l.sent(),j.log("SecretKeyManager: query data key cipher success."),s=i[0],a=i[1],u=r.userRootKeyToken,[4,this.reGenerateUserKey(n,r,s,a)];case 2:return l.sent(),[4,this.updateEncryptionInfoToCloud(u,r)];case 3:return l.sent(),r.userId=t,this.saveUserDataKey(s,a,r),[2]}})})},o.prototype.queryDataKeyCipher=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s;return g(this,function(a){switch(a.label){case 0:return n={keySize:8,hasher:_e.algo.SHA256.create(),iterations:1e5},r=_e.PBKDF2(t,m.uint8ArrayToWordArray(e.rootKeySalt),n),m.isNullOrUndefined(r)?(j.error("queryDataKeyCipher: derive root key failed."),[2,Promise.reject(1)]):(e.userRootKey=m.wordArrayToUint8Array(r),e.userRootKeyLen=8,i={keySize:8,hasher:_e.algo.SHA256.create(),iterations:1e4},s=_e.PBKDF2(r,m.uint8ArrayToWordArray(e.rootKeyTokenSalt),i),m.isNullOrUndefined(s)?(j.error("QueryDataKeyCipher: derive root key token failed."),[2,Promise.reject(1)]):(e.userRootKeyToken=m.wordArrayToUint8Array(s),e.userRootKeyTokenLen=8,[4,this.queryDataKeyCipherFromCloud(e)]));case 1:return a.sent(),[4,this.decryptQueryCipherText(e)];case 2:return[2,a.sent()]}})})},o.prototype.reGenerateUserKey=function(t,e,n,r){return b(this,void 0,void 0,function(){var i,s;return g(this,function(a){switch(a.label){case 0:return[4,this.generateUserKey(t,e,n)];case 1:return a.sent(),e.userOldDataKeyCipherLen>0?(i=this.generateRandom(ie))?[4,this.entireEncryption.aesGcm256Encrypt(r,e.userRootKey,i)]:(j.warn("reGenerateUserKey: random to generate gcmIv failed."),[2,Promise.reject(1)]):[3,3];case 2:if((s=a.sent()).length<=0)return j.warn("reGenerateUserKey: encrypt old dataKey failed."),[2,Promise.reject(52)];e.userOldDataKeyCipher={iv:i,tag:s.slice(32,s.length),cipherText:s.slice(0,32)},a.label=3;case 3:return[2]}})})},o.prototype.generateUserKey=function(t,e,n){return b(this,void 0,void 0,function(){var r,i,s,a,u,l,c,d,y;return g(this,function(T){switch(T.label){case 0:return e.rootKeySalt=this.generateRandom(16),r={keySize:8,hasher:_e.algo.SHA256.create(),iterations:1e5},i=m.uint8ArrayToWordArray(e.rootKeySalt),[4,_e.PBKDF2(t,i,r)];case 1:return s=T.sent(),m.isNullOrUndefined(s)?(j.warn("GenerateUserKey: derive root key failed."),[2,Promise.reject(1)]):(a=m.wordArrayToUint8Array(s),e.userRootKey=a,e.userRootKeyLen=8,e.rootKeyTokenSalt=this.generateRandom(16),u={keySize:8,hasher:_e.algo.SHA256.create(),iterations:1e4},l=m.uint8ArrayToWordArray(e.rootKeyTokenSalt),[4,_e.PBKDF2(s,l,u)]);case 2:return c=T.sent(),m.isNullOrUndefined(c)?(j.warn("GenerateUserKey: derive root key token failed."),[2,Promise.reject(1)]):(e.userRootKeyToken=m.wordArrayToUint8Array(c),e.userRootKeyTokenLen=8,(d=this.generateRandom(ie))?[4,this.entireEncryption.aesGcm256Encrypt(n,a,d)]:(j.warn("GenerateUserKey: random to generate gcmIv failed."),[2,Promise.reject(1)]));case 3:return(y=T.sent())?(e.userDataKeyCipher={iv:d,tag:y.slice(32,y.length),cipherText:y.slice(0,32)},[2]):(j.warn("GenerateUserKey: encrypt dataKey failed."),[2,Promise.reject(52)])}})})},o.prototype.onKeyStatusChanged=function(t){return b(this,void 0,void 0,function(){var e;return g(this,function(n){switch(n.label){case 0:return j.log("onKeyStatusChanged: process call back with dataKey changed, keyStatus: "+t),(e=t)!==ye.INTERRUPT&&e!==ye.NORMAL?[2,Promise.resolve(0)]:[4,this.queryDataKeyAfterReKey()];case 1:return n.sent(),[2,Promise.resolve(0)]}})})},o.prototype.queryDataKeyAfterReKey=function(){var t;return b(this,void 0,void 0,function(){var e,n,r;return g(this,function(i){switch(i.label){case 0:return[4,this.checkDataKeyCache()];case 1:return i.sent(),(e=new je).rootKeyToken=this.userDataKeyInfo.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(e)];case 2:return(n=i.sent()).resultCode!==0?(j.warn(`queryDataKeyAfterReKey: query data key cipher failed from cloud,
             ret:`+n.resultCode+"."),[2,Promise.reject(n.resultCode)]):(r=n.encryptInfo[0]).dataKeyCipherText&&r.dataKeyCipherText.length===$e?this.userDataKeyInfo.dataKeyVersion<r.keyVersion?[4,this.refreshDataKeyCache(r)]:[3,4]:(j.warn(`queryDataKeyAfterReKey: cloud saved dataKeyCipherText is invalid,
             dataKeyCipherText length: `+((t=r.dataKeyCipherText)===null||t===void 0?void 0:t.length)),[2,Promise.reject(51)]);case 3:i.sent(),i.label=4;case 4:return[2]}})})},o.prototype.checkKeyIfNetworkReconnect=function(){return b(this,void 0,void 0,function(){var t,e;return g(this,function(n){switch(n.label){case 0:return j.log("CheckKeyIfNetworkReconnect: check userKey or dataKey changed after reconnect."),[4,this.checkDataKeyCache()];case 1:return n.sent(),(t=new je).rootKeyToken=this.userDataKeyInfo.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(t)];case 2:return(e=n.sent()).resultCode!==0?(j.warn(`CheckKeyIfNetworkReconnect: query data key cipher failed from cloud,
             ret:`+e.resultCode+"."),[2,Promise.reject(e.resultCode)]):[2,this.processDataKeyChangedByReconnect(e.encryptInfo[0])]}})})},o.prototype.processDataKeyChangedByReconnect=function(t){return b(this,void 0,void 0,function(){var e;return g(this,function(n){switch(n.label){case 0:return t?(e=t.keyStatus,j.info(`ProcessDataKeyChangedByReconnect: process reconnect with dataKey changed,' +
            ' keyStatus: `+e+"."),e===ye.INTERRUPT||e===ye.NORMAL&&this.userDataKeyInfo.dataKeyVersion<t.keyVersion?[4,this.refreshDataKeyCache(t)]:[2,Promise.resolve(0)]):(j.warn("ProcessDataKeyChangedByReconnect: encryptionInfo is null"),[2,Promise.reject(1003)]);case 1:return n.sent(),j.log("processDataKeyChangedByReconnect success"),[2,Promise.resolve(0)]}})})},o.prototype.refreshDataKeyCache=function(t){var e;return b(this,void 0,void 0,function(){var n,r,i,s;return g(this,function(a){switch(a.label){case 0:return this.clearOldDataKeyInfo(),t.dataKeyCipherText&&t.dataKeyCipherText.byteLength===$e?(this.saveDataKeyCipher(t,this.userDataKeyInfo),[4,this.decryptQueryCipherText(this.userDataKeyInfo)]):(j.warn(`refreshDataKeyCache: cloud saved dataKeyCipherText is invalid,
             dataKeyCipherText length: `+((e=t.dataKeyCipherText)===null||e===void 0?void 0:e.length)),[2,Promise.reject(51)]);case 1:return n=a.sent(),r=n[0],i=n[1],s=this.saveUserDataKey(r,i,this.userDataKeyInfo),[4,this.entireEncryption.setKeys(this.userDataKeyInfo.userId,r,8,i,s,this.userDataKeyInfo.dataKeyVersion)];case 2:return a.sent(),[2]}})})},o.prototype.decryptQueryCipherText=function(t){return b(this,void 0,void 0,function(){var e,n,r,i,s,a,u,l,c;return g(this,function(d){switch(d.label){case 0:e=[new Uint8Array(32),new Uint8Array(32)],n=Array.from(t.userDataKeyCipher.cipherText).concat(Array.from(t.userDataKeyCipher.tag)),r=t.userDataKeyCipher.iv,d.label=1;case 1:return d.trys.push([1,3,,4]),i=e,s=0,[4,this.entireEncryption.aesGcm256Decrypt(new Uint8Array(n),t.userRootKey,r)];case 2:return i[s]=d.sent(),[3,4];case 3:return d.sent(),j.error("decryptQueryCipherText:decrypt dataKeyCipher failed."),[2,Promise.reject(53)];case 4:if(!(t.userOldDataKeyCipherLen>0))return[3,8];a=Array.from(t.userOldDataKeyCipher.cipherText).concat(Array.from(t.userOldDataKeyCipher.tag)),u=t.userOldDataKeyCipher.iv,d.label=5;case 5:return d.trys.push([5,7,,8]),l=e,c=1,[4,this.entireEncryption.aesGcm256Decrypt(new Uint8Array(a),t.userRootKey,u)];case 6:return l[c]=d.sent(),[3,8];case 7:return d.sent(),j.error("QueryDataKeyCipher:decrypt oldDataKeyCipher failed."),[2,Promise.reject(53)];case 8:return[2,Promise.resolve(e)]}})})},o.prototype.saveDataKeyCipher=function(t,e){var n=t.dataKeyCipherText,r=n.slice(0,ie),i=n.slice(ie,ie+Te),s=n.slice(ie+Te,n.length);if(e.userDataKeyCipher={cipherText:s,tag:i,iv:r},e.userDataKeyCipherLen=$e,e.dataKeyVersion=t.keyVersion,e.dataKeyStatus=t.keyStatus,t.oldDataKeyCipherText&&t.oldDataKeyCipherText.length===$e){var a=t.oldDataKeyCipherText,u=a.slice(0,ie),l=a.slice(ie,ie+Te),c=a.slice(ie+Te,a.length);e.userOldDataKeyCipher={cipherText:c,tag:l,iv:u},e.userOldDataKeyCipherLen=$e}},o.prototype.saveUserDataKey=function(t,e,n){var r=m.uint8ArrayToWordArray(t);n.userDataKey=m.stringToUint8Array(this.encodeDataKey(r)),n.userDataKeyLen=44;var i=0;if(n.userOldDataKeyCipherLen>0){var s=m.uint8ArrayToWordArray(e);n.userOldDataKey=m.stringToUint8Array(this.encodeDataKey(s)),n.userDataKeyLen=44,i=8}return i},o.prototype.getSaltFromCloud=function(){var t,e,n,r;return b(this,void 0,void 0,function(){var i;return g(this,function(s){switch(s.label){case 0:return[4,this.cloudStorage.querySaltValue()];case 1:return(i=s.sent()).resultCode!==0?(j.warn("GetSaltFromCloud: cloud has not saved this user`s salt."),[2,i]):i.encryptInfo[0]&&i.encryptInfo[0].firstSaltValue&&i.encryptInfo[0].secondSaltValue?((t=i.encryptInfo[0].firstSaltValue)===null||t===void 0?void 0:t.length)!==16||((e=i.encryptInfo[0].secondSaltValue)===null||e===void 0?void 0:e.length)!==16?(j.warn("GetSaltFromCloud: cloud saved salt length is not effective length,             firstSalt length:"+((n=i.encryptInfo[0].firstSaltValue)===null||n===void 0?void 0:n.length)+",              secondSalt length:"+((r=i.encryptInfo[0].secondSaltValue)===null||r===void 0?void 0:r.length)),[2,new qe(1,[])]):[2,i]:(j.warn("GetSaltFromCloud: cloud saved salt value is null."),[2,new qe(54,[])])}})})},o.prototype.InsertEncryptionInfoToCloud=function(t){return b(this,void 0,void 0,function(){var e,n,r;return g(this,function(i){switch(i.label){case 0:return(e=new je).firstSaltValue=t.rootKeySalt,e.secondSaltValue=t.rootKeyTokenSalt,e.rootKeyToken=t.userRootKeyToken,n=Array.from(t.userDataKeyCipher.iv).concat(Array.from(t.userDataKeyCipher.tag)).concat(Array.from(t.userDataKeyCipher.cipherText)),e.dataKeyCipherText=new Uint8Array(n),[4,this.cloudStorage.insertEncryptedInfo(e)];case 1:return(r=i.sent()).resultCode!==0?(j.warn("InsertEncryptionInfoToCloud: insert encrypt info failed."),[2,Promise.reject(r.resultCode)]):[2]}})})},o.prototype.queryDataKeyCipherFromCloud=function(t){var e;return b(this,void 0,void 0,function(){var n,r,i;return g(this,function(s){switch(s.label){case 0:return(n=new je).rootKeyToken=t.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(n)];case 1:return(r=s.sent()).resultCode!==0?(j.warn("QueryDataKeyCipherFromCloud: query dataKeyCipher failed."),[2,Promise.reject(r.resultCode)]):(i=r.encryptInfo[0]).dataKeyCipherText&&i.dataKeyCipherText.length===$e?(this.saveDataKeyCipher(i,t),[2]):(j.warn(`queryDataKeyCipherFromCloud: cloud saved dataKeyCipherText is invalid,
             dataKeyCipherText length: `+((e=i.dataKeyCipherText)===null||e===void 0?void 0:e.length)),[2,Promise.reject(1)])}})})},o.prototype.updateEncryptionInfoToCloud=function(t,e){return b(this,void 0,void 0,function(){var n,r,i,s,a;return g(this,function(u){switch(u.label){case 0:return(n=new je).rootKeyToken=t,r=Array.from(e.userDataKeyCipher.iv).concat(Array.from(e.userDataKeyCipher.tag)).concat(Array.from(e.userDataKeyCipher.cipherText)),(i=new je).firstSaltValue=e.rootKeySalt,i.secondSaltValue=e.rootKeyTokenSalt,i.rootKeyToken=e.userRootKeyToken,i.dataKeyCipherText=new Uint8Array(r),e.userOldDataKeyCipherLen>0&&(s=Array.from(e.userOldDataKeyCipher.iv).concat(Array.from(e.userOldDataKeyCipher.tag)).concat(Array.from(e.userOldDataKeyCipher.cipherText)),i.oldDataKeyCipherText=new Uint8Array(s)),[4,this.cloudStorage.updateEncryptedInfo(n,i)];case 1:return(a=u.sent()).resultCode!==0?(j.warn("updateEncryptionInfoToCloud: update encrypt info failed."),[2,Promise.reject(a.resultCode)]):[2]}})})},o.prototype.getUserId=function(){return b(this,void 0,void 0,function(){var t,e;return g(this,function(n){switch(n.label){case 0:return[4,he.getConfigInstance().getCurrentUser()];case 1:return t=n.sent(),e=t==null?void 0:t.getUid(),m.isNullOrUndefined(t)||m.isNullOrUndefined(e)?(j.error("getUserId: this user is not authenticated."),[2,Promise.reject(15)]):[2,e]}})})},o.prototype.checkDataKeyCache=function(){return b(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,this.getUserId()];case 1:return t=e.sent(),this.userDataKeyInfo.userRootKeyLen!==8||this.userDataKeyInfo.userRootKeyTokenLen!==8?(j.warn("checkDataKeyCache: user key is invalid, please verify user key first."),[2,Promise.reject(51)]):t!==this.userDataKeyInfo.userId?(j.warn("checkDataKeyCache: this user is not the current user, please verify user key first."),[2,Promise.reject(15)]):[2]}})})},o.prototype.checkUserKeyFormat=function(t,e){if(!(e?ls.test(t):cs.test(t)))throw j.error("checkUserKeyFormat: user key is invalid."),h.build(50)},o.prototype.encodeDataKey=function(t){return m.encode(t)},o.prototype.generateRandom=function(t){return this.entireEncryption.generateRandom(t)},o.prototype.clearDataKeyInfo=function(){j.log("clearDataKeyInfo: clear dataKey."),this.userDataKeyInfo.userId="",this.userDataKeyInfo.userRootKeyLen=0,this.userDataKeyInfo.userRootKeyTokenLen=0,this.userDataKeyInfo.userRootKey=new Uint8Array(0),this.userDataKeyInfo.userRootKeyToken=new Uint8Array(0),this.clearOldDataKeyInfo()},o.prototype.clearOldDataKeyInfo=function(){this.userDataKeyInfo.dataKeyVersion=0,this.userDataKeyInfo.dataKeyStatus=0,this.userDataKeyInfo.userDataKeyLen=0,this.userDataKeyInfo.userDataKeyCipherLen=0,this.userDataKeyInfo.userOldDataKeyLen=0,this.userDataKeyInfo.userOldDataKeyCipherLen=0,this.userDataKeyInfo.userDataKey=new Uint8Array(0),this.userDataKeyInfo.userDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userDataKeyInfo.userOldDataKey=new Uint8Array(0),this.userDataKeyInfo.userOldDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)}},o}(),Xt=function(){function o(){this.userId="",this.userRootKey=new Uint8Array(0),this.userRootKeyToken=new Uint8Array(0),this.userDataKey=new Uint8Array(0),this.userDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userOldDataKey=new Uint8Array(0),this.userOldDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userRootKeyLen=0,this.userRootKeyTokenLen=0,this.userDataKeyLen=0,this.userDataKeyCipherLen=0,this.dataKeyVersion=0,this.dataKeyStatus=0,this.userOldDataKeyLen=0,this.userOldDataKeyCipherLen=0,this.rootKeySalt=new Uint8Array(0),this.rootKeyTokenSalt=new Uint8Array(0)}return o.prototype.copy=function(t){this.userId=t.userId,this.userRootKey=new Uint8Array(t.userRootKey),this.userRootKeyToken=new Uint8Array(t.userRootKeyToken),this.userDataKey=new Uint8Array(t.userDataKey),this.userDataKeyCipher={iv:new Uint8Array(t.userDataKeyCipher.iv),tag:new Uint8Array(t.userDataKeyCipher.tag),cipherText:new Uint8Array(t.userDataKeyCipher.cipherText)},this.userOldDataKey=new Uint8Array(t.userOldDataKey),this.userOldDataKeyCipher={iv:new Uint8Array(t.userOldDataKeyCipher.iv),tag:new Uint8Array(t.userOldDataKeyCipher.tag),cipherText:new Uint8Array(t.userOldDataKeyCipher.cipherText)},this.userRootKeyLen=t.userRootKeyLen,this.userRootKeyTokenLen=t.userRootKeyTokenLen,this.userDataKeyLen=t.userDataKeyLen,this.userDataKeyCipherLen=t.userDataKeyCipherLen,this.dataKeyVersion=t.dataKeyVersion,this.dataKeyStatus=t.dataKeyStatus,this.userOldDataKeyLen=t.userOldDataKeyLen,this.userOldDataKeyCipherLen=t.userOldDataKeyCipherLen,this.rootKeySalt=new Uint8Array(t.rootKeySalt),this.rootKeyTokenSalt=new Uint8Array(t.rootKeyTokenSalt)},o}(),ps=function(){function o(t){this.naturalCloudSyncModule=new ts(t)}return o.prototype.executeUpsert=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.onUpsert(e,t)];case 1:return[2,n.sent()]}})})},o.prototype.executeDelete=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.onDelete(e,t)];case 1:return[2,n.sent()]}})})},o.prototype.executeQuery=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onQuery(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.executeAggregateQuery=function(t,e,n){return b(this,void 0,void 0,function(){var r;return g(this,function(i){switch(i.label){case 0:return[4,this.naturalCloudSyncModule.onAggregateQuery(t,e,n)];case 1:return[2,(r=i.sent()).isNull?0:r.doubleRes]}})})},o.prototype.runTransaction=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onTransaction(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.unsubscribeForRekey=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.unsubscribeForRekey()];case 1:return[2,t.sent()]}})})},o.prototype.subscribeForRekey=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.subscribeForRekey()];case 1:return[2,t.sent()]}})})},o.prototype.onSubscribe=function(t,e,n,r){return b(this,void 0,void 0,function(){return g(this,function(i){switch(i.label){case 0:return[4,this.naturalCloudSyncModule.onSubscribe(t,e,n,r)];case 1:return[2,i.sent()]}})})},o.prototype.onUnSubscribe=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onUnSubscribe(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.needToDisconnectWebsocket=function(){return this.naturalCloudSyncModule.needToDisconnectWebsocket()},o.prototype.disconnectWebSocket=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.disconnectWebSocket()];case 1:return t.sent(),[2]}})})},o.prototype.addEncryptionListener=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().addEncryptionListener(t)];case 1:return e.sent(),[2]}})})},o.prototype.querySaltValue=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().querySaltValue()];case 1:return[2,t.sent()]}})})},o.prototype.queryDataKeyCipherText=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().queryDataKeyCipherText(t)];case 1:return[2,e.sent()]}})})},o.prototype.insertEncryptedInfo=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().insertEncryptedInfo(t)];case 1:return[2,e.sent()]}})})},o.prototype.updateEncryptedInfo=function(t,e){return b(this,void 0,void 0,function(){return g(this,function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().updateEncryptedInfo(t,e)];case 1:return[2,n.sent()]}})})},o.prototype.executeServerStatusQuery=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.onServerStatusQuery()];case 1:return[2,t.sent()]}})})},o}(),fs=function(){function o(){this.intervalTimeOut=0,this.timeOutStateMachine=!1,this.firstTime=0}return o.prototype.setIntervalCleanKey=function(t){var e=this;this.firstTime=Date.now(),t||this.timeOutStateMachine||(this.intervalTimeOut=setInterval(function(){var n;Date.now()-e.firstTime>=9e5&&(e.secretKeyManager&&e.secretKeyManager.clearDataKeyInfo(),(n=e.secretKeyManager)===null||n===void 0||n.getEntireEncryption().clearUserKeysInfo(),e.encryptTaskManager.tryToDisconnectWhenClearUserKey(),e.timeOutStateMachine=!1,clearInterval(e.intervalTimeOut))},3e4),this.timeOutStateMachine=!0)},o.prototype.saveSecretKeyManager=function(t){this.secretKeyManager=t},o.prototype.saveEncryptTaskManager=function(t){this.encryptTaskManager=t},o}(),X=new M("NaturalBase"),Zt=function(){function o(t){this.naturalStoreMap=new Map,this.isUserKeyValid=!1,this.onEventListener=void 0,this.certificateService=new kt(t),this.entireEncryptInterval=new fs,this.defaultNStore=new Xn,this.cloudStorage=new ps(this),this.secretKeyManager=new ds(this)}return o.prototype.getNaturalStore=function(t){if(!m.isEmpty(t))return this.naturalStoreMap.get(t)},o.prototype.getAllNaturalStore=function(){return Q(this.naturalStoreMap.values())},o.prototype.createObjectType=function(t){this.validateSchemaInput(t);var e=this.convert(t);if(!this.defaultNStore)return X.error("createObjectType: the default naturalStore is not inited."),1;if(this.naturalStoreMap.size!==0)return X.warn("createObjectType: opening naturalStore exists."),8;var n=this.defaultNStore.getAppSchema();return n.size!==0&&Pt.compareSchemas(this.defaultNStore.getAppVersion(),n,t.schemaVersion,e)||(this.certificateService.setAppVersion(t.schemaVersion),this.defaultNStore.createObjectType(t.schemaVersion,e)),0},o.prototype.openNaturalStore=function(t){return b(this,void 0,void 0,function(){var e,n;return g(this,function(r){if(e={naturalStore:void 0,exceptionCode:1},this.defaultNStore instanceof Xn){if(!this.naturalStoreMap.has(t)){if(this.naturalStoreMap.size>=4)return X.warn("the count of natural store exceeds 4"),e.exceptionCode=6,[2,e];n=new cn(t,this),this.naturalStoreMap.set(n.naturalStoreId,n)}e.naturalStore=this.naturalStoreMap.get(t),e.exceptionCode=0}return[2,e]})})},o.prototype.tryCloseNaturalStore=function(t,e){var n=this.naturalStoreMap.get(e);if(n)if(n.references.has(t))if(n.references.size>1)n.references.delete(t);else{if(n.hasSubscriber())throw X.error("tryCloseNaturalStore: zone has snapshot subscriber."),h.build(10);n.close(),this.naturalStoreMap.delete(e),this.naturalStoreMap.size||(X.log("tryCloseNaturalStore: will to disconnect websocket."),this.cloudStorage.disconnectWebSocket()),n.references.delete(t),X.log("tryCloseNaturalStore: close zone success.")}else X.warn("tryCloseNaturalStore: zone has been closed.");else X.warn("tryCloseNaturalStore: zone has not been found.")},o.prototype.setUserKey=function(t,e,n){var r,i;return b(this,void 0,void 0,function(){var s,a;return g(this,function(u){switch(u.label){case 0:s=e.length,u.label=1;case 1:return u.trys.push([1,6,,7]),s!==0?[3,3]:(X.log("SetUserKey: begin to set user key."),[4,(r=this.secretKeyManager)===null||r===void 0?void 0:r.setUserKey(t,n)]);case 2:return u.sent(),[3,5];case 3:return X.log("SetUserKey: begin to modify user key."),[4,(i=this.secretKeyManager)===null||i===void 0?void 0:i.modifyUserKey(t,e,n)];case 4:u.sent(),u.label=5;case 5:return[3,7];case 6:return a=u.sent(),m.isErrorObject(a)?[2,Promise.reject(a)]:[2,Promise.reject(h.build(a))];case 7:return this.isUserKeyValid=!0,this.onEventListener?[4,this.addEncryptionMonitor()]:[3,9];case 8:u.sent(),u.label=9;case 9:return X.log("setUserKey: set or modify user key success."),[2,Promise.resolve(!0)]}})})},o.prototype.addOnEventListener=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return this.onEventListener=t,this.isUserKeyValid?[4,this.addEncryptionMonitor()]:(X.warn("user key is invalid, schedule to addEventListener when user key is valid"),[2]);case 1:return e.sent(),[2]}})})},o.prototype.addEncryptionMonitor=function(){return b(this,void 0,void 0,function(){var t=this;return g(this,function(e){switch(e.label){case 0:return this.monitor||(this.monitor=new is(function(){var n;X.info("start onUserCommandChanged"),(n=t.onEventListener)===null||n===void 0||n.onEvent(At.USER_KEY_CHANGED)},function(n){return b(t,void 0,void 0,function(){var r;return g(this,function(i){switch(i.label){case 0:return X.info("start onKeyStatusChanged, status:"+n),[4,this.secretKeyManager.onKeyStatusChanged(n).catch(function(s){return s})];case 1:return(r=i.sent())!==0?(X.error("onKeyStatusChanged process fail, resultCode:"+r),[2]):n!==ye.UPDATING?[3,3]:[4,this.cloudStorage.unsubscribeForRekey()];case 2:return i.sent(),[3,5];case 3:return n!==ye.NORMAL?[3,5]:[4,this.cloudStorage.subscribeForRekey()];case 4:i.sent(),i.label=5;case 5:return[2]}})})})),[4,this.cloudStorage.addEncryptionListener(this.monitor)];case 1:return e.sent(),X.info("addEncryptionMonitor done."),[2]}})})},o.prototype.onConnect=function(){var t;return b(this,void 0,void 0,function(){var e,n;return g(this,function(r){switch(r.label){case 0:return X.log("start onConnect"),this.onEventListener?[4,this.secretKeyManager.checkKeyIfNetworkReconnect().catch(function(i){return i})]:[3,4];case 1:return e=r.sent(),this.isUserKeyValid=e===0,this.isUserKeyValid?[4,this.addEncryptionMonitor()]:[3,3];case 2:r.sent(),r.label=3;case 3:e===1005001&&(X.warn("user key has changed, need to set new user key."),(t=this.onEventListener)===null||t===void 0||t.onEvent(At.USER_KEY_CHANGED)),r.label=4;case 4:return[4,this.cloudStorage.onSubscribe(ue.ALL_STORE,void 0,void 0,!0)];case 5:return(n=r.sent())!==0&&X.error("Resubscribe fail for: "+n),!this.cloudStorage.needToDisconnectWebsocket()||this.isUserKeyValid?[3,7]:(X.debug("need to disconnect"),[4,this.cloudStorage.disconnectWebSocket()]);case 6:r.sent(),r.label=7;case 7:return[2]}})})},o.prototype.validateSchemaInput=function(t){if(m.isNullOrUndefined(t))throw h.build("The object type info must not be null.");if(m.isNullOrUndefined(t.objectTypes)||m.isNullOrUndefined(t.permissions))throw h.build("The object type list and permissions must not be null.");if(typeof t.schemaVersion!="number"||isNaN(t.schemaVersion)||t.schemaVersion<=0)throw h.build("The version of object type should be greater than 0.");if(t.objectTypes.length!==t.permissions.length)throw h.build("The size of object type list should be the same as permissions.")},o.prototype.convert=function(t){var e=t.permissions,n=t.objectTypes,r=new Map,i=function(u,l){return u.objectTypeName===l.objectTypeName?0:u.objectTypeName>l.objectTypeName?1:-1};e.length>1&&e.sort(i),n.length>1&&n.sort(i);for(var s=0;s<e.length;s++){var a=new gi(e[s],n[s]);Pt.validateObjectSchema(a),r.set(a.name,a)}return r},o.prototype.getDataModelHelper=function(){var t;return(t=this.defaultNStore)===null||t===void 0?void 0:t.getDataModelHelper()},o.prototype.getDefaultNaturalStore=function(){return this.defaultNStore},o.prototype.getEntireEncryptInterval=function(){return this.entireEncryptInterval},o.prototype.getEntireEncryption=function(){return this.secretKeyManager.getEntireEncryption()},o.prototype.getNaturalCloudStorage=function(){return this.cloudStorage},o.prototype.getCertificateService=function(){return this.certificateService},o}(),hs=new M("ListenerHandlerImpl"),ys=function(){function o(t,e,n){this.naturalStore=t,this.listenerId=e,this.callback=n}return o.prototype.remove=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return this.callback!==null&&(this.callback.remove(this),this.callback=null),this.naturalStore?[4,this.naturalStore.removeSnapshotListener(this.listenerId)]:[3,2];case 1:t.sent()!==0&&hs.error("remove registration failed."),t.label=2;case 2:return this.naturalStore=null,[2]}})})},o}(),nr=new M("TransactionImpl"),gs=function(){function o(t){this.transactionObjectsSize=0,this.needVerifyObjects=[],this.needVerifyObjectsMap=new Map,this.queryObjectsSize=0,this.transactionList=[],this.zone=t}return o.prototype.executeQuery=function(t){return b(this,void 0,void 0,function(){var e=this;return g(this,function(n){if(this.zone.getNaturalStore().checkQueryClass(t),this.transactionList.length>0)throw nr.warn("All transaction read need before all transaction write."),h.build("All transaction read need before all transaction write.");return[2,new Promise(function(r,i){e.zone.getNaturalStore().executeTransactionQuery(t).then(function(s){var a,u;if(e.needVerifyObjectsMap.has(t.getClassName())){var l=e.needVerifyObjectsMap.get(t.getClassName()).objects;e.needVerifyObjectsMap.get(t.getClassName()).objects=l.concat(s.objects)}else e.needVerifyObjectsMap.set(t.getClassName(),{objectTypeName:t.getClassName(),objects:s.objects});try{for(var c=E(s.decryptObjects),d=c.next();!d.done;d=c.next()){var y=d.value;e.queryObjectsSize=e.queryObjectsSize+e.zone.getDataModelHelper().calculateObject(y)}}catch(T){a={error:T}}finally{try{d&&!d.done&&(u=c.return)&&u.call(c)}finally{if(a)throw a.error}}r(s.decryptObjects)}).catch(function(s){i(m.isErrorObject(s)?s:h.build(s))})})]})})},o.prototype.executeUpsert=function(t){if(!this.checkObjectList(t,"upsert"))return this;this.calculateObjectsSize(t);var e=m.getClassName(t[0]);return this.transactionList.push({operationType:ge.SYNC_UPSERT,objectTypeName:e,objects:t}),this},o.prototype.executeDelete=function(t){return this.checkObjectList(t,"delete")?(this.calculateObjectsSize(t),this.transactionList.push({operationType:ge.SYNC_DELETE,objectTypeName:m.getClassName(t[0]),objects:t}),this):this},o.prototype.calculateObjectsSize=function(t){var e,n;try{for(var r=E(t),i=r.next();!i.done;i=r.next()){var s=i.value;this.transactionObjectsSize=this.transactionObjectsSize+this.zone.getDataModelHelper().calculateObject(s)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},o.prototype.release=function(){this.needVerifyObjects=[],this.transactionList=[],this.transactionObjectsSize=0,this.queryObjectsSize=0,this.needVerifyObjectsMap.clear()},o.prototype.isTransactionEmpty=function(){var t,e;try{for(var n=E(this.transactionList),r=n.next();!r.done;r=n.next())if(r.value.objects.length>0)return!1}catch(i){t={error:i}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}return!0},o.prototype.getTransactionObjectsSize=function(){return this.transactionObjectsSize},o.prototype.getQueryObjectsSize=function(){return this.queryObjectsSize},o.prototype.getTransactionList=function(){return this.transactionList},o.prototype.getNeedVerifyObjects=function(){return this.needVerifyObjects},o.prototype.sortNeedVerifyObjects=function(){var t,e,n=Array.from(this.needVerifyObjectsMap.values()).sort(function(u,l){return u.objectTypeName.localeCompare(l.objectTypeName)}),r=function(u){var l=i.zone.getDataModelHelper().getPrimaryKeyByClassName(u.objectTypeName);u.objects.sort(function(c,d){var y,T,S=c.userObject,O=d.userObject;try{for(var P=(y=void 0,E(l)),U=P.next();!U.done;U=P.next()){var z=U.value,F=0;switch(z.fieldType){case v.Byte:case v.Short:case v.Integer:F=S[z.fieldName]-O[z.fieldName];break;case v.Long:F=S[z.fieldName].compare(O[z.fieldName]);break;case v.String:F=S[z.fieldName].localeCompare(O[z.fieldName])}if(F!==0)return F}}catch(ae){y={error:ae}}finally{try{U&&!U.done&&(T=P.return)&&T.call(P)}finally{if(y)throw y.error}}return 0}),i.needVerifyObjects=i.needVerifyObjects.concat(u.objects)},i=this;try{for(var s=E(n),a=s.next();!a.done;a=s.next())r(a.value)}catch(u){t={error:u}}finally{try{a&&!a.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}},o.prototype.checkObjectList=function(t,e){if(!t)throw h.build("The object list must not be null.");if(!m.isArray(t))throw h.build("The object list is invalid.");if(t.length===0)return nr.log("No objects to "+e+"."),!1;if(!m.isSameObjectType(t))throw h.build("Only one object type is supported for batch operations.");return!0},o}(),Ae=new M("CloudDBZone"),rr=function(){function o(t,e,n){var r=this;this.listenerHandlers=new Set,this.callback={remove:function(i){r.listenerHandlers.delete(i)}},this.zoneId=t,this.zoneName=e,this.naturalStore=n,this.naturalStore.references.add(t)}return Object.defineProperty(o.prototype,"cloudDBZoneName",{get:function(){return this.zoneName},enumerable:!1,configurable:!0}),o.prototype.executeServerStatusQuery=function(){return b(this,void 0,void 0,function(){var t=this;return g(this,function(e){return[2,new Promise(function(n,r){t.naturalStore.executeServerStatusQuery().then(function(i){n(i)}).catch(function(i){r(m.isErrorObject(i)?i:h.build(i))})})]})})},o.prototype.subscribeSnapshot=function(t,e){return b(this,void 0,void 0,function(){var n,r=this;return g(this,function(i){return this.checkQuickGamePlatform(),this.checkCloudDBZoneHandle(),this.checkListener(e),n=++o.listenerId,[2,new Promise(function(s,a){r.naturalStore.addSnapshotListener(t,e,n).then(function(u){if(u!==0)return Ae.error("register listener failed."),void a(h.build(u));var l=new ys(r.naturalStore,n,r.callback);r.listenerHandlers.add(l),s(l)}).catch(function(u){a(m.isErrorObject(u)?u:h.build(u))})})]})})},o.prototype.checkListener=function(t){if(m.isNullOrUndefined(t))throw h.build("The listener must not be null.");if(typeof t!="object"||typeof t.onSnapshot!="function")throw h.build("The listener must be object or function.")},o.prototype.hasSnapshot=function(){return this.listenerHandlers.size>0},o.prototype.executeUpsert=function(t){return b(this,void 0,void 0,function(){var e,n=this;return g(this,function(r){return this.isValidOperation(t),(e=m.convertArray(t)).length===0?(Ae.warn("ObjectList is empty when executeUpsert."),[2,Promise.resolve(0)]):(this.validateObjectList(e),[2,new Promise(function(i,s){n.naturalStore.executeUpsert(e).then(function(a){i(a)}).catch(function(a){s(m.isErrorObject(a)?a:h.build(a))})})])})})},o.prototype.validateObjectType=function(t){var e,n;try{for(var r=E(t),i=r.next();!i.done;i=r.next()){var s=i.value;if(!this.naturalStore.getDataModelHelper().validate(s))return!1}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}return!0},o.prototype.calculateObjectListSize=function(t){var e=this,n=0;return t.forEach(function(r){n+=e.naturalStore.getDataModelHelper().calculateObject(r)}),n},o.prototype.executeDelete=function(t){return b(this,void 0,void 0,function(){var e,n=this;return g(this,function(r){return this.isValidOperation(t),(e=m.convertArray(t)).length===0?(Ae.warn("ObjectList is empty when executeDelete."),[2,Promise.resolve(0)]):(this.validateObjectList(e),[2,new Promise(function(i,s){n.naturalStore.executeDelete(e).then(function(a){i(a)}).catch(function(a){s(m.isErrorObject(a)?a:h.build(a))})})])})})},o.prototype.validateObjectList=function(t){if(t.length>1e3)throw h.build("The size of object list exceeds the limit.");if(!m.isSameObjectType(t))throw h.build("Only one object type is supported for batch operations.");if(!this.validateObjectType(t))throw h.build("The object type is not loaded yet.");if(this.calculateObjectListSize(t)>2097152)throw h.build("The capacity of objects exceeds the limit.")},o.prototype.executeQuery=function(t){return b(this,void 0,void 0,function(){var e=this;return g(this,function(n){return this.checkCloudDBZoneHandle(),[2,new Promise(function(r,i){e.naturalStore.executeQuery(t).then(function(s){r(s)}).catch(function(s){i(m.isErrorObject(s)?s:h.build(s))})})]})})},o.prototype.executeAverageQuery=function(t,e){var n=this;return this.checkCloudDBZoneHandle(),new Promise(function(r,i){n.naturalStore.executeAggregateQuery(t,"AVG",e).then(function(s){r(s)}).catch(function(s){i(m.isErrorObject(s)?s:h.build(s))})})},o.prototype.runTransaction=function(t){return this.checkQuickGamePlatform(),this.checkCloudDBZoneHandle(),this.checkTransactionFunction(t),this.getCloudDBZoneResult(t)},o.prototype.checkTransactionFunction=function(t){if(m.isNullOrUndefined(t))throw h.build("Function must not be null.");if(typeof t!="object"||typeof t.apply!="function")throw h.build("Function is invalid.")},o.prototype.getCloudDBZoneResult=function(t){return b(this,void 0,void 0,function(){var e,n,r,i,s;return g(this,function(a){switch(a.label){case 0:e=new gs(this),n=!1,r=0,a.label=1;case 1:if(n||!(r<5))return[3,8];a.label=2;case 2:return a.trys.push([2,5,6,7]),[4,t.apply(e)];case 3:return(n=a.sent())?(e.sortNeedVerifyObjects(),this.verifyTransaction(e),[4,this.getTransactionResult(e)]):(Ae.warn("user function return false, transaction failed."),[2,!1]);case 4:return a.sent(),n=!0,[3,7];case 5:return i=a.sent(),(s=this.handleUnrecoverableException(i))?[2,Promise.reject(s)]:(n=!1,++r>=5?[2,Promise.reject(h.build(i))]:[3,7]);case 6:return e.release(),[7];case 7:return[3,1];case 8:return[2,n]}})})},o.prototype.handleUnrecoverableException=function(t){if(m.isErrorObject(t))return t;switch(t){case 1004e3:case 1004001:case 1004002:case 1004003:case 1004004:case 1004005:case 1004006:case 1004007:case 1005e3:case 52:case 53:case 1005001:case 51:case 1001:case 1002:case 16:case 2001015:return h.build(t)}},o.prototype.verifyTransaction=function(t){if(this.verifyTransactionListLength(t),this.verifyTransactionData(t),t.getTransactionObjectsSize()>2097152)throw h.build("The capacity of objects exceeds the limit.");if(t.getNeedVerifyObjects().length>1e3)throw Ae.warn("The size of object list to be verified exceeds the limit."),h.build("The size of object list to be verified exceeds the limit.");if(t.getQueryObjectsSize()>5242880)throw Ae.warn("The capacity of objects to be verified exceeds the limit."),h.build("The capacity of objects to be verified exceeds the limit.")},o.prototype.verifyTransactionData=function(t){var e=this;t.getTransactionList().forEach(function(n){if(!e.validateObjectType(n.objects))throw h.build("The object type is not loaded yet.")})},o.prototype.verifyTransactionListLength=function(t){var e,n,r=0;try{for(var i=E(t.getTransactionList()),s=i.next();!s.done;s=i.next()){var a=s.value;if((a.operationType===ge.SYNC_UPSERT||a.operationType===ge.SYNC_DELETE)&&(r+=a.objects.length)>1e3)throw h.build("The size of object list exceeds the limit.")}}catch(u){e={error:u}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}},o.prototype.getTransactionResult=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,,4,5]),t.isTransactionEmpty()?[3,2]:[4,this.naturalStore.runTransaction(this.zoneName,t.getNeedVerifyObjects(),t.getTransactionList())];case 1:return e.sent(),[3,3];case 2:Ae.warn("nothing need to execute in this transaction, transaction succeed."),e.label=3;case 3:return[3,5];case 4:return t.release(),[7];case 5:return[2]}})})},o.prototype.checkCloudDBZoneHandle=function(){if(!this.naturalStore.references.has(this.zoneId))throw Ae.warn("The CloudDBZone has not been created or opened."),h.build("The CloudDBZone has not been created or opened.")},o.prototype.isValidOperation=function(t){if(this.checkCloudDBZoneHandle(),!m.isValidObject(t))throw h.build("The object list is invalid.")},o.prototype.checkQuickGamePlatform=function(){if(De.getApplicationType()==="FastGame")throw h.build("QuickGame platform is not support transaction or subscribe")},o.prototype.getNaturalStore=function(){return this.naturalStore},o.prototype.getDataModelHelper=function(){return this.naturalStore.getDataModelHelper()},o.listenerId=0,o}(),bs=new M("CloudDBZoneConfig"),vs=/^[a-zA-Z]{1}[a-zA-Z0-9]{0,19}$/,ms=function(){function o(t,e){this.checkInput(t),this.cloudDBZoneName_=t,this.checkTraceId(e)}return Object.defineProperty(o.prototype,"cloudDBZoneName",{get:function(){return this.cloudDBZoneName_},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"traceId",{get:function(){return this.traceId_},enumerable:!1,configurable:!0}),o.prototype.checkInput=function(t){if(typeof t!="string"||!this.isCloudDBZoneNameValid(t)||t.length>20)throw h.build("CloudDBZone name is invalid.")},o.prototype.checkTraceId=function(t){if(t&&t["x-trace-id"]!==void 0&&t["x-trace-id"]!==null){var e=t["x-trace-id"];if(typeof e!="string"||!m.checkTraceId(e))return this.traceId_=m.generateTraceId(),void bs.warn("The customized trace id is invalid, a new trace id '"+this.traceId_+"' will be used");this.traceId_=e}else this.traceId_=void 0},o.prototype.isCloudDBZoneNameValid=function(t){return vs.test(t)},o}();(function(o){o[o.USER_KEY_CHANGED=0]="USER_KEY_CHANGED"})(At||(At={}));var en=new M("AGConnectCloudDB"),Us=function(){function o(t){this.isCreateObjectTypeSuccess=!1,this.naturalBase=t}return o.initialize=function(t){if(!o.sAGConnectCloudDB){kt.loadAgcConfig(t);var e=new Zt;this.sAGConnectCloudDB=new o(e)}},o.getInstance=function(t){if(m.isNullOrUndefined(t))return o.sAGConnectCloudDB;if(!he.getConfigInstance().getAGCRoutePolicySet().has(t))throw h.build("The agcRoutePolicy is invalid");var e=this.CLOUDDB_MAP.get(t);if(!m.isNullOrUndefined(e))return e;var n=new o(new Zt(t));return this.CLOUDDB_MAP.set(t,n),n},o.prototype.createObjectType=function(t){if(!(this.naturalBase instanceof Zt))throw h.build("Failed to create object type info into the AGConnectCloudDB.");var e=this.naturalBase.createObjectType(t);if(e!==0)throw h.build(e);this.isCreateObjectTypeSuccess=!0},o.prototype.openCloudDBZone=function(t){var e=this;if(!(t&&t instanceof ms))throw h.build("The config is invalid.");if(!this.isCreateObjectTypeSuccess)throw h.build("Failed to open the CloudDBZone because the object type has not been created.");return ut.setTraceId(t.traceId),new Promise(function(n,r){e.naturalBase.openNaturalStore(t.cloudDBZoneName).then(function(i){if(i.exceptionCode===0){var s=new rr(m.generateUUID(),t.cloudDBZoneName,i.naturalStore);n(s)}else en.error("openCloudDBZone: Failed to create or open a CloudDBZone."),r(h.build(i.exceptionCode))}).catch(function(i){en.error("openCloudDBZone: Failed to create or open a CloudDBZone."),r(h.build(i))})})},o.prototype.closeCloudDBZone=function(t){this.validateCloudDBZone(t),this.naturalBase.tryCloseNaturalStore(t.zoneId,t.cloudDBZoneName)},o.prototype.setUserKey=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:if(typeof t!="string"||t.length===0)throw h.build("User key must not be null.");return e=typeof e!="string"?"":e,n=typeof n=="boolean"&&n,[4,this.naturalBase.setUserKey(t,e,n)];case 1:return[2,r.sent()]}})})},o.prototype.addEventListener=function(t){return b(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:if(!t)throw h.build("EventListener must not be null.");if(!m.isFunction(t.onEvent))throw h.build("EventListener is invalid.");return[4,kt.getUserInfo()];case 1:return e.sent()?[4,this.naturalBase.addOnEventListener(t)]:(en.error("User has not login, fail to addEventListener"),[2]);case 2:return e.sent(),[2]}})})},o.prototype.validateCloudDBZone=function(t){if(!t)throw h.build("CloudDBZone must not be null.");if(!(t instanceof rr))throw h.build("Input CloudDBZone is invalid.");if(t.hasSnapshot())throw h.build("Remove snapshot listener first.")},o.CLOUDDB_MAP=new Map,o}(),Ss=rt.getCryptoJS(),Ts=function(){function o(){}return o.prototype.decrypt=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,In.decrypt(t,e,{name:"AES-GCM",iv:n,tagLength:Te})];case 1:return[2,r.sent()]}})})},o.prototype.encrypt=function(t,e,n){return b(this,void 0,void 0,function(){return g(this,function(r){switch(r.label){case 0:return[4,In.encrypt(t,e,{name:"AES-GCM",iv:n,tagLength:Te})];case 1:return[2,r.sent()]}})})},o.prototype.generateRandom=function(t){var e=Ss.lib.WordArray.random(t);return m.wordArrayToUint8Array(e)},o}(),Is=function(){function o(){}return o.prototype.request=function(t){var e=t;this.realRequest(e)},o}(),or=new M("AGCHttpsAdapter"),ws=function(o){function t(){return o.call(this)||this}return se(t,o),t.prototype.getService=function(){return this.service||(this.service=_.instance().getService("AGCNetworkService")),this.service},t.prototype.realRequest=function(e){var n=this,r=e.url,i=e.backUrl,s=e.method,a=e.header,u=e.data,l=e.success?e.success:function(d){},c=e.fail?e.fail:function(d){};this.internalRequest(r,s,a,u).then(function(d){var y=d.status;y>=200&&y<300?l({statusCode:y,data:d.data}):(or.warn("[AGC Http Adapter fail] =>"+y+" "+d.statusText),n.retryRequest(i,s,a,u,l,c))}).catch(function(d){n.retryRequest(i,s,a,u,l,c)})},t.prototype.internalRequest=function(e,n,r,i){var s=i instanceof ArrayBuffer?{responseType:"arraybuffer",timeout:6e4}:{};switch(n){case"DELETE":return this.getService().delete(e,void 0,r,s);case"GET":return this.getService().get(e,void 0,r,s);case"POST":return this.getService().post(e,i,r,s);case"PUT":return this.getService().put(e,i,r,s);default:return Promise.reject({status:405})}},t.prototype.retryRequest=function(e,n,r,i,s,a){this.internalRequest(e,n,r,i).then(function(u){var l=u.status;l>=200&&l<300?s({statusCode:l,data:u.data}):(or.warn("[AGC Http Adapter fail] =>"+l+" "+u.statusText),a({status:l,statusText:u.statusText}))}).catch(function(u){a(u)})},t}(Is),Es=function(){function o(t,e){this.listeners=t,this.agcWebsocket=_.instance(e).getService("AGCWebSocketService")}return o.prototype.connect=function(t){if(!t)throw h.build(1003);this.agcWebsocket.connect(t.url,t.header),this.agcWebsocket.onOpen(this.listeners._onopen),this.agcWebsocket.onMessage(this.listeners._onmessage),this.agcWebsocket.onClose(this.listeners._onclose),this.agcWebsocket.onError(this.listeners._onerror)},o.prototype.close=function(t){this.agcWebsocket&&this.agcWebsocket.close((t==null?void 0:t.eventCode)||1e3,t)},o.prototype.sendMessage=function(t){this.agcWebsocket&&this.agcWebsocket.send(t.data)},o}(),Rs=function(){function o(){}return o.prototype.getAGCRoutePolicySet=function(){return this.agcRoutePolicySet||(this.agcRoutePolicySet=new Set([1,3,2,4])),this.agcRoutePolicySet},o.prototype.getAddressMap=function(){return this.addressMap||(this.addressMap=new Map([[1,["CN","CN_back"]],[4,["SG","SG_back"]],[3,["RU","RU_back"]],[2,["DE","DE_back"]]])),this.addressMap},o.prototype.getAgcRoutePolicyMap=function(){return this.agcRoutePolicyMap||(this.agcRoutePolicyMap=new Map([["CN",1],["SG",4],["RU",3],["DE",2]])),this.agcRoutePolicyMap},o.prototype.getConfigInstance=function(t){return this.agcInstance=_.instance().configInstance(t),this.agcInstance},o.prototype.getCredentialsProvider=function(){var t;return this.credentialsProvider=(t=this.agcInstance)===null||t===void 0?void 0:t.getService("CredentialsService"),this.credentialsProvider},o.prototype.getCurrentUser=function(){return b(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,_.auth().getCurrentUser()];case 1:return[2,t.sent()]}})})},o.prototype.getRegionMap=function(){return this.regionMap||(this.regionMap=new Map([[1,"CN"],[2,"DE"],[3,"RU"],[4,"SG"]])),this.regionMap},o}();Ir.setClient(ws),mr.setClient(Es),he.setConfigAdapter(Rs),De.setApplicationType("Browser"),wr.setEncryptor(new Ts);export{ni as P,ms as o,_ as r,Us as s};
